"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function GanttService(e,t){if(!t){this.sfdcType="service",this.fields={};for(var i in e.Fields)this.fields[i]=e.Fields[i];this.id=e.Fields.Id||null,this.name=e.Fields.AppointmentNumber||null,this.AssignedResourceLastModifiedDate=e.AssignedResourceLastModifiedDate||null,this.ServiceAppointmentLastModifiedDate=e.ServiceAppointmentLastModifiedDate||null,this.accountName=e.Fields["Account.Name"]||null,this.accountId=e.Fields.AccountId||null,this.latitude=e.Fields.Latitude||null,this.longitude=e.Fields.Longitude||null,this.arrivalWindowEndTime=e.Fields.ArrivalWindowEndTime||null,this.arrivalWindowStartTime=e.Fields.ArrivalWindowStartTime||null,this.dueDate=e.Fields.DueDate||null,this.durationType=e.Fields.DurationType||null,this.earliestStartTime=e.Fields.EarliestStartTime||null,this.estDuration=e.Fields.Duration||null,this.travelTimeFrom=e.Fields.EstimatedTravelTimeFrom__c||null,this.travelTimeTo=e.Fields.EstimatedTravelTime||null,this.ganttLabel=e.Fields.GanttLabel__c||null,this.jeopardy=e.Fields.InJeopardy__c||null,this.jeopardyReason=e.Fields.InJeopardyReason__c||null,this.parentRecord=e.Fields.ParentRecordId||null,this.parentRecordStatus=e.Fields.ParentRecordStatusCategory||null,this.parentRecordType=e.Fields.ParentRecordType||null,this.pinned=e.Fields.Pinned__c||!1,this.schedEndTime=e.Fields.SchedEndTime||null,this.schedStartTime=e.Fields.SchedStartTime||null,this.serviceTerritory=e.Fields.ServiceTerritory||null,this.serviceTerritoryName=e.Fields["ServiceTerritory.Name"]||null,this.status=e.Fields.Status||null,this.statusCategory=e.Fields.StatusCategory||null,this.subject=e.Fields.Subject||null,this.ganttColor=e.Fields.GanttColor__c||null,this.resource=e.Resource||null,this.resourceName=e.ResourceName||null,this.resourceContractor=e.ResourceContractor||null,this.isAssignToCrew=e.IsAssignToCrew||null,this.assignedResource=e.AssignedResource||null,this.violations=null,this.relatedTo=e.relatedTo||null,this.relatedFather=null,this.priority=this.minPriority,this.relatedFather=e.relatedFather,this.policyUsed=e.Fields.Scheduling_Policy_Used__c||null,this.scheduleMode=e.Fields.Schedule_Mode__c||null,this.emergency=e.Fields.Emergency__c||!1,this.isServiceInChain=usingNewMstModel&&e.isServiceInChain,this.relatedService2=e.relatedService2||null,this.relatedService1=e.relatedService1||null;var s="WorkOrder"==e.Fields.ParentRecordType?CustomSettings.woPriorityField:CustomSettings.woliPriorityField;s&&e.ParentFields&&e.ParentFields[s]&&(this.priority=e.ParentFields[s]);var n=fslNamespace?mdtBooleanField.replace(fslNamespace+"__",""):mdtBooleanField;this.isMDT=e.Fields[n]?!0:!1,e.Fields.MDT_Operational_Time__c?this.calculateMdtTimes(e.Fields.MDT_Operational_Time__c):this.isMDT&&(this.mdtTimes={travel:[],working:[]}),this.parentFields={};for(var r in e.ParentFields)this.parentFields[r]=e.ParentFields[r];this.setSchedulerProperties(),addFieldSetToServiceObject(GanttService.prototype.allFieldSetsSet,e.Fields,this),this.isMDT&&(this.travelTimeFrom=0,this.travelTimeTo=0)}}function getGanttResourceWithSecondaryStms(e){if(showSecondarySTMs){var t=e.resourceId.split(",");if(e.resourceBeforeDrag&&e.resourceBeforeDrag!=e.resourceId&&t.length>1)for(var i=0;i<t.length;i++)if(e.resourceBeforeDrag.split(",")[i]!=t[i]){e.resourceId=t[i];break}}}function addFieldSetToServiceObject(e,t,i){for(var s in e){var n=null;if(n=t[e[s].APIName],n||0==n){switch(e[s].Type){case"DATE":case"DATETIME":var r=60*new Date(n).getTimezoneOffset()*1e3;n=new Date(n+r),i.fields[e[s].APIName]=n.getTime();break;case"REFERENCE":var a=e[s].JsAPIName.replace("__r","__c");i[a]=t[a]}i[e[s].APIName]=n}}}function LastKnownPosition(e){this.id=e.Id,this.latitude=e[fieldNames.ServiceResource.LastKnownLocation__Latitude__s],this.longitude=e[fieldNames.ServiceResource.LastKnownLocation__Longitude__s],this.lastModifiedDate=e[fieldNames.ServiceResource.LastKnownLocationUpdate__c];var t=void 0;this.lastModifiedDate&&(t=60*new Date(this.lastModifiedDate).getTimezoneOffset()*1e3),this.lastModifiedDate=this.lastModifiedDate?new Date(this.lastModifiedDate+t):null}function OptimizationRequest(e){if(this.id=e.Id,this.lastModifiedDate=e.LastModifiedDate,this.name=e.Name,this.scheduledAmount=e[fieldNames.Optimization_Request.Objects_Scheduled__c],this.objectToScheduled=e[fieldNames.Optimization_Request.Objects_To_Schedule__c],this.status=e[fieldNames.Optimization_Request.Status__c]||null,this.statusLabel=e.statusLabel||e[fieldNames.Optimization_Request.Status__c]||null,this.allTasks=e[fieldNames.Optimization_Request.All_Tasks_Mode__c]||null,this.includeEmptyLocations=e[fieldNames.Optimization_Request.Include_Services_With_Empty_Location__c]||null,this.type=e[fieldNames.Optimization_Request.Type__c]||null,this.failureReason=e[fieldNames.Optimization_Request.Failure_Reason__c]||null,this.optimizationData=e[fieldNames.Optimization_Request.Optimization_Data__c]||null,this.orgResourceAbsence=e[fieldNames.Optimization_Request.Originating_Resource_Absence__c]||null,this.orgServiceAppointment=e[fieldNames.Optimization_Request.Originating_Service_Appointment__c]||null,this.policy=e[fieldNames.Optimization_Request.Scheduling_Policy__c]||null,this.serviceAppointment=e[fieldNames.Optimization_Request.Service_Appointment__c]||null,this.resource=e[fieldNames.Optimization_Request.Service_Resource__c]||null,this.result=e[fieldNames.Optimization_Request.Result__c]||null,this.timespan=null,this.finish=e[fieldNames.Optimization_Request.Finish__c]?new Date(e[fieldNames.Optimization_Request.Finish__c]):null,this.start=e[fieldNames.Optimization_Request.Start__c]?new Date(e[fieldNames.Optimization_Request.Start__c]):null,this.start){var t=60*new Date(this.start).getTimezoneOffset()*1e3;this.start=new Date(this.start.valueOf()+t)}if(this.finish){var i=60*new Date(this.finish).getTimezoneOffset()*1e3;this.finish=new Date(this.finish.valueOf()+i)}}function ResourceAbsence(e){this.id=e.Id,this.end=e[fieldNames.ResourceAbsence.End],this.resource=e[fieldNames.ResourceAbsence.Resource],this.start=e[fieldNames.ResourceAbsence.Start],this.absenceType=e.TypeLabel||e[fieldNames.ResourceAbsence.Type]||"",this.reason=e.TypeLabel||e[fieldNames.ResourceAbsence.Type]||"",this.ganttLabel=e[fieldNames.ResourceAbsence.GanttLabel__c]||null,this.lastModifiedDate=e.LastModifiedDate||null,this.name=e.AbsenceNumber,this.resourceName=e[fieldNames.ResourceAbsence.Resource__r].Name,this.ganttColor=e[fieldNames.ResourceAbsence.Gantt_Color__c],this.approved=e[fieldNames.ResourceAbsence.Approved__c],this.travelTo=e[fieldNames.ResourceAbsence.EstTravelTime__c]?60*e[fieldNames.ResourceAbsence.EstTravelTime__c]:0,this.travelFrom=e[fieldNames.ResourceAbsence.EstTravelTimeFrom__c]?60*e[fieldNames.ResourceAbsence.EstTravelTimeFrom__c]:0,this.sfdcType="absence",e.RecordType&&e.RecordType.DeveloperName&&"Non_Availability"==e.RecordType.DeveloperName?this.type="na":this.type="break",this.setSchedulerProperties()}function ResourceCapacity(e){this.sfdcType="capacity",this.id=e.Id,this.end=e[fieldNames.ResourceCapacity.EndDate],this.resource=e[fieldNames.ResourceCapacity.ServiceResource],this.resourceName=e[fieldNames.ResourceCapacity.ServiceResource__r]?e[fieldNames.ResourceCapacity.ServiceResource__r].Name:null,this.start=e[fieldNames.ResourceCapacity.StartDate],this.hoursInUse=e[fieldNames.ResourceCapacity.HoursInUse__c],this.hoursPerTimePeriod=e[fieldNames.ResourceCapacity.CapacityInHours]||0,this.minutesUsed=e[fieldNames.ResourceCapacity.MinutesUsed__c],this.lastModifiedDate=e.LastModifiedDate||null,this.name=e.CapacityNumber,this.timePeriod=e[fieldNames.ResourceCapacity.TimePeriod],this.workItemsAllocated=e[fieldNames.ResourceCapacity.Work_Items_Allocated__c],this.workItemsPerTimePeriod=e[fieldNames.ResourceCapacity.CapacityInWorkItems]||0,this.setSchedulerProperties()}function addDaysToDate(e,t){var i=864e5*t;return new Date(e.getTime()+i)}function calcCapacityPercentage(e,t){return parseFloat((e/t*100).toFixed(2))}function ResourcesAndTerritories(e){this.id=e.Id,this.name=e.MemberNumber,this.effectiveEndDate=e[fieldNames.ServiceTerritoryMember.EffectiveEndDate]||null,this.effectiveStartDate=e[fieldNames.ServiceTerritoryMember.EffectiveStartDate],this.latitude=e[fieldNames.ServiceTerritoryMember.Latitude],this.longitude=e[fieldNames.ServiceTerritoryMember.Longitude],this.serviceResource=e[fieldNames.ServiceTerritoryMember.ServiceResource],this.serviceResource__r=e[fieldNames.ServiceTerritoryMember.ServiceResource__r],this.serviceTerritory=e[fieldNames.ServiceTerritoryMember.ServiceTerritory],this.serviceTerritory__r=e[fieldNames.ServiceTerritoryMember.ServiceTerritory__r],this.serviceTerritoryType=e[fieldNames.ServiceTerritoryMember.TerritoryType],this.operatingHours=e[fieldNames.ServiceTerritoryMember.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritoryMember.OperatingHours__r];var t=void 0,i=void 0;this.effectiveStartDate&&(t=60*new Date(this.effectiveStartDate).getTimezoneOffset()*1e3),this.effectiveEndDate&&(i=60*new Date(this.effectiveEndDate).getTimezoneOffset()*1e3),this.effectiveStartDate=this.effectiveStartDate?new Date(this.effectiveStartDate+t):new Date(0),this.effectiveEndDate=this.effectiveEndDate?new Date(this.effectiveEndDate+i):new Date(24e11),this.timezone=e[fieldNames.ServiceTerritoryMember.ServiceTerritory__r][fieldNames.ServiceTerritory.OperatingHours__r][fieldNames.OperatingHours.Timezone]}function ServiceCrewMember(e){this.id=e.Id,this.name=e.Name,this.endDate=e[fieldNames.ServiceCrewMember.EndDate]||null,this.startDate=e[fieldNames.ServiceCrewMember.StartDate],this.serviceResource=e[fieldNames.ServiceCrewMember.ServiceResource],this.serviceResource__r=e[fieldNames.ServiceCrewMember.ServiceResource__r],this.serviceCrew=e[fieldNames.ServiceCrewMember.ServiceCrew],this.serviceCrew__r=e[fieldNames.ServiceCrewMember.ServiceCrew__r],this.leader=e[fieldNames.ServiceCrewMember.Leader],this.ganttLabel=e[fieldNames.ServiceCrewMember.GanttLabel];var t=void 0,i=void 0;this.startDate&&(t=60*new Date(this.startDate).getTimezoneOffset()*1e3),this.endDate&&(i=60*new Date(this.endDate).getTimezoneOffset()*1e3),this.startDate=this.startDate?new Date(this.startDate+t):new Date(24e11),this.endDate=this.endDate?new Date(this.endDate+i):new Date(24e11)}function ServiceResource(e){var t=this;this.id=e.Id,this.online=!1,this.isUndestaffOrOverStaff=!1,this.name=e.Name,this.isCapacityBased=e[fieldNames.ServiceResource.IsCapacityBased],this.description=e[fieldNames.ServiceResource.Description]||"",this.isOptimizationCapable=e[fieldNames.ServiceResource.IsOptimizationCapable],this.relatedRecord=e[fieldNames.ServiceResource.RelatedRecord],this.relatedRecord__r=e[fieldNames.ServiceResource.RelatedRecord__r],this.resourceType=e[fieldNames.ServiceResource.ResourceType],this.ganttLabel=e[fieldNames.ServiceResource.GanttLabel__c],this.lastKnownLongitude=e[fieldNames.ServiceResource.LastKnownLongitude],this.lastKnownLocationDate=e[fieldNames.ServiceResource.LastKnownLocationDate],this.lastKnownLatitude=e[fieldNames.ServiceResource.LastKnownLatitude],this.serviceCrew=e[fieldNames.ServiceResource.ServiceCrew],this.serviceCrew__r=e[fieldNames.ServiceResource.ServiceCrew__r],this.relatedRecord__r&&(this.pictureLink=this.relatedRecord__r.SmallPhotoUrl),this.onlineOffset=e[fieldNames.ServiceResource.Online_Offset__c]||orgOnlineOffset,this.pictureLink&&this.pictureLink.endsWith("profilephoto/005/T")&&(this.pictureLink=null),e[fieldNames.ServiceResource.PictureLink]&&(this.pictureLink=e[fieldNames.ServiceResource.PictureLink]),this.skills={},this.sobject=e,e[fieldNames.ServiceResource.Skills]&&e[fieldNames.ServiceResource.Skills].forEach(function(e){t.skills[e[fieldNames.ServiceResourceSkill.Skill]]=new ServiceResourceSkill(e)})}function ServiceResourceSkill(e){this.id=e.Id,this.name=e.SkillNumber,this.effectiveEndDate=e[fieldNames.ServiceResourceSkill.EffectiveEndDate],this.effectiveStartDate=e[fieldNames.ServiceResourceSkill.EffectiveStartDate],this.level=e[fieldNames.ServiceResourceSkill.SkillLevel],this.serviceResource=e[fieldNames.ServiceResourceSkill.ServiceResource],this.skill=e[fieldNames.ServiceResourceSkill.Skill];var t=void 0,i=void 0;this.effectiveStartDate&&(t=60*new Date(this.effectiveStartDate).getTimezoneOffset()*1e3),this.effectiveEndDate&&(i=60*new Date(this.effectiveEndDate).getTimezoneOffset()*1e3),this.effectiveStartDate=this.effectiveStartDate?new Date(this.effectiveStartDate+t):new Date(0),this.effectiveEndDate=this.effectiveEndDate?new Date(this.effectiveEndDate+i):new Date(864e11)}function ServiceTerritory(e){this.id=e.Id,this.name=e.Name,this.latitude=e[fieldNames.ServiceTerritory.Latitude],this.longitude=e[fieldNames.ServiceTerritory.Longitude],this.operatingHours=e[fieldNames.ServiceTerritory.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritory.OperatingHours__r],this.description=e[fieldNames.ServiceTerritory.Description],this.parentTerritory=e[fieldNames.ServiceTerritory.ParentTerritory],this.isActive=e[fieldNames.ServiceTerritory.IsActive],e[fieldNames.ServiceTerritory.ParentTerritory]&&e[fieldNames.ServiceTerritory.ParentTerritory]&&(this.parentTerritory=new ServiceTerritory(e[fieldNames.ServiceTerritory.ParentTerritory__r]))}function handleTabSettingAndRecordTypesPermissions(e){var t=new Promise(function(t,i){var s=JSON.parse(e.Admin.replace(/&quot;/g,'"')),n=JSON.parse(e.Agent.replace(/&quot;/g,'"')),r=JSON.parse(e.Community.replace(/&quot;/g,'"')),a=JSON.parse(e.Dispatcher.replace(/&quot;/g,'"')),o=JSON.parse(e.Resource.replace(/&quot;/g,'"'));Promise.all([createTabAndRecordTypePermission("FSL_Admin","FSL Admin",s.tabSettings,s.recordTypeVisibilities),createTabAndRecordTypePermission("FSL_Agent","FSL Agent",n.tabSettings,n.recordTypeVisibilities),createTabAndRecordTypePermission("FSL_Dispatcher","FSL Dispatcher",a.tabSettings,a.recordTypeVisibilities),createTabAndRecordTypePermission("FSL_Community_Self_Service","FSL Self Service",r.tabSettings,r.recordTypeVisibilities),createTabAndRecordTypePermission("FSL_Resource","FSL Resource",o.tabSettings,o.recordTypeVisibilities)]).then(function(){t()},function(){t()})});return t}function createTabAndRecordTypePermission(e,t,i,s){new Promise(function(n,r){for(var a=window.location.origin,o='<soapenv:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:met="http://soap.sforce.com/2006/04/metadata"><soapenv:Header><met:SessionHeader><met:sessionId>'+sessionId+'</met:sessionId></met:SessionHeader></soapenv:Header><soapenv:Body><met:updateMetadata><met:metadata xsi:type="met:PermissionSet"><fullName>'+e+"_Permissions</fullName><label>"+t+" Permissions</label>",c=0;c<i.length;c++)o+="<tabSettings><tab>"+i[c].tab+"</tab><visibility>"+i[c].visibility+"</visibility></tabSettings>";for(var l=0;l<s.length;l++)o+="<recordTypeVisibilities><recordType>"+s[l].recordType+"</recordType><visible>"+s[l].visible+"</visible></recordTypeVisibilities>";o+="</met:metadata></met:updateMetadata></soapenv:Body></soapenv:Envelope>",window.$.ajax({url:a+"/services/Soap/m/38.0",type:"POST",dataType:"xml",data:o,beforeSend:function(e){e.setRequestHeader("Content-Type","text/xml"),e.setRequestHeader("SOAPAction",'""')}}).then(function(e,t,i){n()},function(e,t,i){console.log("Failed to update permissions on load of VF"),n()})})}function setHoursToDisplay(e,t,i){minHourToDisplay=e,maxHourToDisplay=t,includeWeekends=i}function updateTimesToSnapIn(){var e=cachedDomElements.timesDragFix.html(),t=null;0!==e.indexOf(customLabels.SchedulingTimesGantSnap)||ctrlPressed?0!==e.indexOf(customLabels.SchedulingTimesGantSnap)&&ctrlPressed&&(t=customLabels.SchedulingTimesGantSnap+" "+e.substr(customLabels.SchedulingTimesGant.length,e.length),cachedDomElements.timesDragFix.html(t)):(t=customLabels.SchedulingTimesGant+" "+e.substr(customLabels.SchedulingTimesGantSnap.length,e.length),cachedDomElements.timesDragFix.html(t))}function showTimesWhenDragging(e,t){cachedDomElements.timesDragFix=cachedDomElements.timesDragFix||$("#timesDragFix");var i=(t.start_date.getMinutes()+t.travelTo/60)%60,s=i%serviceJumpsOnGantt,n=serviceJumpsOnGantt-i%serviceJumpsOnGantt;if(scheduler.getState().drag_id!==t.id)return void(scheduler.getState().drag_id||cachedDomElements.timesDragFix.hide());var r=t.finish-t.start,a=new Date(e);a.setSeconds(0),t.travelTo&&a.setSeconds(a.getSeconds()+t.travelTo),a=s>n?new Date(a.getTime()+60*n*1e3):new Date(a.getTime()-60*s*1e3);var o=new Date(a.getTime()+r),c=moment(a).format("lll"),l=moment(o).format("lll"),u=customLabels.SchedulingTimesGant+"<br/>"+c+" - "+l;ctrlPressed&&(u=customLabels.SchedulingTimesGantSnap+"<br/>"+c+" - "+l),cachedDomElements.timesDragFix.html(u).show()}function generateBreakEventHtml(e){var t="Break_Laebl",i="breakIcon";return"ZoomLevel2"!=scheduler._mode&&"ZoomLevel3"!=scheduler._mode&&(t="Break_Laebl BreakLabelSmall",i="breakIconSmall"),e.ganttLabel?'<span class="'+t+'">\n                    <img src="'+lsdIcons.breakImg+'" class="'+i+'" draggable="false"/>\n                    '+e.ganttLabel+"\n                </span>":'<span class="'+t+'">\n                <img src="'+lsdIcons.breakImg+'" class="'+i+' NA_Break_NoLabel_Icon" draggable="false"/>\n            </span>'}function generateCapacityHtml(e){var t="",i="contractorCapacityHoursUsed ",s="fa-battery-empty",n=0;return e.hoursPerTimePeriod>0?n=e.hoursInUse/e.hoursPerTimePeriod*100:e.workItemsPerTimePeriod>0&&(n=e.workItemsAllocated/e.workItemsPerTimePeriod*100),s=25>=n?"fa-battery-empty":50>=n?"fa-battery-quarter":75>=n?"fa-battery-half":90>=n?"fa-battery-three-quarters":"fa-battery-full",n=n>100?100:n,t+='<span class="'+i+'" style="width:calc('+n+'% - 5px);"></span>',e.text&&(t+="ZoomLevel6"===scheduler._mode?'<div class="ServiceEventPadding"><span class="Capacity_Label"><i class="fa '+s+'"></i>'+e.text.split(" ")[0]+"</span></div>":"MonthlyView"===scheduler._mode?'<div class="ServiceEventPadding"><span class="Capacity_Label">'+e.text.split(" ")[0]+"</span></div>":'<div class="ServiceEventPadding"><span class="Capacity_Label"><i class="fa '+s+'"></i>'+e.text+"</span></div>"),t}function generateNAhtml(e,t,i){return i?'<div class="ServiceEvent" style="'+t+'">\n                    <div class="ServiceEventPadding">\n                        <svg aria-hidden="true" class="slds-icon naIcon">\n                            <use xlink:href="'+lsdIcons.na+'"></use>\n                        </svg>\n                        <span class="NA_Label">\n                            '+(e.ganttLabel||e.reason)+"\n                        </span>\n                    </div>\n                </div>":'<div class="ServiceEventPadding" style="'+t+'">\n                <svg aria-hidden="true" class="slds-icon naIcon">\n                    <use xlink:href="'+lsdIcons.na+'"></use>\n                </svg>\n                <span class="NA_Label">\n                    '+(e.ganttLabel||e.reason)+"\n                </span>\n            </div>"}function generateIconsHtmlForService(e){var t="";if(e.violations&&(t="<div class='violationsOnService'><i class='fa fa-warning'></i></div>"),e.jeopardy&&(t='<div class="jeopardyOnService"><img src="'+lsdIcons.jeopardyImg+'"></div>'),e.emergency&&(t+='<svg aria-hidden="true" class="slds-icon emergencyOnService"><use xlink:href="'+lsdIcons.emergency+'"></use></svg>'),e.pinned&&(t+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.pin+'"></use></svg>'),flaggedServices[e.id]&&(t+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.flag+'"></use></svg>'),(e.relatedFather||e.relatedTo||e.isServiceInChain)&&(t+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.related+'"></use></svg>'),e.isMDT){var i='<svg aria-hidden="true" class="slds-icon onServiceIcon">\n                                <use xlink:href="'+lsdIcons.clock+'"></use>\n                            </svg>',s='<svg aria-hidden="true" class="slds-icon onServiceIcon forwardIcon">\n                                <use xlink:href="'+lsdIcons.forward+'"></use>\n                            </svg>';t+=i+s}return t}function generateServiceColorAndFont(e){var t="";if("na"==e.type&&e.ganttColor&&e.travelTo&&(t+="margin-right:-6px;"),e.ganttColor&&!globalSelectedGanttServices[e.id]){var i=generateGanttTextColor(e.ganttColor.substr(1,7));t+="color:#"+i+";background:"+e.ganttColor+";"}return"ZoomLevel3"!=scheduler._mode&&"ZoomLevel2"!=scheduler._mode&&(t+="font-size:10px;"),t}function attchDatalessSchedulerEvents(){function e(e){if(t(e))return!0;var i=s();return!(e.getHours()>=i.min&&e.getHours()<i.max)}function t(e){if("ZoomLevel6"==scheduler.getState().mode||"MonthlyView"==scheduler.getState().mode||"MTDView"==scheduler.getState().mode){var t=0==firstDayOfTheWeek?6:0,i=0==firstDayOfTheWeek?5:6;if(!includeWeekends&&(e.getDay()==i||e.getDay()==t))return!0}return!1}function i(e){var i=s();if(t(e.start_date)&&t(e.end_date))return!1;var n=[];if("ZoomLevel2"===scheduler._mode)n.push({start:scheduler._min_date.getTime(),finish:scheduler._max_date.getTime()});else for(var r=scheduler._min_date.getTime(),a=scheduler._max_date.getTime(),o=r;a>o;o+=864e5){var c={start:o+1e3*i.min*60*60,finish:o+1e3*i.max*60*60};n.push(c)}return isMultipleIntersection({start:e.start_date.getTime(),finish:e.end_date.getTime()},n)}function s(){var e=scheduler.getState().mode,t=minHourToDisplay,i=maxHourToDisplay,s=null;switch(e){case"ZoomLevel4":s=2;break;case"ZoomLevel5":s=4;break;case"ZoomLevel6":s=6}if(null!=s){t-=t%s;var n=s-i%s;n!=s&&(i+=n)}return{min:t,max:i}}function n(e,t){if(gameOn)return!1;var s=i(t),n=!0;return contractorSupport&&(t.resourceContractor&&(n=!1),"contractorcapacity"==t.type&&t.timePeriod!=capacityDurationFilter&&(n=!1)),s&&n}scheduler.date.ZoomLevel1_start=function(e){var t=scheduler.date.day_start(new Date(e));return t.setHours(e.getHours()),t},scheduler.date.ZoomLevel2_start=function(e){var t=scheduler.date.day_start(new Date(e));return t.setHours(e.getHours()),t},scheduler.templates.event_bar_text=function(e,t,i){var n=void 0,r=void 0,a=void 0,o=void 0,c=void 0,l=void 0,u=s(),d=i.finish-i.start,v=new Date(e),p=void 0;if(v.setSeconds(0),i.travelTo&&v.setSeconds(v.getSeconds()+i.travelTo),p=new Date(v.getTime()+d),showTimesWhenDragging(e,i),"break"===i.type)return generateBreakEventHtml(i);if("contractorcapacity"===i.type)return generateCapacityHtml(i);var g=generateIconsHtmlForService(i),h=generateServiceColorAndFont(i),m=!0,f=new Date(scheduler._min_date),S=new Date(scheduler._max_date);if(f.setHours(u.min),S.setHours(u.max),isIntersect(v,p,f,S)||"ZoomLevel2"===scheduler._mode||(m=!1),m&&(i.travelTo||i.travelFrom)){if(n=getXPositionOfEvent({start_date:v,end_date:p},!1,scheduler.matrix[scheduler._mode]),r=getXPositionOfEvent({start_date:v,end_date:p},!0,scheduler.matrix[scheduler._mode]),a=r-n+12,2>=a&&(a=3),h+="width:"+a+"px;",i.travelTo){var b=new Date(e);b.setMinutes(b.getMinutes()+i.travelTo/60),o=getXPositionOfEvent({start_date:i.start_date,end_date:b},!1,scheduler.matrix[scheduler._mode]),c=getXPositionOfEvent({start_date:i.start_date,end_date:b},!0,scheduler.matrix[scheduler._mode]),l=c-o+7,h+="margin-left:"+l+"px;"}return"na"==i.type?generateNAhtml(i,h,!0):'<div class="ServiceEvent" territory_id="'+i.getGanttTerritory()+'" style="'+h+'");"><div class="ServiceEventPadding">'+g+i.text+"</div></div>"}if("na"==i.type)return generateNAhtml(i,h,!1);var y=g+i.text;return m||i.isDummy||(y=""),'<div class="ServiceEventPadding" style="'+h+'">'+y+"</div>"},scheduler.templates.event_class=function(e,t,i){if("break"==i.type)return"NA_Break";var s="";return"na"==i.type&&(s+=" NA_Absence "),"na"==i.type&&i.ganttColor&&!i.travelTo&&(s+=" na_with_color_no_travel_to "),"na"==i.type&&i.ganttColor&&i.travelTo&&(s+=" na_with_color "),"contractorcapacity"==i.type?(s+=" eventContractorCapacity",i.hoursPerTimePeriod>0?i.hoursInUse>0&&i.hoursInUse>i.hoursPerTimePeriod&&(s+=" overCapacityPattern"):i.workItemsPerTimePeriod>0&&i.workItemsAllocated>0&&i.workItemsAllocated>i.workItemsPerTimePeriod&&(s+=" overCapacityPattern"),showCandidates.on&&(s+=" fadedSlot"),s):("service"==i.type&&(s+=getClassByStatus(i.statusCategory)),i.isMDT&&(s+=" mdtEvent"),showCandidates.on&&i.id!==showCandidates.id&&(s+=" fadedSlot"),i.hiddenTravelFrom&&(s+=" dhx_long_travel_from_time_background"),i.hiddenTravelTo&&(s+=" dhx_long_travel_to_time_background"),s+=i.travelTo&&i.travelFrom?" dhx_travelToFrom dhx_travel_time_background":i.travelTo&&!i.travelFrom?" dhx_travelTo dhx_travel_time_background":!i.travelTo&&i.travelFrom?" dhx_travelFrom dhx_travel_time_background":"na"==i.type?" NA_Absence_NoTravel":" dhx_noTravel","service"==i.type&&(globalSelectedGanttServices[i.id]&&(i.travelTo||i.travelFrom)?s+=" selectedEvent":globalSelectedGanttServices[i.id]?s+=" selectedEventNoTravel":i.id==scheduler._select_id&&(i.travelTo||i.travelFrom)?s+=" selectedEvent":i.id==scheduler._select_id&&(s+=" selectedEventNoTravel")),i.status&&(s+=" GanttCustomStatus_"+i.status.split(" ").join("")),s)},scheduler.templates.tooltip_text=function(e,t,i){var s;if(contextShown)return!1;var n="",r=getLocationdIdByResource(i.resourceId),a=utils.getLocationOffset(e,r)-utils.getUserOffset(e),o=new Date(i.start);o.setMinutes(o.getMinutes()+a);var c=new Date(i.finish);c.setMinutes(c.getMinutes()+a);var l=0,u=0;if(n+='<div class="tooltipBody">',"contractorcapacity"==i.type)return s="fa-battery-empty",i.hoursPerTimePeriod>0?(l=i.hoursInUse/i.hoursPerTimePeriod*100,u=Math.floor(i.hoursInUse/i.hoursPerTimePeriod*100*100)/100):i.workItemsPerTimePeriod>0&&(l=i.workItemsAllocated/i.workItemsPerTimePeriod*100,u=Math.floor(i.workItemsAllocated/i.workItemsPerTimePeriod*100*100)/100),s=25>=l?"fa-battery-empty":50>=l?"fa-battery-quarter":75>=l?"fa-battery-half":90>=l?"fa-battery-three-quarters":"fa-battery-full",n+='<div class="tooltipLine"><b style="font-size:15px"><i class="fa '+s+'"></i> '+i.resourceName+"</b> ("+u+"%)</div>",i.workItemsPerTimePeriod&&(n+='<div class="tooltipLine">'+customLabels.NumServicesScheduled.replaceAll(i.workItemsAllocated,i.workItemsPerTimePeriod)+"</div>"),i.hoursPerTimePeriod&&(n+='<div class="tooltipLine">'+customLabels.NumHoursScheduled.replace("{0}",i.hoursInUse).replace("{1}",i.hoursPerTimePeriod)+"</div>"),n+='<div class="tooltipHR"></div>',n+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Start+"</span> "+moment(i.start_date).format("llll")+"</div>",n+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Finish+"</span> "+moment(i.end_date).format("llll")+"</div>",n+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Duration_Type+"</span> "+i.timePeriod+"</div>",i.workItemsAllocated>0&&(n+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.NumberOfServices+"</span> "+i.workItemsAllocated+"</div>"),n+="</div>";if("service"!=i.type)return s=absenceTypeIcon(i.type),n+=i.ganttLabel?'<div class="tooltipLine"><b>'+s+'<span class="tooltipName">'+i.ganttLabel+"</span> </b> </div>":'<div class="tooltipLine"><b>'+s+'<span class="tooltipName">'+i.name+"</span> </b> </div>",n+='<div class="tooltipHR"></div>',n+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Start+"</span> "+moment(i.start).format("llll")+"</div>",n+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Finish+"</span> "+moment(i.finish).format("llll")+"</div>",a&&!useLocationTimezone&&(n+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Resource_start+"</span> "+moment(o).format("llll")+"</div>",n+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Resource_finish+"</span> "+moment(c).format("llll")+"</div>"),i.travelTo&&(n+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(i.travelTo/60)+"</div>"),i.travelFrom&&(n+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(i.travelFrom/60)+"</div>"),(i.reason||i.comment)&&(n+='<div class="tooltipHR"></div>'),i.reason&&(n+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Reason+"</span> "+i.reason+"</div>"),n+="</div>";var d='<svg aria-hidden="true" class="slds-icon tooltipJeopardyIcon">\n                                <use xlink:href="'+lsdIcons.jeopardy+'"></use>\n                            </svg>',v='<svg aria-hidden="true" class="slds-icon tooltipMDTIcon">\n                                <use xlink:href="'+lsdIcons.clock+'"></use>\n                            </svg>',p='<svg aria-hidden="true" class="slds-icon tooltipMDTArrowIcon">\n                                <use xlink:href="'+lsdIcons.forward+'"></use>\n                            </svg>',g='<svg aria-hidden="true" class="slds-icon tooltipMDTArrowIcon">\n                                <use xlink:href="'+lsdIcons.emergency+'"></use>\n                            </svg>',h="";i.ganttColor&&(h='style="background:'+i.ganttColor+'"'),n+=i.ganttLabel?'<div class="tooltipLine"><div '+h+' class="tooltipStatus '+getClassByStatus(i.statusCategory)+'"></div><b style="font-size:15px">'+i.name+" / "+i.ganttLabel+"</b> ("+statusTranslations[i.status]+")</div>":'<div class="tooltipLine"><div '+h+' class="tooltipStatus '+getClassByStatus(i.statusCategory)+'"></div><b style="font-size:15px">'+i.name+"</b> ("+statusTranslations[i.status]+")</div>",i.jeopardy&&i.jeopardyReason&&(n+='<div class="tooltipJeopardy">'+d+"<span>"+customLabels.JeopardyTooltip+" "+i.jeopardyReason+"</span></div>"),i.emergency?n+='<div class="tooltipJEmergency">'+g+"<span>"+customLabels.ScheduledWithEmergency+"</span></div>":i.jeopardy&&(n+='<div class="tooltipJeopardy">'+d+"<span>"+customLabels.JeopardyTooltipLong+"</span></div>"),i.pinned&&(n+='<div class="tooltipLine tooltipPinned"><i>'+customLabels.Pinned_Tooltip+"</i></div>");var m=GanttService.prototype.allFieldSets.GanttToolTip;if(m)for(var f=0;f<m.length;f++){var S=i[m[f].APIName];"Status"===m[f].APIName?S=statusTranslations[i.status]:"DATETIME"==m[f].Type&&S?S=moment(S).format("llll"):"DATE"==m[f].Type&&S&&(S=moment(S).format("L")),S&&(n+='<div class="tooltipLine"><b>'+m[f].Label+": </b> "+S+"</div>")}if(n+='<div class="tooltipHR"></div>',n+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Start+"</span> "+moment(i.start).format("llll")+"</div>",n+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Finish+"</span> "+moment(i.finish).format("llll")+"</div>",!a&&!alwaysShowLocalTimeTooltip||useLocationTimezone||(n+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Resource_start+"</span> "+moment(o).format("llll")+"</div>",n+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Resource_finish+"</span> "+moment(c).format("llll")+"</div>"),i.hiddenTravelTo?n+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(i.hiddenTravelTo.hiddenTravel/60)+"</div>":i.travelTo&&(n+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(i.travelTo/60)+"</div>"),
i.hiddenTravelFrom?n+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(i.hiddenTravelFrom.hiddenTravel/60)+"</div>":i.travelFrom&&(n+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(i.travelFrom/60)+"</div>"),i.tooltipText&&(n+='<div class="tooltipHR"></div>',n+='<div class="tooltipLine tooltipTitle">'+customLabels.Custom_Tooltip_Field+'</div><div class="tooltipLine">'+i.tooltipText+"</div>"),n+="</div>",(i.hiddenTravelTo||i.hiddenTravelFrom||i.isMDT)&&(n+='<div class="tooltipTravel">',(i.hiddenTravelTo||i.hiddenTravelFrom)&&(n+='<div class="tooltipLine tooltipTitle"><i class="fa fa-car"></i>'+customLabels.Travel_time+"</div><div>",n+=customLabels.Travel_time_too_long.replace("{0}",maxTravelTimeInSeconds/60/60)+'<div class="travelExplain">'+customLabels.To_change_maximum_travel_hours+"</div>",n+="</div>"),i.isMDT&&(n+='<div class="tooltipLine tooltipTitle">'+v+p+customLabels.Multi_Day_Service+"</div><div>",n+=customLabels.This_service_spans_across_more_than_one_day,n+="</div>"),n+="</div>"),i.violations){n+='<div class="tooltipViolation">',n+='<div class="tooltipLine tooltipTitle"><i class="fa fa-warning"></i>'+customLabels.Rule_violations_Tooltip+"</div><div>";for(var f=0;f<i.violations.length;f++)-1!=i.violations[f].ViolationString.indexOf(violationDelimiter)?(n+=i.violations[f].RuleName+" - ",n+=i.violations[f].ViolationString.substring(0,i.violations[f].ViolationString.indexOf(violationDelimiter))+"<br/>",n+=i.violations[f].ViolationString.substring(i.violations[f].ViolationString.indexOf(violationDelimiter)+violationDelimiter.length)+"<br/>"):n+=i.violations[f].RuleName+" - "+i.violations[f].ViolationString+"<br/>";n+="</div>"}return n};var r=!1;return dhtmlxEvent(scheduler._obj,"mouseleave",function(e){scheduler.getState().drag_id&&(r=!0,scheduler._on_mouse_up(e),cachedDomElements.timesDragFix.hide(),window.getSelection().removeAllRanges())}),scheduler.attachEvent("onBeforeEventChanged",function(){return r?(r=!1,!1):!0}),scheduler._hover=null,scheduler.attachEvent("onMouseMove",function(e,t){if(!e)return void(scheduler._hover&&($(".dhx_cal_event_line, .ServiceEvent").removeClass("hoverRelated"),scheduler._hover=null));if(scheduler._events[e].relatedTo||scheduler._events[e].relatedFather){var i=$(scheduler.getRenderedEvent(e)).find(".ServiceEvent"),s=null;if(0===i.length&&(i=$(scheduler.getRenderedEvent(e))),scheduler._events[e].relatedFather?(s=$(scheduler.getRenderedEvent(scheduler._events[e].relatedFather)).find(".ServiceEvent"),0===s.length&&(s=$(scheduler.getRenderedEvent(scheduler._events[e].relatedFather)))):(s=$(scheduler.getRenderedEvent(scheduler._events[e].relatedTo)).find(".ServiceEvent"),0===s.length&&(s=$(scheduler.getRenderedEvent(scheduler._events[e].relatedTo)))),scheduler._hover=e,i&&s){if($(i).hasClass("hoverRelated"))return;$(i).addClass("hoverRelated"),$(s).addClass("hoverRelated")}}}),scheduler.templates.ZoomLevel2_scale_date=function(e){var t=e.getHours(),i=e.getMinutes()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getMinutes()):formatNumberToLocaleString(e.getMinutes());return isAMPM?0===t?formatNumberToLocaleString(12)+":"+i+" AM":12===t?formatNumberToLocaleString(12)+":"+i+" PM":t>12?formatNumberToLocaleString(t-12)+":"+i+" PM":formatNumberToLocaleString(t)+":"+i+" AM":formatNumberToLocaleString(t)+":"+i},scheduler.templates.ZoomLevel3_scale_date=function(e){var t=e.getHours(),i=e.getMinutes()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getMinutes()):formatNumberToLocaleString(e.getMinutes());return isAMPM?0===t?formatNumberToLocaleString(12)+" AM":12==t?formatNumberToLocaleString(12)+" PM":t>12?formatNumberToLocaleString(t-12)+" PM":formatNumberToLocaleString(t)+" AM":(e.getHours()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getHours()):formatNumberToLocaleString(e.getHours()))+":"+i},scheduler.templates.ZoomLevel4_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel5_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel6_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel4_cell_class=function(e,t,i){return!i.children&&shouldSeparateCell(t)?"BorderForDayChange":""},scheduler.templates.ZoomLevel2_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel5_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel6_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.filter_ZoomLevel1=n,scheduler.filter_ZoomLevel2=n,scheduler.filter_ZoomLevel3=n,scheduler.filter_ZoomLevel4=n,scheduler.filter_ZoomLevel5=n,scheduler.filter_ZoomLevel6=n,scheduler.filter_MonthlyView=function(e,t){return"contractorcapacity"===t.type},scheduler.filter_MTDView=function(e,t){return"contractorcapacity"===t.type||t.isMDT},scheduler.ignore_ZoomLevel3=e,scheduler.ignore_ZoomLevel4=e,scheduler.ignore_ZoomLevel5=e,scheduler.ignore_ZoomLevel6=e,scheduler.ignore_MonthlyView=function(e){return t(e)},scheduler.ignore_MTDView=scheduler.ignore_MonthlyView,{isDateInsideWeekend:t}}function shouldSeparateCell(e){var t=getMinAndMaxHoursToDisplay();switch(scheduler._mode){case"ZoomLevel4":t.max-=2;break;case"ZoomLevel5":t.max-=4;break;case"ZoomLevel6":t.max-=6}if("ZoomLevel2"===scheduler._mode&&23===e.getHours()&&30===e.getMinutes())return!0;if(e.getHours()==t.max){var i=new Date(e);if(i.setHours(i.getHours()+24),i<=scheduler._max_date)return!0}return!1}function getXPositionOfEvent(e,t,i){var s=0,n=i._step,r=i.round_position,a=0,o=t?e.end_date:e.start_date;o.valueOf()>scheduler._max_date.valueOf()&&(o=scheduler._max_date);var c=o-scheduler._min_date_timeline;if(c>0){var l=scheduler._get_date_index(i,o);scheduler._ignores[l]&&(r=!0);for(var u=0;l>u;u++)s+=scheduler._cols[u];var d=scheduler.date.add(scheduler._min_date_timeline,scheduler.matrix[scheduler._mode].x_step*l,scheduler.matrix[scheduler._mode].x_unit);r?+o>+d&&t&&(a=scheduler._cols[l]):(c=o-d,i.first_hour||i.last_hour?(c-=i._start_correction,0>c&&(c=0),a=Math.round(c/n),a>scheduler._cols[l]&&(a=scheduler._cols[l])):a=Math.round(c/n))}return s+=t?0===c||r?a-14:a-12:a+1}function getResourceEventsIds(e,t,i){var s=[];for(var n in scheduler._events)"service"==scheduler._events[n].type&&scheduler._events[n].start_date>=e&&scheduler._events[n].end_date<=t&&scheduler._events[n].resourceId==i&&(s.push(n),scheduler._events[n].relatedTo&&s.push(scheduler._events[n].relatedTo),scheduler._events[n].relatedFather&&s.push(scheduler._events[n].relatedFather));return s}function getEventIdsOfResources(e){var t=[];for(var i in scheduler._events)"service"==scheduler._events[i].type&&e.indexOf(scheduler._events[i].resourceId)>-1&&(t.push(i),scheduler._events[i].relatedTo&&t.push(scheduler._events[i].relatedTo),scheduler._events[i].relatedFather&&t.push(scheduler._events[i].relatedFather));return t}function getEventIdsOfLocation(e,t,i){var s=[];for(var n in scheduler._events)"service"==scheduler._events[n].type&&scheduler._events[n].start_date>=e&&scheduler._events[n].end_date<=t&&i.indexOf(scheduler._events[n].location)>-1&&s.push(n);return s}function setCapacityFilter(e,t){contractorSupport&&(capacityDurationFilter=e,t&&scheduler._is_initialized()&&scheduler.updateView())}function cantLoadGantt(e){$(".keypressEvents")&&($(".bodyDiv").css("background","#fff"),$(".keypressEvents").remove(),$("#ErrorLoadingGantt").show()),$("#ErrorContainer").append(e)}function getLocationdIdByResource(e){for(var t=scheduler.serverList("resources"),i=0;i<t.length;i++)for(var s=0;s<t[i].children.length;s++)if(e.split(",")[0]==t[i].children[s].key)return t[i].key;return null}function absenceTypeIcon(e){return"break"==e?'<svg aria-hidden="true" class="slds-icon tooltipBreakIcon">\n                    <use xlink:href="'+lsdIcons["break"]+'"></use>\n                </svg>':'<svg aria-hidden="true" class="slds-icon tooltipNAIcon">\n                <use xlink:href="'+lsdIcons.na+'"></use>\n            </svg>'}function getClassByStatus(e){switch(e){case globalCategories.NONE:return"eventStatusNew";case globalCategories.SCHEDULED:return"eventStatusAssigned";case globalCategories.DISPATCHED:return"eventStatusDispatched";case globalCategories.IN_PROGRESS:return"eventStatusTravel";case globalCategories.RUNNING_LONG:return"eventStatusOnSite";case globalCategories.COMPLETED:return"eventStatusCompleted";case globalCategories.MISSED:return"eventStatusIncomplete";case globalCategories.COULD_NOT_COMPLETE:return"eventStatusCouldntComplete";case globalCategories.CANCELED:return"eventStatusCancelled";default:return"eventCustomStatus"}}function getMinAndMaxHoursToDisplay(){var e=scheduler.getState().mode,t=minHourToDisplay,i=maxHourToDisplay,s=null;switch(e){case"ZoomLevel4":s=2;break;case"ZoomLevel5":s=4;break;case"ZoomLevel6":s=6}if(null!==s){t-=t%s;var n=s-i%s;n!=s&&(i+=n)}return{min:t,max:i}}function isIntersect(e,t,i,s){return s>e&&t>i}function isIntersectIncludeLimits(e,t,i,s){return s>=e&&t>=i}function isMultipleIntersection(e,t){for(var i=0;i<t.length;i++)if(isIntersect(e.start,e.finish,t[i].start,t[i].finish))return!0;return!1}function generateGanttTextColor(e){var t=parseInt("0x888888",16),i=parseInt("0x"+e,16);return i>t?"000000":"ffffff"}function formatNumberToLocaleString(e){try{return e.toLocaleString(jsUserLocale)}catch(t){console.warn("Something wrong with your locale settings: "+jsUserLocale)}return e}function generateHoursMinutes(e){if(60>e)return customLabels.MinutesGanttTooltip.replace("$0",e);var t=e%60,i=Math.floor(e/60);return customLabels.MinutesHoursGanttTooltip.replace("$0",i).replace("$1",t)}function calculateColor(e){if(e instanceof GanttService){var t=e.start.getHours();switch(t){case 0:e.ganttColor="#e21818";break;case 1:e.ganttColor="#e24818";break;case 2:e.ganttColor="#e27c18";break;case 3:e.ganttColor="#e29418";break;case 4:e.ganttColor="#e29418";break;case 5:e.ganttColor="#e2ab18";break;case 6:e.ganttColor="#e2ab18";break;case 7:e.ganttColor="#e2ab18";break;case 8:e.ganttColor="#e8db0f";break;case 9:e.ganttColor="#fcff00";break;case 10:e.ganttColor="#d2ff00";break;case 11:e.ganttColor="#8aff00";break;case 12:e.ganttColor="#00ff72";break;case 13:e.ganttColor="#00ffa8";break;case 14:e.ganttColor="#00ffea";break;case 15:e.ganttColor="#00e4ff";break;case 16:e.ganttColor="#00aeff";break;case 17:e.ganttColor="#007eff";break;case 18:e.ganttColor="#005aff";break;case 19:e.ganttColor="#001eff";break;case 20:e.ganttColor="#4800ff";break;case 21:e.ganttColor="#b400ff";break;case 22:e.ganttColor="#f000ff";break;case 23:e.ganttColor="#ff00d2"}}}!function(){String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var i=this.toString();("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>i.length)&&(t=i.length),t-=e.length;var s=i.lastIndexOf(e,t);return-1!==s&&s===t})}(),function(){var e=angular.module("serviceExpert",["uiGmapgoogle-maps","angularMoment","ui.bootstrap","chart.js","MstResolver"]);e.run(["amMoment",function(e){e.changeLocale(userLocale)}]),e.config(["$sceDelegateProvider","$compileProvider","MstResolverProvider",function(e,t,i){debugMode||t.debugInfoEnabled(!1),i.setConfig({fslOperationRemoteAction:RemoteActions.getFslOperation,apiVersion:"41.0",fieldNames:fieldNames.FslOperation,autoConnect:!1}),e.resourceUrlWhitelist(["self","https://**.force.com"])}])}(),function(){angular.module("serviceExpert").controller("ctrlGantt",["$scope","$rootScope","$q","sfdcService","servicesService","utils","calendarsService","userSettingsManager","resourceFilterHelper","monthlyViewHelperService","ResourcesAndTerritoriesService","TimePhasedDataService","StateService","CapacityLightboxService","ResourceSmallMenu","AbsencesService","SkillsService","DeltaService","AbsenceLightboxService","ResourceLightboxService","ServiceAppointmentLightboxService","kpiCalculationsService","ResourceCapacitiesService","ResourceCrewsService","SERVICE_STATUS","SERVICE_CATEGORY","GetSlotsService","bulkScheduleService","GeneralLightbox","StreamingClientResolverService","StreamingAPIService","RegisterService",function(e,t,i,s,n,r,a,o,c,l,u,d,v,p,g,h,m,f,S,b,y,T,w,L,k,C,R,D,A,I,F,x){function M(){if(J)return void(J=!1);setHoursToDisplay(e.businessHoursRange.start,e.businessHoursRange.end,e.businessHoursRange.includeWeekends),scheduler.setCurrentView(),r.ganttSettings.startHour=e.businessHoursRange.start,r.ganttSettings.finishHour=e.businessHoursRange.end;var t={};t.Gantt_View_Start_Hour__c=r.ganttSettings.startHour,t.Gantt_View_Finish_Hour__c=r.ganttSettings.finishHour,t.Include_Weekends__c=e.businessHoursRange.includeWeekends,o.SetUserSettingProperties(t)}function O(e,t){if(""===t&&(t=prompt(customLabels.msg_to_post_to_chatter,"")),null!==t){if(""===t)return void alert(customLabels.no_empty_msg_to_chatter);1===e.length&&(n.recentlyUsed[e[0]]=!0),n.postToChatter(e,t).then(function(e){})}}function P(){for(var t in e.selectedGanttServices)delete e.selectedGanttServices[t]}function E(t){for(var i=!1,s=0;s<e.pinnedStatusesSF.length;s++)scheduler._events[t].status===e.pinnedStatusesSF[s]&&(i=!0);scheduler._events[t].pinned||i?(K.hideItem("reschedule"),K.hideItem("candidates"),K.hideItem("unschedule"),K.hideItem("status"),K.hideItem("reshuffle"),K.hideItem("groupNearby")):(K.showItem("reschedule"),K.showItem("candidates"),K.showItem("unschedule"),K.showItem("status"),K.showItem("reshuffle"),K.showItem("groupNearby")),scheduler._events[t].pinned?K.hideItem("status"):K.showItem("status"),scheduler._events[t].latitude&&scheduler._events[t].longitude&&r.hasCustomPermission("Group_Nearby")?K.showItem("groupNearby"):K.hideItem("groupNearby"),r.hasCustomPermission("Schedule")?K.showItem("reschedule"):K.hideItem("reschedule"),r.hasCustomPermission("Reshuffle")?K.showItem("reshuffle"):K.hideItem("reshuffle"),K.removeItem("showRelated"),(scheduler._events[t].isServiceInChain||scheduler._events[t].relatedTo||scheduler._events[t].relatedFather)&&K.addNewChild(K.topId,5,"showRelated",r.getSVGIconHTML(lsdIcons.related)+customLabels.Show_related,!1),v.isMapEnabled()&&null!==scheduler._events[t].latitude?K.showItem("map"):K.hideItem("map"),K.removeItem("flag"),n.flagged[t]?K.addNewChild(K.topId,1,"flag","<span class='emptyFlag'>"+r.getSVGIconHTML(lsdIcons.flag)+"</span> "+customLabels.Unflag,!1):K.addNewChild(K.topId,1,"flag","<span class='fullFlag'>"+r.getSVGIconHTML(lsdIcons.flag)+"</span> "+customLabels.Flag,!1),K.removeItem("pin"),scheduler._events[t].pinned?K.addNewChild(K.topId,9,"pin","<span class='emptyFlag'>"+r.getSVGIconHTML(lsdIcons.unpin)+"</span> "+customLabels.Unpin,!1):K.addNewChild(K.topId,9,"pin","<span class='fullFlag'>"+r.getSVGIconHTML(lsdIcons.pin)+"</span> "+customLabels.Pin,!1),K.removeItem("consoleTab"),e.isInConsole()&&K.addNewChild(K.topId,1,"consoleTab",r.getSVGIconHTML(lsdIcons.external)+customLabels.Open_Tab,!1)}function N(e){var t=void 0,i=0;if(_.isEmpty(r.statusFlow)){K.removeItem("status"),K.addNewChild(K.topId,5,"status",r.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1);for(var s in r.statuses)t="ContextMenu_"+r.statusTranslations[r.statuses[s]].split(" ").join(""),K.addNewChild("status",i,"status_change_"+i,"<span class='StatusColorChanger "+t+" "+r.getCSSClassForContext(r.statusTranslations[r.statuses[s]],k)+"'></span>"+r.statusTranslations[r.statuses[s]],!1),Y["status_change_"+i++]=r.statuses[s]}else{if(!(r.statusFlow[e]&&r.statusFlow[e].length>0))return void K.removeItem("status");for(K.removeItem("status"),K.addNewChild(K.topId,5,"status",r.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),Y={},i=0;i<r.statusFlow[e].length;i++)t="ContextMenu_"+r.statusFlow[e][i].split(" ").join(""),K.addNewChild("status",i,"status_change_"+i,"<span class='StatusColorChanger "+t+" "+r.getCSSClassForContext(r.statusFlow[e][i],k)+"'></span>"+r.statusTranslations[r.statusFlow[e][i]],!1),Y["status_change_"+i]=r.statusFlow[e][i]}}function B(t){for(var i in e.selectedGanttServices)e.selectedGanttServices[i]&&(n.flagged[i]=t);scheduler.updateView()}function H(){if(scheduler._is_initialized()&&e.datalessMethods){for(var t=0;t<e.nowTimespans.length;t++)scheduler.deleteMarkedTimespan(e.nowTimespans[t]);e.nowTimespans.length=0;var i=scheduler.serverList("resources"),s=getMinAndMaxHoursToDisplay();for(t=0;t<i.length;t++){var n=new Date,a=new Date(n.valueOf()+6e4*n.getTimezoneOffset());if(useLocationTimezone?a.setMinutes(a.getMinutes()+r.getLocationOffset(a,i[t].key)):a=r.convertDateBetweenTimeZones(a,"GMT",userTimeZone),s.min<=a.getHours()&&a.getHours()<s.max&&!e.datalessMethods.isDateInsideWeekend(a)&&"MonthlyView"!==scheduler._mode){var o={};o[scheduler.getState().mode]=[];for(var c=0;c<i[t].children.length;c++)o[scheduler.getState().mode].push(i[t].children[c].key);e.nowTimespans.push(scheduler.addMarkedTimespan({start_date:a,end_date:scheduler.date.add(a,1,"minute"),css:"dhx_now_time dhx_matrix_now_time",sections:o}))}}}}function G(e){if(!confirm(customLabels.are_you_sure_unschedule))return!0;var t=[],i=[];e.forEach(function(e){i.push(d.serviceAppointments()[e]),t.push(d.serviceAppointments()[e].resource),n.recentlyUsed[e]=!0}),n.unscheduleServices(e).then(function(e){n.drawServicesAndAbsences(e.services,e.absences),T.calculateKpis(),P()})["catch"](function(e){r.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})}function V(e,t){if(t===k.CANCELED&&!confirm(customLabels.AreYouSureYouWantToCancel))return!0;var i=[],s=[];e.forEach(function(e){s.push(d.serviceAppointments()[e]),i.push(d.serviceAppointments()[e].resource),n.recentlyUsed[e]=!0}),n.changeStatus(e,t).then(function(e){n.drawServicesAndAbsences(e.services),P()})["catch"](function(e){r.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})}function U(e){var t=(e.start_date.getMinutes()+e.travelTo/60)%60,i="na"===e.type?e.end-e.start:e.schedEndTime-e.schedStartTime,s=t%serviceJumpsOnGantt,n=serviceJumpsOnGantt-t%serviceJumpsOnGantt;0!==s&&(s>n?e.start_date=new Date(e.start_date.getTime()+60*n*1e3):e.start_date=new Date(e.start_date.getTime()-60*s*1e3),e.end_date=new Date(e.start_date.getTime()+i+1e3*e.travelFrom+1e3*e.travelTo),e.schedStartTime=e.start_date.getTime()+1e3*e.travelTo,e.schedEndTime=e.end_date.getTime()-1e3*e.travelFrom)}var j="",z="",q={},W=!0,K=new dhtmlXMenuObject({parent:"contextZone_A",context:!0}),Z=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});e.selectedGanttServices={},e.resourceFilterHelper=c,e.resources=[],e.searchEmployee="",e.resourceFieldToSortyBy="Name",e.successfullyScheduled=0,e.currentSchedulingIndex=0,e.ganttLocked=o.GetUserSettingsProperty("Lock_Gantt__c")||!1,e.timelineName="",e.nowTimespans=[],e.selectedSkills={},e.pinnedStatusesSF=CustomSettings.pinnedStatusesSF.split(","),e.hasCustomPermission=r.hasCustomPermission,e.crewViewActive=!1,e.crewsFilter=r.crewsFilter,e.useResourceSkillFilter=useResourceSkillFilter,t.statusTranslations=r.statusTranslations,t.$on("moveToCrewView",function(){e.crewViewActive=!0,d.isCrewViewActive=!0}),e.$watch("resourceFilterHelper",function(t,i){$("#resourceExplainCrap").html(e.resourceFilterHelper.generateFilterExplanation(e.resourceFilters.showWorkingResource)),angular.equals(t,i)||o.SetUserSettingsProperty("Resource_Filter__c",JSON.stringify({sortBy:e.resourceFilterHelper.resourceFieldToSortyBy,asc:e.resourceFilterHelper.descending,showWorkingResource:e.resourceFilters.showWorkingResource,booleanFields:e.resourceFilterHelper.selectionInfo.resourceFilteringOptions,picklistField:e.resourceFilterHelper.selectionInfo.selectedPicklist,picklistOptions:e.resourceFilterHelper.selectionInfo.picklistOptions,picklistOptionsModel:e.resourceFilterHelper.selectionInfo.picklistOptionsModel,picklistNullValues:e.resourceFilterHelper.selectionInfo.picklistNullValues,crewsOption:e.resourceFilterHelper.selectionInfo.crewsSelectionOptions.selectedPicklist}))},!0),h.getEmployeeAbsenceTypes().then(function(t){e.nonAvailabilityTypes=t,e.defaultDragNa={selectedNaDuration:JSON.parse(o.GetUserSettingsProperty("Drag_Na_Duration__c"))||60,selectedNaType:o.GetUserSettingsProperty("Drag_Na_Type__c")||e.nonAvailabilityTypes[Object.keys(e.nonAvailabilityTypes)[0]],selectedNaLabel:o.GetUserSettingsProperty("Drag_Na_Label__c")}}),e.businessHoursRange={start:r.ganttSettings.startHour,end:r.ganttSettings.finishHour,includeWeekends:o.GetUserSettingsProperty("Include_Weekends__c")},e.resourceFilters={showWorkingResource:JSON.parse(o.GetUserSettingsProperty("Resource_Filter__c"))?JSON.parse(o.GetUserSettingsProperty("Resource_Filter__c")).showWorkingResource:!1,resourcesWorkingInRange:{}},e.isInConsole=v.isInConsole,e.openConsoleTab=r.openConsoleTab,e.capacityFields=l.capacityCalculationFields,Object.defineProperty(e.selectedGanttServices,"getSelected",{enumrable:!1,value:function(){var e=[];for(var t in this)this[t]&&e.push(t);return e}}),e.isGanttFilterApplied=function(){return r.crewsFilter||e.skillsFilter||c.isResourceFilterApplied()||e.resourceFilters.showWorkingResource},cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix"));var J=!0;e.$watchCollection("businessHoursRange",M),u.promises.resources().then(function(){e.resources=u.getResources}),e.saveDragNaDefaults=function(t){switch(t){case"duration":o.SetUserSettingsProperty("Drag_Na_Duration__c",e.defaultDragNa.selectedNaDuration);break;case"type":o.SetUserSettingsProperty("Drag_Na_Type__c",e.defaultDragNa.selectedNaType);break;case"label":o.SetUserSettingsProperty("Drag_Na_Label__c",e.defaultDragNa.selectedNaLabel)}},e.getTimePhasedObjects=function(e){var i=scheduler.getState().min_date,s=scheduler.getState().max_date;return"undefined"!=typeof e&&("left"==e?(s.setDate(i.getDate()+1),i.setDate(i.getDate()-1)):"right"==e&&(i.setDate(s.getDate()-1),s.setDate(s.getDate()+1))),d.getTimePhasedObjects(i,s).then(function(e){if(t.$broadcast("ganttFinishedLoadingServices"),W){W=!1,scheduler.updateView();var i=null;document.URL.indexOf("service=")>-1&&(i=document.URL.substr(document.URL.indexOf("service=")+8,18)),scheduler._events[i]?(scheduler._select_id=i,scheduler.select(i),setTimeout(function(){r.showOnGantt(i)},0)):i&&alert(customLabels.cant_display_service)}})},e.changeDatesByArrows=function(t){e.getTimePhasedObjects(t)},scheduler.attachEvent("onDblClick",function(t,i){r.safeApply(e,function(){"service"===scheduler.getEvent(t).type?(n.recentlyUsed[t]=!0,y.open(t)):"contractorcapacity"===scheduler.getEvent(t).type?p.open(t):S.open(t)})}),scheduler.attachEvent("onBeforeFolderToggle",function(t,i,s){return r.safeApply(e,function(){v.ganttOpenedTerritories[t.key]=i}),!0}),scheduler.attachEvent("onViewChange",function(t,i){r.safeApply(e,function(){switch(scheduler._mode){case"ZoomLevel2":e.timelineName=customLabels.In_Day;break;case"ZoomLevel3":e.timelineName=customLabels.Daily;break;case"ZoomLevel4":e.timelineName=customLabels.X2_Days;break;case"ZoomLevel5":e.timelineName=customLabels.X3_Days;break;case"ZoomLevel6":e.timelineName=customLabels.Weekly;break;case"MonthlyView":e.timelineName=customLabels.Utilization;break;case"MTDView":e.timelineName=customLabels.MDTVIEW}$("#MonthlyLocationViewTooltip").remove(),H(),scheduler.updateView(),T.calculateKpis()})}),scheduler.attachEvent("onBeforeDrag",function(t,i,s){var n,r=s.ctrlKey||s.metaKey;if(!t||"create"==i){if(!r)for(n in e.selectedGanttServices)e.selectedGanttServices[n]=!1,scheduler.getRenderedEvent(n)&&scheduler.updateEvent(n);return!1}if(t&&"service"===scheduler.getEvent(t).type){if(r)return Z.hide(),e.selectedGanttServices[t]?(e.selectedGanttServices[t]=!1,scheduler.updateEvent(t)):(e.selectedGanttServices[t]=!0,scheduler.updateEvent(t)),!1;e.selectedGanttServices[t]=!0;for(n in e.selectedGanttServices)n!=t&&(e.selectedGanttServices[n]=!1,scheduler.getEvent(n)&&scheduler.getSection(scheduler.getEvent(n).resourceId)&&scheduler.updateEvent(n))}else if(!r&&e.selectedGanttServices.getSelected().length>=1)for(n in e.selectedGanttServices)e.selectedGanttServices[n]=!1,scheduler.getRenderedEvent(n)&&scheduler.updateEvent(n);if(!("service"!=scheduler.getEvent(t).type&&"na"!=scheduler.getEvent(t).type||t&&"service"==scheduler.getEvent(t).type&&scheduler.getEvent(t).pinned&&preventUpdateOfPinned))return!0}),e.$watchCollection("selectedGanttServices",function(t,i){globalSelectedGanttServices=e.selectedGanttServices}),e.jumpToDate=function(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"JumpToDate",date:scheduler._date,navigation:!0,handler:function(t,i){scheduler.setCurrentView(t),scheduler.destroyCalendar(),e.changeDatesByArrows()}})};var X=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});X.addNewChild(X.topId,0,"details",r.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),X.attachEvent("onClick",function(t,i,s){switch(t){case"details":r.safeApply(e,function(){S.open(z)});break;case"delete":r.safeApply(e,function(){confirm(customLabels.naDeleteConfirm)&&h.deleteAbsence(z).then(function(e){e?scheduler.deleteEvent(z):alert(customLabels.Failed_To_Delete_Break)})})}}),function(){K.addNewChild(K.topId,0,"details",r.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),K.addNewChild(K.topId,3,"reschedule",r.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),K.addNewChild(K.topId,4,"candidates",r.getSVGIconHTML(lsdIcons.candidates)+customLabels.Get_Candidates,!1),K.addNewChild(K.topId,10,"reshuffle",r.getSVGIconHTML(lsdIcons.retweet)+customLabels.Reshuffle,!1),K.addNewChild(K.topId,11,"groupNearby",r.getSVGIconHTML(lsdIcons.groupNearby)+customLabels.GroupNearby,!1),K.addNewChild(K.topId,5,"status",r.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),K.addNewChild(K.topId,6,"map",r.getSVGIconHTML(lsdIcons.world)+customLabels.Map,!1),K.addNewChild(K.topId,8,"unschedule",r.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),fieldTrackingEnabled.service&&(K.addNewChild(K.topId,7,"chatter",r.getSVGIconHTML(lsdIcons.chat)+customLabels.Chatter+"<i id='chatterArrowContext' class='fa fa-caret-right chatter-carret'></i>",!1),K.addNewChild("chatter",0,"chatter_welldone",r.getSVGIconHTML(lsdIcons.like)+customLabels.well_done,!1),K.addNewChild("chatter",1,"chatter_hurryup",r.getSVGIconHTML(lsdIcons.hurry)+customLabels.Hurry_up,!1),K.addNewChild("chatter",2,"chatter_requestupdate",r.getSVGIconHTML(lsdIcons.help)+customLabels.Request_update,!1),K.addNewChild("chatter",3,"chatter_custom",r.getSVGIconHTML(lsdIcons.threedots)+customLabels.Custom_message,!1))}();var Y={};scheduler.attachEvent("onContextMenu",function(t,i){if(scheduler.config.readonly)return!0;if(t&&"service"!=scheduler.getEvent(t).type&&"break"!=scheduler.getEvent(t).type&&"na"!=scheduler.getEvent(t).type)return!1;if(t){scheduler.dhtmlXTooltip.hide();var s=0,n=0;if(i.pageX||i.pageY?(s=i.pageX,n=i.pageY):(i.clientX||i.clientY)&&(s=i.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,n=i.clientY+document.body.scrollTop+document.documentElement.scrollTop),e.selectedGanttServices.getSelected().length<2)return"break"==scheduler._events[t].type?(X.removeItem("delete"),X.showContextMenu(s,n),z=t,!1):"na"==scheduler._events[t].type?(X.removeItem("delete"),X.addNewChild(X.topId,1,"delete",r.getSVGIconHTML(lsdIcons["delete"])+customLabels.Delete,!1),X.showContextMenu(s,n),z=t,!1):(E(t),scheduler.getEvent(t).pinned||N(scheduler.getEvent(t).status),K.showContextMenu(s,n),j=t,!1);Z.removeItem("selectedNumber"),Z.addNewChild(Z.topId,0,"selectedNumber","<i class='fa fa-check-square-o'></i> "+customLabels.x_services_selected.replaceAll(e.selectedGanttServices.getSelected().length),!0),Z.removeItem("status"),Z.addNewChild(Z.topId,4,"status",r.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),Y={};var a=0;for(var o in r.statuses){var c="ContextMenu_"+r.statusTranslations[r.statuses[o]].split(" ").join("");Z.addNewChild("status",a,"status_change_"+a,"<span class='StatusColorChanger "+c+" "+r.getCSSClassForContext(r.statusTranslations[r.statuses[o]],k)+"'></span>"+r.statusTranslations[r.statuses[o]],!1),Y["status_change_"+a++]=r.statuses[o]}return Z.showContextMenu(s,n),!1}return j="",z="",!0}),K.attachEvent("onShow",function(e){contextShown=!0}),K.attachEvent("onHide",function(e){contextShown=!1}),X.attachEvent("onShow",function(e){contextShown=!0}),X.attachEvent("onHide",function(e){contextShown=!1}),K.attachEvent("onClick",function(t,i,a){e.$evalAsync(function(){switch(t){case"details":r.safeApply(e,function(){y.open(j)});break;case"consoleTab":e.openConsoleTab(null,j);break;case"flag":e.$evalAsync(function(){n.flagged[j]=!n.flagged[j],scheduler.updateEvent(j)});break;case"pin":n.changePin([scheduler._events[j].id],!scheduler._events[j].pinned).then(function(){return scheduler.updateView()});break;case"reschedule":e.$evalAsync(function(){n.autoScheduleService(j).then(function(e){0===e.services.length&&alert(customLabels.NoCandidates),n.drawServicesAndAbsences(e.services,e.absences)})["catch"](function(e){var t=d.serviceAppointments()[j].name;r.addNotification(t+" - "+customLabels.Action_Could_Not_Be_Performed,e.message,function(){y.open(j)})})});break;case"reshuffle":e.$evalAsync(function(){s.runReshuffle(j,v.selectedPolicyId).then(function(e){f.updateOptimizationRequest(e)},function(){r.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message)})});break;case"groupNearby":e.$evalAsync(function(){s.runGroupNearby(j,v.selectedPolicyId).then(function(e){f.updateOptimizationRequest(e)},function(){r.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message)})});break;case"candidates":R.get(j);break;case"chatter_welldone":O([j],customLabels.Well_done_mate);break;case"chatter_hurryup":O([j],customLabels.hurry_up_with_this_service);break;case"chatter_requestupdate":O([j],customLabels.please_update_service);break;case"chatter_custom":O([j],"");break;case"unschedule":e.$evalAsync(function(){G([j])});break;case"map":e.showOnMap(j);break;case"showRelated":if(usingNewMstModel)return void A.open("Related Services For "+scheduler._events[j].name,mstPage+"?ingantt=true&id="+j);if(scheduler._events[scheduler._events[j].relatedFather])return void r.showOnGantt(scheduler._events[j].relatedFather);if(scheduler._events[scheduler._events[j].relatedTo])return void r.showOnGantt(scheduler._events[j].relatedTo);scheduler._events[j].relatedFather?alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[j].relatedFather].name)):alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[j].relatedTo].name));break;default:e.$evalAsync(function(){V([j],Y[t])})}})}),$(".dhtmlxMenu_dhx_skyblue_SubLevelArea_Polygon").mouseover(function(){scheduler.dhtmlXTooltip.hide()}),Z.addNewChild(Z.topId,1,"flag",r.getSVGIconHTML(lsdIcons.flag)+customLabels.Flag,!1),Z.addNewChild(Z.topId,2,"unflag","<span class='emptyFlag'>"+r.getSVGIconHTML(lsdIcons.flag)+"</span>"+customLabels.Unflag,!1),Z.addNewChild(Z.topId,3,"reschedule",r.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),Z.addNewChild(Z.topId,5,"unschedule",r.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),Z.addNewChild(Z.topId,7,"pin",r.getSVGIconHTML(lsdIcons.pin)+customLabels.Pin,!1),Z.addNewChild(Z.topId,8,"unpin","<span class='emptyFlag'>"+r.getSVGIconHTML(lsdIcons.unpin)+"</span>"+customLabels.Unpin,!1),Z.attachEvent("onShow",function(e){contextShown=!0}),Z.attachEvent("onHide",function(e){contextShown=!1}),Z.attachEvent("onClick",function(t,i,s){e.$evalAsync(function(){switch(t){case"flag":r.safeApply(e,function(){B(!0)});break;case"unflag":r.safeApply(e,function(){
B(!1)});break;case"reschedule":D.schedule(e.selectedGanttServices.getSelected());break;case"pin":n.changePin(e.selectedGanttServices.getSelected(),!0).then(function(){return scheduler.updateView()});break;case"unpin":n.changePin(e.selectedGanttServices.getSelected(),!1).then(function(){return scheduler.updateView()});break;case"unschedule":G(e.selectedGanttServices.getSelected());break;default:V(e.selectedGanttServices.getSelected(),Y[t])}})}),e.lockGanttToggle=function(){scheduler.config.readonly=!scheduler.config.readonly,e.ganttLocked=scheduler.config.readonly,o.SetUserSettingsProperty("Lock_Gantt__c",e.ganttLocked)},e.unSelecteAllSkills=function(){for(var t in e.selectedSkills)e.selectedSkills[t]=!1},e.selectAllSkills=function(){for(var t in e.selectedSkills)e.selectedSkills[t]=!0},m.promises.skills().then(function(t){e.skills=t}),scheduler.attachEvent("onYScaleClick",function(e,t,i){for(var s=["resourceMenuBtn","resourceMenuIcon"],n=0;n<s.length;n++)if(i.target.classList&&i.target.classList.contains(s[n])||i.target.parentNode&&i.target.parentNode.classList.contains(s[n]))return void g.open(t.resourceId,t.key,i.target);t.children||b.open(t.resourceId,t.key)}),e.$on("keypress",function(t,i){if($("#MonthlyViewTooltip").remove(),!v.isLightboxOpened()&&!$("*:focus").is("textarea, input"))switch(i.which){case 13:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(n.recentlyUsed[scheduler._selected_id]=!0,y.open(scheduler._select_id));break;case 37:$(".dhx_cal_prev_button").click();break;case 38:var s=$(".dhx_cal_data").scrollTop();$(".dhx_cal_data").scrollTop(s-30);break;case 39:$(".dhx_cal_next_button").click();break;case 40:s=$(".dhx_cal_data").scrollTop(),$(".dhx_cal_data").scrollTop(s+30);break;case 87:""!==scheduler._select_id&&scheduler._select_id&&"service"==scheduler.getEvent(scheduler._select_id).type&&scheduler.getEvent(scheduler._select_id).parentRecord&&(e.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._events[scheduler._select_id].parentRecord],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):r.openLightningPrimaryTab(scheduler._events[scheduler._select_id].parentRecord)}):window.open("../"+scheduler._events[scheduler._select_id].parentRecord));break;case 83:""!==scheduler._select_id&&scheduler._select_id&&"service"==scheduler.getEvent(scheduler._select_id).type&&(e.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._select_id],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):r.openLightningPrimaryTab(scheduler._select_id)}):window.open("../"+scheduler._select_id));break;case 84:e.jumpToToday();break;case 70:1===e.selectedGanttServices.getSelected().length&&""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(n.flagged[scheduler._select_id]?(n.flagged[scheduler._select_id]=!1,scheduler.updateEvent(scheduler._select_id)):(n.flagged[scheduler._select_id]=!0,scheduler.updateEvent(scheduler._select_id)));break;case 48:e.changeTimeline(0);break;case 96:e.changeTimeline(0);break;case 49:e.changeTimeline(1);break;case 97:e.changeTimeline(1);break;case 50:e.changeTimeline(2);break;case 98:e.changeTimeline(2);break;case 51:e.changeTimeline(3);break;case 99:e.changeTimeline(3);break;case 55:e.changeTimeline(7);break;case 77:r.hasCustomPermission("MDT_View")&&monthlyViewSettings.isMonthlyAvailable&&e.changeTimeline(35);break;case 85:r.hasCustomPermission("Monthly_Utilization")&&monthlyViewSettings.isMonthlyAvailable&&e.changeTimeline(30);break;case 103:e.changeTimeline(7)}}),e.changeTimeline=function(t){var i=scheduler._min_date,s=scheduler._max_date,n=void 0;switch(t){case 0:if(n="ZoomLevel2",n==scheduler._mode)return;e.timelineName=customLabels.In_Day;break;case 1:if(n="ZoomLevel3",n==scheduler._mode)return;e.timelineName=customLabels.Daily;break;case 2:if(n="ZoomLevel4",n==scheduler._mode)return;e.timelineName=customLabels.X2_Days;break;case 3:if(n="ZoomLevel5",n==scheduler._mode)return;e.timelineName=customLabels.X3_Days;break;case 7:if(n="ZoomLevel6",n==scheduler._mode)return;e.timelineName=customLabels.Weekly;break;case 30:if(n="MonthlyView",n==scheduler._mode)return;e.timelineName=customLabels.Utilization;break;case 35:if(n="MTDView",n==scheduler._mode)return;e.timelineName=customLabels.MDTVIEW}scheduler.setCurrentView(i,n),e.changeDatesByArrows(s)},setInterval(H,6e5),e.jumpToToday=function(){var t=new Date;t.setHours(0),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0),scheduler.setCurrentView(t),e.changeDatesByArrows()},t.$on("afterShowEvent",function(){setTimeout(function(){e.changeDatesByArrows(),H(),scheduler.updateView(),t.$broadcast("updateKpis")},800)}),e.showOnMap=function(i){t.$broadcast("showServiceOnMap",i),r.safeApply(e)},scheduler.attachEvent("onBeforeEventChanged",function(e,t,i,s){var r=void 0,a=void 0,o=void 0,c=void 0;if(n.handleSnap(e,t),e.resourceId===s.resourceId){if(r=e.start_date.getTime(),a=e.end_date.getTime(),o=s.start_date.getTime(),c=s.end_date.getTime(),Math.abs((r-o)/1e3/60)<minDragMinutes||Math.abs((a-c)/1e3/60)<minDragMinutes)return cachedDomElements.timesDragFix.hide(),!1}else if("na"===e.type)return!1;if(v.areContractorsSupported()&&"service"==e.type&&u.getResources()[e.getGanttResource()].isCapacityBased){for(var l in d.resourceCapacities()){var p=d.resourceCapacities()[l];if(p.resource==u.getResources()[e.getGanttResource()].id&&e.start.getTime()>=p.start_date.getTime()&&e.start.getTime()<=p.end_date.getTime())return e.resourceBeforeDrag=s.resourceId,e.eventBeforeDrag=s,U(e),!0}return cachedDomElements.timesDragFix.hide(),alert(customLabels.serviceCantBeAssignedWithoutCapacity),!1}return q=GanttService.copy(s),snapTo=t.ctrlKey,U(e),e.resourceBeforeDrag=s.resourceId,e.eventBeforeDrag=s,!0}),e.updateMonthlyKpi=function(){"MonthlyView"===scheduler._mode&&scheduler.updateView()},e.cancelCrewView=function(){e.crewViewActive=!1,d.isCrewViewActive=!1},t.$on("gotNewTimePhasedObjects",function(e,t){n.drawServicesAndAbsences(t.serviceAppointments,t.resourceAbsences,[],t.resourceCapacities),_.isEmpty(t.serviceAppointments)&&_.isEmpty(t.resourceAbsences)&&_.isEmpty(t.resourceCapacities)||n.checkRules(r.getServicesBetweenDates(t.start,t.finish)).then(function(){return scheduler.updateView()})}),s.isStreamingShouldBeActive().then(function(e){"true"==e?v.setStreamingActiveState(!0):(v.setStreamingActiveState(!1),"false"!==e&&r.addNotification(customLabels.GanttLiveRefreshNotSupported,e,null,null)),I.initStreaming()}),x.register("services",function(e){n.drawServicesAndAbsences(e.updated||[],[],e.deleted||[])}),x.register("absences",function(e){n.drawServicesAndAbsences([],e.updated||[],e.deleted||[])}),x.register("capacities",function(e){n.drawServicesAndAbsences([],[],e.deleted||[],e.updated||[])}),x.register("rules",function(e){n.checkRules(e).then(function(){return scheduler.updateView()})}),scheduler.attachEvent("onEventChanged",function(t,i){("service"===i.type||"na"===i.type)&&r.safeApply(e,function(){return"na"===i.type?void h.saveChangesToAbsence(q,i).then(function(e){n.drawServicesAndAbsences(e.services||[],e.absences||[])})["catch"](function(e){console.warn("Couldn't update absence"),e[0].error?r.addNotification(customLabels.Action_Could_Not_Be_Performed,e[0].error):r.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")}):void n.saveChangesToServiceAppointment(q,i).then(function(e){var t=[],i=[];e.absences.forEach(function(e){e.isScheduled()&&e.setGanttResource(d.resourcesAndTerritories(),r.generateResourceId),i.push(e)}),e.services.forEach(function(e){e.isScheduled()&&e.setGanttResource(d.resourcesAndTerritories(),r.generateResourceId),t.push(e)}),n.drawServicesAndAbsences(t,i)})["catch"](function(e){console.warn("Couldn't update service. "+e[2]),r.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message.substr(e[0].message.indexOf(",")+1)||customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")})})}),e.$on("GotSlotsEnded",function(){}),e.$on("JumpToDate",function(t,i){scheduler.setCurrentView(i),e.changeDatesByArrows()}),e.$on("GotSlots",function(t,i){var s=getMinAndMaxHoursToDisplay();(i.minDateOfCandidate.getHours()<s.min||i.minDateOfCandidate.getHours()>=s.max)&&confirm(customLabels.confirmChangeBusinessHours)&&(i.minDateOfCandidate.getHours()<s.min?e.businessHoursRange.start=i.minDateOfCandidate.getHours():e.businessHoursRange.end=24,M())})}])}(),function(){angular.module("serviceExpert").controller("mainController",["$scope","StateService",function(e,t){e.isOSX=t.isOSX,e.lang=t.lang}])}(),function(){angular.module("serviceExpert").controller("ctrlMap",["$scope","sfdcService","$rootScope","$q","userSettingsManager","servicesService","bulkScheduleService","$timeout","$filter","utils","ServiceAppointmentLightboxService","ResourceLightboxService","TimePhasedDataService","FieldSetFieldsService","ResourcesAndTerritoriesService","LastKnownPositionService","DeltaService","SERVICE_STATUS","SERVICE_CATEGORY","DRAWING_STATES","StreamingAPIService","RegisterService",function(e,t,i,s,n,r,a,o,c,l,u,d,v,p,g,h,m,f,S,b,y,T){function w(t){e.allMarkersArray=[],e.showResources&&I(),e.showServices&&x(),e.showLivePositions&&D(),e.showTerritories&&E(),C(t)}function L(t){var i=t.type;switch(e.serviceInfoWindow.show=!1,e.resourceInfoWindow.show=!1,e.territoryInfoWindow.show=!1,e.reportInfoWindow.show=!1,e.livePosInfoWindow.show=!1,e.currentMarker=t,i){case"service":e.serviceInfoWindow.show=!0,e.currentMarker.item=v.serviceAppointments()[t.id];break;case"lastKnownPosition":e.livePosInfoWindow.show=!0;break;case"resource":e.resourceInfoWindow.show=!0;break;case"territory":e.territoryInfoWindow.show=!0;break;case"report":e.reportFields=[],e.reportFields.push.apply(e.reportFields,t.item.otherProperties),e.reportInfoWindow.show=!0}o(function(){e.$apply(),l.setMapCloseButtonPosition()},0)}function k(){e.resourcesFilterList=[];var t=scheduler.getState().min_date,i=scheduler.getState().max_date,s=v.resourcesAndTerritories(),n=g.getResources();for(var r in n){var a=s[r],o=n[r];for(var c in a){var l=a[c];if(isIntersect(t,i,l.effectiveStartDate,l.effectiveEndDate)){e.resourcesFilterList.push({label:o.name,value:o.id});break}}}}function C(t){var i=maxReportMarkers;for(var s in e.reportsData){var n=e.reportsData[s];if(n.show){n.displayCount=0;for(var r=0;r<n.data.length;r++){var a=n.data[r];if(0==i){t&&(e.showTooManyReportsAlert=!0);break}var o=R(a,s+n.displayCount);o&&(n.displayCount++,i--)}}}}function R(t,i){if(t.latitude){var s=staticResources.report;"ServiceAppointment"===t.sObjectType?s=staticResources.service_png:void 0!==staticResources[t.sObjectType.toLowerCase().replace(/ /g,"_")]&&(s=staticResources[t.sObjectType.toLowerCase().replace(/ /g,"_")]);var n={id:i,icon:s,type:"report",coords:{latitude:t.latitude,longitude:t.longitude},item:t};return e.allMarkersArray.push(n),!0}}function D(){var e=scheduler.getState().min_date,t=scheduler.getState().max_date,i=v.resourcesAndTerritories(),s=h.lastKnownPositions();for(var n in s){var r=i[n];for(var a in r){var o=r[a];if(isIntersect(e,t,o.effectiveStartDate,o.effectiveEndDate)){A(s[n]);break}}}}function A(t){var i=g.getResources()[t.id];if(e.isEmpty(e.filteredResources)||e.filteredResources[i.id]){var s={id:t.id+"_position",icon:staticResources.livepos_png,type:"lastKnownPosition",resourceId:t.id,coords:{latitude:t.latitude,longitude:t.longitude},item:angular.extend(angular.copy(t),{resourceName:i.name})};s.item.lastModifiedDate=l.convertDateBetweenTimeZones(s.item.lastModifiedDate,"UTC",userTimeZone),e.allMarkersArray.push(s)}}function I(){var e=scheduler.getState().min_date,t=scheduler.getState().max_date,i=v.resourcesByPrimariesAndRelocations();for(var s in i){var n=i[s];for(var r in n){var a=n[r];isIntersect(e,t,a.effectiveStartDate,a.effectiveEndDate)&&F(a)}}}function F(t){if(t.latitude){var i=g.getResources()[t.serviceResource];if(i&&(e.isEmpty(e.filteredResources)||e.filteredResources[i.id])){var s={id:t.id,icon:staticResources.homebase_png,type:"resource",resourceId:i.id,serviceTerritory:t.serviceTerritory,coords:{latitude:t.latitude,longitude:t.longitude},item:angular.extend(angular.copy(t),{resourceName:i.name})};e.allMarkersArray.push(s)}}}function x(){for(var t=e.filteredServices.servicesArray,i=0;i<t.length;i++){var s=t[i];s.id!=e.currentShowOnMapServiceId&&P(s)}e.currentShowOnMapServiceId&&P(v.serviceAppointments()[e.currentShowOnMapServiceId])}function M(e,t){for(var i=new google.maps.LatLngBounds,s=0;s<e.length;s++){var n=t?e[s].coords.latitude:e[s].latitude,r=t?e[s].coords.longitude:e[s].longitude;if(n&&r){var a=new google.maps.LatLng(n,r);i.extend(a)}}return i}function O(){var t=new google.maps.LatLng(37.794024,-122.394837),i=e.filteredServices.servicesArray,s=M(i);s.isEmpty()&&(s=M(_.values(v.serviceAppointments()))),s.isEmpty()?e.map.setCenter(t):e.map.fitBounds(s)}function P(t){if(!t.latitude)return!1;if(!e.showServices)return!1;var i=t.getGanttResource();if(!(e.isEmpty(e.filteredResources)||null!=i&&e.filteredResources[i]))return!1;var s=staticResources.service_png;t.statusCategory==S.COMPLETED&&(s=staticResources.service_completed_png);var n={id:t.id,icon:s,type:"service",animation:2,coords:{latitude:t.latitude,longitude:t.longitude},item:t};e.allMarkersArray.push(n)}function E(){var t=g.territories;for(var i in t)t[i].latitude&&e.allMarkersArray.push({id:i,icon:staticResources.territory_map_icon,type:"territory",animation:2,coords:{latitude:t[i].latitude,longitude:t[i].longitude},item:t[i]})}function N(t,i){if(e.polygons[t])e.polygons[t].polygon.setVisible(i),V(t,i);else if(g.territories[t]||"NoTerritoryPolygon"==t){V(t);for(var s=e.myTreeView.getSubItems(t),n=0;n<s.length;n++)B(s[n],i)}G()}function B(t,i){i?e.myTreeView.checkItem(t):e.myTreeView.uncheckItem(t)}function H(){var e=n.GetUserSettingsProperty("Invisible_Polygons__c");return void 0==e?[]:JSON.parse(n.GetUserSettingsProperty("Invisible_Polygons__c"))}function G(){return n.SetUserSettingsProperty("Invisible_Polygons__c",JSON.stringify(e.InvisiblePolygons))}function V(t,i){for(var s=0;s<e.InvisiblePolygons.length;s++)if(e.InvisiblePolygons[s]==t)return void e.InvisiblePolygons.splice(s,1);i||e.InvisiblePolygons.push(t)}function U(t){if(t)for(var i=0;i<t.length;i++)t[i][fieldNames.Polygon.KML__c]&&(e.polygons[t[i].Id]=t[i])}function j(){function t(e){if(e.id&&e.parent){if(r[e.parent.id])return e.parent;var i={};return g.allTerritories[e.parent.id]&&(i={id:g.allTerritories[e.parent.id].id,parent:g.allTerritories[e.parent.id].parentTerritory?g.allTerritories[e.parent.id].parentTerritory:0}),t(i)}}var i=s.defer(),n=g.territories,r={},a=[],o=(l.getFilteredLocations(),{NoTerritoryPolygon:{id:"NoTerritoryPolygon"}});for(var c in e.polygons)r[c]={id:c,parent:e.polygons[c][fieldNames.Polygon.Service_Territory__c]?n[e.polygons[c][fieldNames.Polygon.Service_Territory__c]]:o.NoTerritoryPolygon,text:e.polygons[c].Name,icons:{file:"fa-square"},icon_color:e.polygons[c][fieldNames.Polygon.Color__c],checked:-1==e.InvisiblePolygons.indexOf(c)?1:0,items:[]};for(var u in n)r[u]={id:u,parent:g.territories[u].parentTerritory?g.territories[u].parentTerritory:0,text:g.territories[u].name,icons:{file:"fa-building-o"},checked:-1==e.InvisiblePolygons.indexOf(u)?1:0,items:[]};r.NoTerritoryPolygon={id:"NoTerritoryPolygon",parent:0,text:customLabels.Polygons_without_Service_Territory,icons:{file:"fa-building-o"},checked:-1==e.InvisiblePolygons.indexOf("NoTerritoryPolygon")?1:0,items:[]};for(var d in r){var v=r[d],p=t(v);0!==v.parent&&p?r[p.id].items.push(v):a.push(v)}return i.resolve(a),i.promise}function z(){if(e.geoXmlParser=new geoXML3.parser({map:e.map,suppressInfoWindows:!0,zoom:!1}),!e.isEmpty(e.polygons)){var t=0;try{for(var i in e.polygons){e.geoXmlParser.parseKmlString(e.polygons[i][fieldNames.Polygon.KML__c]);for(var s=0;s<e.geoXmlParser.docs[t].placemarks.length;s++)if(e.geoXmlParser.docs[t].placemarks[s].polygon){e.geoXmlParser.docs[t].placemarks[s].id=e.polygons[i].Id,e.geoXmlParser.docs[t].placemarks[s].polygon.id=e.polygons[i].Id,e.geoXmlParser.docs[t].placemarks[s].polygon.name=e.polygons[i].Name,e.geoXmlParser.docs[t].placemarks[s].polygon.territory=e.polygons[i][fieldNames.Polygon.Service_Territory__c];var n=-1==e.InvisiblePolygons.indexOf(i)?!0:!1;e.geoXmlParser.docs[t].placemarks[s].polygon.setVisible(n),e.geoXmlParser.docs[t].placemarks[s].polygon.addListener("click",function(){e.shouldBound=!1,pe.hide(),K(this)}),e.geoXmlParser.docs[t].placemarks[s].polygon.addListener("rightclick",re),e.polygons[i].polygon=e.geoXmlParser.docs[t].placemarks[s].polygon}t++}}catch(r){alert("Problem parsing KML string"),console.error(r)}}}function q(){google.maps.event.addListener(e.drawingManager,"overlaycomplete",function(t){var i=t.overlay;return e.cancelDrawingShape?(e.cancelDrawingShape=!1,void i.setMap(null)):(i.type=t.type,i.set("fillColor",e.selectedColor),i.set("name",e.polygonName),i.set("territory",e.polygonTerritory),e.drawingManager.setDrawingMode(null),google.maps.event.addListener(i,"click",function(e){if(void 0!==e.vertex&&i.type===google.maps.drawing.OverlayType.POLYGON){var t=i.getPaths().getAt(e.path);t.removeAt(e.vertex),t.length<3&&i.setMap(null)}K(i)}),void K(i))}),"function"!=typeof google.maps.Polygon.prototype.ToWKT&&(google.maps.Polygon.prototype.ToWKT=function(){for(var e=this,t="POLYGON(",i=e.getPaths(),s=0;s<i.getLength();s++){var n=i.getAt(s);t+="(";for(var r=0;r<n.getLength();r++)t+=n.getAt(r).lng().toString()+" "+n.getAt(r).lat().toString()+",";t+=n.getAt(0).lng().toString()+" "+n.getAt(0).lat().toString()+"),"}return t=t.substring(0,t.length-1)+")"})}function W(){e.selectedShape&&("marker"!==e.selectedShape.type&&e.selectedShape.setEditable(!1),e.selectedShape.set("strokeWeight",1),e.selectedShape=null,e.currentEditPolygon=null,e.polygonName="",e.polygonTerritory="null"),e.drawState=e.drawState==b.DRAW?b.EDIT:b.NONE}function K(t){if(this&&(t=this),e.drawState==b.INTERSECT){if(e.currentIntersectingId==t.id)return;return e.selectedIntersectingPolygons[t.id]?delete e.selectedIntersectingPolygons[t.id]:e.selectedIntersectingPolygons[t.id]=!0,void e.$apply()}"marker"!==t.type&&(W(),e.selectedColor=e.selectedShapeColor=t.get("fillColor"),e.drawState!=b.EDIT&&(e.drawState=b.SELECTED)),e.polygonName=t.name,e.polygonTerritory=t.territory||"null",e.selectedShape=t,J(),t.id!=e.myTreeView.getSelectedId()&&(e.shouldBound=!1,e.myTreeView.selectItem(t.id)),e.$apply()}function Z(t){e.selectedShape&&(e.selectedShape.set("fillColor",t),e.selectedShapeColor=t),e.selectedColor=t}function J(){e.selectedShape&&e.selectedShape.set("strokeWeight",3)}function X(){e.selectedShape&&(e.selectedShape.setMap(null),o(function(){e.currentEditPolygon&&se(e.currentEditPolygon),e.polygonName="",e.polygonTerritory="null"},0))}function Y(t){var i=e.drawingManager.get("polygonOptions");i.fillColor=t,e.drawingManager.set("polygonOptions",i)}function Q(t,i){if(!i){var s=t[fieldNames.Polygon.Service_Territory__c]?t[fieldNames.Polygon.Service_Territory__c]:"NoTerritoryPolygon";e.myTreeView.addItem(t.Id,t.Name,s)}e.myTreeView.checkItem(t.Id),e.myTreeView.setItemIcons(t.Id,{file:"fa-square"}),e.myTreeView.setIconColor(t.Id,t[fieldNames.Polygon.Color__c])}function ee(e,t){return t+e.substring(5,7)+e.substring(3,5)+e.substring(1,3)}function te(e){for(var t="",i=0;i<e.length;i++)t+=e[i].lng+","+e[i].lat+",0\n";return t+=e[0].lng+","+e[0].lat+",0"}function ie(e,t,i){return'<?xml version="1.0" encoding="UTF-8"?> \n                            <kml xmlns="http://www.opengis.net/kml/2.2">\n                                <Style id="'+i.replace(" ","")+'Style"> \n                                    <LineStyle> \n                                        <width>1</width> \n                                    </LineStyle> \n                                    <PolyStyle> \n                                        <color>'+ee(t,80)+"</color> \n                                    </PolyStyle> \n                                </Style> \n                                <Placemark> \n                                    <name>"+i.replace(" ","")+"</name> \n                                    <styleUrl>#"+i.replace(" ","")+"Style</styleUrl> \n                                    <Polygon> \n                                        <outerBoundaryIs> \n                                            <LinearRing>\n                                                <coordinates>"+te(e)+"</coordinates> \n                                            </LinearRing> \n                                        </outerBoundaryIs> \n                                    </Polygon> \n                                </Placemark> \n                            </kml>"}function se(t){e.geoXmlParser.parseKmlString(t[fieldNames.Polygon.KML__c]);for(var i=e.geoXmlParser.docs.length-1,s=0;s<e.geoXmlParser.docs[i].placemarks.length;s++)e.geoXmlParser.docs[i].placemarks[s].id=t.Id,e.geoXmlParser.docs[i].placemarks[s].polygon.id=t.Id,e.geoXmlParser.docs[i].placemarks[s].polygon.name=t.Name,e.geoXmlParser.docs[i].placemarks[s].polygon.territory=t[fieldNames.Polygon.Service_Territory__c],e.geoXmlParser.docs[i].placemarks[s].polygon.addListener("click",function(){e.shouldBound=!1,pe.hide(),K(this)}),e.geoXmlParser.docs[i].placemarks[s].polygon.addListener("rightclick",re),e.polygons[t.Id]=t,e.polygons[t.Id].polygon=e.geoXmlParser.docs[i].placemarks[s].polygon}function ne(e,t){t=t||{},this.setMap(e),this.mapDiv=e.getDiv(),this.menuItems=t.menuItems||{},this.isVisible=!1}function re(t){pe.hide(),this.clickedPolygon_=this,K(this);var i=pe.getProjection(),s=i.fromLatLngToDivPixel(t.latLng);pe.show(s),e.map.setOptions({draggableCursor:"pointer"})}function ae(t){switch(t){case"menu-edit-polygon":e.mapOptionsToggle=!0,$(".polygonsTab").click(),e.editPolygon();break;case"menu-intersect-polygon":e.mapOptionsToggle=!0,$(".polygonsTab").click(),e.currentIntersectingId=angular.copy(e.selectedShape.id),e.drawState=b.INTERSECT,e.$apply();break;case"menu-delete-polygon":e.deletePolygon();break;case"menu-schedule-polygon":a.schedule(oe(e.selectedShape)),e.$apply();break;case"menu-unschedule-polygon":r.unscheduleServices(oe(e.selectedShape));break;case"menu-dispatch-polygon":r.changeStatus(oe(e.selectedShape),f.DISPATCHED).then(function(e){r.drawServicesAndAbsences(e.services)})["catch"](function(e){l.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)});break;case"menu-joepardy-polygon":r.setInJeopardy(oe(e.selectedShape))}}function oe(t){for(var i=[],s=0;s<e.filteredServices.servicesArray.length;s++){var n=e.filteredServices.servicesArray[s];if(null!=n.latitude&&null!=n.longitude){var r=new google.maps.LatLng(n.latitude,n.longitude);google.maps.geometry.poly.containsLocation(r,t)&&i.push(n.id)}}return i}function ce(t){for(var i=t.slice(9,t.length-2).split(","),s=[],n=0;n<i.length;n++){var r=i[n].split(" ");s.push(new google.maps.LatLng({lat:parseFloat(r[1]),lng:parseFloat(r[0])}))}e.selectedShape.setPath(s),e.savePolygon(),e.selectedIntersectingPolygons={}}e.SERVICE_STATUS=f,e.invokedActions={},e.allMarkersArray=[],e.reports={},e.reportsData={},e.map=null,e.markersControl={},e.territoriesMarkers=[],e.firstMapShow=!0,e.trafficLayerEnabled=!1,e.mapControl={},e.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}};var le={services:!0,resources:!0,positions:!0,territories:!0},ue=JSON.parse(n.GetUserSettingsProperty("Map_Object_Markers__c"))||le;e.showServices=ue.services,e.showResources=ue.resources,e.showLivePositions=ue.positions,e.showTerritories=ue.territories,e.showOnMap=!1,e.setMapMarkerUserSettings=function(){n.SetUserSettingsProperty("Map_Object_Markers__c",JSON.stringify({services:e.showServices,resources:e.showResources,positions:e.showLivePositions,territories:e.showTerritories}))},e.showTooManyReportsAlert=!1,e.resourcesFilterList=[],e.filterResourceInputValue="",e.filteredResources={},e.selectedReport="null",e.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},resource:{pixelOffset:new google.maps.Size(0,-38)},report:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)}},e.serviceInfoWindow={show:!1,control:{}},e.resourceInfoWindow={show:!1,control:{}},e.territoryInfoWindow={show:!1,control:{}},e.reportInfoWindow={show:!1,control:{}},e.livePosInfoWindow={show:!1,control:{}},e.filteredServices=r.filteredServices,e.filter=r.filter,e.currentShowOnMapServiceId=null,e.drawingStates=b,e.drawState=b.NONE,e.selectedShape=null,e.selectedShapeColor=e.selectedColor,e.drawingManager,e.setSelectedShapeColor=Z,e.polygons={},e.polygonName="",e.polygonTerritory="null",e.territories={},e.selectedIntersectingPolygons={},e.shouldBound=!0,e.cancelDrawingShape=!1,e.InvisiblePolygons=H(),e.hasCustomPermission=l.hasCustomPermission,e.getServiceInfoRowClass=l.getServiceInfoRowClass,e.pinnedStatusesSF=CustomSettings.pinnedStatusesSF,l.getReports().then(function(t){if(t)for(var i=0;i<t.length;i++)e.reports[t[i].Id]=t[i]}),h.getLastKnownPositions(),e.redrawAllMarkers=w,e.$watch("workingState",function(t){"map"==t?(e.map=e.mapControl.getGMap(),o(function(){if(k(),w(),google.maps.event.trigger(e.mapControl.getGMap(),"resize"),e.firstMapShow){e.showOnMap||O();var t=e.map.getStreetView(),i={fullscreenControl:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER}};t.setOptions(i);var s={fillOpacity:.5,strokeWeight:1,editable:!0,draggable:!0,fillColor:e.selectedColor};e.drawingManager=new google.maps.drawing.DrawingManager({drawingMode:null,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER,drawingModes:["polygon"]},polygonOptions:s,rectangleOptions:s}),e.drawingManager.setMap(e.map),q(),z(),google.maps.event.addListener(e.map,"click",function(){e.map.setOptions({draggableCursor:"grab"}),pe.hide()}),pe=new ne(e.map,de),e.firstMapShow=!1,e.showOnMap=!1}},0)):e.currentShowOnMapServiceId=null}),e.$on("resizeMap",function(t,i){google.maps.event.trigger(e.mapControl.getGMap(),"resize")}),e.$on("showServiceOnMap",function(t,s){e.currentShowOnMapServiceId=s,i.$broadcast("changeWorkingState","map"),e.map=e.mapControl.getGMap(),e.showOnMap=!0,o(function(){google.maps.event.trigger(e.mapControl.getGMap(),"resize");var t=v.serviceAppointments()[s],i=new google.maps.LatLng(t.latitude,t.longitude);e.map.setCenter(i),e.map.setZoom(20),o(function(){e.markersControl.getPlurals().get(s).gObject.setAnimation(google.maps.Animation.BOUNCE),o(function(){var t=e.markersControl.getPlurals().get(s);t&&t.gObject.setAnimation(null)},3500)},100)},0)}),p.fieldsSetFields().then(function(t){e.serviceFields=t.MapInfo}),e.isEmpty=function(e){return e?_.isEmpty(e):!0},e.markerCloseClicked=function(){e.serviceInfoWindow.show=!1,e.resourceInfoWindow.show=!1,e.territoryInfoWindow.show=!1,e.reportInfoWindow.show=!1,e.livePosInfoWindow.show=!1,e.$apply()},e.openLink=function(t,i){return"Resource__r"==i.APIName?void e.openLightbox(t.resourceId,"resource"):void l.openLink(t,i)},e.openReportLink=function(t){if(t.isReference){if("ServiceResource"==t.APIName)return void e.openLightbox(t.Value,"resource");if("ServiceAppointment"==t.APIName)return void e.openLightbox(t.Value,"service");var i=l.openConsoleTab(null,t.Value);i||window.open("../"+t.Value,"_blank")}},e.markerClicked=function(e,t,i){L(i)},e.openLightbox=function(t,i,s){var n=null;switch(s&&(n=l.generateResourceId(t,s)),i){case"service":r.recentlyUsed[t]=!0,u.open(t);break;case"resource":d.open(t,n);break;case"homeBase":e.$emit("showResourceLightbox",e.resources[t])}},e.$watch("filter",function(t,i){"map"===e.workingState&&w()},!0),e.clearResource=function(t){delete e.filteredResources[t],w()},e.clearAllResources=function(){e.filteredResources={},w()},e.addResourceToFilterList=function(){var t=g.getResources();""!=e.filterResourceInputValue&&t[e.filterResourceInputValue.value]&&(e.filteredResources[e.filterResourceInputValue.value]=t[e.filterResourceInputValue.value],e.filterResourceInputValue="",w())},e.toggleReportMarkers=function(t){var i=e.reportsData[t];i.show=!i.show,w()},e.removeReportFromMap=function(t){delete e.reportsData[t],w()},e.removeAllReportsFromMap=function(){e.reportsData={},w()},e.showReportOnMap=function(){"null"!=e.selectedReport&&t.getReportRowsForMap(e.selectedReport).then(function(t){e.reportsData[e.selectedReport]={show:!0,data:t,displayCount:0};var i=!0;w(i)})},T.register("positions",function(e){w()}),e.isPinnedStatus=function(){if(e.currentMarker){for(var t=e.pinnedStatusesSF.split(","),i=0;i<t.length;i++)if(e.currentMarker.item.status===t[i])return!0;return!1}},e.needToShowDispatchButton=function(){return e.currentMarker&&"service"==e.currentMarker.type&&e.currentMarker.item.statusCategory!=S.DISPATCHED&&e.currentMarker.item.statusCategory==S.SCHEDULED},e.isServiceCurrentlyDispatching=function(){return e.currentMarker&&"dispatched"==e.invokedActions[e.currentMarker.id]},e.changeStatusToDispatch=function(t){return e.invokedActions[t]?void alert(customLabels.another_operation_running):(e.invokedActions[e.currentMarker.id]="dispatched",void r.changeStatus([t],f.DISPATCHED).then(function(t){t.services.length>0&&(e.currentMarker.item=t.services[0])})["finally"](function(){delete e.invokedActions[e.currentMarker.id]}))},e.isServiceCurrentlyScheduling=function(){return e.currentMarker&&"schedule"==e.invokedActions[e.currentMarker.id]},e.autoScheduleService=function(t){var t=e.currentMarker.id;return e.invokedActions[t]?void alert(customLabels.another_operation_running):(r.recentlyUsed[t]=!0,e.invokedActions[t]="schedule",void r.autoScheduleService(t).then(function(i){r.drawServicesAndAbsences(i.services,i.absences),delete e.invokedActions[t]}))},e.myTreeView={},e.lastSelectedLeafId=null,s.all([l.getPolygons(),g.promises.territories()]).then(function(t){U(t[0]);for(var i in g.territories)-1!=l.getFilteredLocations().indexOf(i)&&(e.territories[i]=g.territories[i]);E(),j().then(function(t){e.locationsTree=t,e.myTreeView=new dhtmlXTreeView({parent:"polygonsByTerritoriesTree",iconset:"font_awesome",checkboxes:!0,items:e.locationsTree}),e.myTreeView.attachEvent("onSelect",function(t,i){return e.drawState!=b.NONE&&e.drawState!=b.SELECTED?!1:(e.lastSelectedLeafId||(e.lastSelectedLeafId=t),!e.polygons[t]||void 0==e.lastSelectedLeafId||e.lastSelectedLeafId==t&&void 0==e.polygons[t]?void W():(i&&(K(e.polygons[t].polygon),e.shouldBound&&e.selectedShape.getVisible()&&e.map.fitBounds(e.selectedShape.bounds),e.shouldBound=!0),void(e.lastSelectedLeafId=e.polygons[t].Id)))}),e.myTreeView.attachEvent("onCheck",N)})}),e.toggleDrawMode=function(){e.drawState!=b.INTERSECT&&(e.drawingManager.setDrawingMode("polygon"),W(),Y(e.selectedColor),e.drawState=b.DRAW)},e.cancelPolygon=function(){null!=e.drawingManager.getDrawingMode()&&(e.cancelDrawingShape=!0,e.drawingManager.setDrawingMode(null)),e.drawState==b.EDIT&&X(),e.drawState=b.NONE,e.selectedIntersectingPolygons={}},e.editPolygon=function(){e.drawState==b.SELECTED&&e.selectedShape.getVisible()&&(e.currentEditPolygon=e.polygons[e.selectedShape.id],e.drawState=b.EDIT,e.selectedShape.setEditable(!0),e.selectedShape.setDraggable(!0))},e.savePolygon=function(){if(!e.selectedShape)return void(e.drawState=b.NONE);var i=[];e.selectedShape.getPath().forEach(function(e,t){i.push({lat:e.lat(),lng:e.lng()})});var s=e.selectedShape.id||null,n="null"!=e.polygonTerritory?e.polygonTerritory:null;return e.polygonName?(t.savePolygon(ie(i,e.selectedShapeColor,e.polygonName),e.selectedShapeColor,e.polygonName,n,s).then(function(t){e.selectedShape.setMap(null),se(t),Q(t,s),e.selectedShape=e.polygons[t.Id].polygon}),void(e.drawState=b.NONE)):void alert(customLabels.Polygon_name_field_is_empty);
},e.deletePolygon=function(){if(!e.selectedShape)return void(e.drawState=b.NONE);if(confirm(customLabels.This_will_delete_the_selected_polygon.replaceAll(e.selectedShape.name))){var i=e.selectedShape.id||null;t.deletePolygon(i).then(function(t){e.selectedShape.setMap(null),e.myTreeView.deleteItem(i),W()}),e.drawState=b.NONE}};var de={},ve=[],pe=void 0;ne.prototype=new google.maps.OverlayView,ne.prototype.onAdd=function(){$("<div id='cMenu' class='context-menu-polygon'></div>").appendTo($("#map"));for(var e=$("#cMenu").get(0),t=0;t<this.menuItems.length;t++){var i=this.menuItems[t];$('<div id="'+i.id+'" class="truncate context-menu-polygon-item" title="'+i.name+'">'+i.label+"</div>").appendTo(e)}this.div_=e;var s=this.getPanes();s.overlayMouseTarget.appendChild(this.div_);for(var n=this,t=0;t<this.menuItems.length;t++){var i=this.menuItems[t],r=function(){n.clickedItem=this.id,google.maps.event.trigger(n,"click")};google.maps.event.addDomListener($("#"+i.id).get(0),"click",$.proxy(r,i))}google.maps.event.addListener(n,"click",function(){ae(n.clickedItem),event.stopPropagation(),pe.hide()})},ne.prototype.draw=function(){},ne.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_),this.div_=null},ne.prototype.hide=function(){this.div_&&(this.div_.style.visibility="hidden")},ne.prototype.show=function(e){if(this.div_){var t=this.div_;t.style.left=e.x+5+"px",t.style.top=e.y+10+"px",this.div_.style.visibility="visible"}},e.hasCustomPermission("Polygons_create_update")&&ve.push({id:"menu-intersect-polygon",className:"context_menu_item",eventName:"intersect",label:l.getSVGIconHTML(lsdIcons.cut)+customLabels.Cut_Intersections,name:customLabels.Cut_Intersections}),e.hasCustomPermission("Bulk_Schedule")&&ve.push({id:"menu-schedule-polygon",className:"context_menu_item",eventName:"schedule",label:l.getSVGIconHTML(lsdIcons.calendar)+customLabels.Schedule,name:customLabels.Schedule}),ve.push({id:"menu-unschedule-polygon",className:"context_menu_item",eventName:"unschedule",label:l.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,name:customLabels.Unschedule}),e.hasCustomPermission("Bulk_Dispatch")&&ve.push({id:"menu-dispatch-polygon",className:"context_menu_item",eventName:"dispatch",label:l.getSVGIconHTML(lsdIcons.dispatch)+customLabels.Dispatch,name:customLabels.Dispatch}),ve.push({id:"menu-joepardy-polygon",className:"context_menu_item",eventName:"joepardy",label:l.getSVGIconHTML(lsdIcons.jeopardy)+customLabels.In_Jeopardy,name:customLabels.In_Jeopardy}),e.hasCustomPermission("Polygons_create_update")&&ve.push({id:"menu-delete-polygon",className:"context_menu_item",eventName:"delete",label:l.getSVGIconHTML(lsdIcons["delete"])+customLabels.Delete_polygon,name:customLabels.Delete_polygon}),de.menuItems=ve,e.getIntersectionsForPolygons=function(){if(!e.isEmpty(e.selectedIntersectingPolygons))try{var t=new jsts.io.WKTReader,i=t.read(e.selectedShape.ToWKT());for(var s in e.selectedIntersectingPolygons){var n=t.read(e.polygons[s].polygon.ToWKT());i=i.difference(n)}var r=new jsts.io.WKTWriter,a=r.write(i);ce(a)}catch(o){alert("Problem finding intersections in given polygons."),console.error(o)}}}])}(),function(){angular.module("serviceExpert").controller("ctrlRightSide",["$q","$scope","$rootScope","$filter","$sce","sfdcService","utils","servicesService","kpiCalculationsService","StateService","DeltaService","TimePhasedDataService","StreamingAPIService","RegisterService",function(e,t,i,s,n,r,a,o,c,l,u,d,v,p){function g(){var e=moment(scheduler._min_date).format("M/D/YYYY"),t=new Date(scheduler._max_date);t=moment(t.setDate(scheduler._max_date.getDate()+1)).format("M/D/YYYY");for(var i=scheduler.serverList("resources"),s="",n=0;n<i.length;n++)s+=n+1<i.length?i[n].key.substr(0,15)+",":i[n].key.substr(0,15);return{locations:s,start:e,end:t}}function h(e){"Failed"!==e.status&&"Completed"!==e.status&&"Global Optimization"!==e.type&&e.start&&e.finish&&(e.timespan=m(e))}function m(e){if(!e.resource)return(new Date).getTime();var t=void 0,i=d.getResoruceGanttIdByDate(e.resource,e.start),s="reshufle-on-gantt",n="";if(!i)return(new Date).getTime();switch(t=i.split(","),e.type){case"Fix Overlaps":s="fix-overlaps-on-gantt",n=customLabels.FixOverlaps;break;case"SA Reshuffle":s="reshufle-on-gantt",n=customLabels.Reshuffle;break;case"Fill-In Schedule":s="fillin-on-gantt",n=customLabels.Fill_in_Schedule;break;case"Group Nearby SAs":s="group-near-on-gantt",n=customLabels.GroupNearby;break;case"Resource Schedule Optimization":s="resource-day-on-gantt",n=customLabels.RDOptimize;break;default:s="reshufle-on-gantt"}return scheduler.addMarkedTimespan({start_date:e.start,end_date:e.finish,sections:{ZoomLevel2:t,ZoomLevel3:t,ZoomLevel4:t,ZoomLevel5:t,ZoomLevel6:t},css:"smart-on-gantt "+s,html:"<div><span>"+n+"</span></div>"})}t.isMapEnabled=l.isMapEnabled(),t.servicesObjects=o.servicesObjects,t.flaggedServices=o.flagged,t.servicesScheduledToCapacity={},t.notifications=a.butlerNotifications,t.unreadNotifications=0,t.showServiceList=a.showServiceList,t.optRunning=!1,t.optQueued=!1,t.optimizationRequests={},t.workingState="gantt",t.openConsoleTab=a.openConsoleTab,t.openSObjectLink=a.openSObjectLink,t.activeRequests=r.activeRequests,t.activeRuleCheckRequests=r.activeRuleCheckRequests,t.kpi=c.kpis,t.optimizationRequsts={},t.$watch("workingState",function(e){"gantt"==e&&setTimeout(function(){scheduler._is_initialized()&&scheduler.updateView()},0)}),r.getServiceMapInfoWindowFields().then(function(e){t.serviceFields=e}),t.getServiceInfoRowClass=a.getServiceInfoRowClass,t.openLink=a.openLink,t.order=function(e,i){t.orderByField=e,t.reverse=i},t.$on("changeWorkingState",function(e,i){t.workingState=i,"gantt"==i?setTimeout(function(){scheduler.updateView()},100):$(".dhtmlXTooltip").remove()}),t.showNotifications=function(e){t.unreadNotifications=0;for(var i=0;i<a.butlerNotifications.length;i++)a.butlerNotifications[i].unread=!1},t.calcUnreadNotifications=function(){t.unreadNotifications=0;for(var e=0;e<a.butlerNotifications.length;e++)a.butlerNotifications[e].unread&&t.unreadNotifications++;return t.unreadNotifications},t.changeResourceLightboxTab=function(e){e!=t.selectedResourceLightboxTab&&(t.selectedResourceLightboxTab=e)},t.closeContractorCapacityLightbox=function(){t.lightboxContractorCapacity=null,$("#ContractorCapacityLightbox").attr("style","")},t.$on("keypress",function(e,i){27==i.which&&l.areContractorsSupported()&&t.closeContractorCapacityLightbox()}),t.formatTravel=function(e){var t=Math.floor(e/60/60),i=Math.floor(e/60%60);return t+customLabels.kpi_h+" "+i+customLabels.kpi_m},t.toggleServiceList=function(){t.showServiceList.show=!0,setTimeout(function(){scheduler.updateView(),i.$broadcast("resizeMap",{})},830)},t.openReport=function(e){var t=g(),i="../"+sfdcReports[e]+"?pv0="+t.start+"&pv1="+t.end+"&pv2="+t.locations;a.openConsoleTab(i)||window.open(i)},t.getObjectKeys=function(e){return Object.keys(e).length>0?Object.keys(e):0},t.isEmpty=function(e){return Object.keys(e).length},e.all([d.promises.initialPhasedData,r.getOptimizationRequests()]).then(function(e){e[1].forEach(function(e){t.optimizationRequsts[e.Id]=new OptimizationRequest(e),h(t.optimizationRequsts[e.Id])})}),t.getRequestCss=function(e){switch(e){case"In Progress":return"smart_in_progress";case"Completed":return"smart_completed";case"Failed":return"smart_failed";case"Open":return"smart_open";case"Queued":return"smart_queued"}},p.register("optimizationRequests",function(e){e.forEach(function(e){var i=new OptimizationRequest(e);t.optimizationRequsts[e.Id]&&t.optimizationRequsts[e.Id].timespan&&scheduler.deleteMarkedTimespan(t.optimizationRequsts[e.Id].timespan),t.optimizationRequsts[e.Id]=i,h(i)}),scheduler.updateView()}),t.getNumOfRunningRequests=function(){var e=0;for(var i in t.optimizationRequsts)"Completed"!=t.optimizationRequsts[i].status&&"Failed"!=t.optimizationRequsts[i].status&&e++;return e},t.marginLeftForBox=0,t.mapAvailable=mapMode,t.openSomethingBox=function(e,i){"smart"===i?t.marginLeftForBox=e.target.offsetLeft-227:t.marginLeftForBox=e.target.offsetLeft-200}}])}(),function(){angular.module("serviceExpert").controller("serviceListCtrl",["$scope","$compile","$rootScope","$filter","utils","$timeout","$sce","servicesService","sfdcService","ResourcesAndTerritoriesService","GetSlotsService","userSettingsManager","StateService","TimePhasedDataService","LoadServiceListService","FieldSetFieldsService","ServiceAppointmentLightboxService","ServiceSelectorService","LocationFilteringService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService","StreamingAPIService","RegisterService","GanttFilterService","GeneralLightbox",function(e,t,i,s,n,r,a,o,c,l,u,d,v,p,g,h,m,f,S,b,y,_,T,w,L,k){function C(t){delete e.filtersMap[t];for(var i=-1,s=0;s<e.filterOptions.length;s++)if(e.filterOptions[s].Id===t){i=s;break}-1!==i&&e.filterOptions.splice(i,1),e.filter.selectedFilter="All",d.SetUserSettingsProperty("Selected_List_View__c",e.filter.selectedFilter)}function R(){if(!e.filtersMap)return!1;var t=e.filtersMap[e.filter.selectedFilter];if(!t||t.old)return!1;var i=new Date(e.filter.endDate),s=new Date(e.filter.endDate);"Invalid Date"===e.filter.endDate.toString()&&(i=new Date(scheduler._max_date),s=new Date(scheduler._max_date)),t.List_only_appointments_on_the_gantt?(i=scheduler._min_date,s=scheduler._max_date):(i.setDate(i.getDate()-t.Days_before_horizon),s.setDate(s.getDate()+t.Days_after_horizon));var r=Math.ceil((s-i)/1e3/60/60/24);g.loadServiceAppointmentsToList(e.servicesObjects(),e.servicesListVisitedDays,s,r).then(function(t){if(t.remainingCount>0)n.addNotification(customLabels.Too_Many_Services_Header_Services_List,customLabels.Too_Many_Services_Services_List);else for(;t.newStart<=t.horizon.date;)e.servicesListVisitedDays[t.newStart]=!0,t.newStart=n.addDaysToDate(t.newStart,1);for(var i=[],s=0;s<t.scheduledServices.length;s++)i.push(t.scheduledServices[s].id);o.checkRules(i).then(function(){scheduler.updateView()})})["catch"](function(e){console.warn("loadServiceAppointmentsToList failed "+e)})}function D(e,t){for(var i=0;i<t.length;i++)if(t[i].name==e)return t[i].filter;return!1}function A(){var e=d.GetUserSettingsProperty("Filters__c");return void 0==e?[]:JSON.parse(d.GetUserSettingsProperty("Filters__c"))}function I(){return d.SetUserSettingsProperty("Filters__c",JSON.stringify(e.storageFilters))}function F(){if(!useNewFilters){e.storageFilters=A();for(var t=0;t<e.storageFilters.length;t++)e.filterOptions.push({name:e.storageFilters[t].name,value:e.storageFilters[t].name});x(e.storageFilters.length>0?e.storageFilters[0].name:null)}}function x(t){if(e.lastSelectedFilter=t,t){for(var i=0;i<e.storageFilters.length;i++)e.storageFilters[i].name==t&&(e.filter.advancedFilter=angular.copy(e.storageFilters[i].filter));e.customFilterName=t,e.DisplayComboBowArrow=!0,e.IsCustomFilterReadonly=!0,e.displayNew=!0,e.displayEdit=!0,e.displayDelete=!0}else e.filter.advancedFilter=M(),e.customFilterName="",e.DisplayComboBowArrow=!1,e.IsCustomFilterReadonly=!0,e.displayNew=!0,e.displayEdit=!1,e.displayDelete=!1}function M(){var t={statusCheckboxs:{},minDate:new Date,maxDate:new Date,servicePriority:10,unScheduled:!0,violations:!0,jeopardies:!0,noLocation:!0,locationsCheckboxs:{}};if(Object.keys(e.statusTranslations).length>0)for(var s in e.statusTranslations)t.statusCheckboxs[e.statusTranslations[s]]=!0;else i.$on("gotStatuses",function(){for(var i in e.statusTranslations)t.statusCheckboxs[e.statusTranslations[i]]=!0});for(var n=0;n<e.territories.length;n++){var r=e.territories[n];t.locationsCheckboxs[r.name]=!0}return t}function O(t){for(var i=0;i<e.filterOptions.length;i++)e.filterOptions[i].name==t&&e.filterOptions.splice(i,1)}angular.element(document).ready(function(){function e(){var e=d.GetUserSettingsProperty("Left_Panel_Width_Percentage__c"),i=400,s=$("#contentWrapper"),n=d.GetUserSettingsProperty("Services_List_Height_Percentage__c"),a=250,o=$("#SmartPanelContainer");if(0==s.length&&(s=$(window)),0==o.length&&(o=$(window)),0==!s.width()&&!t){t=!0,null!=e&&e>0&&100>e&&(i=s.width()*e*.01),400>i&&(i=400);var c=i+3;$("#RightSideContainer").width("calc(100% - "+c+"px)"),Split(["#LeftSideContainer","#RightSideContainer"],{sizes:[i+"px"],minSize:[400,700],snapOffset:10,gutterSize:3,onDragEnd:function(){scheduler.updateView();var e=$("#LeftSideContainer").width()/s.width();e*=100,d.SetUserSettingsProperty("Left_Panel_Width_Percentage__c",e)}})}r(function(){if(0==!o.height()){null!=n&&n>0&&100>n&&(a=o.height()*n*.01),a>250&&(a=250);var e=a+5;$("#ServiceListBottomContainer").height("calc(100% - "+e+"px");var t=o.height()-250;$("#SmartPanelContainer").find(".gutter-vertical").length&&$("#SmartPanelContainer").find(".gutter-vertical").remove(),Split(["#ServiceListTopContainer","#ServiceListBottomContainer"],{direction:"vertical",sizes:[a+"px"],minSize:[5,t],snapOffset:10,gutterSize:5,onDragEnd:function(){var e=$("#ServiceListTopContainer").height()/o.height();e*=100,d.SetUserSettingsProperty("Services_List_Height_Percentage__c",e)}})}},0)}var t=!1;e(),$(window).bind("resize",e)}),useNewFilters&&L.filtersPromise.then(function(t){var i=[];e.filterOptions.forEach(function(e){var t={};for(var s in e)t[s]=e[s];t.Name=e.name,t.old=!0,t.Id=e.value,i.push(t)}),e.filterOptions=[].concat(i,_toConsumableArray(t)),e.filtersMap={},e.filterOptions.forEach(function(t){return e.filtersMap[t.Id]=t})})["finally"](function(){e.filterOptions.sort(function(e,t){return e.Name>t.Name?1:e.Name<t.Name?-1:0}),L.setFilterMap(e.filtersMap)}),window.__closeFilterLightbox=function(t){n.safeApply(e,function(){var i=k.closeLightboxFromOutside();i&&i(),L.getFilterFromSalesforce(t).then(function(t){if(e.filtersMap[t.Id]){for(var i=0;i<e.filterOptions.length;i++)if(e.filterOptions[i].Id===t.Id){e.filterOptions[i]=t;break}}else e.filterOptions.push(t),e.filterOptions.sort(function(e,t){return e.Name>t.Name?1:e.Name<t.Name?-1:0});e.filtersMap[t.Id]=t})})},e.openGanttFilterLightbox=function(t){var i=e.filtersMap[e.filter.selectedFilter];switch(t){case"new":k.open(customLabels.FilterEditor,filterEditorPage);break;case"edit":k.open(customLabels.FilterEditor,filterEditorPage+"?&id="+i.Id);break;case"delete":if(!confirm(customLabels.ConfirmFilterDelete))return;L.deleteFilter(i.Id).then(C);break;case"hide":if(!confirm(customLabels.ConfirmFilterHide))return;L.hideFilter(i.Id).then(C)}},e.showNewFilterButton=function(){return customPermissions.Create_custom_Gantt_filters},e.showEditFilterButton=function(){if(!e.filtersMap)return!1;var t=e.filtersMap[e.filter.selectedFilter];return!t||t.old?!1:customPermissions.Create_custom_Gantt_filters&&!customPermissions.Publish_custom_Gantt_filters&&t.CreatedById===userId?!0:customPermissions.Publish_custom_Gantt_filters?!0:!1},e.showDeleteFilterButton=function(){if(!e.filtersMap)return!1;var t=e.filtersMap[e.filter.selectedFilter];return!t||t.old?!1:customPermissions.Create_custom_Gantt_filters&&t.CreatedById===userId},e.showHideFilterButton=function(){if(!e.filtersMap)return!1;var t=e.filtersMap[e.filter.selectedFilter];return!t||t.old?!1:customPermissions.Publish_custom_Gantt_filters&&customPermissions.Create_custom_Gantt_filters},e.newFilterChanged=function(){if(!useNewFilters)return void e.loadServiceAppointmentsToList();if(!e.filtersMap)return!1;var t=e.filtersMap[e.filter.selectedFilter]||e.filtersMap.All;return e.filtersMap[e.filter.selectedFilter]||(e.filter.selectedFilter="All",t.selectedFilter="All"),d.SetUserSettingsProperty("Selected_List_View__c",e.filter.selectedFilter),!t||t.old?void e.loadServiceAppointmentsToList():void R()},e.fieldsTypes=n.fieldsTypes,e.openConsoleTab=n.openConsoleTab,e.woPriorities=n.woPriorities,e.useNewFilters=window.useNewFilters,e.isMapEnabled=v.isMapEnabled(),e.contractorSupport=v.areContractorsSupported(),e.statuses=b,e.statusTranslations=n.statusTranslations,e.pinnedStatusesSF=CustomSettings.pinnedStatusesSF,e.ganttSettings=n.ganttSettings,e.showServiceList=n.showServiceList,e.trust=n.trust,e.hasCustomPermission=n.hasCustomPermission,e.isLightning=n.isLightning,e.isOptimizationEnabled=isOptimizationEnabled,e.bulkActionsOrder=bulkActionsOrder,e.isInConsole=v.isInConsole,e.matchGantt=d.GetUserSettingsProperty("Match_Gantt_Dates__c"),e.fullScreen=!1,window.location.search.match(/[&?]fullScreen=(\d)/)&&(e.fullScreen="1"===window.location.search.match(/[&?]fullScreen=(\d)/)[1]?"0":"1"),e.servicesObjects=p.serviceAppointments,e.selectedServiceId=null,e.lastSelectedServiceId=null,e.servicesListVisitedDays={},e.servicesListInited=!1,e.servicesListFields=[],e.flagged=o.flagged,e.loadedTerritories=[],e.selectorService=f,e.servicesSelection=e.selectorService.SelectedServices,e.selectedPolicy=null,e.policyOptions=[],e.showGanttSettings=!1,e.ganttSettingDraft=null,e.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],e.reallyHideList=!1,e.showAdvancedFilter=!1,e.invokedAction={},e.invokedActionFor={},e.showCustomFilterDropdown=!1,e.storageFilters=null,e.prevEndDate=null,e.sortingColumn="start",e.sortingColumnName={start:customLabels.Start_time,finish:customLabels.Finish_time,accountName:customLabels.Account,serviceTypeName:customLabels.Service_type,priority:customLabels.Priority,resourceName:customLabels.Resource,earlyStart:customLabels.Early_start,dueDate:customLabels.Due_date,locationName:customLabels.Location},e.selectedDates={earlyStart:customLabels.Early_start,dueDate:customLabels.Due_date,appStart:customLabels.Appointment_start,appEnd:customLabels.Appointment_finish,start_date:customLabels.Start,end_date:customLabels.Finish},e.actionNames={Schedule:{name:customLabels.Schedule,icon:lsdIcons.calendar},"Change Status":{name:customLabels.Change_status,icon:lsdIcons.replace},"Create Service":{name:customLabels.Create_Service,icon:lsdIcons.page},Optimize:{name:customLabels.Optimize,icon:lsdIcons.magicwand},"Flag-Unflag":{name:customLabels.Flag_Unflag,icon:lsdIcons.flag},Unschedule:{name:customLabels.Unschedule,icon:lsdIcons.na},Delete:{name:customLabels.Delete,icon:lsdIcons["delete"]}},e.filter=o.filter,e.orderByField=o.filter.orderByField,e.reverse=o.filter.reverse,e.filteredServices=o.filteredServices,e.filterOptions=[],n.hasCustomPermission("Service_List_Todo")&&e.filterOptions.push({name:customLabels.Todo,value:"Todo"}),e.filterOptions.push({name:customLabels.AllServices,value:"All"}),e.filterOptions.push({name:customLabels.Recently_used,value:"Recent"}),n.hasCustomPermission("Service_List_Flagged")&&e.filterOptions.push({name:customLabels.Flagged,value:"Flagged"}),n.hasCustomPermission("Service_List_Selected")&&e.filterOptions.push({name:customLabels.Selected_Capital,value:"Selected"}),n.hasCustomPermission("Service_List_Unscheduled")&&e.filterOptions.push({name:customLabels.UnscheduledCapital,value:"Unscheduled"}),n.hasCustomPermission("Service_List_Scheuled")&&e.filterOptions.push({name:customLabels.Scheduled,value:"Scheduled"}),n.hasCustomPermission("Service_List_In_Jeopardy")&&e.filterOptions.push({name:customLabels.In_Jeopardy,value:"inJeopardy"}),n.hasCustomPermission("Service_List_Rule_Violating")&&e.filterOptions.push({name:customLabels.Rules_violating,value:"Violating"}),n.hasCustomPermission("Service_List_Gantt")&&e.filterOptions.push({name:customLabels.Gantt,value:"Gantt filter"}),n.hasCustomPermission("Service_List_Canceled")&&e.filterOptions.push({name:customLabels.Cancelled,value:"Cancelled filter"}),v.areContractorsSupported()&&n.hasCustomPermission("Service_List_Contractors")&&e.filterOptions.push({name:customLabels.Contractors,value:"Contractors filter"}),v.areCrewsSupported()&&n.hasCustomPermission("Service_List_Crews")&&e.filterOptions.push({name:customLabels.crews,value:"Crews filter"}),h.fieldsSetFields().then(function(t){e.servicesListFields=t.ListColumns,e.clickedServiceFieldPairs=[];for(var i=0;i<t.ListExpanded.length;){for(var s=i+2,n=[];i<t.ListExpanded.length&&s>i;i++)n.push(t.ListExpanded[i]);e.clickedServiceFieldPairs.push(n)}}),e.isPinnedStatus=function(t){for(var i=e.pinnedStatusesSF.split(","),s=0;s<i.length;s++)if(t===i[s])return!0;return!1},e.getSingleTaskColumnClass=function(e){var t={SingleTaskColumn:!0,truncate:!0};return t["Field-"+e.Type]=!0,t},e.getHeaderTaskColumnClass=function(e){var t={SortingTasksListColumn:!0};return t["Field-"+e.Type]=!0,t},e.loadServiceAppointmentsToList=function(){var t=(new Date(e.endDate),new Date(e.endDate.getTime()-24*n.ganttSettings.backHorizon*60*60*1e3),g.getBackHorizonToFetch(e.servicesListVisitedDays,e.endDate,n.ganttSettings.backHorizon));t.horizon<=0||g.loadServiceAppointmentsToList(e.servicesObjects(),e.servicesListVisitedDays,e.endDate,n.ganttSettings.backHorizon).then(function(t){if(t.remainingCount>0)n.addNotification(customLabels.Too_Many_Services_Header_Services_List,customLabels.Too_Many_Services_Services_List);else for(;t.newStart<=t.horizon.date;)e.servicesListVisitedDays[t.newStart]=!0,t.newStart=n.addDaysToDate(t.newStart,1);for(var i=[],s=0;s<t.scheduledServices.length;s++)i.push(t.scheduledServices[s].id);o.checkRules(i).then(function(e){scheduler.updateView()})})["catch"](function(e){console.warn("loadServiceAppointmentsToList failed "+e)})},e.formatServiceField=function(e,t){var i=e[t.APIName];switch(t.Type){case n.fieldsTypes.DateTime:i=s("amDateFormat")(i,"lll");break;case n.fieldsTypes.Date:i=s("amDateFormat")(i,"L")}return i},e.getRefFieldID=function(e,t){var i=t.JsAPIName.replace("__r","__c");return e[i]},e.isFieldEmpty=function(e,t){return"undefined"==typeof s("displayFieldSetField")(e,t)},e.openCalendarAdvanceFilterStart=function(){e.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMin",date:new Date(e.filter.endDate),navigation:!0,handler:function(t,i){n.safeApply(e,function(){t>new Date(e.filter.advancedFilter.maxDate)?alert(customLabels.startBeforeEnd):e.filter.advancedFilter.minDate=t}),scheduler.destroyCalendar()}}))},e.openCalendarAdvanceFilterFinish=function(){e.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMax",date:new Date(e.endDate),navigation:!0,handler:function(t,i){n.safeApply(e,function(){t<new Date(e.filter.advancedFilter.minDate)?alert(customLabels.startBeforeEnd):e.filter.advancedFilter.maxDate=t}),scheduler.destroyCalendar()}}))},e.openCalendarAdvanceFilterStart=function(){e.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMin",date:new Date(e.filter.endDate),navigation:!0,handler:function(t,i){n.safeApply(e,function(){t>new Date(e.filter.advancedFilter.maxDate)?alert(customLabels.startBeforeEnd):e.filter.advancedFilter.minDate=t}),scheduler.destroyCalendar()}}))},v.promises.policies().then(function(t){e.policyOptions=t;for(var i=!1,s=d.GetUserSettingsProperty("Gantt_Policy__c"),n=0;n<t.length;n++)if(s){if(t[n].Id===s){e.selectedPolicy=t[n],i=!0;break}}else if(t[n].Id===defaultPolicy){e.selectedPolicy=t[n],i=!0;break}i||(e.selectedPolicy=e.policyOptions[0]),v.selectedPolicyId=e.selectedPolicy.Id})["catch"](function(e){console.warn(e),cantLoadGantt(customLabels.no_policy_found)}),e.changePolicy=function(){v.selectedPolicyId=e.selectedPolicy.Id,d.SetUserSettingsProperty("Gantt_Policy__c",e.selectedPolicy.Id);var t=[];for(var i in scheduler._events)"service"===scheduler._events[i].type&&t.push(i);t.length>0&&o.checkRules(t).then(function(){return scheduler.updateView()})},e.order=function(t,i){e.filter.orderByField=t,e.filter.reverse=i},e.selectService=function(t){t==e.selectedServiceId?(e.selectedServiceId=null,e.lastSelectedServiceId=t):(e.lastSelectedServiceId=e.selectedServiceId,e.selectedServiceId=t)},e.violationsTooltip=function(e){if(e.isMDT&&!e.violations&&!e.jeopardy)return customLabels.Multi_Day_Service;if(e.violations||e.jeopardy){if(e.jeopardy&&e.jeopardyReason)return e.jeopardyReason;if(e.violations){for(var t="",i=0;i<e.violations.length;i++)t+=e.violations[i].RuleName+"\n";return t&&(t=t.substring(0,t.length-1)),t}}},e.getStatusClass=function(e){return n.getCSSClassForContext(e.statusCategory,y)},e.$on("initCompleted",function(t){e.initEndDate();var i=d.GetUserSettingsProperty("locations");e.territories=[];for(var s=0;s<i.length;s++)void 0!==l.territories[i[s]]&&e.territories.push(l.territories[i[s]]);F()}),e.initEndDate=function(){e.endDate=e.getSchedulerMaxDate(),e.endDate=n.addDaysToDate(e.endDate,1),e.prevEndDate=e.endDate,e.filter.endDate=e.endDate},e.$on("ganttFinishedLoadingServices",function(){(e.matchGantt||e.servicesListInited===!1)&&(e.servicesListInited||(null===e.endDate||isNaN(e.endDate.getTime()))&&e.initEndDate(),e.servicesListInited=!0,e.newFilterChanged())}),e.getSchedulerMaxDate=function(){var e=scheduler.getState().max_date;return 0===e.getHours()&&0===e.getMinutes()?e=new Date(e.getTime()-6e4):(e.setHours(23),e.setMinutes(59),e.setSeconds(0)),e},scheduler.attachEvent("onBeforeViewChange",function(e,t){return scheduler._old={mode:e,date:t},!0}),scheduler.attachEvent("onViewChange",function(t,i){(scheduler._old.mode!==t||i!==scheduler._old.date)&&(v.isLoadingNewLocations||n.safeApply(e,function(){if(e.matchGantt){var t=e.getSchedulerMaxDate();e.filter.endDate=t,e.endDate=t,e.matchGantt&&e.newFilterChanged()}}))}),e.matchGanttClicked=function(){if(e.matchGantt)e.prevEndDate=e.endDate,e.filter.endDate=e.getSchedulerMaxDate(),e.endDate=e.filter.endDate,d.SetUserSettingsProperty("Match_Gantt_Dates__c",!0);else{var t=e.prevEndDate;"Invalid Date"===t.toString()&&(t=scheduler._min_date),e.filter.endDate=t,e.endDate=t,d.SetUserSettingsProperty("Match_Gantt_Dates__c",!1)}e.newFilterChanged()},e.openLightBox=function(e){o.recentlyUsed[e]=!0,m.open(e)},e.flagging=function(e){return o.flagged[e]?void(o.flagged[e]&&(o.flagged[e]=!o.flagged[e],scheduler.updateEvent(e))):(o.flagged[e]=!0,void scheduler.updateEvent(e))},e.showOnGantt=function(e){o.recentlyUsed[e.id]=!0,scheduler._events[e.id]?"none"==$("#GanttMapContainer").css("display")?(i.$broadcast("changeWorkingState","gantt"),r(function(){scheduler.updateView()},20),r(function(){n.showOnGantt(e.id)},120)):n.showOnGantt(e.id):alert(customLabels.location_not_loaded)},e.changeStatusToDispatch=function(t){if(e.invokedActionFor[t]||v.schedulingRunningFor[t])return void alert(customLabels.another_operation_running);o.recentlyUsed[t]=!0,e.invokedAction[t]="dispatch",e.invokedActionFor[t]=!0;var i=[t];o.changeStatus(i,b.DISPATCHED).then(function(e){o.drawServicesAndAbsences(e.services)})},e.showOnMap=function(e){i.$broadcast("showServiceOnMap",e)},e.openDateEndCalendar=function(){e.matchGantt||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"DateStart",date:new Date(e.filter.endDate),navigation:!0,handler:function(t,i){n.safeApply(e,function(){e.endDate=t,e.endDate.setHours(23),e.endDate.setMinutes(59),e.endDate.setSeconds(0),e.filter.endDate=e.endDate,e.newFilterChanged()}),scheduler.destroyCalendar()}}))},e.openFullScreen=function(){var e=window.location.search.match(/[&?]fullScreen=(\d)/),t=0;if(e){var i="1"===e[1]?"0":"1";window.location.search=window.location.search.replace(/[&?]fullScreen=\d/,"&fullScreen="+i)}else window.location.search+="&fullScreen=1",t=1},e.getSlots=function(t){return o.recentlyUsed[t]=!0,"none"==$("#GanttMapContainer").css("display")&&(i.$broadcast("changeWorkingState","gantt"),setTimeout(function(){scheduler.updateView()},20)),e.invokedActionFor[t]||v.schedulingRunningFor[t]?void alert(customLabels.another_operation_running):void u.get(t)},e.scheduleAndReshuffle=function(t){return e.invokedActionFor[t]?void alert(customLabels.another_operation_running):(o.recentlyUsed[t]=!0,e.invokedAction[t]="reshuffle",e.invokedActionFor[t]=!0,void c.runReshuffle(t,v.selectedPolicyId).then(function(i){_.updateOptimizationRequest(i);var s=function n(s){s.forEach(function(s){var r=new OptimizationRequest(s);r.id!=i.Id||"Completed"!=r.status&&"Failed"!=r.status||(e.invokedAction[t]=null,e.invokedActionFor[t]=!1,w.unRegister("optimizationRequests",n))})};w.register("optimizationRequests",s)},function(){n.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message),e.invokedAction[t]=null,e.invokedActionFor[t]=!1}))},e.groupNearby=function(t){return e.invokedActionFor[t]?void alert(customLabels.another_operation_running):(o.recentlyUsed[t]=!0,e.invokedAction[t]="groupNearby",e.invokedActionFor[t]=!0,void c.runGroupNearby(t,v.selectedPolicyId).then(function(i){_.updateOptimizationRequest(i);var s=function n(s){s.forEach(function(s){var r=new OptimizationRequest(s);r.id!=i.Id||"Completed"!=r.status&&"Failed"!=r.status||(e.invokedAction[t]=null,e.invokedActionFor[t]=!1,w.unRegister("optimizationRequests",n))})};w.register("optimizationRequests",s)},function(){n.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message),e.invokedAction[t]=null,e.invokedActionFor[t]=!1}))},e.autoScheduleService=function(t){return e.invokedActionFor[t]||v.schedulingRunningFor[t]?void alert(customLabels.another_operation_running):(o.recentlyUsed[t]=!0,e.invokedAction[t]="schedule",e.invokedActionFor[t]=!0,void o.autoScheduleService(t).then(function(i){0===i.services.length&&alert(customLabels.NoCandidates),o.drawServicesAndAbsences(i.services,i.absences),e.invokedActionFor[t]=!1,e.invokedAction[t]=null})["catch"](function(i){n.addNotification(customLabels.Action_Could_Not_Be_Performed,i.message),e.invokedAction[t]=null,e.invokedActionFor[t]=!1}))},e.$on("autoScheduleServiceFinished",function(t,i){e.invokedAction[i]=null,e.invokedActionFor[i]=!1}),e.openBulkAction=function(e){return"Create Service"==e?void i.$broadcast("openCreateServiceLightbox",e):void i.$broadcast("openBulkActions",e)},e.openGanttSettings=function(){e.showGanttSettings=!0,n.ganttSettings?e.ganttSettings=n.ganttSettings:(e.ganttSettings.filterCandidates=!0,e.ganttSettings.servicesPerPage=200,e.ganttSettings.backHorizon=14,e.ganttSettings.capacityDuration="Day"),e.ganttSettingDraft=angular.copy(e.ganttSettings)},e.closeSettingsLightbox=function(){e.showGanttSettings=!1,$("#ganttSettingsLightbox").attr("style",""),e.ganttSettingDraft=angular.copy(e.ganttSettings)},e.parseGanttSettingsToUserSetting=function(e){var t={};return t.Gantt_View_Start_Hour__c=e.startHour,t.Gantt_View_Finish_Hour__c=e.finishHour,t.Filter_Candidates__c=e.filterCandidates,t.Services_Per_Page__c=e.servicesPerPage,t.Resource_Row_Height__c=e.resourceRowHeight,t.Scheduling_horizon_limit__c=e.backHorizon,t.View_Capacity_Type__c=e.capacityDuration,t.Load_On_Today__c=e.loadOnToday,t},e.saveGanttSettings=function(){return"undefined"==typeof e.ganttSettingDraft.backHorizon?void alert(customLabels.backHorizonInvalid):(schedulerConfig.setRowHeights(e.ganttSettingDraft.resourceRowHeight,!0),setCapacityFilter(e.ganttSettingDraft.capacityDuration,!0),e.ganttSettings=angular.copy(e.ganttSettingDraft),n.ganttSettings=angular.copy(e.ganttSettingDraft),e.filter.servicesPerPage=parseInt(e.ganttSettings.servicesPerPage),d.SetUserSettingProperties(e.parseGanttSettingsToUserSetting(e.ganttSettings)).then(function(){}),void(e.showGanttSettings=!1))},e.$on("keypress",function(t,i){27==i.which&&e.closeSettingsLightbox()}),e.stopPropagation=function(e){e.stopPropagation()},e.createArray=function(e,t){if("number"!=typeof e||isNaN(e))return[];if("number"!=typeof t||isNaN(t))return[];var i=Math.floor(e/t);return e%t>0&&i++,new Array(i)},e.changePage=function(t){switch(t){case"right":e.filter.totalPages!=e.filter.currentPage&&(e.filter.currentPage=parseInt(e.filter.currentPage)+1,e.filter.currentPage=e.filter.currentPage.toString());break;case"left":e.filter.currentPage>1&&(e.filter.currentPage=parseInt(e.filter.currentPage)-1,e.filter.currentPage=e.filter.currentPage.toString());break;case"first":e.filter.currentPage>1&&(e.filter.currentPage="1");break;case"last":e.filter.totalPages!=e.filter.currentPage&&(e.filter.currentPage=e.filter.totalPages.toString())}},e.hideServiceList=function(){e.showServiceList.show=!1,e.reallyHideList=!0,
r(function(){scheduler.updateView(),i.$broadcast("resizeMap",{})},0)},e.$watch("showServiceList.show",function(t,i){t&&(e.reallyHideList=!1)}),e.getLocationName=function(t){return e.servicesObjectslocationNam},e.isDraggable=function(t){return e.servicesObjects()[t].resourceId||e.servicesObjects()[t].statusCategory!==y.NONE||e.servicesObjects()[t].pinned&&(!e.servicesObjects()[t].pinned||preventUpdateOfPinned)?!1:!0},e.showAdvancedFilterFunc=function(){$("#AdvancedFilteringOptions").css("display","block"),r(function(){$("#SmartPanelContainer").find(".gutter-vertical").hide(),e.showAdvancedFilter=!0},100)},e.hideAdvancedFilterFunc=function(){e.showAdvancedFilter=!1,setTimeout(function(){$("#SmartPanelContainer").find(".gutter-vertical").show(),$("#AdvancedFilteringOptions").css("display","none")},700)},e.removeSpaces=function(e){return e?e.split(" ").join("+"):""},e.filterChanged=function(){var t=A(),i=D(e.filter.selectedFilter,t);i?(e.filter.advancedFilter=i,e.customFilterSelected=!0,e.customFilterName=e.filter.selectedFilter):e.customFilterSelected=!1,d.GetUserSettingsProperty("Selected_List_View__c")!==e.filter.selectedFilter&&d.SetUserSettingsProperty("Selected_List_View__c",e.filter.selectedFilter)},e.$on("gotNewResources",function(t,i){e.territories=[];for(var s=i.show,n=0;n<s.length;n++)void 0!==l.territories[s[n]]&&e.territories.push(l.territories[s[n]]);e.servicesListVisitedDays={},e.newFilterChanged()}),e.createCustomFilter=function(){e.isEditMode=!1,e.customFilterName="",e.displayCancel=!0,e.IsCustomFilterReadonly=!1,e.DisplayComboBowArrow=!1,e.displayNew=!1,e.displayEdit=!1,e.displaySave=!0,e.displayDelete=!1,e.filter.advancedFilter=M()},e.CancelSaveOrEditCustomFilter=function(){e.displayNew=!0,e.displayEdit=!0,e.DisplayComboBowArrow=!0,e.displaySave=!1,e.displayDelete=!0,e.displayCancel=!1,e.IsCustomFilterReadonly=!0,x(e.lastSelectedFilter)},e.saveCustomFilter=function(){if(0===e.customFilterName.length)return void alert(customLabels.Please_give_a_name_to_the_custom_filter);for(var t=0;t<e.filterOptions.length;t++)if(!e.isEditMode&&e.filterOptions[t].name==e.customFilterName||e.isEditMode&&e.filterOptions[t].name==e.customFilterName&&e.filterOptions[t].name!=e.lastSelectedFilter)return void alert("Please select another name");if(e.displayNew=!0,e.displayEdit=!0,e.DisplayComboBowArrow=!0,e.displaySave=!1,e.displayDelete=!0,e.displayCancel=!1,e.IsCustomFilterReadonly=!0,e.isEditMode){for(var i=0;i<e.storageFilters.length;i++)if(e.storageFilters[i].name==e.lastSelectedFilter){for(e.storageFilters[i].filter=e.filter.advancedFilter,e.storageFilters[i].name=e.customFilterName,I(),t=0;t<e.filterOptions.length;t++)if(e.filterOptions[t].name==e.lastSelectedFilter){e.filterOptions[t].name=e.customFilterName,e.filterOptions[t].value=e.customFilterName;break}e.filter.selectedFilter==e.lastSelectedFilter&&(e.filter.selectedFilter=e.customFilterName);break}}else e.storageFilters.push({name:angular.copy(e.customFilterName),filter:angular.copy(e.filter.advancedFilter)}),e.filterOptions.push({name:angular.copy(e.customFilterName),value:angular.copy(e.customFilterName)}),I(),e.customFilterSelected=!0,e.filter.selectedFilter=e.customFilterName;e.lastSelectedFilter=e.customFilterName},e.EditCustomFilter=function(){e.isEditMode=!0,e.displayCancel=!0,e.DisplayComboBowArrow=!1,e.displayNew=!1,e.displayEdit=!1,e.displaySave=!0,e.displayDelete=!1,e.IsCustomFilterReadonly=!1,e.DisplayComboBowArrow=!1,e.filter.advancedFilter=angular.copy(e.filter.advancedFilter)},e.deleteCustomFilter=function(){e.IsCustomFilterReadonly=!0,e.DisplayComboBowArrow=!0,e.displayNew=!0,e.displayEdit=!0,e.displaySave=!1,e.displayDelete=!0;for(var t=0;t<e.storageFilters.length;t++)if(e.storageFilters[t].name==e.customFilterName){e.storageFilters.splice(t,1);break}O(e.customFilterName),I(),e.filter.selectedFilter==e.customFilterName&&(e.filter.selectedFilter=customPermissions.Service_List_Todo?"Todo":"All"),x(e.storageFilters.length>0?e.storageFilters[0].name:null)},e.customFilterChanged=function(t){e.customFilterName=t,x(t)},e.showDropdownCustomFilters=function(t){t.stopPropagation(),e.storageFilters.length>0&&(e.showCustomFilterDropdown=!e.showCustomFilterDropdown)},e.toggleStatus=function(t,i){e.IsCustomFilterReadonly||(e.filter.advancedFilter.statusCheckboxs[i]=!e.filter.advancedFilter.statusCheckboxs[i])},e.toggleLocation=function(t){e.IsCustomFilterReadonly||(t?e.filter.advancedFilter.locationsCheckboxs[t]=!e.filter.advancedFilter.locationsCheckboxs[t]:e.filter.advancedFilter.noLocation=!e.filter.advancedFilter.noLocation)},e.clearRecentlyViewed=function(){for(var e in o.recentlyUsed)delete o.recentlyUsed[e]},e.openLocationFiltering=function(){S.open()}}])}(),function(){angular.module("serviceExpert").filter("ampmOr24",function(){return function(e,t,i){var s=parseInt(e),n=i?":00":"";return"ampm"==t?12===e?"12PM":0===e||24===e?"12AM":s>12?s-12+"PM":s+"AM":"24"==t?10>s?"0"+s+n:s+n:e}})}(),function(){angular.module("serviceExpert").filter("displayFieldSetField",["utils","$filter",function(e,t){return function(i,s){if(i&&s){var n=i[s.APIName];if(n)if("Status"===s.APIName)n=e.statusTranslations[i.status]||i.status;else switch(s.Type){case e.fieldsTypes.DateTime:n=t("amDateFormat")(n,"l LT");break;case e.fieldsTypes.Date:n=t("amDateFormat")(n,"L");break;case e.fieldsTypes.Currency:n=t("currency")(n,defaultCurrency)}return null==n&&(n=void 0),n}}}]).filter("displayReportField",["utils","$filter",function(e,t){return function(e){if(e){var i=e.Label;switch(e.Type){case"DATETIME_DATA":i=t("amDateFormat")(i,"l LT");break;case"DATE_DATA":i=t("amDateFormat")(i,"L")}return null==i&&(i=void 0),i}}}])}(),function(){angular.module("serviceExpert").filter("orderObjectBy",function(){return function(e,t,i){var s=[];return angular.forEach(e,function(e){s.push(e)}),s.sort(function(e,i){return e[t]>i[t]?1:-1}),i&&s.reverse(),s}})}(),function(){angular.module("serviceExpert").filter("pagination",["servicesService",function(e){return function(t,i,s){e.filter.totalServices=t.length,parseInt(e.filter.currentPage)>e.filter.totalPages&&(e.filter.currentPage="1",i=1);var n=[],r=(i-1)*s,a=(i-1)*s+s;return n=t.length<=s?t:t.slice(r,a),t.length==e.filter.servicesPerPage?e.filter.totalPages=1:(e.filter.totalPages=Math.floor(t.length/e.filter.servicesPerPage),t.length%e.filter.servicesPerPage>0&&e.filter.totalPages++),e.filter.firstVisibleService=r+1,e.filter.lastVisibleService=a,t.length<=s?e.filter.lastVisibleService=t.length:a>t.length&&(e.filter.lastVisibleService=t.length),n}}])}(),function(){angular.module("serviceExpert").filter("replaceLabels",function(){return function(e){for(var t=e,i=arguments.length,s=Array(i>1?i-1:0),n=1;i>n;n++)s[n-1]=arguments[n];for(var r=0;r<s.length;r++)t=t.replace("$"+r,s[r]);return t}})}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){angular.module("serviceExpert").filter("servicesListFilter",["utils","$filter","servicesService","userSettingsManager","ServiceSelectorService","SERVICE_STATUS","SERVICE_CATEGORY",function(e,t,i,s,n,r,a){function o(t,i,s){if(t.name&&-1!=t.name.toLowerCase().indexOf(i.toLowerCase()))return!0;if(t.ganttLabel&&-1!=t.ganttLabel.toLowerCase().indexOf(i.toLowerCase()))return!0;if(t.accountName&&-1!=t.accountName.toLowerCase().indexOf(i.toLowerCase()))return!0;if(t.resourceName&&-1!=t.resourceName.toLowerCase().indexOf(i.toLowerCase()))return!0;if(t.id&&-1!=t.id.toLowerCase().indexOf(i.toLowerCase()))return!0;if(t.serviceTerritoryName&&-1!=t.serviceTerritoryName.toLowerCase().indexOf(i.toLowerCase()))return!0;if(t.status&&-1!=t.status.toLowerCase().indexOf(i.toLowerCase()))return!0;for(var n=0;n<s.length;n++)if((s[n].Type==e.fieldsTypes.String||s[n].Type==e.fieldsTypes.TextArea||s[n].Type==e.fieldsTypes.Reference||s[n].Type==e.fieldsTypes.Picklist)&&t[s[n].APIName]&&-1!=t[s[n].APIName].toLowerCase().indexOf(i.toLowerCase()))return!0;return!1}function c(e,t,i,s){var n=new Date(s);return"undefined"!=typeof t.earlyStart&&t.earlyStart&&e.earlyStart&&e.earlyStart>i&&e.earlyStart<=n?!0:"undefined"!=typeof t.dueDate&&t.dueDate&&e.dueDate&&e.dueDate>i&&e.dueDate<=n?!0:"undefined"!=typeof t.appStart&&t.appStart&&e.appStart&&e.appStart>i&&e.appStart<=n?!0:"undefined"!=typeof t.appEnd&&t.appEnd&&e.appEnd&&e.appEnd>i&&e.appEnd<=n?!0:"undefined"!=typeof t.finish&&t.finish&&e.finish&&e.finish>i&&e.finish<=n?!0:"undefined"!=typeof t.start&&t.start&&e.start&&e.start>i&&e.start<=n?!0:!1}function l(e,t,i){var s=new Date(e.minDate);s.setHours(0),s.setMinutes(0);var n=new Date(e.maxDate);n.setDate(n.getDate()+1),n.setHours(0),n.setMinutes(0);for(var r in t)if(t[r]&&u(i,r,s,n))return!0;return!1}function u(e,t,i,s){if("undefined"==typeof e[t])return!1;var n=e[t];return n>=i&&s>=n?!0:!1}function d(e,t){return e.priority<=t}function v(e,t){return e.jeopardy&&!t.jeopardies?!1:e.violations&&!t.violations?!1:null!==e.start_date||t.unScheduled?!0:!1}function p(e,t,i){if(i&&!e.location)return!0;for(var s in t)if(e.serviceTerritoryName==s&&t[s])return!0;return!1}function g(e){if(void 0==s.GetUserSettingsProperty("Filters__c"))return null;for(var t="object"==_typeof(s.GetUserSettingsProperty("Filters__c"))?s.GetUserSettingsProperty("Filters__c"):JSON.parse(s.GetUserSettingsProperty("Filters__c")),i=0;i<t.length;i++)if(t[i].name==e)return t[i].filter;return null}return function(s,r,u,h){var m=h&&h[r.selectedFilter]&&h[r.selectedFilter].old;if(useNewFilters&&!m)return t("servicesListFilterNew")(s,r,u);var f=[],S=new Date(r.endDate),b=e.addDaysToDate(S,-e.ganttSettings.backHorizon),y=scheduler.getState().min_date,_=scheduler.getState().max_date,T=g(r.selectedFilter),w=null,L=[];r.SearchText.indexOf(",")>-1&&(w=r.SearchText.replace(/, /g,",").split(","),""===w[w.length-1]&&w.length--),w?L=w:L.push(r.SearchText);for(var k in s)for(var C=0;C<L.length;C++){var R=o(s[k],L[C],u),D=c(s[k],r.selectedFiled,b,S);if("Selected"==r.selectedFilter){if(n.SelectedServices[k]&&n.SelectedServices[k]&&R){f.push(s[k]);break}}else if("Flagged"==r.selectedFilter&&R){if(i.flagged[k]){f.push(s[k]);break}}else if("Recent"==r.selectedFilter&&R){if(i.recentlyUsed[k]){f.push(s[k]);break}}else if("Todo"==r.selectedFilter){if((s[k].statusCategory==a.NONE||s[k].violations||s[k].jeopardy)&&s[k].statusCategory!=a.CANCELED&&s[k].statusCategory!=a.COMPLETED&&D){if(L[C].length>1&&R){f.push(s[k]);break}if(L[C].length<=1){f.push(s[k]);break}}}else if("All"==r.selectedFilter){if(D){if(L[C].length>1&&R){f.push(s[k]);break}if(L[C].length<=1){f.push(s[k]);break}}}else if("Unscheduled"==r.selectedFilter){if(!s[k].resource&&s[k].statusCategory!=a.CANCELED&&D){if(L[C].length>1&&R){f.push(s[k]);break}if(L[C].length<=1){f.push(s[k]);break}}}else if("Violating"==r.selectedFilter){if(s[k].violations&&s[k].statusCategory!=a.CANCELED&&D){if(L[C].length>1&&R){f.push(s[k]);break}if(L[C].length<=1){f.push(s[k]);break}}}else if("inJeopardy"==r.selectedFilter){if(s[k].jeopardy&&s[k].statusCategory!=a.CANCELED&&D){if(L[C].length>1&&R){f.push(s[k]);break}if(L[C].length<=1){f.push(s[k]);break}}}else if("Scheduled"==r.selectedFilter){if(s[k].resource&&D){if(L[C].length>1&&R){f.push(s[k]);break}if(L[C].length<=1){f.push(s[k]);break}}}else if("Gantt filter"==r.selectedFilter){if(s[k].resource&&(s[k].start<=_&&s[k].start>=y||s[k].finish<=_&&s[k].finish>=y)){if(L[C].length>1&&R){f.push(s[k]);break}if(L[C].length<=1){f.push(s[k]);break}}}else if("Contractors filter"==r.selectedFilter){if(s[k].resourceContractor&&D){if(L[C].length>1&&R){f.push(s[k]);break}if(L[C].length<=1){f.push(s[k]);break}}}else if("Cancelled filter"==r.selectedFilter){if(s[k].statusCategory==a.CANCELED&&D){if(L[C].length>1&&R){f.push(s[k]);break}if(L[C].length<=1){f.push(s[k]);break}}}else if("Crews filter"==r.selectedFilter){if(s[k].isAssignToCrew){if(L[C].length>1&&R){f.push(s[k]);break}if(L[C].length<=1){f.push(s[k]);break}}else if(void 0!=s[k].parentFields.MinimumCrewSize||void 0!=s[k].parentFields.RecommendedCrewSize){if(L[C].length>1&&R){f.push(s[k]);break}if(L[C].length<=1){f.push(s[k]);break}}}else if(T&&T.statusCheckboxs[statusTranslations[s[k].status]]&&l(T,r.selectedFiled,s[k])&&d(s[k],T.servicePriority)&&v(s[k],T)&&p(s[k],T.locationsCheckboxs,T.noLocation)){if(L[C].length>1&&R){f.push(s[k]);break}if(L[C].length<=1){f.push(s[k]);break}}}return t("orderBy")(f,r.orderByField,r.reverse)}}])}(),function(){function e(e,o,c,l,u,d,v,p,g,h,m,f,S,b,y){var _=(new Date).getTime();return setInterval(function(){return _+=6e4},6e4),y.register("positions",function(e){var t=c.getResources();for(var i in e)t[i]&&(t[i].lastKnownLongitude=e[i].longitude,t[i].lastKnownLocationDate=e[i].lastModifiedDate.getTime()-1e3*e[i].lastModifiedDate.getTimezoneOffset()*60,t[i].lastKnownLatitude=e[i].latitude)}),function(u,f,b,y,T,w){function L(e){return e.lastKnownLocationDate&&e.lastKnownLocationDate&&e.onlineOffset&&(e.lastSeen=parseInt((_-e.lastKnownLocationDate)/1e3/60),e.lastKnownLocationDate+60*e.onlineOffset*1e3>_)?(e.online=!0,!0):(e.online=!1,!1)}function k(e,t){var i=c.getResources()[e.resourceId].sobject[m.resourceFieldToSortyBy],s=c.getResources()[t.resourceId].sobject[m.resourceFieldToSortyBy],n=m.descending?1:-1;return i>s?n:s>i?-1*n:0}var C=[],R={},D=[],A=f.replace(/, /g,",").split(","),I=l.resourcesAndTerritories(),F=l.resourceToServiceCrewMembers(),x=o.getTerritoriesSortedByTree();if(x.forEach(function(e){C.push(new r(e,c.operatingHours[e.operatingHours],h)),R[e.id]=C.length-1}),b)for(var M in y)y[M]&&D.push(M);var O=p.GetUserSettingsProperty("locations"),P=e.ganttSettings&&e.ganttSettings.filterCandidates;for(var E in I){var N=I[E],$=c.getResources()[E];if($&&i($.name,A)&&(!b||d.doesHaveSkills(E,D,scheduler._min_date,scheduler._max_date))){var B=!1;for(var H in w.resourceFilteringOptions)if(w.resourceFilteringOptions[H]&&!$.sobject[H]){B=!0;break}if(!B){if("select_a_field"!==w.selectedPicklist){if(w.picklistOptions.length>0&&-1===w.picklistOptions.indexOf($.sobject[w.selectedPicklist])){if(!w.picklistNullValues)continue;if("undefined"!=typeof $.sobject[w.selectedPicklist])continue}if(0===w.picklistOptions.length&&w.picklistNullValues&&"undefined"!=typeof $.sobject[w.selectedPicklist])continue}if(l.isCrewViewActive){var G=l.currentCrewToShow;if(void 0===G[E])continue;if(void 0!==G[E].members){var V=!1;for(var U in G[E].members){var j,z;if(useLocationTimezone)for(var q in N)n(scheduler._min_date,scheduler._max_date,N[q].effectiveStartDate,N[q].effectiveEndDate)&&(j=e.convertDateBetweenTimeZones(G[E].members[U].startDate,"GMT",N[q].timezone),z=e.convertDateBetweenTimeZones(G[E].members[U].endDate,"GMT",N[q].timezone),n(scheduler._min_date,scheduler._max_date,j,z)&&(V=!0));else j=e.convertDateBetweenTimeZones(G[E].members[U].startDate,"GMT",userTimeZone),z=e.convertDateBetweenTimeZones(G[E].members[U].endDate,"GMT",userTimeZone),n(scheduler._min_date,scheduler._max_date,j,z)&&(V=!0)}if(V===!1)continue}}if(w.crewsSelectionOptions.selectedPicklist!==customLabels.showAll){if(e.crewsFilter=!0,w.crewsSelectionOptions.selectedPicklist===customLabels.hideCrewMembers){if("C"!==$.sobject.ResourceType){var W=!1;for(var K in F[E])n(scheduler._min_date,scheduler._max_date,F[E][K].startDate,F[E][K].endDate)&&(W=!0);if(W===!0)continue}}else if(w.crewsSelectionOptions.selectedPicklist===customLabels.showCrewsAndCrewMembers){if("C"!==$.sobject.ResourceType){var Z=!1;for(var J in F[E])n(scheduler._min_date,scheduler._max_date,F[E][J].startDate,F[E][J].endDate)&&(Z=!0);if(Z!==!0)continue}}else if(w.crewsSelectionOptions.selectedPicklist===customLabels.showOnlyCrews){if("C"!==$.sobject.ResourceType)continue}else if(w.crewsSelectionOptions.selectedPicklist===customLabels.hideCrewsAndCrewMembers){if("C"===$.sobject.ResourceType)continue;var X=!1;for(var Y in F[E])n(scheduler._min_date,scheduler._max_date,F[E][Y].startDate,F[E][Y].endDate)&&(X=!0);if(X===!0)continue}}else e.crewsFilter=!1;if(!P||!g.getCandidatesIds()||g.getCandidatesIds()[E])for(var Q in N){var ee=e.generateResourceId(N[Q].serviceResource,N[Q].serviceTerritory);if((!T.showWorkingResource||t(ee,v,e))&&(!O||-1!=O.indexOf(N[Q].serviceTerritory))&&n(scheduler._min_date,scheduler._max_date,N[Q].effectiveStartDate,N[Q].effectiveEndDate)){var te=C[R[N[Q].serviceTerritory]],ie=new a(e.generateResourceId,c.getResources()[N[Q].serviceResource],N[Q].serviceTerritory,L(c.getResources()[N[Q].serviceResource]),!1,s(N[Q]));-1===te.children.map(function(e){return e.key}).indexOf(ie.key)&&te.children.push(ie)}}}}}var se=[],ne=0;return C.forEach(function(e,t){return 0===e.children.length&&se.push(t)}),se.forEach(function(e){return C.splice(e-ne++,1)}),C.forEach(function(e){return e.children.sort(k)}),e.hasCustomPermission("Utilization_on_Service_Territory")&&showDailyUtilization&&"MonthlyView"!==scheduler._mode&&"MTDView"!==scheduler._mode&&C.forEach(function(e){for(var t=void 0,i=[],s=new Date(scheduler._min_date);s<scheduler._max_date;s.setDate(s.getDate()+1))i.push(S.calculateLocation(e.children,s));var n=i.reduce(function(e,t){return e["break"]+=t["break"],e.capacity+=t.capacity,e.overtime+=t.overtime,e.service+=t.service,e.travel+=t.travel,e.na+=t.na,e},{"break":0,capacity:0,overtime:0,service:0,travel:0,na:0});t=S.calculateLocationUtilization(n),e.addUtilizationHtml(t)}),C}}function t(e,t,i){var s=new Date(scheduler._min_date),n=t.resourceToWorkingDates[e];if(!n)return!1;for(;s<scheduler._max_date;){var r=n[i.formatDayToString(s)];if(r&&(r.regular>0||r.overtime>0))return!0;s.setDate(s.getDate()+1)}return!1}function i(e,t){if(0===t.length)return!0;for(var i=0;i<t.length;i++)if(e.toLowerCase().indexOf(t[i].toLowerCase())>-1)return!0;return!1}function s(e){return"S"==e.serviceTerritoryType}function n(e,t,i,s){return isIntersect(e,t,i,s)}function r(e,t,i){this.key=e.id,this.name=e.name,this.children=[],this.generateHtml(e,t.timezone),void 0===i.ganttOpenedTerritories[e.id]&&(i.ganttOpenedTerritories[e.id]=!0),this.open=i.ganttOpenedTerritories[e.id]}function a(e,t,i,s,n,r){this.key=e(t.id,i),this.resourceId=t.id,this.name=t.name,this.contractor=t.isCapacityBased,this.online=s,this.lastSeen=t.lastSeen,this.secondary=r,this.isUndestaffOrOverstaff=n,t.isUndestaffOrOverstaff=n,this.generateHtml(t)}angular.module("serviceExpert").filter("timelineFilter",e),e.$inject=["utils","LocationFilteringService","ResourcesAndTerritoriesService","TimePhasedDataService","ResourceCrewsService","SkillsService","calendarsService","userSettingsManager","GetSlotsService","StateService","resourceFilterHelper","LastKnownPositionService","monthlyViewHelperService","DeltaService","RegisterService"],r.prototype.generateHtml=function(e,t){if(e.parentTerritory?this.label="<div class='truncate ParentName'>"+e.parentTerritory.name+"</div><div class='truncate LocationName'>"+e.name+"</div>":this.label="<div class='truncate LocationName'>"+e.name+"</div>","MonthlyView"!==scheduler._mode&&"MTDView"!==scheduler._mode){var i=new Date,s=e.parentTerritory?"margin-top:-26px;":"";i=new Date(i.valueOf()+6e4*i.getTimezoneOffset()),i.setMinutes(i.getMinutes()+utils.getLocationOffset(i,e.id)),this.label+="<div class='timeZoneFolder' style=\""+s+'">'+t+" - "+moment(i).format("llll")+"</div>"}},r.prototype.addUtilizationHtml=function(e){var t=this.label.indexOf("Parent")>-1?'style="margin-top: -9px"':"",i=this.label.indexOf("</div>"),s="green-daily-utlz";if(e>=monthlyViewSettings.high&&e<monthlyViewSettings.critical?s="yellow-daily-utlz":e>=monthlyViewSettings.critical&&(s="red-daily-utlz"),null!==e){var n='<b class="'+s+'">'+e+"%</b>";e='<div class="dailyViewUtilization" '+t+">"+customLabels.UtilizationDaily.replace("$0",n)+" </div>",this.label=this.label.slice(0,i+6)+e+this.label.slice(i+6)}},a.prototype.generateHtml=function(e){this.label="";var t=this.online?"online-indicator":"online-indicator offline-indicator",i=this.secondary?"<span class='secondaryGanttLabel' title=\""+customLabels.Secondary+'">('+customLabels.Secondary+")</span>":"",s=e.lastKnownLocationDate&&this.lastSeen<1440?'<div class="'+t+'" title="'+utils.hoursMinutes(this.lastSeen,customLabels.SeenXMinsHoursAgo,customLabels.SeenXAgoHours,customLabels.SeenXAgo)+'"></div>':"";if(void 0!=e.serviceCrew__r){var n=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourceCrewPhoto":"ResourceCrewPhoto",r="";e.pictureLink?this.label+="<img src='"+e.pictureLink+"' title='"+e.description+"' class='"+n+"' />":this.label+="<span class='"+n+'\'><svg aria-hidden="true" class="crew-slds-icon crewContextMenuIcon"><use xlink:href=\''+lsdIcons.crew+"'></use></svg></span>",this.label+=""+r+s}else if(e.pictureLink){var a=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourcePhoto":"ResourcePhoto";this.label+="<img src='"+e.pictureLink+"' title='"+e.description+"' class='"+a+"' />"+s}else{var o=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourcePhotoDefault":"NormalResourcePhotoDefault";this.label+="<div title='"+e.description+"' class=\"ResourcePhotoIcon "+o+'"></div>'+s}this.label+='<div class="resourceMenuBtn">\n                            <svg aria-hidden="true" class="slds-icon resourceMenuIcon">\n                                <use xlink:href="'+lsdIcons.threedots+'"></use>\n                            </svg>\n                        </div>',e.ganttLabel?scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.id+"' title='"+e.description+"'>"+this.name+" "+i+"</a>\n                <div class='smallResourceGanttLabel truncate'>"+e.ganttLabel+"</div>":this.label+="<a resource='"+this.id+"' class='smallResourceName' title='"+e.description+"'>"+this.name+" "+i+"</a>\n                <div class='resourceGanttLabel truncate'>"+e.ganttLabel+"</div>":scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.id+"' class='smallResourceName' style='margin-top:6px;' title='"+e.description+"'>"+this.name+" "+i+"</a>":this.label+="<a resource='"+this.id+"' style='margin-top:6px;' title='"+e.description+"'>"+this.name+" "+i+"</a>"}}(),function(){angular.module("serviceExpert").filter("toArray",function(){return function(e){var t=[];return angular.forEach(e,function(e,i){t.push(e)}),t}})}(),function(){function stringifySingleCondition(e,t,i){if(e[getPropertyName(t.property)]||e[getPropertyName(t.property)]===!1||(e[getPropertyName(t.property)]=""),"FSL__RULE_VIOLATIONS__FSL"===t.property){var s="true"===t.value.toString();return"equals"===t.operator&&s||"not equal to"===t.operator&&!s?"(Array.isArray(__evalRealService.violations) && __evalRealService.violations.length > 0)":"(!__evalRealService.violations || (Array.isArray(__evalRealService.violations) && __evalRealService.violations.length === 0))"}var n=evaluateOperator(t.operator);if(t.value&&t.value.indexOf&&t.value.indexOf(",")>-1&&(t.value=t.value.replace(/, /g,",").split(",")),Array.isArray(t.value))return t.value=t.value.map(function(e){return e.toLowerCase?e.toLowerCase():e}),__picklistArrayForFilter[i]=t.value,evaluateArrayValue(t.operator,t.property,i);if(evaluateValue(t.property,t.value,__ganttFilterFieldSet,i),n){var r=__ganttFilterFieldSet[t.property].Type;return"STRING"===r||"TEXTAREA"===r||"EMAIL"===r||"REFERENCE"===r?"__evalService."+getPropertyName(t.property)+".toLowerCase() "+evaluateOperator(t.operator)+" __evalConditionValue."+t.property+"_"+i+".toLowerCase()":"__evalService."+getPropertyName(t.property)+" "+evaluateOperator(t.operator)+" __evalConditionValue."+t.property+"_"+i}return evaluateSepcialOperator(t.operator,t.value,t.property)}function evaluateArrayValue(e,t,i){switch(e){case"contains":return"new RegExp(__picklistArrayForFilter["+i+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === true";case"does not contain":return"new RegExp(__picklistArrayForFilter["+i+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === false";case"start with":return"new RegExp('^' + __picklistArrayForFilter["+i+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === true";case"equals":return"__picklistArrayForFilter["+i+"].indexOf(__evalService."+getPropertyName(t)+".toLowerCase()) > -1";case"not equal to":return"__picklistArrayForFilter["+i+"].indexOf(__evalService."+getPropertyName(t)+".toLowerCase()) === -1";default:return"__picklistArrayForFilter["+i+"].some( element => __evalService."+getPropertyName(t)+" "+evaluateOperator(e)+" element)"}}function getPropertyName(e){return"FSL__RULE_VIOLATIONS__FSL"===e?"FSL__RULE_VIOLATIONS__FSL":removeNamespace(__ganttFilterFieldSet[e].APIName)}function evaluateCondition(service,conditions,logic){var serviceFields=service.fields;window.__evalService=serviceFields,window.__evalRealService=service;var stringConditions=logic?replaceLogicOperators(logic):"",conditionsMapped={};for(var i in conditions)conditionsMapped[i]=stringifySingleCondition(serviceFields,conditions[i],i-1),logic||(stringConditions+="{"+i.toString()+"} && ");logic||(stringConditions=stringConditions.substr(0,stringConditions.length-3));for(var _i in conditionsMapped)stringConditions=stringConditions.replace("{"+_i+"}",conditionsMapped[_i]);return eval(stringConditions)}function evaluateValue(e,t,i,s){if(!i[e])return void(window.__evalConditionValue[e]=null);switch(i[e].Type){case"BOOLEAN":window.__evalConditionValue[e+"_"+s]=t===!0;break;case"DATE":case"DATETIME":window.__evalConditionValue[e+"_"+s]=new Date(t);break;case"STRING":case"EMAIL":case"TEXTAREA":case"REFERENCE":t?window.__evalConditionValue[e+"_"+s]=t.toLowerCase():window.__evalConditionValue[e+"_"+s]="";break;default:window.__evalConditionValue[e+"_"+s]=t}}function evaluateOperator(e){switch(e){case"equals":return"==";case"not equal to":return"!=";case"less than":return"<";case"greater than":return">";case"less or equal":return"<=";case"greater or equal":return">=";default:return null}}function evaluateSepcialOperator(e,t,i){switch(e){case"contains":return"__evalService."+getPropertyName(i)+".toLowerCase().indexOf('"+t.toLowerCase()+"') > -1";case"does not contain":return"__evalService."+getPropertyName(i)+".toLowerCase().indexOf('"+t.toLowerCase()+"') === -1";case"start with":return"__evalService."+getPropertyName(i)+".toLowerCase().indexOf('"+t.toLowerCase()+"') === 0"}}function replaceLogicOperators(e){return e=e.split("AND").join("&&"),e=e.split("OR").join("||"),e=e.split("NOT").join("!")}function removeNamespace(e){if(fslNamespace&&0===e.indexOf(fslNamespace)){var t=fslNamespace.length+2;return e.substr(t,e.length-t)}return e}function isServiceInDateRange(e,t,i,s){var n=scheduler._min_date,r=scheduler._max_date;return s.List_only_appointments_on_the_gantt?e.end_date&&isIntersectIncludeLimits(n,r,e.end_date,e.end_date)?!0:e.start_date&&isIntersectIncludeLimits(n,r,e.start_date,e.start_date)?!0:!1:(n=new Date(i),r=new Date(i),n.setDate(n.getDate()-s.Days_before_horizon),r.setDate(r.getDate()+s.Days_after_horizon+1),t.earlyStart&&e.EarliestStartTime&&isIntersectIncludeLimits(n,r,e.EarliestStartTime,e.EarliestStartTime)?!0:t.dueDate&&e.DueDate&&isIntersectIncludeLimits(n,r,e.DueDate,e.DueDate)?!0:t.start&&e.start&&isIntersectIncludeLimits(n,r,e.start,e.start)?!0:t.finish&&e.finish&&isIntersectIncludeLimits(n,r,e.finish,e.finish)?!0:t.appStart&&e.appStart&&isIntersectIncludeLimits(n,r,e.appStart,e.appStart)?!0:t.appEnd&&e.appEnd&&isIntersectIncludeLimits(n,r,e.appEnd,e.appEnd)?!0:!1)}function searchOnService(e,t,i){if(e.name&&-1!=e.name.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.ganttLabel&&-1!=e.ganttLabel.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.accountName&&-1!=e.accountName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.resourceName&&-1!=e.resourceName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.id&&-1!=e.id.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.serviceTerritoryName&&-1!=e.serviceTerritoryName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.status&&-1!=e.status.toLowerCase().indexOf(t.toLowerCase()))return!0;for(var s=0;s<i.length;s++)if((i[s].Type==utils.fieldsTypes.String||i[s].Type==utils.fieldsTypes.TextArea||i[s].Type==utils.fieldsTypes.Reference||i[s].Type==utils.fieldsTypes.Picklist)&&e[i[s].APIName]&&-1!=e[i[s].APIName].toLowerCase().indexOf(t.toLowerCase()))return!0;return!1}window.__ganttFilterFieldSet={},window.__picklistArrayForFilter=[],window.__evalConditionValue={},angular.module("serviceExpert").filter("servicesListFilterNew",["utils","$filter","GanttFilterService","FieldSetFieldsService",function(e,t,i,s){return s.fieldsSetFields().then(function(e){e.ganttFilter.forEach(function(e){return __ganttFilterFieldSet[e.FullAPIName]=e})}),function(e,s,n){var r=[],a=i.getFilterById(s.selectedFilter);if(a){var o=null,c=[];s.SearchText.indexOf(",")>-1&&(o=s.SearchText.replace(/, /g,",").split(","),""===o[o.length-1]&&o.length--),o?c=o:c.push(s.SearchText);for(var l in e){if(s.SearchText){for(var u=!1,d=0;d<c.length;d++)if(searchOnService(e[l],c[d],n)){u=!0;break}if(!u)continue}s.pivotDate=new Date(s.endDate),s.pivotDate.setHours(0),s.pivotDate.setMinutes(0),isServiceInDateRange(e[l],s.selectedFiled,s.pivotDate,a)&&evaluateCondition(e[l],a.Criterias,a.Logic)&&r.push(e[l])}}else for(var v in e)r.push(e[v]);return t("orderBy")(r,s.orderByField,s.reverse)}}])}(),function(){function e(){function e(e,t,i,s,n,r,a,o,c){e.bulkActionsOrder=bulkActionsOrder,e.actionNames={Schedule:{name:customLabels.Schedule,icon:lsdIcons.calendar},Dispatch:{name:customLabels.Dispatch,icon:lsdIcons.dispatch},Optimize:{name:customLabels.Optimize,icon:lsdIcons.magicwand},"Flag-Unflag":{name:customLabels.Flag_Unflag,icon:lsdIcons.flag},Unschedule:{name:customLabels.Unschedule,icon:lsdIcons.na}},e.checkHasCustomPermission=function(e){return void 0==i.hasCustomPermission("Bulk_"+e)?!0:i.hasCustomPermission("Bulk_"+e)},e.openBulkAction=function(e){switch(e){case"Schedule":o.schedule(r.getSelected());break;case"Dispatch":s.open();break;case"Unschedule":n.open();break;case"Optimize":a.open();break;case"Flag-Unflag":for(var i=r.getSelected(),c=0;c<i.length;c++)t.flagged[i[c]]=!t.flagged[i[c]];scheduler.updateView()}}}e.$inject=["$scope","servicesService","utils","bulkDispatchService","bulkUnscheduleService","ServiceSelectorService","optimizeLightboxService","bulkScheduleService","rdOptimizeLightboxService"];var t='<div id="quickActionsButtons">\n			                    <div id="actionQuickFirst" class="truncate quickActionBtn" ng-show="bulkActionsOrder.first.length && checkHasCustomPermission(actionNames[bulkActionsOrder.first[0].title].name)" ng-click="openBulkAction(bulkActionsOrder.first[0].title)" title="{{actionNames[bulkActionsOrder.first[0].title].name}}">\n									{{actionNames[bulkActionsOrder.first[0].title].name}}\n								</div>\n	                        	<div id="actionQuickSecond"\n									 class="truncate quickActionBtn"\n									 ng-show="bulkActionsOrder.second.length && checkHasCustomPermission(actionNames[bulkActionsOrder.second[0].title].name)"\n									 ng-click="openBulkAction(bulkActionsOrder.second[0].title)"\n									 title="{{actionNames[bulkActionsOrder.second[0].title].name}}">{{actionNames[bulkActionsOrder.second[0].title].name}}</div>\n		                    	<div class="truncate" id="ActionButton" ng-show="bulkActionsOrder.dropdown.length" cs-toggle="MainActionContainer">\n                                    <span ng-show="(!bulkActionsOrder.first.length &&\n                                                   !bulkActionsOrder.second.length) ||\n                                                   (!checkHasCustomPermission(actionNames[bulkActionsOrder.first[0].title].name) &&\n                                                   !checkHasCustomPermission(actionNames[bulkActionsOrder.second[0].title].name))">\n                                           '+customLabels.Actions+'\n                                    </span>\n                                    <i class="fa fa-caret-down"></i>\n		                    	</div>\n	                    	</div>\n	                        <div id="MainActionContainer">\n			                    <div class="truncate BulkActionMenuItem" ng-repeat="action in bulkActionsOrder.dropdown" ng-show="checkHasCustomPermission(actionNames[action.title].name)" ng-click="openBulkAction(action.title)">\n									<svg aria-hidden="true" class="slds-icon mainActionIcon">\n										\u2028<use xlink:href="{{actionNames[action.title].icon}}"></use>\n									\u2028</svg>\n									{{actionNames[action.title].name}}</div>\n	                        </div>';
return{restrict:"E",template:t,scope:{},controller:e}}angular.module("serviceExpert").directive("bulkActionsButton",e),e.$inject=[]}(),function(){function e(){return customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n								<option value="all">'+customLabels.All+'</option>\n								<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n							</select>")}function t(){return customLabels.Use_the_following_policy_x_and_y.replace("$0",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions"></select>').replace("$1",'<select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n								 	<option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n								 	<option value="noFilter">'+customLabels.None+"</option>\n								 </select>")}function i(){return customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartChangeStatus" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartChangeStatus\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>').replace("$1",'<u id="bulkFinishChangeStatus" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishChangeStatus\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>')}function s(){return customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n							</select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>')}function n(){return customLabels.changeStatusBulkMsg.replace("$0",'<select class="selectChangeStatusBulk bulkStatusWidth" ng-model="bulkStatus">\n								<option ng-repeat="(statusType,statusLabel) in statuses" value="{{statusLabel}}" >{{getStatusTranslations()[statusLabel]}}</option>\n							</select>')}angular.module("serviceExpert").directive("bulkOptimizeOptions",function(){return{template:e()}}).directive("bulkOptimizePolicy",function(){return{template:t()}}).directive("bulkChangeStatusDates",function(){return{template:i()}}).directive("bulkUnscheduleDates",function(){return{template:s()}}).directive("bulkChangeStatusPicklist",function(){return{template:n()}})}(),function(){function e(){function e(e){e.colors=[{Name:"Red",Hex:"#E53935"},{Name:"Pink",Hex:"#D81B60"},{Name:"Purple",Hex:"#8E24AA"},{Name:"Indigo",Hex:"#3949AB"},{Name:"Blue",Hex:"#1E88E5"},{Name:"Cyan",Hex:"#00ACC1"},{Name:"Teal",Hex:"#00897B"},{Name:"Green",Hex:"#43A047"},{Name:"Lime",Hex:"#C0CA33"},{Name:"Yellow",Hex:"#FDD835"},{Name:"Amber",Hex:"#FFB300"},{Name:"Orange",Hex:"#FB8C00"},{Name:"Brown",Hex:"#6D4C41"},{Name:"Grey",Hex:"#757575"},{Name:"Blue Grey",Hex:"#546E7A"},{Name:"Black",Hex:"#000"}],e.selectColor=function(t){e.selectedColor=t.Hex,e.setSelectedShapeColor(t.Hex),e.showColorMenu=!1},e.showMenuClick=function(t){(e.drawState==e.drawingStates.EDIT||e.drawState==e.drawingStates.DRAW)&&(e.showColorMenu=!e.showColorMenu)},e.selectedColor="#546E7A",e.showColorMenu=!1,angular.element("#mapOptionsContainer").on("click",function(t){for(var i=["color-square","color-button"],s=0;s<i.length;s++)if(t.target.classList.contains(i[s])||t.target.parentNode&&t.target.parentNode.classList.contains(i[s]))return;e.showColorMenu&&(e.showColorMenu=!1)})}e.$inject=["$scope"];var t='<div id="select-color-btn" title="'+customLabels.Select_color+'" class="color-button truncate"  ng-click="showMenuClick()" ng-class="{disabledButton: drawState != drawingStates.EDIT && drawState != drawingStates.DRAW}">\n                            <span class="color-square" ng-style="{\'background-color\': selectedColor}"></span><span>'+customLabels.Select_color+'</span>\n                        </div>\n                        <div class="color-menu" id="colorMenu" ng-show="showColorMenu == true">\n                            <span class="color-box" ng-repeat="color in colors" ng-click="selectColor(color)" ng-style="{\'background-color\': color.Hex}"></span>\n                        </div>';return{restrict:"E",template:t,scope:!1,controller:e}}angular.module("serviceExpert").directive("csColorPicker",e),e.$inject=[]}(),function(){angular.module("serviceExpert").directive("csRange",["$filter","utils",function(e,t){function i(i,s,n){var r=$($(s[0]).find(".showingDates")),a=isAMPM?"ampm":"24",o=$($(s[0]).find(".sliderSelector"));i.$watchCollection(n.ngModel,function(t,i){!o.slider("instance")||t.start===i.start&&t.end===i.end||(o.slider("values",[t.start,t.end]),r.text(n.showingText.replace("{1}",e("ampmOr24")(parseInt(t.start),a,!0)).replace("{2}",e("ampmOr24")(parseInt(t.end),a,!0))))}),o.slider({range:!0,min:parseInt(n.min),max:parseInt(n.max),values:[parseInt(n.defaultStart),parseInt(n.defaultEnd)],slide:function(t,i){r.text(n.showingText.replace("{1}",e("ampmOr24")(parseInt(i.values[0]),a,!0)).replace("{2}",e("ampmOr24")(parseInt(i.values[1]),a,!0)))},stop:function(e,s){t.safeApply(i,function(){i[n.ngModel].start=s.values[0],i[n.ngModel].end=s.values[1]})}}),r.text(n.showingText.replace("{1}",e("ampmOr24")(parseInt(n.defaultStart),a,!0)).replace("{2}",e("ampmOr24")(parseInt(n.defaultEnd),a,!0)))}return{restrict:"CAE",link:i,scope:!0,template:'<div class="sliderSelector"></div><span class="showingDates"></span>'}}])}(),function(){angular.module("serviceExpert").directive("safeBinder",[function(){function e(e,t,i){$(t[0]).html(e.safeBinder)}return{restrict:"A",scope:{safeBinder:"="},link:e}}])}(),function(){function e(){function e(e){e.callMe=function(e,t,i,s){var n=i+" "+s;return sendCTIMessage("/CLICK_TO_DIAL?DN="+encodeURIComponent(e)+"&amp;ID="+t+"&amp;ENTITY_NAME=User&amp;OBJECT_NAME="+encodeURIComponent(n)+"&amp;DISPLAY_NAME="+encodeURIComponent("User")),!1}}e.$inject=["$scope"];var t='<span class="tel" style="display: none;">\n                                <img src="/img/s.gif" alt="" width="1" height="1" title="" onload="if (self.registerClickToDial) registerClickToDial(this.parentNode, false);"></img>{{number}}\n                                <img src="/img/btn_nodial_inline.gif" alt="Click to dial disabled" width="16" height="10" title="Click to dial disabled"></img>\n                            </span> \n                            <span style="display: block;">\n                                <img src="/img/s.gif" alt="" width="1" height="1" title="" onload="if (self.registerClickToDial) registerClickToDial(this.parentNode, true);"></img>\n                                <a href="javascript:void(0);" onclick="disableClicked(this, \'Click to dial disabled\');" ng-click="callMe(number, userId, userFirstName, userLastName)" title="">{{number}}\n                                    <img src="/img/btn_dial_inline.gif" alt="Click to dial" width="16" height="10" title="Click to dial" style="display: inline;"></img>\n                                    <img src="/img/btn_nodial_inline.gif" alt="Click to dial disabled" width="16" height="10" style="display: none;" title="Click to dial disabled"></img>\n                                </a>\n                            </span>';return{restrict:"E",template:t,scope:{number:"@",userId:"@",userFirstName:"@",userLastName:"@"},controller:e}}angular.module("serviceExpert").directive("csClickToDial",e),e.$inject=[]}(),function(){angular.module("serviceExpert").directive("dhxScheduler",["$rootScope","$timeout","userSettingsManager","$q","sfdcService","ResourcesAndTerritoriesService","FieldSetFieldsService",function(e,t,i,s,n,r,a){return{restrict:"C",transclude:!0,template:'<div class="dhx_cal_navline" ng-transclude></div><div class="dhx_cal_header"></div><div class="dhx_cal_data"></div>',link:function(n,o,c){window.utils=angular.element("#serviceExpertApp").injector().get("utils"),n.$watch(c.resources,function(e){scheduler.updateCollection("resources",e)},!0),o.addClass("dhx_cal_container"),schedulerConfig.configTimelines(),schedulerConfig.setConfigurations();var l=i.GetUserSettingsProperty("Gantt_View_Start_Hour__c"),u=i.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),d=i.GetUserSettingsProperty("Resource_Row_Height__c"),v=i.GetUserSettingsProperty("View_Capacity_Type__c"),p=i.GetUserSettingsProperty("Include_Weekends__c"),g=i.GetUserSettingsProperty("Load_On_Today__c"),h=i.GetUserSettingsProperty("Lock_Gantt__c");null!=h&&schedulerConfig.setReadOnly(h),null!=d&&schedulerConfig.setRowHeights(d,!1),null!=v&&setCapacityFilter(v),null!=l&&null!=u&&setHoursToDisplay(l,u,p),e.policy=defaultPolicy;var m=s.all([r.promises.territories(),r.promises.resources(),a.fieldsSetFields()]);m.then(function(){scheduler.init(o[0],new Date,"ZoomLevel3"),n.scheduler=scheduler,n.datalessMethods=attchDatalessSchedulerEvents(),t(function(){switch(g&&scheduler.setCurrentView(new Date),n.getTimePhasedObjects().then(function(){$("#FirstTimeLoading").remove()})["catch"](function(e){bootstrap.handleError(e)}),scheduler._mode){case"ZoomLevel2":n.timelineName=customLabels.In_Day;break;case"ZoomLevel3":n.timelineName=customLabels.Daily;break;case"ZoomLevel4":n.timelineName=customLabels.X2_Days;break;case"ZoomLevel5":n.timelineName=customLabels.X3_Days;break;case"ZoomLevel6":n.timelineName=customLabels.Weekly}},0),e.$broadcast("initCompleted")}),function(e){console.log("err:"+e)}}}}])}(),function(){angular.module("serviceExpert").directive("dragNA",function(){return{restrict:"CAE",scope:{dragService:"="},link:function(e,t,i,s){cachedDomElements.draggedBreak||(cachedDomElements.draggedBreak=$("#draggedBreak")),cachedDomElements.draggedBreakDiv||(cachedDomElements.draggedBreakDiv=$("#draggedBreak div")),t.bind("dragstart",function(e){var t=$("#breakDuration").val();e.originalEvent.dataTransfer.setData("text","absenceNA_"+t),cachedDomElements.draggedBreakDiv.html(t);var i=getMinAndMaxHoursToDisplay(),s=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60),n=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60);n.setMinutes(n.getMinutes()+t);var r=getXPositionOfEvent({start_date:s,end_date:n},!1,scheduler.matrix[scheduler._mode]),a=getXPositionOfEvent({start_date:s,end_date:n},!0,scheduler.matrix[scheduler._mode]),o=a-r+4;cachedDomElements.draggedBreak.css("width",o+"px");var c=document.getElementById("draggedBreak").cloneNode(!0);document.body.appendChild(c);var l=window.DataTransfer;"setDragImage"in l.prototype&&e.originalEvent.dataTransfer.setDragImage(c,0,40)})}}})}(),function(){angular.module("serviceExpert").directive("draggableService",["utils","servicesService","SERVICE_STATUS","SERVICE_CATEGORY",function(e,t,i,s){return{restrict:"CAE",scope:{dragService:"="},link:function(t,i,n,r){cachedDomElements.draggedEvent||(cachedDomElements.draggedEvent=$("#draggedEvent")),cachedDomElements.draggedEventDiv||(cachedDomElements.draggedEventDiv=$("#draggedEvent div")),i.bind("dragstart",function(i){i.originalEvent.dataTransfer.setData("text",t.dragService.id);var n=t.dragService.ganttLabel?t.dragService.ganttLabel:t.dragService.name,r="<b>"+n+"</b><br/>"+t.dragService.estDuration+" "+t.dragService.durationType;cachedDomElements.draggedEventDiv.html(r);var a=getMinAndMaxHoursToDisplay(),o=new Date(scheduler._min_date.getTime()+1e3*a.min*60*60),c=new Date(scheduler._min_date.getTime()+1e3*a.min*60*60);t.dragService.durationType?t.dragService.durationType==e.durationTypes.minutes?c.setMinutes(c.getMinutes()+t.dragService.estDuration):t.dragService.durationType==e.durationTypes.hours?c.setMinutes(c.getMinutes()+Math.floor(60*t.dragService.estDuration)):t.dragService.durationType==e.durationTypes.days&&c.setMinutes(c.getMinutes()+Math.floor(60*t.dragService.estDuration*24)):t.dragService.setMinutes(c.getMinutes()+60);var l=getXPositionOfEvent({start_date:o,end_date:c},!1,scheduler.matrix[scheduler._mode]),u=getXPositionOfEvent({start_date:o,end_date:c},!0,scheduler.matrix[scheduler._mode]),d=u-l+4,v="";switch(t.dragService.statusCategory){case s.NONE:v=" eventStatusNew";break;case s.SCHEDULED:v=" eventStatusAssigned";break;case s.DISPATCHED:v="eventStatusDispatched";break;case s.IN_PROGRESS:v=" eventStatusTravel";break;case s.COMPLETED:v=" eventStatusCompleted";break;case s.COULD_NOT_COMPLETE:v=" eventStatusCouldntComplete";break;case s.CANCELED:v=" eventStatusCancelled";break;default:v=" eventCustomStatus"}cachedDomElements.draggedEvent.css("width",d+"px"),cachedDomElements.draggedEvent.removeClass(),cachedDomElements.draggedEvent.addClass(v),t.dragService.ganttColor?cachedDomElements.draggedEvent.css("background",t.dragService.ganttColor):cachedDomElements.draggedEvent.css("background","");var p=document.getElementById("draggedEvent").cloneNode(!0);document.body.appendChild(p);var g=window.DataTransfer;"setDragImage"in g.prototype&&i.originalEvent.dataTransfer.setDragImage(p,0,28)})}}}]).directive("dragTarget",["$rootScope","$filter","utils","servicesService","sfdcService","kpiCalculationsService","ResourcesAndTerritoriesService","AbsencesService","TimePhasedDataService","SERVICE_CATEGORY",function(e,t,i,s,n,r,a,o,c,l){return{restrict:"CAE",link:function(e,n,u,d){var v=Date.now();n.bind("dragover",function(e){if(cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix")),e.preventDefault(),!scheduler.config.readonly){var s=Date.now();if(!(500>s-v)){v=Date.now();var n=scheduler.getActionData(e.originalEvent),r=a.getResources()[n.section.split("_")[0]],o=n.section.split("_")[1];if(r&&o){var c=i.getLocationOffset(n.date,o)-i.getUserOffset(n.date),l=new Date(n.date);if(l.setMinutes(l.getMinutes()+c),r.name&&(!r.isCapacityBased||r.isCapacityBased&&!contractorSupport)){var u=new Date(n.date),d=n.date.getMinutes(),p=d%serviceJumpsOnGantt,g=serviceJumpsOnGantt-d%serviceJumpsOnGantt;u=p>g?new Date(u.getTime()+60*g*1e3):new Date(u.getTime()-60*p*1e3);var h=t("date")(u,"MMM d, y h:mm a"),m=new Date(u);m.setMinutes(m.getMinutes()+c);var f=t("date")(m,"MMM d, y h:mm a");e.originalEvent.ctrlKey?cachedDomElements.timesDragFix.html("<b>"+r.name+"</b> "+customLabels.SnapOn+" "+h+"<br/> "+(useLocationTimezone?"":customLabels.Location_time+" "+f)):cachedDomElements.timesDragFix.html("<b>"+r.name+"</b> "+customLabels.on+" "+h+"<br/> "+(useLocationTimezone?"":customLabels.Location_time+" "+f)),cachedDomElements.timesDragFix.show()}else cachedDomElements.timesDragFix.hide()}}}}),n.bind("dragleave",function(e){cachedDomElements.timesDragFix.hide(),e.preventDefault()}),n.bind("drop",function(t){if(t.preventDefault(),void 0!==cachedDomElements.draggedEvent&&cachedDomElements.draggedEvent.removeClass(),cachedDomElements.timesDragFix.hide(),!scheduler.config.readonly){var n=scheduler.getActionData(t.originalEvent),u=new Date(n.date),d=n.date.getMinutes(),v=d%serviceJumpsOnGantt,p=serviceJumpsOnGantt-d%serviceJumpsOnGantt;u=v>p?new Date(u.getTime()+60*p*1e3):new Date(u.getTime()-60*v*1e3),n.date=u;var g=a.getResources()[n.section.split("_")[0]];a.territories[n.section.split("_")[1]];if(g&&g.name){var h=t.originalEvent.dataTransfer.getData("text");if(h.indexOf("absenceNA_")>-1){$("#naOptionsContainer").hide();var m=h.substr(10,h.length-10);m=parseInt(m);var f=new Date(n.date);f.setMinutes(f.getMinutes()+m);var S={end_date:f,resource:g.id,start_date:n.date,start:n.date,absenceType:"None"==e.defaultDragNa.selectedNaType?null:e.defaultDragNa.selectedNaType,ganttLabel:e.defaultDragNa.selectedNaLabel};return void i.safeApply(e,function(){s.handleSnap(S,event),o.saveNewAbsence(S).then(function(e){s.drawServicesAndAbsences(e.services||[],e.absences||[])})["catch"](function(e){console.warn("Couldn't update absence"),e.error?i.addNotification(customLabels.Action_Could_Not_Be_Performed,e.error):i.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})})}var b=c.serviceAppointments()[h];if(b){var y=new Date(n.date),_=60;if(b.durationType?b.durationType==i.durationTypes.minutes?y.setMinutes(y.getMinutes()+b.estDuration):b.durationType==i.durationTypes.hours?y.setMinutes(y.getMinutes()+Math.floor(60*b.estDuration)):b.durationType==i.durationTypes.days&&y.setDate(y.getDate()+Math.floor(b.estDuration)):y.setMinutes(y.getMinutes()+_),contractorSupport&&g.isCapacityBased){for(var T=!1,w=!0,L=scheduler.getEvents(n.date,y),k=0;k<L.length;k++)L[k].resourceId.indexOf(n.section)>-1&&"contractorcapacity"==L[k].type&&(T=!0,L[k].timePeriod==i.ganttSettings.capacityDuration&&(w=!1));if(!T)return void alert(customLabels.serviceCantBeAssignedWithoutCapacity);w&&alert(customLabels.is_assigned_to_contractor.replaceAll(b.name,g.name)+".\n"+customLabels.This_capacity_duration_is_filtered_out+".\n"+customLabels.To_change_the_capacity_duration)}var C=angular.copy(b);C.end_date=y,C.resourceId=n.section,C.start_date=new Date(n.date),C.assignedResource=null;var R={statusCategory:l.SCHEDULED,isDummy:!0,id:null},D=void 0,A=angular.copy(C);for(var I in R)A[I]=R[I];D=scheduler.addEvent(A),i.safeApply(e,function(){s.handleSnap(C,t.originalEvent),s.saveChangesToServiceAppointment(b,C).then(function(e){e.absences.forEach(function(e){e.isScheduled()&&e.setGanttResource(c.resourcesAndTerritories(),i.generateResourceId)}),e.services.forEach(function(e){e.isScheduled()&&e.setGanttResource(c.resourcesAndTerritories(),i.generateResourceId)}),scheduler.deleteEvent(D),s.drawServicesAndAbsences(e.services||[],e.absences||[]),r.calculateKpis()})["catch"](function(e){console.warn("Couldn't update service. "+e[2]),i.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message||customLabels.user_is_not_allowed_to_perform_action),scheduler.deleteEvent(D)&&scheduler.parse([e[1]],"json")})})}}}})}}}])}(),function(){angular.module("serviceExpert").directive("googlePlaces",function(){return{restrict:"E",replace:!0,scope:{myMap:"=",searchMarker:"="},template:'<input id="google_places_ac" name="google_places_ac" type="text" class="input-block-level"/>',link:function(e,t,i){var s=new google.maps.places.Autocomplete($("#google_places_ac")[0],{});google.maps.event.addListener(s,"place_changed",function(){var t=s.getPlace();e.searchMarker?e.searchMarker.setPosition(t.geometry.location):e.searchMarker=new google.maps.Marker({map:e.myMap,position:t.geometry.location}),t.geometry.viewport?e.myMap.fitBounds(t.geometry.viewport):(e.myMap.setCenter(t.geometry.location),e.myMap.setZoom(17))})}}})}(),function(){angular.module("serviceExpert").directive("csGroupActions",["$compile",function(e){function t(t,i,s){function n(e,t,i){return Math.ceil($(e).offset().top)>=t+i}var r,a,o=$('<ul class="moreQuickActionsContainer"></ul>'),c=$(i).parent().parent().children();angular.element(i[0]).on("click",function(s){s.stopPropagation();var l=$(c).last(),u=$(c).first(),d=$(u).offset().top,v=$(u).outerHeight(!0);if(o.hasClass("viewMoreActive"))return o.removeClass("viewMoreActive"),o.empty(),void o.remove();if(n($(l),d,v)){for(var p=c.length-1;p>1;p--)if(r=$(c[p]),a=n(r,d,v)){var g=$("<li></li>");r.find("> div:first-child").clone().removeClass("quickActionGoLeft").addClass("menuQuickAction").css({marginBottom:"0",border:"none",width:"87%"}).appendTo(g),g.css({display:"block"}).appendTo(o),e(g)(t)}$(o.children().get().reverse()).appendTo(o),$(i).append(o),o.addClass("viewMoreActive"),o.show();var h=o.offset().top,m=o.outerHeight(!0);n($("#TaskListPagination"),h,m)||$("#TaskListItems").animate({scrollTop:$("#TaskListItems").scrollTop()+36*o.children().length},500)}angular.element("body").on("mousedown",function(e){for(var t=["moreQuickActionsBtn","menuQuickAction","fa-caret-down"],i=0;i<t.length;i++)if(e.target.classList.contains(t[i])||e.target.parentNode&&e.target.parentNode.classList.contains(t[i]))return;o.hasClass("viewMoreActive")&&(o.removeClass("viewMoreActive"),o.empty(),o.remove(),angular.element("body").off("mousedown"))})})}return{restrict:"A",link:t}}]).directive("csLastAction",["utils","SERVICE_STATUS","StateService",function(e,t,i){function s(s,n,r){var a=$(n),o=s.service,c=r.csLastAction;switch(c){case"edit":!o.pinned&&e.hasCustomPermission("Reshuffle")||o.isScheduled()&&(o.latitude||o.longitude)&&e.hasCustomPermission("Group_Nearby")||!o.pinned&&o.status==t.SCHEDULED||o.isScheduled()||i.isMapEnabled()&&(o.latitude||o.longitude)||a.hide();break;case"reshuffle":o.isScheduled()&&(o.latitude||o.longitude)&&e.hasCustomPermission("Group_Nearby")||!o.pinned&&o.status==t.SCHEDULED||o.isScheduled()||i.isMapEnabled()&&(o.latitude||o.longitude)||a.hide();break;case"groupNearby":!o.pinned&&o.status==t.SCHEDULED||o.isScheduled()||i.isMapEnabled()&&(o.latitude||o.longitude)||a.hide();break;case"dispatch":o.isScheduled()||i.isMapEnabled()&&(o.latitude||o.longitude)||a.hide();break;case"gantt":i.isMapEnabled()&&(o.latitude||o.longitude)||a.hide()}}return{restrict:"A",link:s}}])}(),function(){angular.module("serviceExpert").directive("keypressEvents",["$rootScope",function(e){var t=[13,16,18,27,37,38,39,40,48,49,50,51,55,69,70,73,77,79,83,84,85,87,90,96,97,98,99,103];return{restrict:"C",link:function(){angular.element("body").bind("keydown",function(i){t.indexOf(i.which)>-1?e.$broadcast("keypress",i):i.stopPropagation()})}}}])}(),function(){function e(e,t,i){function s(e){e.optimizationRequests={},e.optRunning=0,e.optQueued=0,e.replaceText=function(e,t){var i=customLabels[e];return i.replaceAll(t.toString())},i.register("optimizationRequests",function(i){for(var s=0,n=0,r=0;r<i.length;r++){var a=new OptimizationRequest(i[r]);"Queued"==a.status&&n++,"In Progress"==a.status&&s++,e.optimizationRequests[a.id]&&"Completed"==a.status&&"Completed"!=e.optimizationRequests[a.id].status&&t.addNotification(customLabels.Optimization_Completed,customLabels.x_services_were_sched_out_of.replaceAll(a.scheduledAmount,a.objectToScheduled)+".",function(e){t.openSObjectLink("../"+e)},a.id),e.optimizationRequests[a.id]&&"Failed"==a.status&&"Failed"!=e.optimizationRequests[a.id].status&&t.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){t.openSObjectLink("../"+e)},a.id),e.optimizationRequests[a.id]=a}e.optQueued=n,e.optRunning=s})}return{restrict:"E",link:s,scope:{},template:'\n                <div id="optInProgress" ng-show="optRunning">\n                    '+customLabels.Optimization_in_progress+"\n	            	<span ng-show=\"optRunning > 1\">{{ replaceText('XoptimizationRunning',optRunning) }}</span>\n	            	<span ng-show=\"optQueued\">{{ replaceText('XoptimizationQueued',optQueued) }}</span>\n        		</div>"}}e.$inject=["DeltaService","utils","RegisterService"],angular.module("serviceExpert").directive("optimizationIndicator",e)}(),function(){angular.module("serviceExpert").directive("csStopPropagation",[function(){function e(e,t,i){angular.element(t[0]).on(i.csStopPropagation,function(e){e.stopPropagation()})}return{restrict:"A",link:e}}])}(),function(){angular.module("serviceExpert").directive("csToggle",[function(){function e(e,t,i){for(var s=$("#"+i.csToggle),n=$("[cs-toggle]"),r={},a=0;a<n.length;a++){var o=$(n[a]);r[o.attr("id")]=$("#"+o.attr("cs-toggle"))}1===s.length&&(angular.element(t[0]).on("click",function(e){e.stopPropagation();for(var t in r)t!==e.currentTarget.id?(r[t].hide(),$(".dhx_mini_calendar").hide()):s.toggle()}),angular.element("body").on("click",function(e){for(var t in r)r[t].hide()}))}return{restrict:"A",link:e}}])}(),function(){angular.module("serviceExpert").factory("SERVICE_CATEGORY",function(){return{NONE:"None",SCHEDULED:"Scheduled",DISPATCHED:"Dispatched",IN_PROGRESS:"InProgress",COULD_NOT_COMPLETE:"CannotComplete",COMPLETED:"Completed",CANCELED:"Canceled"}})}(),function(){angular.module("serviceExpert").factory("SERVICE_STATUS",function(){return serviceStatuses})}(),function(){angular.module("serviceExpert").constant("dhtmlxDays",{Sunday:"0",Monday:"1",Tuesday:"2",Wednesday:"3",Thursday:"4",Friday:"5",Saturday:"6"})}(),function(){angular.module("serviceExpert").constant("PARENT_RECORD_TYPE",{WORKORDER:"WorkOrder",LINEITEM:"WorkOrderLineItem",ACCOUNT:"Account"})}(),function(){angular.module("serviceExpert").constant("DRAWING_STATES",{NONE:0,EDIT:1,DRAW:2,SELECTED:3,INTERSECT:4})}(),function(){angular.module("serviceExpert").constant("POST_MESSAGE_TYPE",{INIT:0,SHOW_ON_MAP:1,DRAW_MARKERS:2})}(),function(){angular.module("serviceExpert").factory("servicesService",["$q","$rootScope","sfdcService","utils","userSettingsManager","monthlyViewHelperService","TimePhasedDataService","ServiceAppointmentLightboxService","kpiCalculationsService","bulkResultsService","SERVICE_STATUS","SERVICE_CATEGORY","StateService","MstResolver",function(e,t,i,s,n,r,a,o,c,l,u,d,v,p){function g(e,t,i){var n={};e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]&&(n.partialResults=e.schedulingResult[0].PartialResults||[]),n.absences=a.updateTimePhaseData(e.na,"na").absences,n.services=a.updateTimePhaseData(e.services,"service").services,t.resolve(n),b.checkRules(s.getRelatedServices(i)).then(function(){return scheduler.updateView()})}function h(e){return e.isScheduled()?(e.setGanttResource(a.resourcesAndTerritories(),s.generateResourceId),!0):(scheduler._events[e.id]&&delete scheduler._events[e.id],!1)}var m=200,f=7,S=new Date;S.setDate(S.getDate()+3),window.globalStatuses=u,window.globalCategories=d;var b={servicesObjects:{},recentlyUsed:{},flagged:flaggedServices,filteredServices:{servicesArray:[]},filter:{advancedFilter:{statusCheckboxs:{New:!0,Assigned:!0,Dispatched:!0,Travel:!0,"On Site":!0,Incomplete:!0},selectedDates:{dueDate:!0,appEnd:!0,end_date:!0},minDate:new Date(Date.now()-6048e5),maxDate:new Date(Date.now()+6048e5),servicePriority:10,jeopardies:!0,violations:!0,unScheduled:!0},selectedFiled:{appEnd:!0,appStart:!0,dueDate:!0,earlyStart:!0,finish:!0,start:!0},selectedFilter:n.GetUserSettingsProperty("Selected_List_View__c")||(customPermissions.Service_List_Todo?"Todo":"All"),orderByField:"start",reverse:!1,SearchText:"",endDate:S,currentPage:1,servicesPerPage:200,totalServices:0,totalPages:1}};return s.ganttSettings&&(b.filter.servicesPerPage=parseInt(s.ganttSettings.servicesPerPage)),b.checkRules=function(t,n){var r=e.defer(),o=[],l=[],u=[],d=1,p=0,g=void 0,h=[],S={};if(Array.isArray(t)&&0===t.length)return r.resolve([]),r.promise;t.sort(function(e,t){return a.serviceAppointments()[e]||a.serviceAppointments()[t]?!a.serviceAppointments()[e]&&a.serviceAppointments()[t]?-1:a.serviceAppointments()[e]&&!a.serviceAppointments()[t]?1:a.serviceAppointments()[e].start==a.serviceAppointments()[t].start?0:a.serviceAppointments()[e].start>a.serviceAppointments()[t].start?1:-1:0});for(var y=t.slice(0);y.length>0;){p=0,g=null,S[d-1]={};for(var _=0;_<y.length;_++)if(S[d-1][y[_]]=!0,a.serviceAppointments()[y[_]]&&a.serviceAppointments()[y[_]].start){g||(g=moment(a.serviceAppointments()[y[_]].start));var T=moment(a.serviceAppointments()[y[_]].start);if(!(T.diff(g,"days")<=f&&m>p))break;p++}else p++;u.push(y.splice(0,p)),l.push(e.defer()),d++,l[l.length-1].promise.then(function(e){i.checkRules(u[e],v.selectedPolicyId).then(function(t){for(var i in t)if(delete S[e][i],t[i].length>0){if(!a.serviceAppointments()[i])continue;a.serviceAppointments()[i].violations=t[i],o.push(i)}else a.serviceAppointments()[i]&&(a.serviceAppointments()[i].violations=null);for(var s in S[e])"undefined"!=s&&a.serviceAppointments()[s]&&a.serviceAppointments()[s].resourceId&&h.push(s);l[e+1]?l[e+1].resolve(e+1):(c.calculateKpis(),r.resolve(o),h.length>0&&(debugMode&&console.log("Calling check rules again on "+h.length+" services"),n?n--:n=10,b.checkRules(h,n).then(function(){scheduler.updateView()})))})["catch"](function(e){s.addNotification(customLabels.Rule_validation_failed,e.message),r.reject(e),console.warn("rule checking failed"),console.log(e)})})}return l[0].resolve(0),r.promise},b.postToChatter=function(t,s){var n=e.defer();return i.postToChatter(t,s).then(function(e){n.resolve(e)}),n.promise},b.sortServicesByPriority=function(t){var s=e.defer();return i.sortServicesByPriority(t).then(function(e){s.resolve(e)}),s.promise},b.autoScheduleService=function(t){var n=e.defer();return void 0==window.userHasAdminPermissions&&i.userHasAdminPermissions().then(function(e){window.userHasAdminPermissions=e}),i.autoScheduleService(t,v.selectedPolicyId).then(function(e){if(e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]){var i=e.schedulingResult[0].PartialResults||[],r="";i.length>0&&(window.userHasAdminPermissions?i.forEach(function(e){r+=customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)+"<br/>"}):r+=customLabels.ContactSysAdmin,""!==r&&s.addNotification(customLabels.NotAllResult.replace("$0",e.schedulingResult[0].Service.AppointmentNumber),r))}return e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]&&e.schedulingResult[0].LongOperationId?void p.getUpdates(e.schedulingResult[0].LongOperationId).then(function(e){g(e,n,t)})["catch"](function(e){console.error(e),n.reject({eventType:"exception",message:e})}):void g(e,n,t)})["catch"](function(e){console.log(e),n.reject(e)}),n.promise},b.saveChangesToServiceAppointment=function(t,n){var r=e.defer(),o=new Date(n.start_date.getTime()+1e3*n.travelTo),c=new Date(n.end_date.getTime()-1e3*n.travelFrom);if(useLocationTimezone){var l=a.getIntersectingSrstOffset(n,n.getGanttResource()),u=s.getUserOffset(o),d=s.getUserOffset(c);o.setMinutes(o.getMinutes()+u-l),c.setMinutes(c.getMinutes()+d-l)}b.recentlyUsed[t.id]=!0,n.snapToId&&n.ServiceAppointmentLastModifiedDate--;var p=null,g=null;if(n.snapToId){var h=[],m=scheduler._events[n.snapToId].end||scheduler._events[n.snapToId].finish;
for(var f in scheduler._events)if(f!==n.id){var S=scheduler._events[f];S.resourceId===n.resourceId&&"break"!==S.type&&S.latitude&&isIntersect(S.start_date,S.end_date,scheduler._min_date,m)&&h.push(f)}h.sort(function(e,t){return scheduler._events[e].start>scheduler._events[t].start?-1:scheduler._events[e].start<scheduler._events[t].start?1:0}),h.length>0&&(p=scheduler._events[h[0]].latitude,g=scheduler._events[h[0]].longitude)}return i.saveChangesToServiceAppointment(n.id,n.getGanttResource(showSecondarySTMs),n.assignedResource,o,c,v.selectedPolicyId,n.scheduleMode,n.snapToId||null,n.snapToType||null,n.snapDirection||null,p,g).then(function(e){var i={};i.absences=a.updateTimePhaseData(e.resourceAbsences,"na").absences,i.services=a.updateTimePhaseData(e.services,"service").services,e.ValidationError&&r.reject(["",t,e.ValidationError]),r.resolve(i);var o="";t.resourceId&&(o=t.resourceId+","),n.resourceId&&(o+=n.resourceId),b.checkRules(s.getRelatedServices(n.id,o)).then(function(){return scheduler.updateView()})})["catch"](function(e){r.reject([e,t,""]),console.warn(e)}),r.promise},b.handleSnap=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1;if(t.ctrlKey){var s=[];for(var n in scheduler._events){var r=scheduler._events[n];("service"===r.type||"na"===r.type)&&(r.id===e.id||e.resourceId&&-1===r.resourceId.indexOf(e.resourceId)||isIntersect(r.start_date,r.end_date,e.start_date,e.end_date)&&s.push(r))}s.sort(function(e,t){return e.start>t.start?1:e.start<t.start?-1:0});var a=i?1:0;if(s.length>a){var o=new Date(e.start_date);e.travelTo&&(o=o.setSeconds(o.getSeconds()+e.travelTo));var c="right",l=s[0].isDummy?1:0;o<s[l].start&&(c="left");var u=0;s[0].isDummy&&(u=1),s[u]?(e.snapToId=s[u].id,e.snapToType=s[u].type,e.snapDirection=c):(e.snapToId=null,e.snapToType=null,e.snapDirection=null)}else e.snapToId=null,e.snapToType=null,e.snapDirection=null}},b.unscheduleServices=function(t,n,r){var c=e.defer(),u=r?i.unscheduleServicesByLocationsId:i.unscheduleServicesByServicesId,d=null;return r||(d=s.getRelatedServices(t)),u(t,n,r).then(function(u){var v={};if(u.nothingToUnschedule)return void c.resolve(u);var g=e.defer();u.fslOperation?p.getUpdates(u.fslOperation).then(function(e){console.log(e);var t=e.fslOperation.result.services;i.getServicesById(t).then(function(t){a.updateTimePhaseData(t,"service").services,g.resolve({services:t,resourceAbsences:[],resourceCapacities:[],failedResults:e.fslOperation.result.failedResults})})})["catch"](function(e){g.reject(e)}):g.resolve(u),g.promise.then(function(e){v.absences=a.updateTimePhaseData(e.resourceAbsences,"na",!0).absences,v.services=a.updateTimePhaseData(e.services,"service",!0).services,v.capacities=a.updateTimePhaseData(e.resourceCapacities,"capacity").capacities,v.failedResults=e.failedResults,!r&&b.checkRules(d).then(function(){return scheduler.updateView()}),r&&b.checkRules(s.getServicesOfLocations(t,n,r)).then(function(){return scheduler.updateView()});var i=void 0,u=void 0;if(1!==t.length||r){var p=[],g=[];if(r?e.services.forEach(function(t){e.failedResults[t.Id]&&a.serviceAppointments()[t.Id].isScheduled()?g.push(t.Id):p.push(t.Id)}):t.forEach(function(e){a.serviceAppointments()[e].isScheduled()?g.push(e):p.push(e)}),i=customLabels.x_services_were_unscheduled.replaceAll(p.length),u=r?customLabels.x_services_were_unscheduled_out_of_y.replaceAll(p.length,p.length,g.length+p.length):customLabels.x_services_were_unscheduled_out_of_y.replaceAll(p.length,p.length,t.length),g.length>0){var h=g.map(function(e){return a.serviceAppointments()[e].name}).join(", ");u+="<div title='"+h+"' class='dashedBorder' style='display:inline-block;'> "+customLabels.failed_to_unschedule.replaceAll(g.length)+". "+customLabels.View_services+"</div>"}var m=angular.copy(e),f=[];m.services.forEach(function(e){if(r)e.Fields.SchedStartTime||f.push(e);else for(var i=0;i<t.length;i++)e.Id===t[i]&&f.push(e)}),m.services=f,s.addNotification(i,u,function(){var e={success:customLabels.SuccessfullyUnscheduled,fail:customLabels.FailToUnschedule};l.open(m,e)})}else{var S=a.serviceAppointments()[t[0]].name;a.serviceAppointments()[t[0]].isScheduled()?(i=customLabels.Couldnt_unschedule.replaceAll(S),u=customLabels.Couldnt_unschedule.replaceAll(S)+". "+e.failedResults[t[0]].errorMessage):(i=customLabels.was_unscheduled.replaceAll(S),u=customLabels.was_unscheduled_successfully.replaceAll(S)),s.addNotification(i,u,function(){b.recentlyUsed[t[0]]=!0,o.open(t[0])})}c.resolve(v)})})["catch"](function(e){c.reject(e),console.warn(e)}),c.promise},b.drawServicesAndAbsences=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=arguments[3],n=void 0,r={},a={},o={},c={scheduledServices:[],unscheduledServices:[],deletedIds:i};Array.isArray(e)?e.forEach(function(e){return r[e.id]=e}):r=e,Array.isArray(t)?t.forEach(function(e){return a[e.id]=e}):a=t,Array.isArray(s)?s.forEach(function(e){return o[e.id]=e}):o=s,n=angular.extend({},r,a,o);for(var l in n){var u=n[l];h(u)?c.scheduledServices.push(u):c.unscheduledServices.push(u)}return i.forEach(function(e){return delete scheduler._events[e]}),c.scheduledServices.length>0?scheduler.parse(c.scheduledServices,"json"):scheduler.updateView(),c},b.changeStatus=function(t,n,r,c){var u=e.defer(),d=c?i.changeStatusServicesByLocationsId:i.changeStatusServicesByServicesId;return d(t,n,r,c).then(function(e){var i={};if(e.nothingToDispatch)return void u.resolve(e);i.services=a.updateTimePhaseData(e.services,"service").services,i.failedResults=e.failedResults;var r=void 0,d=void 0;if(1!==t.length||c){var v=[],p=[];if(c?e.services.forEach(function(e){a.serviceAppointments()[e.Id].status!==n?v.push(e.Id):p.push(e.Id)}):t.forEach(function(e){a.serviceAppointments()[e].status===n?p.push(e):v.push(e)}),r=customLabels.x_services_were_changed.replaceAll(p.length,s.statusTranslations[n]||n),d=customLabels.x_services_were_changed_out_of_y.replaceAll(p.length,p.length,p.length+v.length,s.statusTranslations[n]||n),v.length>0){var g=v.map(function(e){return a.serviceAppointments()[e].name}).join(", "),h=customLabels.failed_to_change_status.replaceAll(v.length);d+="<div title='"+g+"' class='dashedBorder' style='display:inline-block;'> "+h+". "+customLabels.View_services+"</div>"}s.addNotification(r,d,function(){var t={success:customLabels.SuccessfullyDispatched,fail:customLabels.FailToDispatch};l.open(e,t)})}else{var m=a.serviceAppointments()[t[0]].name;a.serviceAppointments()[t[0]].status!==n&&(r=customLabels.could_not_change_title.replaceAll(m),d=e.failedResults&&!s.isEmpty(e.failedResults)?customLabels.could_not_change_status.replaceAll(m,s.statusTranslations[n],e.failedResults[t[0]].errorMessage):customLabels.could_not_change_status.replaceAll(m,s.statusTranslations[n],""),s.addNotification(r,d,function(){o.open(t[0])})),b.recentlyUsed[t[0]]=!0}u.resolve(i)})["catch"](function(e){u.reject(e),console.warn(e)}),u.promise},b.changePin=function(t,s){var n=e.defer();return i.changePin(t,s).then(function(e){var t=fieldNames.Service_Appointment.pinned;e.forEach(function(e){return a.serviceAppointments()[e.Id].pinned=e[t]}),n.resolve()})["catch"](function(e){n.reject(e),console.warn(e)}),n.promise},b.setInJeopardy=function(t){var n=e.defer();return i.setServiceAppointmentsInJeopardy(t).then(function(e){e.forEach(function(e){return a.serviceAppointments()[e.Id].jeopardy=e[fieldNames.Service_Appointment.InJeopardy__c]}),s.addNotification("In Jeopardy Service Appointments",e.length+" service appointments were marked as in jeopardy"),n.resolve()})["catch"](function(e){n.reject(e),console.warn(e)}),n.promise},b}])}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){angular.module("serviceExpert").factory("userSettingsManager",["$q",function(e){var t={};return t.GetUserSettingsProperty=function(e){return bootstrap.loadedUserSettings[e]},t.SetUserSettingsProperty=function(t,i){var s=e.defer(),n="undefined"==typeof i?"undefined":_typeof(i);return Visualforce.remoting.Manager.invokeAction(RemoteActions.SetUserSettingsProperty,t,i,n,function(e,t){null!=t.result&&(bootstrap.loadedUserSettings=JSON.parse(t.result),s.resolve())},{buffer:!1,escape:!1,timeout:12e4}),s.promise},t.SetUserSettingProperties=function(t){var i=e.defer();for(var s in t){var n=t[s];t[s]=n+":"+("undefined"==typeof n?"undefined":_typeof(n))}return Visualforce.remoting.Manager.invokeAction(RemoteActions.SetUserSettingsProperties,t,function(e,t){var s=JSON.parse(t.result);s.FailedLocations?(bootstrap.loadedUserSettings=s,i.reject(s)):(bootstrap.loadedUserSettings=s,i.resolve())},{buffer:!1,escape:!1,timeout:12e4}),i.promise},t.SetUserSettingPropertiesPromise=function(i){var s=e.defer();return t.SetUserSettingProperties(i),bootstrap.loadedUserSettings=JSON.parse(ev.result),s.promise},t}])}(),function(){function e(e,t,i,s,n,r,a,o,c,l){function u(e,t){return Array.isArray(e)&&!Array.isArray(t)?e.map(function(e){return e+"_"+t}).join(","):Array.isArray(e)&&Array.isArray(t)?e.map(function(e,i){return e+"_"+t[i]}).join(","):Array.isArray(e)||Array.isArray(t)?!Array.isArray(e)&&Array.isArray(t)?t.map(function(t){return e+"_"+t}).join(","):void 0:e+"_"+t}function d(){var t=e.defer();return i.getReports().then(function(e){if(!e)return void t.resolve(null);for(var i=0;i<e.length;i++)Q.push(e[i]);t.resolve(Q)}),t.promise}function v(){var t=e.defer();return Z("Polygons_view")?(i.getPolygons().then(function(e){if(!e)return void t.resolve(null);for(var i=0;i<e.length;i++)ee.push(e[i]);t.resolve(ee)}),t.promise):void t.resolve(null)}function p(e,t){var i="number"==typeof e||"string"==typeof e?scheduler.getEvent(e):e,c=getMinAndMaxHoursToDisplay(),l=i.start_date.getHours(),u=i.end_date.getHours();scheduler._min_date<=i.start&&i.start<scheduler._max_date?scheduler.setCurrentView(scheduler._min_date):scheduler.setCurrentView(new Date(i.start)),setTimeout(function(){if(t=t||scheduler._mode,0===i.end_date.getHours()&&i.end_date.getDate()>i.start_date.getDate()&&(u=24),"MonthlyView"===t)return void alert(customLabels.serviceCantDisplayMonthlyMsg);if("ZoomLevel2"!==scheduler._mode&&(c.min>u||c.max<=l))return void alert(customLabels.serviceCantDisplayMsg);for(var d=!0,v=scheduler.serverList("resources"),p=0;p<v.length;p++)for(var h=0;h<v[p].children.length;h++)if(i.resourceId.indexOf(v[p].children[h].key)>-1){d=!1;break}if(d)return void alert(customLabels.resource_filtered_out);var m=scheduler.getRenderedEvent(e);if(showSecondarySTMs&&i.ServiceTerritoryId&&i.resourceId.indexOf(",")>-1){for(var f=i.resourceId.split(","),S=f[0],b=0;b<f.length;b++)if(f[b].indexOf(i.ServiceTerritoryId)>-1){S=f[b];break}m=g(e,S.split("_")[1])||m}if($(m).removeClass("ShowEventEffect"),i&&(!scheduler.checkEvent("onBeforeEventDisplay")||scheduler.callEvent("onBeforeEventDisplay",[i,t]))){var y=scheduler.config.scroll_hour;scheduler.config.scroll_hour=i.start_date.getHours();var _=scheduler.config.preserve_scroll;if(scheduler.config.preserve_scroll=!1,(i.start_date<scheduler._min_date||i.start_date>scheduler._max_date)&&(a.areContractorsSupported()&&i.resourceContractor?scheduler.setCurrentView(new Date(i.start),t):scheduler.setCurrentView(new Date(i.start),t)),scheduler.config.scroll_hour=y,scheduler.config.preserve_scroll=_,a.areContractorsSupported()){var T=!0;if(i.resourceContractor){var w=scheduler.getEvents(i.start,i.finish);for(p=0;p<w.length;p++)if(w[p].resourceId==i.resourceId&&"contractorcapacity"==w[p].type&&w[p].timePeriod==r.GetUserSettingsProperty("View_Capacity_Type__c")){i=w[p],e=w[p].id,m=scheduler.getRenderedEvent(e),$(m).removeClass("ShowEventEffect"),T=!1;break}if(T)return void alert(customLabels.is_assigned_to_contractor.replaceAll(i.name,i.resourceName)+".\n"+customLabels.This_capacity_duration_is_filtered_out+".\n"+customLabels.To_change_the_capacity_duration)}}scheduler.matrix&&scheduler.matrix[t]&&(scheduler._els.dhx_cal_data[0].scrollTop=0,scheduler._els.dhx_cal_data[0].scrollTop=getAbsoluteTop(scheduler.getRenderedEvent(i.id))-getAbsoluteTop(scheduler._els.dhx_cal_data[0])-20),scheduler.callEvent("onAfterEventDisplay",[i,t]),m=scheduler.getRenderedEvent(e),$(m).addClass("ShowEventEffect"),n(function(){o.calculateKpis(),s.$broadcast("afterShowEvent")},400)}},200)}function g(e,t){for(var i=scheduler._rendered,s=0;s<i.length;s++){var n=i[s];if(n.getAttribute("event_id")==e&&n.children[0].getAttribute("territory_id")==t)return n}}function h(e,t){var i=864e5*t;return new Date(e.getTime()+i)}function m(e){var t=new Date(e);switch(scheduler._mode){case"ZoomLevel2":t=h(t,1);break;case"ZoomLevel3":t=h(t,1);break;case"ZoomLevel4":t=h(t,2);break;case"ZoomLevel5":t=h(t,3);break;case"ZoomLevel6":t=h(t,7);break;case"MonthlyView":t=h(t,30);break;case"MTDView":t=h(t,35)}return{start:new Date(e),end:t}}function f(e,t,i,s){"undefined"==typeof s&&(s=null),te.push({title:e,text:t,action:i,when:new Date,unread:!0,param:s});te.length-1}function S(e,t){switch(e){case t.NONE:return"serviceList_new";case t.SCHEDULED:return"serviceList_assigned";case t.DISPATCHED:return"serviceList_dispatched";case t.IN_PROGRESS:return"serviceList_travel";case t.COMPLETED:return"serviceList_completed";case t.COULD_NOT_COMPLETE:return"serviceList_couldnt_complete";case t.CANCELED:return"serviceList_cancelled";default:return"serviceList_other"}}function b(e,t){return e.start>t.start?1:e.start.getTime()==t.start.getTime()?0:-1}function y(e,t){var i={},s=[];e.start>=t.start&&e.start<t.finish?(i.start=e.start,e.finish<t.finish?i.finish=e.finish:(i.finish=t.finish,s.push({start:t.finish,finish:e.finish,isStart:!1}))):e.finish>t.start&&e.finish<=t.finish?(e.start>t.start?i.start=e.start:(i.start=t.start,s.push({start:e.start,finish:t.start,isStart:!0})),i.finish=e.finish):e.start<t.start&&e.finish>t.finish?(i=angular.copy(t),s.push({start:e.start,finish:t.start,isStart:!0}),s.push({start:t.finish,finish:e.finish,isStart:!1})):i=null;for(var n=[],r=0;r<s.length;r++){var a=s[r];a.start.getTime()!=a.finish.getTime()&&n.push(a)}return{intersection:i,remainderFrom1:n}}function _(e){return!Object.keys(e).length}function T(e){if(e){var t={};return e.Type==ae.Reference&&(t.resourceOnServiceTT=!0),t}}function w(e,t){if(t.Type==ae.Reference){var i=t.JsAPIName.replace("__r","__c");L(e[i])}}function L(e){var t=C(null,e);t||window.open("../"+e,"_blank")}function k(e){return"string"==typeof e?t.trustAsHtml(e):null}function C(e,t){return a.isInConsole()?(e&&e.preventDefault(),sforce.console.generateConsoleUrl(["/"+t],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):D(t)}),!0):!1}function R(e){sforce.console.getEnclosingPrimaryTabId(function(t){var i=t.id;sforce.console.openSubtab(i,"/"+e,!0)})}function D(e){sforce.console.openPrimaryTab(null,"/"+e,!0)}function A(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function I(e){var t={weekday:"short",month:"long",day:"numeric",year:"numeric"},i=new Date(e);i.setHours(12);try{return i.toLocaleDateString(userLocale.replace("_","-"),t)}catch(s){return null}}function F(e,t,i){var s=O(e,t);return P(s.tz(i))}function x(e){return-moment.tz.zone(userTimeZone).offset(O(e,userTimeZone).valueOf())}function M(e,t){var i=c.territories[t],s=c.operatingHours[i.operatingHours].timezone;return-moment.tz.zone(s).offset(O(e,s).valueOf())}function O(e,t){return moment.tz({year:e.getFullYear(),month:e.getMonth(),date:e.getDate(),hours:e.getHours(),minutes:e.getMinutes()},t)}function P(e){return new Date(e.year(),e.month(),e.date(),e.hours(),e.minutes())}function E(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i].id);return t}function N(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i]);return t}function B(e,t){var i=e.$root.$$phase;"$apply"==i||"$digest"==i?t&&"function"==typeof t&&t():e.$apply(t)}function H(e){var t=0;if(e.resourceBeforeDrag=e.resourceId,e.eventBeforeDrag=angular.copy(e),e.isScheduled())t=e.finish.getTime()-e.start.getTime();else switch(e.durationType){case ce.minutes:t=60*e.estDuration*1e3;break;case ce.hours:t=60*e.estDuration*60*1e3;break;case ce.days:t=24*e.estDuration*60*60*1e3;break;default:t=6e4}return t}function G(e,t){var i=Array.isArray(e)?e.concat():[e];t+=i.reduce(function(e,t){return scheduler._events[t]?e+","+scheduler._events[t].resource:e},"");for(var s in scheduler._events){var n=scheduler._events[s];"service"===n.type&&-1!=t.indexOf(n.resource)&&(i.push(n.id),n.relatedTo&&i.push(n.relatedTo),n.relatedFather&&i.push(n.relatedFather),n.relatedService2&&i.push(n.relatedService2),n.relatedService1&&i.push(n.relatedService1))}return i}function V(e,t,i){var s=[];e=Array.isArray(e)?e:[e];var n=e.join(",");for(var r in scheduler._events){var a=scheduler._events[r];"service"===a.type&&n.indexOf(a.serviceTerritory)&&isIntersect(a.start_date,a.end_date,t,i)&&(s.push(a.id),a.relatedTo&&s.push(a.relatedTo),a.relatedFather&&s.push(a.relatedFather),a.relatedService2&&s.push(a.relatedService2),a.relatedService1&&s.push(a.relatedService1))}return s}function U(e,t){var i=[];for(var s in scheduler._events){var n=scheduler._events[s];"service"===n.type&&isIntersect(n.start_date,n.end_date,e,t)&&(i.push(n.id),n.relatedTo&&i.push(n.relatedTo),n.relatedFather&&i.push(n.relatedFather),n.relatedService2&&i.push(n.relatedService2),n.relatedService1&&i.push(n.relatedService1))}return i}function j(){n(function(){var e=$(".gm-style-iw"),t=e.next();t.css({right:"12px",left:"",opacity:1})},0)}function z(e){return'<svg aria-hidden="true" class="slds-icon contextMenuIcon"><use xlink:href="'+e+'"></use></svg>'}function q(e){return'<svg aria-hidden="true" class="slds-icon contextMenuIcon"><use width="17px" height="17px" xlink:href="'+e+'"></use></svg>'}function W(){var e=r.GetUserSettingsProperty("locations");return e?e:[]}function K(e,t,i,s){if(60>e)return s.replaceAll([e]);var n=e%60,r=Math.round(e/60);return 0===n?i.replaceAll([r]):t.replace("$0",r).replace("$1",n)}function Z(e){return customPermissions[e]}function J(){return"undefined"!=typeof sforce&&sforce&&!!sforce.one}var X=void 0,Y=[],Q=[],ee=[],te=[],ie={},se={},ne={},re={},ae={DateTime:"DATETIME",Date:"DATE",String:"STRING",TextArea:"TEXTAREA",Picklist:"PICKLIST",Reference:"REFERENCE",Currency:"CURRENCY",Phone:"PHONE"},oe={show:!0},ce={minutes:"Minutes",hours:"Hours",days:"Days"},le=!1;return i.getAllFormulaFields().then(function(e){X=e}),i.getWorkOrderPriority().then(function(e){Y.push.apply(Y,_toConsumableArray(e))}),function(){ie.startHour=r.GetUserSettingsProperty("Gantt_View_Start_Hour__c"),null==ie.startHour&&(ie.startHour=0),ie.finishHour=r.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),null==ie.finishHour&&(ie.finishHour=24),ie.filterCandidates=r.GetUserSettingsProperty("Filter_Candidates__c"),null==ie.filterCandidates&&(ie.filterCandidates=!0),ie.servicesPerPage=r.GetUserSettingsProperty("Services_Per_Page__c"),null==ie.servicesPerPage&&(ie.servicesPerPage="75"),ie.resourceRowHeight=r.GetUserSettingsProperty("Resource_Row_Height__c"),null==ie.resourceRowHeight&&(ie.resourceRowHeight="medium"),ie.capacityDuration=r.GetUserSettingsProperty("View_Capacity_Type__c"),null==ie.capacityDuration&&(ie.capacityDuration="Day"),ie.backHorizon=r.GetUserSettingsProperty("Scheduling_horizon_limit__c"),null==ie.backHorizon&&(ie.backHorizon=14),ie.loadOnToday=r.GetUserSettingsProperty("Load_On_Today__c"),null==ie.loadOnToday&&(ie.loadOnToday=!0)}(),i.getCustomizationFiles().then(function(e){if(e&&e.CSS){var t=jQuery("<link>");t.attr({rel:"stylesheet",type:"text/css",href:e.CSS}),$("head").append(t)}e&&e.JS&&$.ajax({url:e.JS,dataType:"script"})}),window.openConsoleTabFromModal=function(e){a.isInConsole()&&sforce.console.generateConsoleUrl([e],function(t){t.success?sforce.console.openConsoleUrl(null,t.consoleUrl,!0):D(e)})},String.prototype.replaceAll=function(){for(var e=this,t=arguments.length,i=Array(t),s=0;t>s;s++)i[s]=arguments[s];for(var n=0;n<i.length;n++)e=e.replace("$"+n,i[n]);return e},i.getStatusFlow().then(function(e){if(e){angular.merge(se,e);for(var t in se)se[t]=se[t].sort()}})["catch"](function(e){console.warn("could not get status flow :("),console.log(e)}),i.getStatusTranslations().then(function(e){angular.merge(ne,e),window.statusTranslations=ne})["catch"](function(e){console.warn("could not get status translations :("),console.log(e)}),i.getStatuses().then(function(e){angular.merge(re,e)})["catch"](function(e){console.warn("could not get status :("),console.log(e)}),{getFilteredLocations:W,getSVGIconHTMLCustom:q,getSVGIconHTML:z,getRelatedServices:G,getServicesOfLocations:V,getServicesBetweenDates:U,getServiceDuration:H,safeApply:B,formatDayToString:A,showOnGantt:p,openConsoleTab:C,trust:k,openLink:w,openSObjectLink:L,openLightningSubtab:R,openLightningPrimaryTab:D,getServiceInfoRowClass:T,isEmpty:_,generateResourceId:u,addNotification:f,addDaysToDate:h,setDatesByStartAndMode:m,sortByTime:b,getReports:d,getPolygons:v,intersectDates:y,getCSSClassForContext:S,fieldsTypes:ae,ganttSettings:ie,butlerNotifications:te,getIdsOfSObjectsAbsence:N,showServiceList:oe,checkBoxFields:function(){return X},woPriorities:Y,durationTypes:ce,statusFlow:se,statusTranslations:ne,statuses:re,convertDateBetweenTimeZones:F,convertDtToMomentDt:O,convertMomentDtToDt:P,getUserOffset:x,getLocationOffset:M,setMapCloseButtonPosition:j,getIdsOfSObjects:E,hoursMinutes:K,hasCustomPermission:Z,formatDateWithDayOfWeek:I,isLightning:J,crewsFilter:le}}e.$inject=["$q","$sce","sfdcService","$rootScope","$timeout","userSettingsManager","StateService","kpiCalculationsService","ResourcesAndTerritoriesService","$injector"],angular.module("serviceExpert").factory("utils",e)}(),function(){angular.module("serviceExpert").factory("sfdcService",["$q","$rootScope","userSettingsManager",function(e,t,i){function s(){var e=i.GetUserSettingsProperty("locations");return e?e:[]}function n(){return JSON.parse(i.GetUserSettingsProperty("Show_Orphan_Services__c"))}var r={servicesArray:[],servicesObjs:{},activeRequests:{active:0},activeRuleCheckRequests:{active:0},firstTimeGettingEmployees:function(){return a}},a=e.defer();r.getEmployeesByLocation=function(){var t=e.defer();return r.resourcesUntouched?(t.resolve(angular.copy(r.resourcesUntouched)),t.promise):(r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getEmployeesByLocations,function(e,i){i.status?(r.resources=e,r.resourcesUntouched=angular.copy(e),r.activeRequests.active-=1,t.resolve(e)):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!0,timeout:12e4}),t.promise)},r.getUnPrivilegeUserSettingsFields=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getUnPrivilegeUserSettingsFields,function(e,i){i.status?(r.activeRequests.active-=1,t.resolve(e)):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!0,timeout:12e4}),t.promise},r.isStreamingShouldBeActive=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.isStreamingShouldBeActive,function(e,i){i.status?(r.activeRequests.active-=1,t.resolve(e)):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!0,timeout:12e4}),t.promise},r.getAllFormulaFields=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getAllFormulaFields,function(e,i){i.status?(r.activeRequests.active-=1,t.resolve(e)):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise};var o=null;r.getServiceListFields=function(){return null==o&&(o=e.defer(),r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceListFields,function(e,t){t.status?(r.activeRequests.active-=1,o.resolve(e)):(r.activeRequests.active-=1,o.reject(t))},{buffer:!1,escape:!1,timeout:12e4})),o.promise};var c=null;r.getGanttToolTipFields=function(){return null==c&&(c=e.defer(),r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceGanttTooltipFields,function(e,t){t.status?(r.activeRequests.active-=1,c.resolve(e)):(r.activeRequests.active-=1,c.reject(t))},{buffer:!1,escape:!1,timeout:12e4})),c.promise};var l=null;r.getServiceMiniFormFields=function(){return null==l&&(l=e.defer(),r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceMiniFormFields,function(e,t){t.status?(r.activeRequests.active-=1,l.resolve(e)):(r.activeRequests.active-=1,l.reject(t))},{buffer:!1,escape:!1,timeout:12e4})),l.promise};var u=null;r.getServiceMapInfoWindowFields=function(){return null==u&&(u=e.defer(),r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceMapInfoWindowFields,function(e,t){t.status?(r.activeRequests.active-=1,u.resolve(e)):(r.activeRequests.active-=1,u.reject(t))},{buffer:!1,escape:!1,timeout:12e4})),u.promise};var d=null;r.getServiceCapacityColumns=function(){return null==d&&(d=e.defer(),r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceCapacityColumns,function(e,t){t.status?(r.activeRequests.active-=1,d.resolve(e)):(r.activeRequests.active-=1,d.reject(t))},{buffer:!1,escape:!1,timeout:12e4})),d.promise},r.getPolicies=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getPolicies,function(e,i){i.status?(r.activeRequests.active-=1,t.resolve(e)):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.sortServicesByPriority=function(t){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.sortServicesByPriority,t,function(e,t){t.status?(r.activeRequests.active-=1,i.resolve(e)):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.checkRules=function(i,s){var n=e.defer();return r.activeRuleCheckRequests.active+=1,t.policy||(t.policy=null),s||(s=t.policy),Visualforce.remoting.Manager.invokeAction(RemoteActions.checkRules,i,s,function(e,t){t.status?(r.activeRuleCheckRequests.active-=1,n.resolve(e)):(r.activeRuleCheckRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.getDelta=function(t){var i=e.defer(),n=s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getDelta,t,n,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getOptimiztionRequestsUpdate=function(t){var i=e.defer(),n=s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getOptimiztionRequestsUpdate,t,n,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getGanttServiceOnAssignedResourceUpdate=function(t){var i=e.defer(),n=s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getGanttServiceOnAssignedResourceUpdate,t,n,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getUpdatedAbsences=function(t){var i=e.defer(),n=s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getUpdatedAbsences,t,n,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getDeletedAbsences=function(t){var i=e.defer(),n=s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getDeletedAbsences,t,n,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getUpdatedServices=function(t,i){var n=e.defer(),r=s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getUpdatedServices,t,i,r,function(e,t){t.status?n.resolve(e):n.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.getUpdatedResourceCapacities=function(t){var i=e.defer(),n=s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getUpdatedResourceCapacities,t,n,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getLivePositionsStreaming=function(t){var i=e.defer(),n=s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getLivePositionsStreaming,t,n,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getDelta=function(t){var i=e.defer(),n=s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getDelta,t,n,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.postToChatter=function(t,i){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.postToChatter,t,i,function(e,t){t.status?(r.activeRequests.active-=1,s.resolve(e)):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.getLivePositions=function(){var t=e.defer();r.activeRequests.active+=1;var i=s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getLivePositions,i,function(e,i){i.status?(t.resolve(e),r.activeRequests.active-=1):(t.reject(i),r.activeRequests.active-=1)},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getSlots=function(t,i){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getSlots,t,i,function(e,t){var i={};i.value=e,i.eventType=t.type,"exception"==t.type&&(i.event=t,s.resolve(i),r.activeRequests.active-=1),t.status?(s.resolve(i),r.activeRequests.active-=1):(s.reject(t),r.activeRequests.active-=1)},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.getSkills=function(){var t=e.defer();s();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getSkills,function(e,i){i.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getPolygons=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getPolygons,function(e,i){i.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.savePolygon=function(t,i,s,n,a){var o=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.savePolygon,t,i,s,n,a,function(e,t){t.status?(o.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,o.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),o.promise},r.deletePolygon=function(t){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.deletePolygon,t,function(e,t){t.status?(i.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getLocale=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getLocale,function(e,i){i.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.autoScheduleService=function(t,i){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.autoScheduleService,t,i,function(e,t){t.status?(s.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.getDictionaries=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getDictionaries,function(e,i){i.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.unscheduleServicesByServicesId=function(t){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.unscheduleServicesByServicesId,t,function(e,t){t.status?(i.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.unscheduleServicesByLocationsId=function(t,i,s){
var n=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.unscheduleServicesByLocationsId,t,i,s,function(e,t){t.status?(n.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.getLocationsCurrentTime=function(t,i,s){var n=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getLocationsCurrentTime,function(e,t){t.status?(n.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.changeStatusesByServicesId=function(t,i){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changeStatusesByServicesId,t,i,function(e,t){t.status?(s.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.changeStatusesByLocations=function(t,i,s,n,a){var o=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changeStatusesByLocations,t,i,s,n,a,function(e,t){t.status?(o.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,o.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),o.promise},r.keepAlive=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.keepAlive,function(e,t){t.status||("exception"===t.type?t.message.indexOf("Logged in")>-1&&(alert(customLabels.sessionTimedOut),location.reload()):console.log(customLabels.failed_to_refresh))},{buffer:!1,escape:!1,timeout:12e4})},r.getStatuses=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getStatuses,function(e,i){i.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getEmployeeAbsenceTypes=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getEmployeeAbsenceTypes,function(e,i){i.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getWorkOrderPriority=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getWorkOrderPriority,function(e,i){i.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getReports=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getReportsWithGeolocationCols,function(e,i){i.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getReportRowsForMap=function(t){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getReportRowsForMap,t,function(e,t){t.status?(i.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.runOptimization=function(t,i,s,n,a,o,c){var l=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runOptimization,t,i,s,n,a,o,c,function(e,t){t.status?(l.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,l.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),l.promise},r.runRDOptimization=function(t,i,s,n,a,o,c,l){var u=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runRDOptimization,t,i,s,n,a,o,c,l,function(e,t){t.status?(u.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,u.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),u.promise},r.getRequestObject=function(t){var i=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getRequestObject,t,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getCustomizationFiles=function(){var t=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getCustomizationFiles,function(e,i){i.status?t.resolve(e):t.reject(i)},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getShiftsInRange=function(t,i,n){var a=e.defer(),o=s();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getShifts,t,i,o,function(e,t){t.status?(a.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,a.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),a.promise},r.getOptimizationsRequest=function(){var t=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getOptimizationsRequest,function(e,i){i.status?t.resolve(e):t.reject(i)},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.saveChangesToBreak=function(t,i,n,a,o){var c=e.defer();r.activeRequests.active+=1;s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.saveChangesToBreak,t,i,n,a,o,function(e,t){t.status?(r.activeRequests.active-=1,c.resolve(e)):(r.activeRequests.active-=1,c.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),c.promise},r.deleteBreak=function(t){var i=e.defer();r.activeRequests.active+=1;s();return Visualforce.remoting.Manager.invokeAction(RemoteActions.deleteBreak,t,function(e,t){t.status?(r.activeRequests.active-=1,i.resolve(e)):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getResourceFieldSetFields=function(){var t=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getResourceFieldSetFields,function(e,i){i.status?t.resolve(e):t.reject(i)},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getStatusTranslations=function(){var t=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getStatusTranslations,function(e,i){i.status?t.resolve(e):t.reject(i)},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getResourcePicklistValues=function(t){var i=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getResourcePicklistValues,t,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.GetResourcesAndTerritories=function(t){var i=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.GetResourcesAndTerritories,t||s(),function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.GetTimePhasedObjects=function(t,i,n){var a=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.GetTimePhasedObjects,t,i,n||s(),function(e,t){r.activeRequests.active-=1,t.status?a.resolve(e):a.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),a.promise},r.loadServiceAppointmentsToList=function(t,i,a,o){var c=e.defer(),l=n();return r.activeRequests.active+=1,0>a&&(a=100),Visualforce.remoting.Manager.invokeAction(RemoteActions.LoadServiceAppointmentsToServiceList,t,s(),l,i,a,o,function(e,t){t.status?(c.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,c.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),c.promise},r.saveChangesToAbsence=function(t,i,s,n,a){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,d=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.saveChangesToAbsence,t,i,s,n,a,o,c,l,u,function(e,t){t.status?(d.resolve(e),r.activeRequests.active-=1):(d.reject(t),r.activeRequests.active-=1)},{buffer:!1,escape:!1,timeout:12e4}),d.promise},r.saveChangesToServiceAppointment=function(t,i,s,n,a,o,c,l,u,d,v,p){var g=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.saveChangesToServiceAppointment,t,i,s,n,a,o,c,l,u,d,v,p,function(e,t){t.status?(g.resolve(e),r.activeRequests.active-=1):(g.reject(t),r.activeRequests.active-=1)},{buffer:!1,escape:!1,timeout:12e4}),g.promise},r.changeStatusServicesByServicesId=function(t,i){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changeStatusServicesByServicesId,t,i,function(e,t){t.status?(s.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.changeStatusServicesByLocationsId=function(t,i,s,n){var a=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changeStatusServicesByLocationsId,t,i,s,n,function(e,t){t.status?(a.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,a.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),a.promise},r.deleteResourceAbsence=function(t){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.deleteResourceAbsence,t,function(e,t){t.status?(i.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getStatusFlow=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getStatusFlow,function(e,i){i.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.getStatuses=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getStatuses,function(e,i){i.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.changePin=function(t,i){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changePins,t,i,function(e,t){t.status?(s.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.setServiceAppointmentsInJeopardy=function(t){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.setServiceAppointmentsInJeopardy,t,function(e,t){t.status?(i.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getOptimizationRequests=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getOptimizationRequests,s(),n(),function(e,i){i.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r.runFillInSchedule=function(t,i,s){var n=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runFillInSchedule,t,i,s,function(e,t){t.status?(n.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.runFixOverlaps=function(t,i,s){var n=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runFixOverlaps,t,i,s,function(e,t){t.status?(n.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},r.runGroupNearby=function(t,i){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runGroupNearby,t,i,function(e,t){t.status?(s.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.runReshuffle=function(t,i){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runReshuffle,t,i,function(e,t){t.status?(s.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.getResourceActualRoute=function(t,i){var s=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getResourceActualRoute,t,i,function(e,t){t.status?(s.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,s.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),s.promise},r.getFslOperation=function(t){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getFslOperation,t,function(e,t){t.status?(i.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getServicesById=function(t){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServicesById,t,function(e,t){t.status?(i.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.getGanttFilters=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getGanttFilters,function(e,i){i.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise};var v=null;return r.getGanttFilterFields=function(){return null==v&&(v=e.defer(),r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getGanttFilterFields,function(e,t){t.status?(r.activeRequests.active-=1,v.resolve(e)):(r.activeRequests.active-=1,v.reject(t))},{buffer:!1,escape:!1,timeout:12e4})),v.promise},r.getFilterById=function(t){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getFilterById,t,function(e,t){t.status?(i.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.hideFilter=function(t){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.hideFilter,t,function(e,t){t.status?(i.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.deleteFilter=function(t){var i=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.deleteFilter,t,function(e,t){t.status?(i.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},r.userHasAdminPermissions=function(){var t=e.defer();return r.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.userHasAdminPermissions,function(e,i){i.status?(t.resolve(e),r.activeRequests.active-=1):(r.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},r}])}(),function(){function e(e,t,i,s,n,r){function a(a){u=e.$new(!0),u.lightboxAbsence=t.resourceAbsences()[a],u.selectedTab="details",u.urls={chatter:i.trustAsResourceUrl(customAbsenceChatterPage+"?id="+a).toString(),details:i.trustAsResourceUrl(customAbsencePage+"?id="+a).toString()},u.changeTab=c,u.closeLightbox=o,u.chatterAvailable=fieldTrackingEnabled.absence,u.openConsoleTab=n.openConsoleTab;var d=l();d.find("#AbsenceLightbox").draggable({handle:"#AbsenceLightboxHeader"}),r.setLightBoxStatus(),u.$on("$destroy",function(){return d.remove()}),u.$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)}),s(d)(u),n.safeApply(u,function(){angular.element("body").append(d)})}function o(){r.setLightBoxStatus(!1),u.$destroy()}function c(e){e!==u.selectedTab&&(u.selectedTab=e)}function l(){return angular.element('<div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="AbsenceLightbox">\n\n                        <div class="lightboxHeaderContainer" id="AbsenceLightboxHeader">\n\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n\n                            <h1 class="lightboxHeader">\n                                <i ng-show="lightboxAbsence.type == \'na\'">'+customLabels.NA+":</i>\n                                <i ng-show=\"lightboxAbsence.type == 'break'\">"+customLabels.Break+":</i>\n                                {{ lightboxAbsence.name }}\n                            </h1>\n\n                            <span ng-click=\"changeTab('details')\" ng-class=\"{lightboxSelectedTab: selectedTab == 'details'}\">\n                                "+customLabels.Details+'\n                            </span>\n\n                            <span ng-show="chatterAvailable" ng-click="changeTab(\'chatter\')" ng-class="{lightboxSelectedTab: selectedTab == \'chatter\'}">\n                                '+customLabels.Chatter+'\n                            </span>\n\n                            <div class="ExtendedForm">\n                                <a ng-click="openConsoleTab($event,lightboxAbsence.id)" target="_blank" href="../{{ lightboxAbsence.id }}" title="'+customLabels.ExtandedForm+'">\n                                    <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                        \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                    \u2028</svg>\n                                </a>\n                            </div>\n                        </div>\n\n                        <iframe ng-show="selectedTab == \'details\'" ng-src="{{ urls.details }}"></iframe>\n                        <iframe ng-show="selectedTab == \'chatter\'" ng-src="{{ urls.chatter }}" ng-if="chatterAvailable"></iframe>\n\n                    </div>\n                </div>')}var u=null;return{open:a}}e.$inject=["$rootScope","TimePhasedDataService","$sce","$compile","utils","StateService"],angular.module("serviceExpert").factory("AbsenceLightboxService",e)}(),function(){function e(e,t,i,s,n,r){function a(s,a){var o=e.defer(),c=new Date(a.start_date.getTime()+1e3*a.travelTo),l=new Date(a.end_date.getTime()-1e3*a.travelFrom);if(useLocationTimezone){var u=t.getIntersectingSrstOffset(a,a.getGanttResource()),d=r.getUserOffset(c),v=r.getUserOffset(l);c.setMinutes(c.getMinutes()+d-u),l.setMinutes(l.getMinutes()+v-u)}return i.saveChangesToAbsence(a.id,a.getGanttResource(),c,l,a.absenceType,a.ganttLabel,a.snapToId||null,a.snapToType||null,a.snapDirection||null).then(function(e){if(e.error)return void o.reject([e,s]);var i={};i.absences=t.updateTimePhaseData(e.resourceAbsences,"na").absences,i.services=t.updateTimePhaseData(e.services,"service").services;var a=[];a.push.apply(a,_toConsumableArray(i.services).concat(_toConsumableArray(i.absences)));var c=a.map(function(e){return e.id});c.length&&n.checkRules(r.getRelatedServices(c)).then(function(){return scheduler.updateView()}),o.resolve(i)})["catch"](function(e){o.reject([e,s])}),o.promise}function o(s){var a=e.defer();if(useLocationTimezone){var o=t.getIntersectingSrstOffset(s,s.resource),c=r.getUserOffset(s.start_date),l=r.getUserOffset(s.end_date);s.start_date.setMinutes(s.start_date.getMinutes()+c-o),s.end_date.setMinutes(s.end_date.getMinutes()+l-o)}return i.saveChangesToAbsence(null,s.resource,s.start_date,s.end_date,s.absenceType,s.ganttLabel,s.snapToId||null,s.snapToType||null,s.snapDirection||null).then(function(e){if(e.error)return void a.reject(e);var i={};i.absences=t.updateTimePhaseData(e.resourceAbsences,"na").absences,i.services=t.updateTimePhaseData(e.services,"service").services;var s=[];s.push.apply(s,_toConsumableArray(i.services).concat(_toConsumableArray(i.absences)));var o=s.map(function(e){return e.id});o.length&&n.checkRules(r.getRelatedServices(o)).then(function(){return scheduler.updateView()}),a.resolve(i)})["catch"](function(e){a.reject(e)}),a.promise}function c(t){var n=e.defer();return i.deleteResourceAbsence(t).then(function(e){s.getDelta()})["catch"](function(e){n.reject(e)}),n.promise}function l(){var t=e.defer();return i.getEmployeeAbsenceTypes().then(function(e){e&&(u=e,t.resolve(u))})["catch"](function(e){t.reject(e)}),t.promise}var u={};return{saveChangesToAbsence:a,saveNewAbsence:o,deleteAbsence:c,getEmployeeAbsenceTypes:l}}e.$inject=["$q","TimePhasedDataService","sfdcService","DeltaService","servicesService","utils"],angular.module("serviceExpert").factory("AbsencesService",e)}(),function(){function e(e,t,i,s,n,r,a,o,c){function l(){_=t.$new(!0),_.$on("keypress",function(e,t){27==t.which&&_.$evalAsync(_.closeLightbox)});var a=n.GetUserSettingsProperty("locations");_.filteredLocations=a.map(function(e){return i.territories[e]}),_.selectedCount=s.countSelectedServices(),_.contractorSupport=r.areContractorsSupported(),h(),_.dateSelectFinishWidget=d,_.dateSelectStartWidget=v,_.validateDatesStart=p,_.validateDatesEnd=g,_.targetServices=0==_.selectedCount?"locations":"selectedServices",_.bulkState="form",_.bulkCancel=b,_.results={},_.toggleFlag=m,_.isFlagged=f,_.getServiceName=S,_.selectedLocations={},_.nothingToDispatch=!1;var o=y();o.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(o),_.closeLightbox=u,_.$on("$destroy",function(){return o.remove()}),e(o)(_),o.show(),r.setLightBoxStatus()}function u(){"running"!==_.bulkState&&(r.setLightBoxStatus(!1),_.$destroy())}function d(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(_.actionFinish),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(_.endMinutes)),i.setHours(parseInt(_.endHour)),i<_.actionStart?alert(customLabels.finishAfterStart):_.actionFinish=i,scheduler.destroyCalendar(),_.$apply()}})}function v(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(_.actionStart),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(_.startMinutes)),i.setHours(parseInt(_.startHour)),i>_.actionFinish?alert(customLabels.startBeforeEnd):_.actionStart=i,scheduler.destroyCalendar(),_.$apply()}})}function p(){var e=new Date(_.actionStart);e.setMinutes(parseInt(_.startMinutes)),e.setHours(parseInt(_.startHour)),e>=_.actionFinish?(alert(customLabels.startBeforeEnd),_.startMinutes=_.actionStart.getMinutes(),_.startHour=_.actionStart.getHours().toString()):_.actionStart=e}function g(){var e=new Date(_.actionFinish);e.setMinutes(parseInt(_.endMinutes)),e.setHours(parseInt(_.endHour)),e<=_.actionStart?(alert(customLabels.finishAfterStart),_.endMinutes=_.actionFinish.getMinutes().toString(),_.endHour=_.actionFinish.getHours().toString()):_.actionFinish=e}function h(){_.minutes=T,_.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],_.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),_.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),_.startHour="0",_.endHour="0",_.startMinutes="0",_.endMinutes="0"}function m(e){a.flagged[e]=!a.flagged[e]}function f(e){return a.flagged[e]}function S(e){return o.serviceAppointments()[e].name}function b(){var e=[],t=void 0,i=void 0;if("locations"===_.targetServices){t=_.actionStart,i=_.actionFinish,t.setHours(_.startHour),t.setMinutes(_.startMinutes),t.setHours(_.endHour),t.setMinutes(_.endMinutes);for(var n in _.selectedLocations)_.selectedLocations[n]&&e.push(n);if(0===e.length)return void alert(customLabels.noLocationWasSelected)}else e=s.getSelected();r.setBulkActionRunning(),_.bulkState="running",a.changeStatus(e,c.CANCELED,t,i).then(function(t){if(t.nothingToDispatch)return void(_.nothingToDispatch=!0);a.drawServicesAndAbsences(t.services),_.results.canceled=[],e="locations"===_.targetServices?t.services.map(function(e){return e.id}):e;for(var i=0;i<e.length;i++)o.serviceAppointments()[e[i]].status===c.CANCELED&&_.results.canceled.push(o.serviceAppointments()[e[i]]);_.results.failed=Object.keys(t.failedResults).length>0?t.failedResults:null})["catch"](function(e){console.warn("bulk cancel failed :("),console.log(e)})["finally"](function(){r.setBulkActionRunning(!1),_.bulkState="finished"})}function y(){var e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n							</select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>');return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer LightboxContainerAnimation" id="BulkActionsLightbox">\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                            \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                        \u2028</svg>\n                        <h1 class="light-box-header">'+customLabels.BulkCancel+'</h1>\n                    </div>\n\n                    <div ng-show="bulkState == \'finished\'">\n\n                        <div ng-show="nothingToDispatch" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n\n                        <div ng-show="results.canceled.length" class="lightboxResultContainer">\n\n                            <div class="unscheduleTableTitle">'+customLabels.SuccessfullyCanceled+'</div>\n\n                            <div ng-repeat="dispatced in results.canceled" class="lightboxTableRow">\n                                {{ dispatced.name }}\n                                <div ng-click="toggleFlag(dispatced.id)" class="bulkActionLightboxFlag">\n                                    <span ng-show="isFlagged(dispatced.id)">'+customLabels.Unflag+'</span>\n                                    <span ng-show="!isFlagged(dispatced.id)">'+customLabels.Flag+'</span>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div ng-show="results.failed" class="lightboxResultContainer">\n                            <div class="unscheduleTableTitle">'+customLabels.FailToCancel+'</div>\n                            <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                <span>{{ failedReason.errorMessage }}</span>\n\n                                <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                    <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                    <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                </div>\n\n                            </div>\n                        </div>\n\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.CancelingPleaseWait+'\n                    </div>\n\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.CancelLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ \''+customLabels.x_selected+'\' | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+"</label>\n                                </div>\n\n                                <div class=\"bulkOptimizeOptions\" ng-class=\"{'disabled-area': targetServices != 'locations'}\">\n                                    "+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="bulkCancel()">'+customLabels.CancelServices+"</div>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            ")}for(var _=null,T=[],w=0;60>w;w++)T.push(w);return{open:l}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService","SERVICE_STATUS"],angular.module("serviceExpert").factory("bulkCancelService",e)}(),function(){function e(e,t,i,s,n,r,a,o,c){function l(){
_=t.$new(!0),_.$on("keypress",function(e,t){27==t.which&&_.$evalAsync(_.closeLightbox)});var a=n.GetUserSettingsProperty("locations");_.filteredLocations=a.map(function(e){return i.territories[e]}),_.selectedCount=s.countSelectedServices(),_.contractorSupport=r.areContractorsSupported(),h(),_.dateSelectFinishWidget=d,_.dateSelectStartWidget=v,_.validateDatesStart=p,_.validateDatesEnd=g,_.targetServices=0==_.selectedCount?"locations":"selectedServices",_.bulkState="form",_.bulkDispatch=b,_.results={},_.toggleFlag=m,_.isFlagged=f,_.getServiceName=S,_.selectedLocations={},_.nothingToDispatch=!1,_.isAmpm=isAMPM?"ampm":"24",_.selectedMashu=customLabels.x_selected;var o=y();o.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(o),_.closeLightbox=u,_.$on("$destroy",function(){return o.remove()}),e(o)(_),o.show(),r.setLightBoxStatus()}function u(){"running"!==_.bulkState&&(r.setLightBoxStatus(!1),_.$destroy())}function d(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(_.actionFinish),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(_.endMinutes)),i.setHours(parseInt(_.endHour)),i<_.actionStart?alert(customLabels.finishAfterStart):_.actionFinish=i,scheduler.destroyCalendar(),_.$apply()}})}function v(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(_.actionStart),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(_.startMinutes)),i.setHours(parseInt(_.startHour)),i>_.actionFinish?alert(customLabels.startBeforeEnd):_.actionStart=i,scheduler.destroyCalendar(),_.$apply()}})}function p(){var e=new Date(_.actionStart);e.setMinutes(parseInt(_.startMinutes)),e.setHours(parseInt(_.startHour)),e>=_.actionFinish?(alert(customLabels.startBeforeEnd),_.startMinutes=_.actionStart.getMinutes(),_.startHour=_.actionStart.getHours().toString()):_.actionStart=e}function g(){var e=new Date(_.actionFinish);e.setMinutes(parseInt(_.endMinutes)),e.setHours(parseInt(_.endHour)),e<=_.actionStart?(alert(customLabels.finishAfterStart),_.endMinutes=_.actionFinish.getMinutes().toString(),_.endHour=_.actionFinish.getHours().toString()):_.actionFinish=e}function h(){_.minutes=T,_.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],_.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),_.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),_.startHour="0",_.endHour="0",_.startMinutes="0",_.endMinutes="0"}function m(e){a.flagged[e]=!a.flagged[e]}function f(e){return a.flagged[e]}function S(e){return o.serviceAppointments()[e].name}function b(){var e=[],t=void 0,i=void 0;if("locations"===_.targetServices){t=_.actionStart,i=_.actionFinish,t.setHours(_.startHour),t.setMinutes(_.startMinutes),i.setHours(_.endHour),i.setMinutes(_.endMinutes);for(var n in _.selectedLocations)_.selectedLocations[n]&&e.push(n);if(0===e.length)return void alert(customLabels.noLocationWasSelected)}else e=s.getSelected();r.setBulkActionRunning(),_.bulkState="running",a.changeStatus(e,c.DISPATCHED,t,i).then(function(t){if(t.nothingToDispatch)return void(_.nothingToDispatch=!0);a.drawServicesAndAbsences(t.services),_.results.dispatched=[],e="locations"===_.targetServices?t.services.map(function(e){return e.id}):e;for(var i=0;i<e.length;i++)o.serviceAppointments()[e[i]].status===c.DISPATCHED&&_.results.dispatched.push(o.serviceAppointments()[e[i]]);_.results.failed=Object.keys(t.failedResults).length>0?t.failedResults:null})["catch"](function(e){console.warn("bulk dispatch failed :("),console.log(e)})["finally"](function(){r.setBulkActionRunning(!1),_.bulkState="finished"})}function y(){var e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n							</select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>');return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer LightboxContainerAnimation" id="BulkActionsLightbox">\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" id="CloseDispatchLightbox">\n                            \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                        \u2028</svg>\n                        <h1 class="light-box-header">'+customLabels.BulkDispatch+'</h1>\n                    </div>\n\n                    \n                    <div id="ori-ohev-banim" ng-show="bulkState == \'finished\'">\n                        <div ng-show="bulkState == \'finished\'">\n    \n                            <div ng-show="nothingToDispatch" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n    \n                            <div ng-show="results.dispatched.length" class="lightboxResultContainer dispatchResultsContainer1">\n    \n                                <div class="unscheduleTableTitle">'+customLabels.SuccessfullyDispatched+'</div>\n    \n                                <div ng-repeat="dispatced in results.dispatched" class="lightboxTableRow">\n                                    {{ dispatced.name }}\n                                    <div ng-click="toggleFlag(dispatced.id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(dispatced.id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(dispatced.id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">'+customLabels.FailToDispatch+'</div>\n                                <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span>{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n    \n                        </div>\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.DispatchingPleaseWait+'\n                    </div>\n\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.DispatchLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ selectedMashu | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+"</label>\n                                </div>\n\n                                <div class=\"bulkOptimizeOptions\" ng-class=\"{'disabled-area': targetServices != 'locations'}\">\n                                    "+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="bulkDispatch()">'+customLabels.Dispatch+"</div>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            ")}for(var _=null,T=[],w=0;60>w;w++)T.push(w);return{open:l}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService","SERVICE_STATUS"],angular.module("serviceExpert").factory("bulkDispatchService",e)}(),function(){function e(e,t,i,s,n){function r(s,r){d=n.get("servicesService"),v=t.$new(!0),v.getServiceName=c,v.results={success:[],failed:Object.keys(s.failedResults).length>0?s.failedResults:null},v.labels=r,v.toggleFlag=a,v.isFlagged=o;for(var p=0;p<s.services.length;p++)s.failedResults[s.services[p].Id]||v.results.success.push(s.services[p].Id);v.$on("keypress",function(e,t){27==t.which&&v.$evalAsync(v.closeLightbox)});var g=u();g.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(g),v.closeLightbox=l,v.$on("$destroy",function(){return g.remove()}),e(g)(v),g.show(),i.setLightBoxStatus()}function a(e){d.flagged[e]=!d.flagged[e]}function o(e){return d.flagged[e]}function c(e){return s.serviceAppointments()[e].name}function l(){i.setLightBoxStatus(!1),v.$destroy()}function u(){return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer LightboxContainerAnimation" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.BulkActionResults+'</h1>\n                        </div>\n\n                        <div class="resultsContainerOverflow">\n                            <div ng-show="results.success && results.success.length" class="lightboxResultContainer">\n    \n                                <div class="unscheduleTableTitle">{{labels.success}}</div>\n    \n                                <div ng-repeat="id in results.success" class="lightboxTableRow">\n                                    {{ getServiceName(id) }}\n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed && results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">{{labels.fail}}</div>\n                                <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span class="BulkResultLine">{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+"</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                </div>\n            ")}for(var d=null,v=null,p=[],g=0;60>g;g++)p.push(g);return{open:r}}e.$inject=["$compile","$rootScope","StateService","TimePhasedDataService","$injector"],angular.module("serviceExpert").factory("bulkResultsService",e)}(),function(){function e(e,t,i,s,n){function r(s){var r=null;v=n.get("servicesService"),r=t.$new(!0),r.isAdmin=!1,void 0==window.userHasAdminPermissions?sfdcService.userHasAdminPermissions().then(function(e){e?window.userHasAdminPermissions=r.isAdmin=!0:window.userHasAdminPermissions=!1}):r.isAdmin=window.userHasAdminPermissions,r.toggleFlag=c,r.isFlagged=l,r.results=s,r.getService=o,r.isError=a,r.successfullyScheduled=0,r.globalSelectedCount=Object.keys(s).length,r.generatePartialResult=function(e){return customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)},r.replaceLabelsForSebas=function(){return customLabels.x_services_scheduled_of_y_here_are_results.replaceAll(r.successfullyScheduled,r.globalSelectedCount)};for(var p in s)"scheduled"===s[p].textResult&&r.successfullyScheduled++;r.$on("keypress",function(e,t){27==t.which&&r.$evalAsync(r.closeLightbox)}),r.closeLightbox=u,r.$on("$destroy",function(){return g.remove()});var g=d();g.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),e(g)(r),angular.element("body").append(g),g.show(),i.setLightBoxStatus()}function a(e){return angular.isObject(e)}function o(e){return s.serviceAppointments()[e]}function c(e){v.flagged[e]=!v.flagged[e]}function l(e){return v.flagged[e]}function u(e){i.setLightBoxStatus(!1),e.$destroy()}function d(){return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer LightboxContainerAnimation" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox(this)" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.BulkScheduleResults+'</h1>\n                        </div>\n\n                        <div style="padding:0 15px">\n                        \n                            <p>{{ replaceLabelsForSebas() }}</p>\n            \n                            <div id="ResultTableHeader">\n                                <span>'+customLabels.ID+'</span>\n                                <span id="ResultHeaderStart">'+customLabels.Start+"</span>\n                                <span>"+customLabels.Finish+'</span>\n                                <span id="ResultResourceHeader">'+customLabels.Resource+'</span>\n                            </div>\n            \n                            <div id="ScheduledResultsTable">\n                                <div ng-repeat="(id,res) in results" class="ScheduleResultRow">\n                                \n                                    <span class="scheduledResultColName">{{ getService(id).name }}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).start | amDateFormat:\'lll\'}}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).finish | amDateFormat:\'lll\'}}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).resourceName}}</span>\n                                    <span class="ScheduleResultUnscheduled" ng-if="isError(res)">{{ res.msg }}</span>\n                                    <!--<span class="ScheduleResultUnscheduled" ng-if="isError(res)">'+customLabels.NoCandidates+'</span>-->\n                                    <span class="ScheduleResultUnscheduled" ng-if="res.textResult == \'no candidates\'">'+customLabels.NoCandidates+'</span>\n                                    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                    \n                                    <div class="PartialResultsBulk" ng-show="res.partialResults.length > 0" ng-init="res.showDetails = false;">\n                                        <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="res.showDetails = !res.showDetails">'+customLabels.ShowDetails+'</u></div>\n            \n                                        <div ng-show="res.showDetails">\n                                            <ul>\n                                                <li ng-repeat="partial in res.partialResults">\n                                                    {{ generatePartialResult(partial) }}\n                                                </li>\n                                            </ul>\n                                        </div>\n                                    </div>\n                                    \n                                </div>\n                            </div>\n                            \n                        </div>\n                    </div>\n\n                </div>\n            ')}var v=null;return{open:r}}e.$inject=["$compile","$rootScope","StateService","TimePhasedDataService","$injector"],angular.module("serviceExpert").factory("bulkScheduleResultsService",e)}(),function(){function e(e,t,i,s,n,r,a,o){function c(){g=i.$new(!0),g.isInConsole=r.isInConsole(),g.actionName="Schedule",g.currentSchedulingIndex=0,g.successfullyScheduled=0,g.afterSchedulingServiceObjects={},g.close=l,g.showResults=u,g.progressBarStyle=d,g.getLabel=function(e){return customLabels[e]};var e=p();angular.element("body").append(e),g.$on("$destroy",function(){return e.remove()}),t(e)(g),e.show()}function l(){g.$destroy()}function u(){a.open(g.afterSchedulingServiceObjects),g.$destroy()}function d(){return{width:(g.currentSchedulingIndex+1)/g.globalSelectedCount*100+"%"}}function v(t){0===t.length||r.isScheduleRunning||(g&&g.$destroy(),c(),r.isScheduleRunning=!0,g.globalSelectedCount=t.length,s.sortServicesByPriority(t).then(function(t){function i(e){r.schedulingRunningFor[o[e].id]=!0,s.autoScheduleService(o[e].id).then(function(t){console.log(t),s.drawServicesAndAbsences(t.services,t.absences),g.afterSchedulingServiceObjects[o[e].id]={},g.afterSchedulingServiceObjects[o[e].id].partialResults=t.partialResults,g.afterSchedulingServiceObjects[o[e].id].textResult="no candidates",t.services.forEach(function(t){t.id==o[e].id&&(g.afterSchedulingServiceObjects[o[e].id].textResult="scheduled",g.successfullyScheduled++)})})["catch"](function(t){var i={};i.msg=t.message,g.afterSchedulingServiceObjects[o[e].id]=i})["finally"](function(){if(g.currentSchedulingIndex++,r.schedulingRunningFor[o[e].id]=!1,e+1<g.globalSelectedCount&&a[e+1].resolve(e+1),e+1==g.globalSelectedCount){var t=[];for(var i in scheduler._events)"service"===scheduler._events[i].type&&t.push(i);t.length>0&&s.checkRules(t).then(function(){return scheduler.updateView()}),r.isScheduleRunning=!1}})}var a=[],o=[];t.forEach(function(e){o.push(n.serviceAppointments()[e.ServiceId])}),g.globalSelectedServiceObjects=o;for(var c=0;c<g.globalSelectedCount;c++){var l=e.defer();l.promise.then(i),a.push(l)}a[0].resolve(0)}))}function p(){return angular.element('\n            <div id="SchedulingInProgress" class="slideInProgressBox" ng-class="{SchedulingInProgressConsole: isInConsole}">\n\n				<div ng-show="currentSchedulingIndex != globalSelectedCount">\n					<i class="fa fa-spinner fa-spin"></i> '+customLabels.Scheduling_Services+'\n					<div class="ProgressBar">\n						<div ng-style="progressBarStyle()"></div>\n					</div>\n\n					<div ng-cloak class="ProgressBarLabel">{{ getLabel(\'Scheduling_service\') | replaceLabels : (currentSchedulingIndex+1) : globalSelectedCount }}</div>\n				</div>\n\n				<div ng-show="currentSchedulingIndex == globalSelectedCount">\n					<i class="fa fa-check"></i> '+customLabels.Scheduling_Complete+'\n					<div ng-cloak class="HowManyWereScheduled">{{  getLabel(\'Scheduled_x_out_of_y\') | replaceLabels : successfullyScheduled : globalSelectedCount }}</div>\n					<span ng-cloak class="InProgressAction" ng-click="close()">'+customLabels.Close+'</span>\n					<span ng-cloak class="InProgressAction" ng-click="showResults()">'+customLabels.View_services+"</span>\n				</div>\n\n			</div>")}var g=null;return{schedule:v}}e.$inject=["$q","$compile","$rootScope","servicesService","TimePhasedDataService","StateService","bulkScheduleResultsService","utils"],angular.module("serviceExpert").factory("bulkScheduleService",e)}(),function(){function e(e,t,i,s,n,r,a,o){function c(){y=t.$new(!0),y.$on("keypress",function(e,t){27==t.which&&y.$evalAsync(y.closeLightbox)});var a=n.GetUserSettingsProperty("locations");y.filteredLocations=a.map(function(e){return i.territories[e]}),y.selectedCount=s.countSelectedServices(),y.contractorSupport=r.areContractorsSupported(),g(),y.dateSelectFinishWidget=u,y.dateSelectStartWidget=d,y.validateDatesStart=v,y.validateDatesEnd=p,y.targetServices=0==y.selectedCount?"locations":"selectedServices",y.bulkState="form",y.bulkUnschedule=S,y.results={},y.toggleFlag=h,y.isFlagged=m,y.getServiceName=f,y.selectedLocations={},y.nothingToUnschedule=!1,y.isAmpm=isAMPM?"ampm":"24",y.exception=null;var o=b();o.find("#UnschduleLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(o),y.closeLightbox=l,y.getCustomLabel=function(e){return customLabels[e]},y.$on("$destroy",function(){return o.remove()}),e(o)(y),o.show(),r.setLightBoxStatus()}function l(){"running"!==y.bulkState&&(r.setLightBoxStatus(!1),y.$destroy())}function u(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(y.actionFinish),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(y.endMinutes)),i.setHours(parseInt(y.endHour)),i<y.actionStart?alert(customLabels.finishAfterStart):y.actionFinish=i,scheduler.destroyCalendar(),y.$apply()}})}function d(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(y.actionStart),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(y.startMinutes)),i.setHours(parseInt(y.startHour)),i>y.actionFinish?alert(customLabels.startBeforeEnd):y.actionStart=i,scheduler.destroyCalendar(),y.$apply()}})}function v(){var e=new Date(y.actionStart);e.setMinutes(parseInt(y.startMinutes)),e.setHours(parseInt(y.startHour)),e>=y.actionFinish?(alert(customLabels.startBeforeEnd),y.startMinutes=y.actionStart.getMinutes(),y.startHour=y.actionStart.getHours().toString()):y.actionStart=e}function p(){var e=new Date(y.actionFinish);e.setMinutes(parseInt(y.endMinutes)),e.setHours(parseInt(y.endHour)),e<=y.actionStart?(alert(customLabels.finishAfterStart),y.endMinutes=y.actionFinish.getMinutes().toString(),y.endHour=y.actionFinish.getHours().toString()):y.actionFinish=e}function g(){y.minutes=_,y.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],y.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),y.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),y.startHour="0",y.endHour="0",y.startMinutes="0",y.endMinutes="0"}function h(e){a.flagged[e]=!a.flagged[e]}function m(e){return a.flagged[e]}function f(e){return o.serviceAppointments()[e].name}function S(){var e=[],t=void 0,i=void 0;if("locations"===y.targetServices){t=y.actionStart,i=y.actionFinish,t.setHours(y.startHour),t.setMinutes(y.startMinutes),i.setHours(y.endHour),i.setMinutes(y.endMinutes);for(var n in y.selectedLocations)y.selectedLocations[n]&&e.push(n);if(0===e.length)return void alert(customLabels.noLocationWasSelected)}else e=s.getSelected();r.setBulkActionRunning(),y.bulkState="running",a.unscheduleServices(e,t,i).then(function(t){if(t.nothingToUnschedule)return void(y.nothingToUnschedule=!0);a.drawServicesAndAbsences(t.services,t.absences,[],t.capacities),y.results.unscheduled=[],e="locations"===y.targetServices?t.services.map(function(e){return e.id}):e;for(var i=0;i<e.length;i++)o.serviceAppointments()[e[i]].isScheduled()||y.results.unscheduled.push(o.serviceAppointments()[e[i]]);y.results.failed=Object.keys(t.failedResults).length>0?t.failedResults:null})["catch"](function(e){console.warn("bulk unschedule failed :("),console.log(e),y.exception=e})["finally"](function(){r.setBulkActionRunning(!1),y.bulkState="finished"})}function b(){var e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n							</select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>');return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer LightboxContainerAnimation" id="BulkActionsLightbox">\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                            \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                        \u2028</svg>\n                        <h1 class="light-box-header">'+customLabels.BulkUnschedule+'</h1>\n                    </div>\n\n                    <div ng-show="bulkState == \'finished\'">\n\n\n                        <div ng-show="nothingToUnschedule" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n\n                        <div class="resultsContainerOverflow class="unschedule_res_thingy_qa_halash">\n                        \n                            <div class="bulk-exception" ng-show="exception">\n                                <svg aria-hidden="true" class="slds-icon kpiIcon">\n                                    \u2028<use xlink:href="'+lsdIcons.violation+'"></use>\n                                \u2028</svg>\n                                {{ exception.message }} \n                            </div>\n                        \n                            <div ng-show="results.unscheduled.length" class="lightboxResultContainer">\n    \n                                <div class="unscheduleTableTitle">'+customLabels.SuccessfullyUnscheduled+'</div>\n    \n                                <div ng-repeat="unscheduled in results.unscheduled track by $index" class="lightboxTableRow">\n                                    {{ unscheduled.name }}\n                                    <div ng-click="toggleFlag(unscheduled.id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(unscheduled.id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(unscheduled.id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">'+customLabels.FailToUnschedule+'</div>\n                                <div ng-repeat="(id, failedReason) in results.failed track by $index" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span>{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n                        </div>\n\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.UnschedulingPleaseWait+'\n                    </div>\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.UnscheduleLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ getCustomLabel(\'x_selected\') | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+'</label>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    '+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="bulkUnschedule()">'+customLabels.Unschedule+"</div>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            ");
}for(var y=null,_=[],T=0;60>T;T++)_.push(T);return{open:c}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService"],angular.module("serviceExpert").factory("bulkUnscheduleService",e)}(),function(){angular.module("serviceExpert").factory("calendarsService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils",function(e,t,i,s){function n(){f={},S={},b={},y.resourceToWorkingDates=b}function r(i,n,r){for(var o=new Date(i),c=null;n>o;){var l=s.formatDayToString(o);if(!f[l]){f[l]=!0,c||(c=m(t.resourcesAndTerritories()));var u=new Date(o);u.setDate(u.getDate()+1);for(var d in e.getResources())a(new Date(o),new Date(u),d,c[d])}o.setDate(o.getDate()+1)}}function a(t,i,n,r,a){var l={P:[],R:[],S:[]},u={};for(var v in r){for(var p=r[v].slice(),f=s.generateResourceId(n,v),b=t,y=0;y<p.length;y++){var _=p[y],T=s.intersectDates({start:b,finish:i},_);if(l[_.type].push(_),"S"!=_.type){if(T.intersection){for(var w=0;w<T.remainderFrom1.length;w++){var L=T.remainderFrom1[w];L.isStart&&h(L.start,L.finish,f)}"R"!=_.type||S[_.id]||a||g(_,r,n),b=T.intersection.finish;var k=_.operatingHours||e.allTerritories[v].operatingHours;k?d(T.intersection.start,T.intersection.finish,k,f,a):h(T.intersection.start,T.intersection.finish,f)}}else u[_.serviceTerritory]=_}b.getTime()==i.getTime()||u[f.split("_")[1]]||h(b,i,f)}if(showSecondarySTMs&&!s.isEmpty(u)&&!a){var C=o(l,n,u),R=m(C);c(t,i,n,R[n],!0)}}function o(e,t,i){var n={};n[t]={};for(var r=0;r<e.P.length;r++){var a=e.P[r];if(0!=e.R.length)for(var o=0;o<e.R.length;o++){var c=e.R[o],l=s.intersectDates(a,c);if(l.intersection||(n[t][a.id]=a),l.remainderFrom1.length>0)for(var u=0;u<l.remainderFrom1.length;u++){var d=angular.copy(a);d.start=l.remainderFrom1[u].start,d.finish=l.remainderFrom1[u].finish,n[t][a.id+"_"+u]=d}if(!n[t][c.id]){var v=angular.copy(c);v.serviceTerritory=a.serviceTerritory,n[t][v.id]=v}}else n[t][a.id]=a}var p={};p[t]={};for(var g=0;g<e.S.length;g++){var h=e.S[g];for(var m in n[t]){var f=n[t][m],S=s.intersectDates(f,h);if(S.intersection){var b=angular.copy(f);b.start=S.intersection.start,b.finish=S.intersection.finish,window.isShowSecondaryOperatingHours&&h.operatingHours&&(b.operatingHours=h.operatingHours),b.ohTerr=b.serviceTerritory,b.serviceTerritory=h.serviceTerritory,p[t][m+"_"+g]=b}}}return p}function c(t,i,n,r,a){for(var o in r){for(var c=r[o].slice(),l=s.generateResourceId(n,o),u=t,v=0;v<c.length;v++){var p=c[v],g=s.intersectDates({start:u,finish:i},p);if(g.intersection){for(var m=0;m<g.remainderFrom1.length;m++){var f=g.remainderFrom1[m];f.isStart&&h(f.start,f.finish,l)}u=g.intersection.finish;var S=p.operatingHours||e.allTerritories[p.ohTerr].operatingHours;S?d(g.intersection.start,g.intersection.finish,S,l,a):h(g.intersection.start,g.intersection.finish,l)}}u.getTime()!=i.getTime()&&h(u,i,l)}}function l(e,t){return s.convertDtToMomentDt(e,t)}function u(e){return s.convertMomentDtToDt(e)}function d(t,i,n,r,a){var o=e.getOperatingHours()[n],c=o.timezone,d=useLocationTimezone?c:userTimeZone;if(a&&useLocationTimezone)for(var g=r.split(","),m=0;m<g.length;m++){var f=g[m].split("_")[1],S=e.territories[f].operatingHours;d=e.getOperatingHours()[S].timezone}for(var b=l(t,d),y=l(i,d),_=(b.clone().tz(c),y.clone().tz(c),u(b)),T=u(y),w=_,L=[b.clone().add(-1,"days"),b.clone(),b.clone().add(1,"days")],k=0;k<L.length;k++)for(var C=L[k],R=o.slots[C.get("day")]||[],D=0;D<R.length;D++){var A=R[D],I=v(C,A,"startHour","startMinute",c,d,a),F=v(C,A,"endHour","endMinute",c,d,a),x=s.intersectDates({start:I,finish:F},{start:_,finish:T}).intersection;x&&(I=x.start,F=x.finish,"Extended"==A.type?(h(w,I,r,null),h(I,F,r,A.type)):h(w,I,r,A.type),p(I,F,A.type,r),w=F)}h(w,T,r,null)}function v(e,t,i,s,n,r,a){var o=u(e);o.setHours(t[i]),o.setMinutes(t[s]);var c=useLocationTimezone?n:userTimeZone;a&&useLocationTimezone&&(c=r);var d=l(o,n),v=u(d.tz(c));return v}function p(e,t,i,n){var r=(t.getTime()-e.getTime())/6e4,a=b[n];a||(a={},b[n]=a);var o=s.formatDayToString(e),c=a[o];c||(c={regular:0,overtime:0},a[o]=c),"Extended"==i?c.overtime+=r:c.regular+=r}function g(t,i,n){var r=[];if(showSecondarySTMs)for(var a in i)for(var o=0;o<i[a].length;o++)"S"!=i[a][o].type&&-1==r.indexOf(a)&&r.push(a);else r=Object.keys(i);r.splice(r.indexOf(t.serviceTerritory),1);for(var c=t.serviceTerritory,d=e.territories[c].operatingHours,v=e.getOperatingHours()[d].timezone,p=0;p<r.length;p++){var g=[s.generateResourceId(n,r[p])];S[t.id]=!0;var h=t.start,m=t.finish;if(useLocationTimezone){var f=e.territories[r[p]].operatingHours,b=e.getOperatingHours()[f].timezone;h=u(l(h,v).tz(b)),m=u(l(m,v).tz(b))}var y=e.territories[t.serviceTerritory].name,T=_.escape(customLabels.Relocated_to_many_params.replaceAll(y,moment(h).format("llll"),moment(m).format("llll"))),w=null;w=y?customLabels.Relocated_to.replace("$0",_.escape(y)):customLabels.Relocated_No_Permissions;var L="relocation",k="relocation_monthly";scheduler.addMarkedTimespan({start_date:h,end_date:m,sections:{ZoomLevel2:g,ZoomLevel3:g,ZoomLevel4:g,ZoomLevel5:g,ZoomLevel6:g},html:"<div class='relocatedLabel' title='"+T+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.relocation+"'></use></svg> "+w+"</div>",css:L}),scheduler.addMarkedTimespan({start_date:h,end_date:m,sections:{MonthlyView:g,MTDView:g},html:"<div class='relocatedLabel' title='"+T+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.relocation+"'></use></svg></div>",css:k})}}function h(e,t,i,s){if(e.getTime()!=t.getTime()){var n={};for(var r in scheduler.matrix)"MonthlyView"!==r&&(n[r]=i.indexOf(",")>-1?i.split(","):[i]);var a="gray_section";"Extended"==s&&(a="overtime_section"),scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:n,css:a})}}function m(e){var i={},n=e||t.resourcesByPrimariesAndRelocations();for(var r in n){var a=n[r],o={};i[r]=o;for(var c in a){var l=a[c],u=o[l.serviceTerritory];u||(u=[],o[l.serviceTerritory]=u),u.push({start:l.effectiveStartDate||l.start,finish:l.effectiveEndDate||l.finish,serviceTerritory:l.serviceTerritory,operatingHours:l.operatingHours,type:l.serviceTerritoryType||l.type,id:l.id,ohTerr:l.ohTerr||null})}for(var d in o){var v=o[d];v.sort(s.sortByTime)}}return i}var f={},S={},b={};i.$on("gotNewTimePhasedObjects",function(e,t){r(t.start,t.finish,t.resourceToServiceCrewMembers)});var y={resourceToWorkingDates:b,relocationsOnGantt:S,reset:n};return y}])}(),function(){function e(e,t,i,s,n,r,a,o,c,l,u){function d(s){_=e.$new(!0),_.lightboxCapacity=i.resourceCapacities()[s],_.fieldsTypes=r.fieldsTypes,_.selectedTab="details",_.kpiStart=_.lightboxCapacity.start_date,_.kpiEnd=_.lightboxCapacity.end_date,_.servicesScheduledToCapacity={},_.tableSort={orderByField:"",reverse:!1},_.flaggedServices=t.flagged,_.invokedActionFor={},_.SERVICE_CATEGORY=c,_.currentMenu=null,_.closeLightbox=v,_.openConsoleTab=r.openConsoleTab,_.formatKpitText=g,_.getObjectKeys=h,_.flagService=m,_.unscheduleServices=S,_.postToChatter=f,_.getStatusClass=r.getCSSClassForContext,_.violationsTooltip=b,u.fieldsSetFields().then(function(e){_.servicesListFields=e.CapacityServiceColumns,_.tableSort.orderByField=_.servicesListFields[0].APIName}),_.order=function(e,t){_.tableSort.orderByField=e,_.tableSort.reverse=t},_.getRefFieldID=function(e,t){var i=t.APIName.replace("__r","__c");return e[i]},_.setCurrentMenu=function(e){_.currentMenu==e?_.currentMenu=null:_.currentMenu=e},p(s);var o=y();o.find("#ContractorCapacityLightbox").draggable({handle:"#ContractorCapacityLightboxHeader"}),angular.element("body").append(o),a.setLightBoxStatus(),_.$on("$destroy",function(){return o.remove()}),_.$on("keypress",function(e,t){27==t.which&&_.$evalAsync(_.closeLightbox)}),n(o)(_),r.safeApply(_)}function v(){a.setLightBoxStatus(!1),_.$destroy()}function p(e){_.capacityKpi={hoursCapacity:0,hoursInUse:0,completed:0,jeopardy:0,workItemsCapacity:0,workItemsAllocated:0};var t=scheduler.getEvent(e),i=scheduler.getEvents(t.start_date,t.end_date);_.servicesScheduledToCapacity={},_.capacityKpi.hoursCapacity=t.hoursPerTimePeriod?t.hoursPerTimePeriod:0,_.capacityKpi.hoursInUse=t.hoursInUse?t.hoursInUse:0,_.capacityKpi.completed=0,_.capacityKpi.jeopardy=0,_.capacityKpi.violations=0,_.capacityKpi.workItemsCapacity=t.workItemsPerTimePeriod?t.workItemsPerTimePeriod:0,_.capacityKpi.workItemsAllocated=t.workItemsAllocated?t.workItemsAllocated:0,_.capacityKpi.total=0;for(var s=0;s<i.length;s++)i[s].resourceId==t.resourceId&&"service"==i[s].type&&i[s].start.getTime()>=t.start_date.getTime()&&i[s].start.getTime()<=t.end_date.getTime()&&(_.capacityKpi.total++,i[s].statusCategory==c.COMPLETED&&_.capacityKpi.completed++,i[s].jeopardy&&_.capacityKpi.jeopardy++,i[s].violations&&_.capacityKpi.violations++,_.servicesScheduledToCapacity[i[s].id]=i[s])}function g(){return customLabels.KPIsAreCalculatedFromTo.replaceAll(moment(_.kpiStart).format("llll"),moment(_.kpiEnd).format("llll"))}function h(e){return Object.keys(e).length>0?Object.keys(e):0}function m(e){return t.flagged[e]?void(t.flagged[e]&&(t.flagged[e]=!t.flagged[e])):void(t.flagged[e]=!0)}function f(e,i){return""===i&&(i=prompt(customLabels.msg_to_post_to_chatter,"")),""===i?void alert(customLabels.no_empty_msg_to_chatter):(t.recentlyUsed[e]=!0,void t.postToChatter([e],i).then(function(e){}))}function S(e){if(!confirm(customLabels.are_you_sure_unschedule))return!0;var s=[],n=[];e.forEach(function(e){_.invokedActionFor[e]=!0,n.push(i.serviceAppointments()[e]),s.push(i.serviceAppointments()[e].resource),t.recentlyUsed[e]=!0}),t.unscheduleServices(e).then(function(i){t.drawServicesAndAbsences(i.services,i.absences,[],i.capacities),p(_.lightboxCapacity.id),_.invokedActionFor[e[0]]=!1})["catch"](function(t){r.addNotification(customLabels.Action_Could_Not_Be_Performed,t.message||customLabels.user_is_not_allowed_to_perform_action),_.invokedActionFor[e[0]]=!1})}function b(e){if(e.violations){for(var t="",i=0;i<e.violations.length;i++)t+=e.violations[i].RuleName+" - "+e.violations[i].ViolationString+"\n";return t&&(t=t.substring(0,t.length-1)),t}}function y(){return angular.element('<div class="LightboxBlackContainer">\n				<div class="LightboxContainer" id="ContractorCapacityLightbox">\n\n					<div class="lightboxHeaderContainer" id="ContractorCapacityLightboxHeader">\n\n						<svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n							\u2028<use xlink:href="'+lsdIcons.close+'"></use>\n						</svg>\n\n						<h1 class="lightboxHeader">\n							<i>'+customLabels.Capacity+':</i>\n							{{ lightboxCapacity.name }}\n						</h1>\n\n						<span class="lightboxSelectedTab">\n							'+customLabels.Details+'\n						</span>\n\n						<div class="ExtendedForm">\n							<a ng-click="openConsoleTab($event,lightboxCapacity.id)" target="_blank" href="../{{ lightboxCapacity.id }}" title="'+customLabels.ExtandedForm+'">\n								<svg aria-hidden="true" class="slds-icon openExternalIcon">\n									\u2028<use xlink:href="'+lsdIcons.external+'"></use>\n								\u2028</svg>\n							</a>\n						</div>\n					</div>\n\n					<div id="KPIforCapacity" class="KPIforCapacity">\n						<div class="kpiIndicator" ng-show="capacityKpi.hoursCapacity > 0">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.clock+'"></use>\n								\u2028</svg>\n								{{ capacityKpi.hoursInUse }}/{{ capacityKpi.hoursCapacity }}</div>\n							'+customLabels.Hours_Capacity+'\n						</div>\n\n						<div class="kpiIndicator" ng-show="capacityKpi.workItemsCapacity > 0">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.standard_objects+'"></use>\n								\u2028</svg>\n								{{ capacityKpi.workItemsAllocated }}/{{ capacityKpi.workItemsCapacity }}</div>\n							'+customLabels.Services_Capacity+'\n						</div>\n\n						<div class="kpiIndicator">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.violation+'"></use>\n								\u2028</svg>\n								<!--<i class="fa fa-warning"></i>-->\n								{{ capacityKpi.violations }}</div>\n							'+customLabels.Violations+'\n						</div>\n\n						<div class="kpiIndicator">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.jeopardy+'"></use>\n								\u2028</svg>\n								{{ capacityKpi.jeopardy }}</div>\n							'+customLabels.In_Jeopardy+'\n						</div>\n\n						<div class="kpiIndicator">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.completed+'"></use>\n								\u2028</svg>\n\n								{{ capacityKpi.completed }}/{{ capacityKpi.total }}</div>\n							'+customLabels.Completed+'\n						</div>\n\n						<div class="KpiRange">{{formatKpitText()}}</div>\n					</div>\n                    <div id="ContractorCapacityButtons">\n                            <span class="capacityServiceUnscheduleAll" ng-show="getObjectKeys(servicesScheduledToCapacity).length > 0" ng-click="unscheduleServices(getObjectKeys(servicesScheduledToCapacity))">\n                                <i class="fa fa-ban"></i>\n                                 '+customLabels.Unschedule_All+'\n                            </span>\n                        </div>\n					<div id="ContractorCapacityLightboxContent">\n					\n                            <div class="NoServicesFound" ng-show="!getObjectKeys(servicesScheduledToCapacity)">\n                                <i class="fa fa-times"></i>\n                                <div>'+customLabels.No_services+'</div>\n                            </div>\n                        \n                        <table id="CapacityServicesTable" ng-show="getObjectKeys(servicesScheduledToCapacity).length > 0">\n                          <thead>\n                            <tr class="table-header">\n                                <th></th>\n                                <th></th>\n                                <th></th>\n                                <th ng-attr-title="{{field.Label}}" ng-repeat="field in servicesListFields" ng-class="{sortCapacityServicesBy: tableSort.orderByField == field.APIName}" class="truncate capacityServiceColName" ng-click="tableSort.reverse=!tableSort.reverse;order(field.APIName, tableSort.reverse)">\n                                    <span class="">{{field.Label}}</span>\n                                    <span ng-show="tableSort.orderByField == field.APIName">\n                                        <span>\n                                            <svg ng-show ="!tableSort.reverse" aria-hidden="true" class="slds-icon arrowIcon">\n                                              <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                            </svg>\n                                            <svg ng-show ="tableSort.reverse" aria-hidden="true" class="slds-icon arrowIcon">\n                                              <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                            </svg>\n                                        </span>\n                                    </span>\n                                </th>\n                            </tr>\n                          </thead>\n                          <tbody>\n                            <tr ng-repeat="(key, capacityService) in servicesScheduledToCapacity | orderObjectBy:tableSort.orderByField:tableSort.reverse" class="capacityServiceRow">\n                                <td style="background:{{capacityService.ganttColor}}" class="TaskStatusColor {{ getStatusClass(capacityService.statusCategory, SERVICE_CATEGORY) }}" ></td>\n                                <td class="moreOptions">\n                                    <div class="serviceCapacityActionsButton" title="Actions" ng-click="setCurrentMenu($index)">\n                                          <svg class="slds-icon carretDownIcon" aria-hidden="true" ng-show="!invokedActionFor[capacityService.id]">\n                                                <use xlink:href="'+lsdIcons.down+'"></use>\n                                          </svg>\n                                          <img class="capacityServiceLoading"\n                                             src="'+lsdIcons.spinnerGif+'"\n                                             ng-show="invokedActionFor[capacityService.id]"/>\n                                    </div>   \n                                    <div id="actions-menu-{{$index}}" class="serviceCapacityActions" ng-show="currentMenu == $index">\n                                        <a class="saSingleAction" ng-click="openConsoleTab($event,capacityService.id); setCurrentMenu($index);" target="_blank" href="../{{ capacityService.id }}">'+customLabels.Details+'</a>\n                                        <div class="saSingleAction" ng-click="flagService(capacityService.id); setCurrentMenu($index);">\n                                            <span ng-show="!flaggedServices[capacityService.id]">'+customLabels.Flag+'</span>\n                                            <span ng-show="flaggedServices[capacityService.id]">'+customLabels.Unflag+'</span>\n                                        </div>\n                                        <div class="saSingleAction" ng-click="unscheduleServices([capacityService.id]); setCurrentMenu($index);">'+customLabels.Unschedule+'</div>\n                                        <div class="saSingleAction" ng-click="postToChatter(capacityService.id, \'\'); setCurrentMenu($index);">'+customLabels.Chatter+'</div>\n                                    </div>\n                                </td>\n                                <td class="iconOnServiceRow"\n                                        title="{{ violationsTooltip(capacityService) }}"\n                                        ng-class="{\'serviceList_jeopardy\': capacityService.jeopardy, \'serviceList_violations\': !capacityService.jeopardy && capacityService.violations}">\n                                        <i class="fa fa-bell" ng-if="capacityService.jeopardy"></i>\n                                        <i class="fa fa-warning" ng-if="capacityService.violations && !capacityService.jeopardy"></i>\n                                </td>\n                                <td ng-attr-title="{{capacityService | displayFieldSetField : field}}" ng-repeat="field in servicesListFields" class="truncate">\n                                    <span ng-show="field.Type != fieldsTypes.Reference" title="{{capacityService | displayFieldSetField : field}}">{{capacityService | displayFieldSetField : field}}</span>\n                                    <a ng-show="field.Type == fieldsTypes.Reference" ng-click="openConsoleTab($event, getRefFieldID(capacityService, field))" target="_blank" href="../{{ getRefFieldID(capacityService, field) }}" title="{{capacityService | displayFieldSetField : field}}">\n                                        {{capacityService | displayFieldSetField : field}}\n                                    </a>\n\n                                </td>\n                            </tr>\n                          </tbody>\n                        </table>\n\n\n					</div>\n				</div>\n			</div>')}var _=null;return{open:d}}e.$inject=["$rootScope","servicesService","TimePhasedDataService","$sce","$compile","utils","StateService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService","FieldSetFieldsService"],angular.module("serviceExpert").factory("CapacityLightboxService",e)}(),function(){function e(e,t,i,s,n,r,a){function o(){0==n.getStreamingActiveState()&&e.getDelta(d).then(function(e){d=e.updateTime;var t=[];if(e.deletedAbsence&&e.deletedAbsence.length>0||e.updatedAbsence&&e.updatedAbsence.length>0){var a={};if(e.deletedAbsence.length>0&&(a.deleted=i.deleteTimePhaseData(e.deletedAbsence,"na").absences,t.push.apply(t,_toConsumableArray(r.getRelatedServices(a.deleted)))),e.updatedAbsence.length>0){a.updated=i.updateTimePhaseData(e.updatedAbsence,"na").absences;var o=a.updated.map(function(e){return e.resource}).join(",");t.push.apply(t,_toConsumableArray(r.getRelatedServices(r.getIdsOfSObjects(a.updated),o)))}(a.updated||a.deleted)&&p.absences.forEach(function(e){return e(a)})}if(e.updatedGanttServices&&e.updatedGanttServices.length>0||e.deletedGanttServices&&e.deletedGanttServices.length>0){var c={};e.deletedGanttServices.length>0&&(c.deleted=i.deleteTimePhaseData(e.deletedGanttServices,"service").services,t.push.apply(t,_toConsumableArray(r.getRelatedServices(c.deleted)))),e.updatedGanttServices.length>0&&(c.updated=i.updateTimePhaseData(e.updatedGanttServices,"service").services,t.push.apply(t,_toConsumableArray(r.getRelatedServices(r.getIdsOfSObjects(c.updated))))),(c.updated||c.deleted)&&p.services.forEach(function(e){return e(c)})}if(e.updatedLivePositions){var l=s.updatePositions(e.updatedLivePositions);l.isUpdated&&p.positions.forEach(function(e){return e(l.dic)})}if(t.length>0&&p.rules.forEach(function(e){return e(t)}),n.areContractorsSupported&&(e.deletedCapacities&&e.deletedCapacities.length>0||e.updatedCapacities&&e.updatedCapacities.length>0)){var u={};e.deletedCapacities.length>0&&(u.deleted=i.deleteTimePhaseData(e.deletedCapacities,"capacity").capacities),e.updatedCapacities.length>0&&(u.updated=i.updateTimePhaseData(e.updatedCapacities,"capacity").capacities),(u.updated||u.deleted)&&p.capacities.forEach(function(e){return e(u)})}n.isOptimizationEnabled&&e.optimizationRequests&&e.optimizationRequests.length>0&&p.optimizationRequests.forEach(function(t){return t(e.optimizationRequests)})})["catch"](function(e){console.warn(e)})}function c(e){p.optimizationRequests.forEach(function(t){return t([e])})}function l(e,t){return p[e]&&p[e].push(t)}function u(e,t){p[e].splice(p[e].indexOf(t),1)}var d=null,v=deltaInterval||10,p={services:[],absences:[],capacities:[],positions:[],optimizationRequests:[],rules:[]};return t(o,1e3*v),{register:l,unRegister:u,getDelta:o,updateOptimizationRequest:c}}e.$inject=["sfdcService","$interval","TimePhasedDataService","LastKnownPositionService","StateService","utils","MstResolver"],angular.module("serviceExpert").factory("DeltaService",e)}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(e,t){var i=e.defer(),s={};return e.all([t.getServiceListFields(),t.getServiceMiniFormFields(),t.getServiceMapInfoWindowFields(),t.getGanttToolTipFields(),t.getServiceCapacityColumns(),t.getGanttFilterFields()]).then(function(e){if(s={ListColumns:e[0],ListExpanded:e[1],MapInfo:e[2],GanttToolTip:e[3],CapacityServiceColumns:e[4],ganttFilter:e[5]},"object"!==_typeof(GanttService.prototype.allFieldSets)){GanttService.prototype.allFieldSets=s;var t={};for(var n in GanttService.prototype.allFieldSets)for(var r=GanttService.prototype.allFieldSets[n],a=0;a<r.length;a++)t[r[a].APIName]=r[a];GanttService.prototype.allFieldSetsSet=t}i.resolve(s)})["catch"](function(e){i.reject(),console.warn("FieldSetFieldsService: unable to get service appointment field sets")}),{fieldsSetFields:function(){return i.promise}}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("FieldSetFieldsService",e)}(),function(){function e(e,t){function i(e,t){if(!e){e="";for(var i in t)e+=i+" AND ";return s(e.substr(0,e.length-5))}return s(e)}function s(e){for(var t=e,i=1;10>=i;i++)if(1!==i)-1!==t.indexOf(i)&&(t=t.replace(i,"{"+i+"}"));else{var s=t.indexOf(1),n=t.indexOf(10);-1!==s&&s===n&&(s=t.lastIndexOf(1)),t=t.substr(0,s)+"{1} "+t.substr(s+2)}return t}function n(e){var t=null;return v.forEach(function(i){t=i.Id===e?i:t}),t}function r(i){var s=e.defer();return t.getFilterById(i).then(function(e){for(var t=c(e),i=!0,n=0;n<v.length;n++)if(v[n].Id===t.Id){v[n]=t,i=!1;break}i&&v.push(t),s.resolve(t)}),s.promise}function a(i){var s=e.defer();return t.deleteFilter(i).then(function(e){for(var t=-1,n=0;n<v.length;n++)if(v[n].Id===i){t=n;break}-1!==t&&v.splice(t,1),s.resolve(i)}),s.promise}function o(i){var s=e.defer();return t.hideFilter(i).then(function(e){for(var t=-1,n=0;n<v.length;n++)if(v[n].Id===i){t=n;break}-1!==t&&v.splice(t,1),s.resolve(i)}),s.promise}function c(e){return{Id:e.Id,Name:e[fieldNames.GanttFilter.Name],Description:e[fieldNames.GanttFilter.Description],Days_after_horizon:e[fieldNames.GanttFilter.Days_after_horizon],Days_before_horizon:e[fieldNames.GanttFilter.Days_before_horizon],Criterias:JSON.parse(e[fieldNames.GanttFilter.Criterias]),List_only_appointments_on_the_gantt:e[fieldNames.GanttFilter.List_only_appointments_on_the_gantt],Logic:i(e[fieldNames.GanttFilter.Logic],JSON.parse(e[fieldNames.GanttFilter.Criterias])),Public:e[fieldNames.GanttFilter.Public],Hidden:e[fieldNames.GanttFilter.Hidden],CreatedById:e.CreatedById}}function l(e){p=Object.assign(e,{})}function u(){return p}var d=e.defer(),v=[],p={};return useNewFilters&&t.getGanttFilters().then(function(e){var t=[];e.forEach(function(e){t.push(c(e))}),v=t,d.resolve(t)}),{filtersPromise:d.promise,getFilterById:n,getFilterFromSalesforce:r,deleteFilter:a,hideFilter:o,setFilterMap:l,getFilterMap:u}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("GanttFilterService",e)}(),function(){function e(e,t,i,s,n){function r(){return l.closeLightbox()}function a(r,a){if(!l){l=e.$new(!0),l.url=t.trustAsResourceUrl(a).toString(),l.title=r,l.closeLightbox=o;var u=c();u.find("#ResourceLightbox").draggable({handle:"#ResourceLightboxHeader"}),u.find("#ResourceLightbox").resizable({minHeight:560,minWidth:940,maxWidth:940,handles:"s"}),angular.element("body").append(u),n.setLightBoxStatus(),l.$on("$destroy",function(){return u.remove()}),l.$on("keypress",function(e,t){27==t.which&&l.$evalAsync(l.closeLightbox)}),i(u)(l),s.safeApply(l)}}function o(){l.killWatch&&l.killWatch(),n.setLightBoxStatus(!1),l.$destroy(),l=null}function c(){return angular.element('<div class="LightboxBlackContainer ng-cloack">\n                    <div class="LightboxContainer ng-cloak" id="ResourceLightbox">\n\n                        <div class="lightboxHeaderContainer lightbox-general" id="ResourceLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            \n                            <h1 class="lightboxHeader" id="resourceName" ng-bind="title"></h1>\n                        </div>\n                        \n                        <iframe ng-src="{{ url }}" class="resourceLightboxIframe"></iframe>\n\n                    </div>\n                </div>')}var l=null;return{open:a,closeLightboxFromOutside:r}}e.$inject=["$rootScope","$sce","$compile","utils","StateService"],angular.module("serviceExpert").factory("GeneralLightbox",e)}(),function(){function e(e,t,i,s,n,r,a,o,c,l,u,d,v,p){function g(t){U&&m(),U=e.$new(!0),j=null,U.StateService=a,U.gettingSlots=!0,U.closePanel=m,U.getResourceField=b,U.generateMstText=O,U.formatDateInterval=y,U.service=i.serviceAppointments()[t],U.generateResultText=T,U.allSlotsArray=null,U.slotsTimespansIds=[],U.trustHtml=r.trust,U.jumpToDate=A,U.GRADES=q,U.scheduleToSlot=E,U.replaceLabels=I,U.openLightbox=F,U.showOnGantt=x,U.formatDateHeader=_,U.notifyWhenDoneGettingSlots=L,U.shouldNotify=!1,U.scheduledActionInvoked=!1,U.groupSlotsBy="Resource",U.roundGrade=f,U.bestSlot=null,U.gotSlots=!0,U.exception=null,U.isMst=!1,U.mstPromise=null,U.schedulingTakesLong=!1,U.rawTimespans=[],U.partialResults=[],U.showPartialData=!1,U.isAdmin=!1,void 0==window.userHasAdminPermissions?s.userHasAdminPermissions().then(function(e){e?window.userHasAdminPermissions=U.isAdmin=!0:window.userHasAdminPermissions=!1}):U.isAdmin=window.userHasAdminPermissions,U.generatePartialResult=function(e){return customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)},z||w(t);var o=M();angular.element("#LeftSideContainer").prepend(o),U.$on("$destroy",function(){return o.remove()}),n(o)(U),r.safeApply(U)}function h(e){z=!0,g(e.fslOperation.result.Service.Id),"exception"===e.eventType&&k(e),k({value:e.fslOperation.result},!0),z=!1}function m(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!0;U&&(j=null,t&&e.$broadcast("GotSlotsEnded"),showCandidates.on=!1,showCandidates.id=null,S(),scheduler.updateView(),t&&U.$destroy())}function f(e){return Math.round(e)}function S(){for(var e=0;e<U.slotsTimespansIds.length;e++)scheduler.deleteMarkedTimespan(U.slotsTimespansIds[e])}function b(e,t){return e&&o.getResources()[e]?o.getResources()[e][t]:null}function y(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1,i=60*new Date(e).getTimezoneOffset()*1e3,s=new Date(e+i);return t?moment(s).format("LT"):moment(s).format("llll")}function _(e){var t=e.split("_"),i=new Date(t[2],t[1],t[0],0,0,0,0);return moment(i).format("LL")}function T(e){if(e){var t=0,i=0;return e.forEach(function(e){t++,i+=e.SchedulingOptions.length}),customLabels.getSlotsExpText.replaceAll("<b>"+t+"</b>","<b>"+i+"</b>","<b>"+U.service.name+"</b>","<b>"+y(U.bestSlot.Interval.Start)+"</b>","<b>"+U.bestSlot.Resource.m_resource.Name+"</b>","<b>"+Math.round(U.bestSlot.Grade)+"</b>")}}function w(e){console.time("getting slots"),s.getSlots(e,a.selectedPolicyId).then(function(e){return e.value.FSLOperationId?(console.log("get candidates with MST"),U.isMst=!0,t(function(){return U.schedulingTakesLong=!0},1e3*V),void(U.mstPromise=d.getUpdates(e.value.FSLOperationId).then(function(e){return console.log(e),console.log(e.fslOperation.result),console.timeEnd("getting slots"),U.shouldNotify||k({value:e.fslOperation.result},!0),e})["catch"](function(e){console.error(e);var t={message:e};return U.shouldNotify||k({eventType:"exception",event:t}),p.reject({eventType:"exception",event:t})}))):void k(e)})["catch"](function(e){console.warn("could not get candidates"),console.log(e),U.shouldNotify||k({eventType:"exception",event:event})})}function L(){U.shouldNotify=!0,U.mstPromise.then(function(e){r.addNotification(customLabels.MstFinishedGettingSlots.replace("$0",U.service.AppointmentNumber),customLabels.MstFinishedGettingSlotsMessage,function(){h(e)})})["catch"](function(e){console.error(e),r.addNotification(customLabels.MstFinishedGettingSlots.replace("$0",U.service.AppointmentNumber),e,function(){})}),m(!0)}function k(e){if(U.gettingSlots=!1,"exception"===e.eventType)return U.gotSlots=!1,void(U.exception=e.event);if(U.partialResults=e.value.PartialResults||[],D(e.value),U.gotSlots){U.allSlotsArray=[],U.slotsByDateObject={},j={};for(var t in e.value.ResourceIDToScheduleData){var i=e.value.ResourceIDToScheduleData[t];U.allSlotsArray.push(i);for(var s=0;s<i.SchedulingOptions.length;s++){var n=new Date(i.SchedulingOptions[s].Interval.Start),r=60*new Date(i.SchedulingOptions[s].Interval.Start).getTimezoneOffset()*1e3;j[t]=!0,n.setMilliseconds(n.getMilliseconds()+r);var a=H(n);U.slotsByDateObject[a]=U.slotsByDateObject[a]||[],i.SchedulingOptions[s].Resource=e.value.ResourceIDToScheduleData[t].Resource,U.slotsByDateObject[a].push(i.SchedulingOptions[s])}}U.allSlotsArray.sort(function(e,t){return e.Resource.m_resource.Name>t.Resource.m_resource.Name?1:e.Resource.m_resource.Name<t.Resource.m_resource.Name?-1:0});for(var o=0;o<U.allSlotsArray.length;o++)U.allSlotsArray[o].highest=C(U.allSlotsArray[o].SchedulingOptions);for(var c in U.slotsByDateObject){var l=U.slotsByDateObject[c];l.sort(function(e,t){return e.Interval.Start>t.Interval.Start?1:e.Interval.Start<t.Interval.Start?-1:0;
}),l.highest=C(l),U.bestSlot?U.bestSlot.Grade<l.highest.Grade&&(U.bestSlot=l.highest):U.bestSlot=l.highest}setTimeout(function(){return angular.element("#slotsSentence").html(T(U.allSlotsArray))},100)}}function C(e){for(var t=0,i=e,s=i[0],n=0;n<i.length;n++)i[t].Grade<i[n].Grade&&(t=n,s=i[n]);return s}function R(e){var t=60*new Date(e.Start).getTimezoneOffset()*1e3,i=60*new Date(e.Finish).getTimezoneOffset()*1e3;return{startDate:new Date(e.Start+t),endDate:new Date(e.Finish+i)}}function D(t){var s="",n=null,o=!1;for(var c in t.ResourceIDToScheduleData)if(t.ResourceIDToScheduleData[c].SchedulingOptions)for(var l=t.ResourceIDToScheduleData[c].SchedulingOptions,u=0;u<l.length;u++){var d=R(l[u].Interval),v=i.getResoruceGanttIdByDate(c,d.startDate);if(showSecondarySTMs&&U.service.ServiceTerritoryId&&(v=i.getResoruceGanttIdByDateAndTerritory(c,d.startDate,U.service.ServiceTerritoryId)),v){0===u&&(s+=t.ResourceIDToScheduleData[c].Resource.m_resource.Name+", ",o=!0),(d.startDate<n||null===n)&&(n=new Date(d.startDate));for(var p in scheduler.matrix){var g={};g[p]=v.indexOf(",")>-1?v.split(","):[v];var h="";l[u].MSTOptions&&(h=(new Date).getTime()+Math.floor(1e5*Math.random()),window.mstOptions=window.mstOptions||{},window.mstOptions[h]=l[u].MSTOptions);var m=.11+parseInt(l[u].Grade)/100*.64,f="background-color: rgba(118, 226, 164,"+m+");",S=l[u].Grade<0?"":Math.round(l[u].Grade)+"/100",b=customLabels.CandidateGradeGantt.replaceAll(moment(d.startDate).format("dddd LT"),moment(d.endDate).format("dddd LT"),S),y={start_date:d.startDate,end_date:d.endDate,sections:g,html:"<div oncontextmenu='scheduleSlot(event, \""+U.service.id+'", "'+d.startDate.getTime()+'", "'+v+'", "'+a.selectedPolicyId+'", "'+h+"\")', title='"+b+"' style='"+f+"'><span class='slotText'>"+S+"</span></div>",css:"slotMark"};U.rawTimespans.push(y)}}}if(o){var _=r.setDatesByStartAndMode(n);_.start.setDate(_.start.getDate()-1),_.end.setDate(_.end.getDate()+1),i.getTimePhasedObjects(_.start,_.end).then(function(){for(var e=0;e<U.rawTimespans.length;e++)U.slotsTimespansIds.push(scheduler.addMarkedTimespan(U.rawTimespans[e]));scheduler.updateView()}),showCandidates.on=!0,showCandidates.id=U.service.id,r.ganttSettings&&r.ganttSettings.filterCandidates&&(U.service.resourceId&&-1===s.indexOf(U.service.resourceName)&&(s+=U.service.resourceName+", "),s=s.substr(0,s.length-2)),e.$broadcast("GotSlots",{resourceToFilter:s,minDateOfCandidate:n}),scheduler.setCurrentView(n)}else U.gotSlots=!1}function A(t){e.$broadcast("JumpToDate",new Date(t))}function I(e,t){var i;return(i=customLabels[e]).replaceAll.apply(i,_toConsumableArray(t))}function F(){c.open(U.service.id)}function x(){r.showOnGantt(U.service.id)}function M(){var e='\n                <div id="GetSlotsPanel" xmlns="http://www.w3.org/1999/html">\n\n                    <div class="slots-panel-title">\n                        {{ replaceLabels(\'ShowingCandidatesTo\', [service.name] ) }}\n                        <div class="clear-slots" ng-click="closePanel()">'+customLabels.HideSlots+'</div>\n                    </div>\n\n\n                    <div ng-show="gettingSlots" class="getting-slots">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.FindingCandidates+'\n                        \n                        <div class="get-slots-mst" ng-show="isMst && schedulingTakesLong">\n                            '+customLabels.MstTakingLongTime+'\n                            <div class="get-slots-mst-button" ng-click="notifyWhenDoneGettingSlots()">'+customLabels.MstNotifyMeWhenDone+'</div>\n                        </div>\n                    </div>\n                    \n                    \n                    <div ng-show="exception" class="get-slots-error">\n                        <svg aria-hidden="true" class="slds-icon">\n                          \u2028<use xlink:href=\''+lsdIcons.violation+"'></use>\n                        \u2028</svg>\n                        {{ exception.message }}\n                        \n                        <div>"+customLabels.ContactSysAdmin+'</div>\n                    </div>\n                    \n                    <div ng-show="!gotSlots && !exception" class="get-slots-error">\n                        <i class="fa fa-frown-o"></i>\n                        \n                        <div>'+customLabels.noCandidatesMessageGantt+'</div>\n                        \n                        <div id="AN-PartialResults" ng-show="partialResults.length > 0">\n                            <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="showPartialData = !showPartialData">'+customLabels.ShowDetails+'</u></div>\n\n                            <div ng-show="showPartialData">\n                                <ul>\n                                    <li ng-repeat="partial in partialResults">\n                                        {{ generatePartialResult(partial) }}\n                                    </li>\n\n                                </ul>\n                            </div>\n                        </div>\n                        \n                    </div>\n\n\n\n\n                    <div class="slots-results-recommendations" ng-if="allSlotsArray" ng-show="gotSlots">\n                        <span id="slotsSentence"></span>\n                        <div class="assign-to-recommended" ng-click="scheduleToSlot(bestSlot.Interval.Start, bestSlot.Resource.m_resource.Id, StateService.selectedPolicyId,bestSlot.Interval)">'+customLabels.AssignToRecommended+'</div>\n                    </div>\n\n\n\n                    <div class="slots-grouping" ng-show="allSlotsArray" ng-show="gotSlots">\n                        <span class="truncate groupSlotsBy" title="'+customLabels.GroupSlotsBy+'">'+customLabels.GroupSlotsBy+'</span>\n                        <input type="radio" id="groupByResource" name="groupBy" ng-model="groupSlotsBy" value="Resource" checked="checked">\n                        <label class="groupSlotsBy slots-groupByResource truncate" for="groupByResource" title="'+customLabels.Resource+'">'+customLabels.Resource+'</label>\n                        <input type="radio" id="groupByName" name="groupBy" ng-model="groupSlotsBy" value="Date">\n                        <label class="groupSlotsBy truncate slots-groupByName" for="groupByName" title="'+customLabels.Date+'">'+customLabels.Date+'</label>\n\n                        <div class="button-on-grouping" ng-show="service.isScheduled()" ng-click="showOnGantt()" title="'+customLabels.Show_on_gantt+'">\n                            <svg aria-hidden="true" class="slds-icon quickActionIcon">\n                                \u2028<use xlink:href="'+lsdIcons.table+'"></use>\n                            \u2028</svg>\n                        </div>\n\n                        <div class="button-on-grouping" ng-click="openLightbox()" title="'+customLabels.OpenDetailsWindow+'">\n                            <svg aria-hidden="true" class="slds-icon quickActionIcon">\n                                \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                            \u2028</svg>\n                        </div>\n                    </div>\n\n\n                    <div id="Slots-List-In-Panel" ng-show="gotSlots">\n                    \n                        <div id="AN-PartialResults" ng-show="partialResults.length > 0">\n                            <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="showPartialData = !showPartialData">'+customLabels.ShowDetails+'</u></div>\n\n                            <div ng-show="showPartialData">\n                                <ul>\n                                    <li ng-repeat="partial in partialResults">\n                                        {{ generatePartialResult(partial) }}\n                                    </li>\n\n                                </ul>\n                            </div>\n                        </div>\n                        \n                        \n                        \n                    \n                        <div ng-repeat="candidate in allSlotsArray" class="resource-slot-row" ng-init="candidate.showSlots = false" ng-show="groupSlotsBy == \'Resource\'">\n    \n                            <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'name\')" class="candidates-container-row" ng-click="candidate.showSlots = !candidate.showSlots">\n                                <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') == null && getResourceField(candidate.Resource.m_resource.Id, \'serviceCrew\') == undefined" class="ResourcePhotoIcon"></div>\n                                <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'serviceCrew\') != undefined && getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') == null" class="ResourcePhotoIcon CrewPhotoIcon"></div>\n                                <img ng-show="getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') != null" ng-src="{{getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\')}}" class="ResourcePhotoIcon" />\n                                <h1>{{ getResourceField(candidate.Resource.m_resource.Id, \'name\') }}</h1>\n                                {{ replaceLabels(\'Xoptions\', [candidate.SchedulingOptions.length] ) }}\n                                \n                                <div ng-show="candidate.highest.Grade > -1" class="slot-grade slots-highest-grade" ng-class=\'{\n                                                "GS-grade-excellent": candidate.highest.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": candidate.highest.Grade >= GRADES.GOOD && candidate.highest.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": candidate.highest.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(candidate.highest.Grade)}}/100\n                                </div>\n                            </div>\n    \n                            <div ng-repeat="intervalItem in candidate.SchedulingOptions" class="time-interval" ng-show="candidate.showSlots">\n                                <span class="jump-to-date" title="Jump to date" ng-click="jumpToDate(intervalItem.Interval.Start)">{{ formatDateInterval(intervalItem.Interval.Start) }}</span>\n    \n                                <div class="slot-grade" ng-show="intervalItem.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": intervalItem.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": intervalItem.Grade >= GRADES.GOOD && intervalItem.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": intervalItem.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(intervalItem.Grade)}}/100\n                                </div>\n    \n                                <div ng-click="scheduleToSlot(intervalItem.Interval.Start, candidate.Resource.m_resource.Id, StateService.selectedPolicyId, intervalItem)" class="schedule-to-slot">'+customLabels.Schedule+'</div>\n                                \n                                \n                                <div class="mst-interval-for-tapuhi truncate" ng-show="intervalItem.MSTOptions">\n                                    {{generateMstText(intervalItem.MSTOptions)}}\n                                </div>\n                                \n                               \n                            </div>\n    \n                        </div>\n                        \n                       \n                       \n                        <div ng-repeat="(date,slots) in slotsByDateObject" class="resource-slot-row" ng-init="candidate.showSlots = false" ng-show="groupSlotsBy == \'Date\'">\n    \n                            <div class="candidates-container-row date-title-container" ng-click="slots.showDatesSlots = !slots.showDatesSlots">\n                                <h1>{{ formatDateHeader(date) }}</h1>\n                                {{ replaceLabels(\'Xoptions\', [slots.length] ) }}\n                                \n                                        <div class="slot-grade slots-highest-grade" ng-show="slots.highest.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": slots.highest.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": slots.highest.Grade >= GRADES.GOOD && slots.highest.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": slots.highest.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(slots.highest.Grade)}}/100\n                                        </div>\n                            </div>\n    \n                            <div ng-repeat="intervalItem in slots" class="time-interval" ng-show="slots.showDatesSlots">\n                                <span class="jump-to-date" title="Jump to date" ng-click="jumpToDate(intervalItem.Interval.Start)">{{ formatDateInterval(intervalItem.Interval.Start, true) }}</span>\n                                <span> ({{intervalItem.Resource.m_resource.Name}})</span>\n    \n                                <div class="slot-grade" ng-show="intervalItem.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": intervalItem.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": intervalItem.Grade >= GRADES.GOOD && intervalItem.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": intervalItem.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(intervalItem.Grade)}}/100\n                                </div>\n    \n                                <div ng-click="scheduleToSlot(intervalItem.Interval.Start, intervalItem.Resource.m_resource.Id, StateService.selectedPolicyId, intervalItem)" class="schedule-to-slot">'+customLabels.Schedule+'</div>\n                                \n                                <div class="mst-interval-for-tapuhi truncate" ng-show="intervalItem.MSTOptions">\n                                    {{generateMstText(intervalItem.MSTOptions)}}\n                                </div>\n                                \n                            </div>\n    \n                        </div>\n\n                </div>\n            ';return angular.element(e)}function O(e){var t="";for(var s in e)t=customLabels.MstCandidatesGanttLine.replace("$0",i.serviceAppointments()[s].name).replace("$1",y(e[s].Interval.Start)).replace("$2",e[s].Resource.m_resource.Name);return t}function P(e,t,n){var o=e.Interval.Start,c=e.Interval.Finish,d=e.Resource.m_resource.Id,p=i.serviceAppointments()[t],g=60*new Date(o).getTimezoneOffset()*1e3,h=i.getResoruceGanttIdByDate(d,o);return o+=g,c+=g,p?(N(p,o,h,n),void l.saveChangesToServiceAppointment(p,p).then(function(e){e.absences.forEach(function(e){e.isScheduled()&&e.setGanttResource(i.resourcesAndTerritories(),r.generateResourceId)}),e.services.forEach(function(e){e.isScheduled()&&e.setGanttResource(i.resourcesAndTerritories(),r.generateResourceId)}),l.drawServicesAndAbsences(e.services||[],e.absences||[]),u.calculateKpis()})):(o=new Date(o),c=new Date(c),s.saveChangesToServiceAppointment(t,d,null,o,c,a.selectedPolicyId,"AutomaticGetSlots"),void v.getDelta())}function E(t,s,n,a){if(!U.scheduledActionInvoked){if(U.scheduledActionInvoked=!0,a.MSTOptions&&Object.keys(a.MSTOptions).length>0)for(var o in a.MSTOptions)P(a.MSTOptions[o],o,n);var c=U.service,d=60*new Date(t).getTimezoneOffset()*1e3;t+=d,c.resourceBeforeDrag=c.resourceId,c.eventBeforeDrag=angular.copy(c);var v=i.getResoruceGanttIdByDate(s,t);N(c,t,v,n),scheduler._events[c.id]?(scheduler.updateEvent(c.id),scheduler.callEvent("onEventChanged",[c.id,scheduler.getEvent(c.id)]),setTimeout(function(){scheduler.callEvent("onDragEnd")},1200),m()):l.saveChangesToServiceAppointment(c,c).then(function(s){s.absences.forEach(function(e){e.isScheduled()&&e.setGanttResource(i.resourcesAndTerritories(),r.generateResourceId)}),s.services.forEach(function(e){e.isScheduled()&&e.setGanttResource(i.resourcesAndTerritories(),r.generateResourceId)}),l.drawServicesAndAbsences(s.services||[],s.absences||[]),u.calculateKpis(),e.$broadcast("JumpToDate",new Date(parseInt(t)))})["catch"](function(e){console.warn("Couldn't update service. "+e[0]+" "+e[2]),r.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2])})["finally"](function(){e.$broadcast("JumpToDate",new Date(parseInt(t))),m()}),m()}}function N(e,t,i,s){var n=r.getServiceDuration(e);e.start=new Date(t),e.finish=new Date(t+n),e.start_date=new Date(t),e.end_date=new Date(t+n),e.travelTo=0,e.travelFrom=0,i&&(e.resourceId=i),e.policyUsed=s,e.scheduleMode="AutomaticGetSlots"}function B(e,t){for(var i in mstOptions[e])P(mstOptions[e][i],i,t)}function H(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function G(){return j}var V=2,U=null,j=null,z=!1,q={STAR:candidatesGrades.ideal,EXCELLENT:candidatesGrades.ideal,GOOD:candidatesGrades.reecommended};return window.scheduleSlot=function(t,s,n,a,o,c){t.preventDefault(),$("#ScheduleOnSlot").remove(),$('<div id="ScheduleOnSlot">'+customLabels.ScheduleHere+"</div>").css("left",t.clientX-30+"px").css("top",t.clientY+5+"px").on("click",function(){c&&B(c,o);var t=U.service;t&&(t.resourceBeforeDrag=t.resourceId,t.eventBeforeDrag=angular.copy(t),N(t,parseInt(n),a,o),$("#ScheduleOnSlot").remove(),scheduler._events[t.id]?(scheduler.updateEvent(t.id),scheduler.callEvent("onEventChanged",[t.id,scheduler.getEvent(t.id)]),setTimeout(function(){scheduler.callEvent("onDragEnd")},1200),m()):l.saveChangesToServiceAppointment(t,t).then(function(t){t.absences.forEach(function(e){e.isScheduled()&&e.setGanttResource(i.resourcesAndTerritories(),r.generateResourceId)}),t.services.forEach(function(e){e.isScheduled()&&e.setGanttResource(i.resourcesAndTerritories(),r.generateResourceId)}),l.drawServicesAndAbsences(t.services||[],t.absences||[]),u.calculateKpis(),e.$broadcast("JumpToDate",new Date(parseInt(n)))})["catch"](function(e){console.warn("Couldn't update service. "+e[0]+" "+e[2]),r.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2])})["finally"](function(){e.$broadcast("JumpToDate",new Date(parseInt(n))),m()}))}).appendTo("body")},$("body").on("click",function(){$("#ScheduleOnSlot").remove()}),{get:g,close:m,getCandidatesIds:G}}e.$inject=["$rootScope","$timeout","TimePhasedDataService","sfdcService","$compile","utils","StateService","ResourcesAndTerritoriesService","ServiceAppointmentLightboxService","servicesService","kpiCalculationsService","MstResolver","DeltaService","$q"],angular.module("serviceExpert").factory("GetSlotsService",e)}(),function(){function e(e,t,i,s){function n(e){var t={},i=!1;for(var n in e){var r=new LastKnownPosition(e[n]),o=void 0;e[n].ServiceCrewMembers&&e[n].ServiceCrewMembers[0].IsLeader&&(o=s.getCrewToResources()[e[n].ServiceCrewMembers[0].ServiceCrewId]),(!a[r.id]||a[r.id].lastModifiedDate<r.lastModifiedDate)&&(t[n]=r,a[n]=r,i=!0,o&&(t[o.Id]=r,a[o.Id]=r))}return{dic:t,isUpdated:i}}function r(){return t.getLivePositions().then(function(e){for(var t in e)a[t]=new LastKnownPosition(e[t]);return a})}var a={};return{getLastKnownPositions:r,updatePositions:n,lastKnownPositions:function(){return a}}}e.$inject=["$q","sfdcService","utils","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("LastKnownPositionService",e)}(),function(){function e(e,t,i,s,n){function r(r,o,l,u){var d=e.defer(),v=a(o,l,u);if(v.horizon<=0){var p={scheduledServices:[],unscheduledServices:[],remainingCount:0,newStart:i.addDaysToDate(v.date,-v.horizon+1),horizon:v};return d.resolve(p),d.promise}var g=i.addDaysToDate(v.date,-v.horizon+1),h=c(r,l,u),m=CustomSettings.maxServiceAppointmentsToLoad-h.length;return 0>=m?(i.addNotification(customLabels.Too_Many_Services_Header_Services_List,customLabels.Too_Many_Services_Services_List),d.reject(),d.promise):(t.loadServiceAppointmentsToList(v.date,v.horizon,m,h).then(function(e){s.updateTimePhaseData(e.stms,"stm");var t=s.updateTimePhaseData(e.ganttServiceAppointments,"service"),r=s.resourcesAndTerritories(),a={scheduledServices:[],unscheduledServices:[],remainingCount:e.remainingCount,newStart:g,horizon:v};t.services.forEach(function(e){e.isScheduled()?(e.setGanttResource(r,i.generateResourceId),a.scheduledServices.push(e)):(scheduler._events[e.id]&&delete scheduler._events[e.id],a.unscheduledServices.push(e))}),n.drawServicesAndAbsences(a.scheduledServices,[],[],[]),d.resolve(a)})["catch"](function(e){d.reject(e),console.warn("loadServiceAppointmentsToList: something went wrong"),i.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}),d.promise)}function a(e,t,s){var n=void 0,r=void 0,a=i.addDaysToDate(t,-s+1),o=t;if(e[a]){for(r=a;o>=r&&e[r];)r=i.addDaysToDate(r,1);return n=(o.getTime()-r.getTime())/864e5,n++,{date:o,horizon:n}}for(r=o;r>=a&&e[r];)r=i.addDaysToDate(r,-1);return n=(r.getTime()-a.getTime())/864e5,n++,{date:r,horizon:n}}function o(e,t,s){var n=i.addDaysToDate(t,-s);return e.earlyStart&&e.earlyStart>n&&e.earlyStart<=t?!0:e.dueDate&&e.dueDate>n&&e.dueDate<=t?!0:e.appStart&&e.appStart>n&&e.appStart<=t?!0:e.appEnd&&e.appEnd>n&&e.appEnd<=t?!0:e.finish&&e.finish>n&&e.finish<=t?!0:e.start&&e.start>n&&e.start<=t?!0:!1}function c(e,t,i){var s=[];for(var n in e)o(e[n],t,i)&&s.push(n);return s}return{loadServiceAppointmentsToList:r,getBackHorizonToFetch:a}}e.$inject=["$q","sfdcService","utils","TimePhasedDataService","servicesService"],angular.module("serviceExpert").factory("LoadServiceListService",e)}(),function(){function e(e,t,i,s,n,r,a,o,c,l,u,d){function v(){_.show(),o.setLightBoxStatus()}function p(e,t,i){if(e.depth=t,i.push(e),e.items)for(var s=0,n=e.items.length;n>s;s++)e.items[s].depth=t,p(e.items[s],t+1,i)}function g(e,t){for(var i=null,s=0;s<e.length;s++){if(e[s].id===t)return e[s];if(i=g(e[s].items,t))return i}return i}function h(e,t){for(var i=0;i<e.items.length;i++)y.locationFilter[e.items[i].id]=t,h(e.items[i],t)}function m(e,t){var i=Object.keys(e).map(function(t){return e[t]}).sort(function(e,i){var s=0,n=0;return t.forEach(function(t,r){t.id===e.id&&(s=r),t.id===i.id&&(n=r)}),s>n?1:n>s?-1:0});return i}function f(){return angular.element('<div class="LightboxBlackContainer">\n                        <div class="LightboxContainer LightboxContainerAnimation" id="LocationFilteringLightbox">\n\n                            <div class="lightboxHeaderContainer" id="LocationFilteringLightboxHeader">\n                                <h1 class="light-box-header">'+customLabels.Location_filtering+'</h1>\n                                <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" ng-hide="noLocationsLoad">\n                                    \u2028\u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                                </svg>\n                            </div>\n\n                            <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.LocationFilteringParagraph+'</p>\n\n                                <div class="LocationsTreeContainer">\n                                    <p id="secondary-notice" ng-show="showSecondaryTimezoneNotice">'+customLabels.Stms_with_different_tz+'</p>\n\n                                    <div class="locationFilterRow addBorderBottom">\n                                        <input type="checkbox" ng-model="showOrphanServices" id="servicesNoLocations" />\n                                        <label for="servicesNoLocations">'+customLabels.unassosiated_filtering+'</label><br/>\n                                    </div>\n\n                                    <input id="locationFilteringSearch" type="text" ng-model="locationSearchTerm.text" placeholder="'+customLabels.Search_location+'" />\n                                    <span class="selectAllLocations" ng-click="selectAllLocations(true)" title="'+customLabels.Select_all+'">'+customLabels.All+'</span>\n                                    <span class="selectAllLocations" ng-click="selectAllLocations(false)" title="'+customLabels.Select_none+'">'+customLabels.None+'</span>\n\n                                    <div ng-repeat="l in filteredLocations = (locationsFlat | filter:locationSearchTerm)" class="locationFilterRow" ng-style="{{ styleForLocationTree(l.depth) }}" ng-click="selectLocation(l.id)">\n                                        <input type="checkbox" ng-model="locationFilter[l.id]" id="location_{{ l.id }}" />\n                                        <label for="location_{{ l.id }}" ng-bind="l.text"></label><br/>\n                                    </div>\n\n                                </div>\n\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="applyFilterLocation()">'+customLabels.Save+"</div>\n                            </div>\n\n                        </div>\n                    </div>")}function S(){return y.locationsFlat}function b(){return y.territoriesSortedByTree}var y=t.$new(!0),_=f().hide();return _.find("#LocationFilteringLightbox").draggable({handle:"#LocationFilteringLightboxHeader"}),angular.element("body").append(_),y.trust=r.trust,y.showOrphanServices=!0,y.locationSearchTerm="",y.showLocationFiltering=!1,y.noLocationsLoad=!1,y.locationFilter={},y.locationFilterCopy={},y.locationsFlat=[],y.territoriesSortedByTree=[],y.showSecondaryTimezoneNotice=showSecondarySTMs&&useLocationTimezone,e(_)(y),y.$on("keypress",function(e,t){27==t.which&&y.closeLightbox()}),y.closeLightbox=function(){if(!y.noLocationsLoad){for(var e in y.locationFilterCopy)y.locationFilter[e]=y.locationFilterCopy[e];y.showOrphanServices=y.showOrphanServicesOldValue,_.hide(),o.setLightBoxStatus(!1)}},y.styleForLocationTree=function(e){return{"margin-left":20*e+"px"}},i.promises.territories().then(function(){function e(s){if(s.id&&s.parent){if(t[s.parent.id])return s.parent;var n={};return i.allTerritories[s.parent.id]&&(n={id:i.allTerritories[s.parent.id].id,parent:i.allTerritories[s.parent.id].parentTerritory?i.allTerritories[s.parent.id].parentTerritory:0}),e(n)}}var t={},a=[],o=[],c=[];for(var l in i.territories)t[l]={id:l,parent:i.territories[l].parentTerritory?i.territories[l].parentTerritory:0,text:i.territories[l].name,items:[]};for(var u in t){var d=t[u],g=e(d);0!==d.parent&&g?t[g.id].items.push(d):a.push(d)}y.locationsTree=a;for(var h=0;h<a.length;h++)p(a[h],0,y.locationsFlat);y.showOrphanServices=JSON.parse(s.GetUserSettingsProperty("Show_Orphan_Services__c")),y.showOrphanServicesOldValue=y.showOrphanServices,y.territoriesSortedByTree=m(i.territories,y.locationsFlat),null!=s.GetUserSettingsProperty("locations")&&(o=s.GetUserSettingsProperty("locations")),n.getUnPrivilegeUserSettingsFields().then(function(e){if(e.length>1){for(var t=customLabels.Unprivileged_Usersettings_Fields_Msg.split("{1}"),i=t[0],s="",n=3,a=0;a<e.length&&n>a;++a)s+="<br>"+e[a];if(n<e.length){var o=e.length-n;s+="<br>",i+=t[1].replace("{2}",o)}i=i.replace("{0}",s),r.addNotification(customLabels.Unprivileged_Usersettings_Fields,i)}})["catch"](function(e){console.warn("GetUserSettingsProperty failed :-("),console.error(e)});for(var f=0;f<y.locationsFlat.length;f++){if(0===o.length)return y.showLocationFiltering=!0,y.noLocationsLoad=!0,void v();y.noLocationsLoad=!1,y.locationFilter[y.locationsFlat[f].id]=o.indexOf(y.locationsFlat[f].id)>-1,y.locationFilter[y.locationsFlat[f].id]&&c.push(y.locationsFlat[f].id)}y.locationFilterCopy=angular.copy(y.locationFilter),s.SetUserSettingsProperty("locations",JSON.stringify(c))}),y.applyFilterLocation=function(){var e=[],n=[];for(var v in y.locationFilter)y.locationFilter[v]?e.push(v):n.push(v);return 0===e.length?void alert(customLabels.One_loaded_location):(y.noLocationsLoad=!1,angular.extend(y.locationFilterCopy,y.locationFilter),y.showOrphanServicesOldValue=y.showOrphanServices,o.isLoadingNewLocations=!0,s.SetUserSettingProperties(y.parseLocationSettings(JSON.stringify(e),y.showOrphanServices)).then(function(){l.reset(),i.reset(),scheduler._events={},scheduler.deleteMarkedTimespan(),a.reset(),c.reset(),u.reset(),d.reset(),i.getResourceAndTerritories().then(function(){var i=new Date(scheduler.getState().min_date),s=new Date(scheduler.getState().max_date);i.setDate(i.getDate()-1),s.setDate(s.getDate()+1),a.getTimePhasedObjects(i,s).then(function(){scheduler.updateView(),t.$broadcast("gotNewResources",{show:e}),o.isLoadingNewLocations=!1})})})["catch"](function(e){for(var t=customLabels.territories_r_failure_msg+"\n",i=JSON.parse(e.FailedLocations),s=0;s<i.length;s++)t+=i[s].Name+"\n";r.addNotification(customLabels.territories_r_failure,t),o.isLoadingNewLocations=!1}),void y.closeLightbox())},y.parseLocationSettings=function(e,t){return{locations:e,Show_Orphan_Services__c:t}},y.selectLocation=function(e){var t=y.locationFilter[e],i=g(y.locationsTree,e);i&&h(i,t)},y.selectAllLocations=function(e){angular.forEach(y.filteredLocations,function(t){y.locationFilter[t.id]=e})},{open:v,getFlatTerritoriesArray:S,getTerritoriesSortedByTree:b}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","sfdcService","utils","TimePhasedDataService","StateService","calendarsService","monthlyViewHelperService","ResourceCrewsService","ResourceCapacitiesService"],angular.module("serviceExpert").factory("LocationFilteringService",e)}(),function(){function e(e,t,i,s,n,r,a,o){function c(){f=t.$new(!0),f.$on("keypress",function(e,t){27==t.which&&f.$evalAsync(f.closeLightbox)});var r=s.GetUserSettingsProperty("locations");f.filteredLocations=r.map(function(e){return i.territories[e]}),g(),f.dateSelectFinishWidget=u,f.dateSelectStartWidget=d,f.validateDatesStart=v,f.validateDatesEnd=p,f.optimizeAllServices="all",f.runOptimizion=h,f.selectedLocations={},f.checkBoxFields=a.checkBoxFields,f.optimizeSelectedFilter="noFilter",f.orphanServices=!1,f.policyOptions=n.policies,f.selectedPolicy=f.policyOptions[0];for(var o=0;o<n.policies.length;o++)if(n.policies[o].Id===n.selectedPolicyId){f.selectedPolicy=n.policies[o];break}var c=m();c.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(c),f.closeLightbox=l,f.$on("$destroy",function(){return c.remove()}),e(c)(f),c.show(),n.setLightBoxStatus()}function l(){n.setLightBoxStatus(!1),f.$destroy()}function u(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(f.actionFinish),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(f.endMinutes)),i.setHours(parseInt(f.endHour)),i<f.actionStart?alert(customLabels.finishAfterStart):f.actionFinish=i,scheduler.destroyCalendar(),f.$apply()}})}function d(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(f.actionStart),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(f.startMinutes)),i.setHours(parseInt(f.startHour)),i>f.actionFinish?alert(customLabels.startBeforeEnd):f.actionStart=i,scheduler.destroyCalendar(),f.$apply()}})}function v(){var e=new Date(f.actionStart);e.setMinutes(parseInt(f.startMinutes)),e.setHours(parseInt(f.startHour)),e>=f.actionFinish?(alert(customLabels.startBeforeEnd),f.startMinutes=f.actionStart.getMinutes(),f.startHour=f.actionStart.getHours().toString()):f.actionStart=e}function p(){var e=new Date(f.actionFinish);e.setMinutes(parseInt(f.endMinutes)),e.setHours(parseInt(f.endHour)),
e<=f.actionStart?(alert(customLabels.finishAfterStart),f.endMinutes=f.actionFinish.getMinutes().toString(),f.endHour=f.actionFinish.getHours().toString()):f.actionFinish=e}function g(){f.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),f.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),f.startHour="0",f.endHour="0",f.startMinutes="0",f.endMinutes="0"}function h(){var e=[],t=void 0,i=void 0,s=void 0,r=void 0;for(var c in f.selectedLocations)f.selectedLocations[c]&&e.push(c);return 0===e.length?void alert(customLabels.noLocationWasSelected):(t=f.actionStart,i=f.actionFinish,i.setDate(i.getDate()+1),s="noFilter"===f.optimizeSelectedFilter?null:f.optimizeSelectedFilter,r="all"===f.optimizeAllServices,n.setBulkActionRunning(),o.runOptimization(t,i,e,r,f.orphanServices,f.selectedPolicy.Id,s).then(function(e){e?o.getRequestObject(e).then(function(e){e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?a.addNotification(customLabels.Optimization_Request_Sent,customLabels.Optimization_sent_details,function(e){a.openSObjectLink("../"+e)},e.Id):a.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){a.openSObjectLink("../"+e)},e.Id)}):a.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)})["catch"](function(e){console.warn("runOptimization failed :("),console.log(e)})["finally"](function(){n.setBulkActionRunning(!1)}),void f.closeLightbox())}function m(){var e=customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n								<option value="all">'+customLabels.All+'</option>\n								<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n							</select>"),t='<div id="PolicyInOptimize">'+customLabels.Use_the_following_policy_x_and_y.replace("$0",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions"></select>').replace("$1",'<select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n								 	<option ng-repeat="(fieldName, fieldLbl) in checkBoxFields()" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n								 	<option value="noFilter">'+customLabels.None+"</option>\n								 </select>")+"</div>";return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer LightboxContainerAnimation" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.Optimize+'</h1>\n                        </div>\n\n\n                        <div class="lightboxContentContainer">\n\n                            <p class="bulkExplain">'+customLabels.SelectServicesOptimize+'</p>\n\n                            <div class="selectedTargetLocations">\n                                <label for="bulkRadioSelectedIds">'+customLabels.ChooseLocationsLB+'</label>\n                            </div>\n\n\n                            <div id="bulkLocationNames">\n                                <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                    <input ng-model="selectedLocations[location.id]" type="checkbox" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                    <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                </div>\n\n                                <div>\n                                    <input ng-model="orphanServices" type="checkbox" name="orphanLocationsOptimize" id="orphanLocationsOptimize" />\n                                    <label for="orphanLocationsOptimize">'+customLabels.IncludeServicesNoLocations+'</label>\n                                </div>\n                            </div>\n\n\n                            <div class="bulkOptimizeOptions">\n                                '+e+"\n                                "+t+'\n                            </div>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <div class="lightboxSaveButton" ng-click="runOptimizion()">'+customLabels.Optimize+"</div>\n                        </div>\n\n\n                    </div>\n                </div>\n            ")}for(var f=null,S=[],b=0;60>b;b++)S.push(b);return{open:c}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","servicesService","utils","sfdcService"],angular.module("serviceExpert").factory("optimizeLightboxService",e)}(),function(){function e(e,t,i,s,n,r,a,o){function c(s){S=t.$new(!0),S.$on("keypress",function(e,t){27==t.which&&S.$evalAsync(S.closeLightbox)}),S.resource=i.getResources()[s];var r=JSON.parse(localStorage.getItem(sfdcUser+"_RSO"))||{},o=n.selectedPolicyId;r.selectedPolicy&&(o=r.selectedPolicy.Id),g(),S.dateSelectFinishWidget=u,S.dateSelectStartWidget=d,S.validateDatesStart=v,S.validateDatesEnd=p,S.optimizeAllServices=r.optimizeAllServices||"all",S.runOptimizion=h,S.checkBoxFields=a.checkBoxFields(),S.optimizeSelectedFilter=r.optimizeSelectedFilter||Object.keys(S.checkBoxFields)[0],S.optimizeCalloutSelectedFilter=r.optimizeCalloutSelectedFilter||Object.keys(S.checkBoxFields)[0],S.scheduleOnlyResourceFutureJobs=void 0!=r.scheduleOnlyResourceFutureJobs?r.scheduleOnlyResourceFutureJobs:!0,S.policyOptions=n.policies;for(var c=0;c<n.policies.length;c++)if(n.policies[c].Id===o){S.selectedPolicy=n.policies[c];break}var m=f();m.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(m),S.closeLightbox=l,S.$on("$destroy",function(){return m.remove()}),e(m)(S),m.show(),n.setLightBoxStatus()}function l(){n.setLightBoxStatus(!1),S.$destroy()}function u(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(S.actionFinish),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(S.endMinutes)),i.setHours(parseInt(S.endHour)),i<S.actionStart?alert(customLabels.finishAfterStart):S.actionFinish=i,scheduler.destroyCalendar(),S.$apply()}})}function d(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(S.actionStart),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(S.startMinutes)),i.setHours(parseInt(S.startHour)),i>S.actionFinish?alert(customLabels.startBeforeEnd):S.actionStart=i,scheduler.destroyCalendar(),S.$apply()}})}function v(){var e=new Date(S.actionStart);e.setMinutes(parseInt(S.startMinutes)),e.setHours(parseInt(S.startHour)),e>=S.actionFinish?(alert(customLabels.startBeforeEnd),S.startMinutes=S.actionStart.getMinutes(),S.startHour=S.actionStart.getHours().toString()):S.actionStart=e}function p(){var e=new Date(S.actionFinish);e.setMinutes(parseInt(S.endMinutes)),e.setHours(parseInt(S.endHour)),e<=S.actionStart?(alert(customLabels.finishAfterStart),S.endMinutes=S.actionFinish.getMinutes().toString(),S.endHour=S.actionFinish.getHours().toString()):S.actionFinish=e}function g(){S.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),S.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),S.startHour="0",S.endHour="0",S.startMinutes="0",S.endMinutes="0"}function h(){var e=void 0,t=void 0,i=void 0,s=void 0,r=void 0;e=S.actionStart,t=S.actionFinish,t.setDate(t.getDate()+1),s=S.optimizeSelectedFilter,i=S.optimizeCalloutSelectedFilter,r="all"===S.optimizeAllServices,m(),n.setBulkActionRunning(),o.runRDOptimization(S.resource.id,e,t,r,S.scheduleOnlyResourceFutureJobs,S.selectedPolicy.Id,s,i).then(function(e){e?o.getRequestObject(e).then(function(e){e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?a.addNotification(customLabels.Optimization_Request_Sent,customLabels.Optimization_sent_details,function(e){a.openSObjectLink("../"+e)},e.Id):a.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){a.openSObjectLink("../"+e)},e.Id)}):a.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)})["catch"](function(e){console.warn("runOptimization failed :("),console.log(e)})["finally"](function(){n.setBulkActionRunning(!1)}),S.closeLightbox()}function m(){var e={optimizeAllServices:S.optimizeAllServices,scheduleOnlyResourceFutureJobs:S.scheduleOnlyResourceFutureJobs,selectedPolicy:S.selectedPolicy,optimizeSelectedFilter:S.optimizeSelectedFilter,optimizeCalloutSelectedFilter:S.optimizeCalloutSelectedFilter};localStorage.setItem(sfdcUser+"_RSO",JSON.stringify(e))}function f(){var e=customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n								<option value="all">'+customLabels.All+'</option>\n								<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n							</select>"),t='<div id="ResourceToOptimize">'+customLabels.OptimizeTheFollowingResourceDay.replace("$0",'<span class="rdoResourceName">{{resource.name}}</span>')+"</div>",i=customLabels.OptimizeOnlySAsAssignedTo.replace("$0",'<span class="rdoResourceName" ng-class="{disabledonlyAssignTo: !scheduleOnlyResourceFutureJobs}">{{resource.name}}</span>');return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer LightboxContainerAnimation" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.RDOptimize+'</h1>\n                        </div>\n\n\n                        <div class="lightboxContentContainer">\n\n                            <p class="bulkExplain">'+customLabels.SetTheParametersForRDO+'</p>\n\n                            <div class="bulkOptimizeOptions">\n                                '+t+'\n                            </div>\n                            <div class="bulkOptimizeOptions">\n                                '+e+'\n                            </div>\n\n                            <div class="horizontalSeperator">\n                                <div class="configureRDO">'+customLabels.Configure+'</div>\n                            </div>\n\n                            <div class="bulkOptimizeOptionsContainer">\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.OptimizePolicyText+'\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions">\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.OptimizeFilterText+'\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n                                            <option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel" ng-class="{disabledonlyAssignTo: !scheduleOnlyResourceFutureJobs}">\n                                        '+i+'\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <input ng-model="scheduleOnlyResourceFutureJobs" type="checkbox" name="scheduleOnlyResourceFutureSa" id="scheduleOnlyResourceFutureSa" />\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.OptimizeKeepTheFollowingSAsScheduled+'\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select ng-model="optimizeCalloutSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n                                            <option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n                                         </select>\n                                    </div>\n                                </div>\n                            </div>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <div class="lightboxSaveButton" ng-click="runOptimizion()">'+customLabels.Optimize+"</div>\n                        </div>\n\n\n                    </div>\n                </div>\n            ")}var S=null;return{open:c}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","servicesService","utils","sfdcService"],angular.module("serviceExpert").factory("rdOptimizeLightboxService",e)}(),function(){function e(e,t){function i(i,s){e.register(i,s),t.register(i,s)}function s(i,s){e.unRegister(i,s),t.unRegister(i,s)}return{register:i,unRegister:s}}e.$inject=["DeltaService","StreamingAPIService"],angular.module("serviceExpert").factory("RegisterService",e)}(),function(){angular.module("serviceExpert").factory("ResourceCapacitiesService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils","StateService",function(e,t,i,s,n){function r(){l={}}function a(e,t){for(var i=new Date(e),n=null;t>i;){var r=s.formatDayToString(i);if(!l[r]){l[r]=!0,n||(n=c());var a=new Date(i);a.setDate(a.getDate()+1);for(var u=0;u<=n.length;u++)o(new Date(i),new Date(a),n[u])}i.setDate(i.getDate()+1)}}function o(e,t,i){if(e.getTime()!=t.getTime()){var s={};for(var n in scheduler.matrix)s[n]=[i];var r="capacityPattern";scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:s,css:r})}}function c(){for(var i=[],n=t.resourcesAndTerritories(),r=e.getCapacityBasedResources(),a=0;a<=r.length;a++){var o=r[a],c=n[o];for(var l in c){var u=c[l];i.push(s.generateResourceId(o,u.serviceTerritory))}}return i}var l={};return i.$on("gotNewTimePhasedObjects",function(e,t){n.areContractorsSupported()&&Object.keys(t.resourcesAndTerritories).length&&a(t.start,t.finish)}),{reset:r}}])}(),function(){angular.module("serviceExpert").factory("ResourceCrewsService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils","StateService",function(e,t,i,s,n){function r(){m={}}function a(e,t,i){for(var n=new Date(e),r=void 0;t>n;){var a=s.formatDayToString(n);if(!m[a]){void 0==r&&(r=g(i.serviceCrewMembers)),m[a]=!0;var c=new Date(n);c.setDate(c.getDate()+1);for(var l in r)o(new Date(n),new Date(c),r[l])}n.setDate(n.getDate()+1)}}function o(e,t,i){if(e.getTime()!=t.getTime()){var s;s=i.member.ganttLabel?i.member.ganttLabel:customLabels.XCrewMember.replaceAll(i.member.serviceCrew__r.Name),c(e,t,i,s,"S"),c(e,t,i,s,"R"),l(e,t,i,s)}}function c(e,t,i,n,r){var a=i.territoriesByType[r];if(void 0!==a&&(showSecondarySTMs||"R"===r))for(var o=0;o<a.length;o++){var c,l,u=a[o],d=useLocationTimezone?u.operatingHours.TimeZone:userTimeZone;useLocationTimezone?(c=p(u.start,u.operatingHours.TimeZone,d),l=p(u.finish,u.operatingHours.TimeZone,d)):(c=u.start,l=u.finish);var g=s.intersectDates({start:c,finish:l},{start:e,finish:t}).intersection;if(null!=g){var h=p(i.member.startDate,"GMT",d),m=p(i.member.endDate,"GMT",d),f=s.intersectDates({start:g.start,finish:g.finish},{start:h,finish:m}).intersection;null!=f&&v(f.start,f.finish,u.sectionsToDraw,"crewMember",n,"crewLabelStyle")}}}function l(e,t,i,n){var r=i.territoriesByType.P,a=i.territoriesByType.R;if(void 0==a)d(e,t,i,n);else if(void 0!==r)for(var o=0;o<r.length;o++){var c=!1,l=r[o],g=useLocationTimezone?l.operatingHours.TimeZone:userTimeZone,h=p(i.member.startDate,"GMT",g),m=p(i.member.endDate,"GMT",g),f=s.intersectDates({start:h,finish:m},{start:e,finish:t}).intersection;if(null!=f){var S=s.intersectDates({start:l.start,finish:l.finish},{start:f.start,finish:f.finish}).intersection;if(null!=S){for(var b=0;b<a.length;b++){var y=a[b],_=useLocationTimezone?y.operatingHours.TimeZone:userTimeZone,T=p(y.start,_,g),w=p(y.finish,_,g),L=s.intersectDates({start:T,finish:w},{start:e,finish:t}).intersection;if(null!=L){var k=s.intersectDates({start:L.start,finish:L.finish},{start:S.start,finish:S.finish}).intersection;null!=k&&(u(k,S,l.sectionsToDraw,n),c=!0)}}c||null==S||v(S.start,S.finish,l.sectionsToDraw,"crewMember",n,"crewLabelStyle")}}}}function u(e,t,i,s){t.start.getTime()<e.start.getTime()&&v(t.start,e.start,i,"crewMember",s,"crewLabelStyle"),e.finish.getTime()<t.finish.getTime()&&v(e.finish,t.finish,i,"crewMember",s,"crewLabelStyle")}function d(e,t,i,n){var r=i.territoriesByType.P;if(void 0!==r)for(var a=0;a<r.length;a++){var o=r[a],c=useLocationTimezone?o.operatingHours.TimeZone:userTimeZone,l=p(i.member.startDate,"GMT",c),u=p(i.member.endDate,"GMT",c),d=s.intersectDates({start:e,finish:t},{start:l,finish:u}).intersection;if(null!=d){var g=s.intersectDates({start:o.start,finish:o.finish},{start:d.start,finish:d.finish}).intersection;null!=g&&v(g.start,g.finish,o.sectionsToDraw,"crewMember",n,"crewLabelStyle")}}}function v(e,t,i,s,n,r){scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:i.daily,css:s,html:"<div class='"+r+"' title='"+n+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.crewMember+"'></use></svg> "+n+" </div>"}),scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:i.monthly,html:"<div class='relocatedLabel' title='"+n+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.crewMember+"'></use></svg></div>",css:"crewmember_monthly"})}function p(e,t,i){return s.convertDateBetweenTimeZones(e,t,i)}function g(e){var i={},n=t.resourcesAndTerritories();for(var r in e){void 0==i[r]&&(i[r]={},i[r].territoriesByType={},i[r].member=e[r]);var a=n[e[r].serviceResource];for(var o in a){var c=a[o],l=s.generateResourceId(e[r].serviceResource,c.serviceTerritory);void 0==i[r].territoriesByType[c.serviceTerritoryType]&&(i[r].territoriesByType[c.serviceTerritoryType]=[]),i[r].territoriesByType[c.serviceTerritoryType].push({start:c.effectiveStartDate,finish:c.effectiveEndDate,serviceTerritory:c.serviceTerritory,operatingHours:c.serviceTerritory__r.OperatingHours,type:c.serviceTerritoryType,id:c.id,section:l,sectionsToDraw:h(l)})}void 0!==i[r].territoriesByType.P&&i[r].territoriesByType.P.sort(s.sortByTime),void 0!==i[r].territoriesByType.R&&i[r].territoriesByType.R.sort(s.sortByTime),void 0!==i[r].territoriesByType.S&&i[r].territoriesByType.S.sort(s.sortByTime)}return i}function h(e){var t={monthly:{},daily:{}};for(var i in scheduler.matrix)"MonthlyView"===i||"MTDView"==i?t.monthly[i]=[e]:t.daily[i]=[e];return t}var m={};return i.$on("gotNewTimePhasedObjects",function(e,t){n.areCrewsSupported()&&Object.keys(t.serviceCrewMembers).length&&a(t.start,t.finish,t)}),{reset:r}}])}(),function(){angular.module("serviceExpert").factory("resourceFilterHelper",["$q","sfdcService","$sce","userSettingsManager",function(e,t,i,s){function n(){return m.crewsSelectionOptions.crewFilteringOptions}function r(){return g}function a(){return h}function o(e,t){var i=m.picklistOptions.indexOf(e);-1===i?m.picklistOptions.push(e):m.picklistOptions.splice(i,1)}function c(){if(m.selectedPicklist&&(m.picklistOptions.length||m.picklistNullValues))return!0;for(var e in m.resourceFilteringOptions)if(m.resourceFilteringOptions[e])return!0;return!1}function l(){m.selectedPicklist="select_a_field",m.length=0,m.picklistOptions.length=0,m.picklistNullValues=!1;for(var e in m.resourceFilteringOptions)m.resourceFilteringOptions[e]=!1}function u(){for(var e in m.resourceFilteringOptions)m.resourceFilteringOptions[e]=!0}function d(e){var t="",i="",s=customLabels.SelectAfieldToResourceFilter;e&&(t="<b>"+customLabels.CurrentlyWorking+"</b>");for(var n in g)"BOOLEAN"===g[n][1]&&m.resourceFilteringOptions[g[n][2]]?""===t?t="<b>"+g[n][0]+"</b>":t+=" and <b>"+g[n][0]+"</b>":"PICKLIST"===g[n][1]&&m.selectedPicklist===g[n][2]&&(i=m.picklistOptions.join("</b> "+customLabels.or+" <b>"),i.length>0&&(i="<b>"+g[n][0]+"</b> is <b>"+i+"</b>"),m.picklistNullValues&&(""===i?i="<b>"+customLabels.None+"</b>":i+=" "+customLabels.or+" <b>"+customLabels.None+"</b>"));return""!==t&&""!==i?s=customLabels.Resources_That_Are_x_and_y.replaceAll(t,i):""===t&&""!==i?s=customLabels.Resources_That_Are_x.replaceAll(i):""!==t&&""==i&&(s=customLabels.Resources_That_Are_x.replaceAll(t)),s}var v={sortBy:customLabels.name,asc:!0,showWorkingResource:!1,booleanFields:{},picklistField:"select_a_field",picklistOptions:[],picklistOptionsModel:[],picklistNullValues:!1,crewsOption:customLabels.showAll},p=JSON.parse(s.GetUserSettingsProperty("Resource_Filter__c"))||v,g=null,h=null,m={selectedPicklist:p.picklistField,resourceFilteringOptions:p.booleanFields,picklistOptionsModel:p.picklistOptionsModel,picklistOptions:p.picklistOptions,picklistNullValues:p.picklistNullValues,crewsSelectionOptions:{selectedPicklist:p.crewsOption,crewFilteringOptions:[customLabels.showAll,customLabels.hideCrewMembers,customLabels.showCrewsAndCrewMembers,customLabels.showOnlyCrews,customLabels.hideCrewsAndCrewMembers]}},f=t.getResourceFieldSetFields().then(function(e){g=e,g.Name=["Name","STRING","Name"];for(var t in g)"BOOLEAN"===g[t][1]&&(m.resourceFilteringOptions[t]=p.booleanFields[t])});return f.then(function(){var e=[];for(var i in g)"PICKLIST"===g[i][1]&&e.push(i);t.getResourcePicklistValues(e).then(function(e){h=e,$("#resourceExplainCrap").html(d(p.showWorkingResource))})}),{getResourceFieldset:r,getCrewFilteringOptions:n,getPicklistNames:a,selectionInfo:m,updateSelectedPicklist:o,resetFilter:l,setAll:u,generateFilterExplanation:d,isResourceFilterApplied:c,resourceFieldToSortyBy:p.sortBy,resourceCrewFilter:m.crewsSelectionOptions.selectedPicklist,resourceCrewDefaultFilter:customLabels.showAll,descending:p.asc,showWorkingResource:p.showWorkingResource}}])}(),function(){function e(e,t,i,s,n,r,a,o,c,l,u,d,v){function p(o,c){if(!z){z=e.$new(!0),z.lightboxResource=t.getResources()[o],z.terMemberKey=c||a.getResoruceGanttIdByDate(o,scheduler.getState().min_date),z.selectedTab="details",z.urls={related:i.trustAsResourceUrl(customResourceRelatedListLightboxPage+"?id="+o).toString(),chatter:i.trustAsResourceUrl(customResourceChatter+"?id="+o).toString(),details:i.trustAsResourceUrl(customResourceLightboxPage+"?id="+o).toString(),calendar:i.trustAsResourceUrl("vf079_ResourceCalendar?id="+o).toString()},z.urls.custom1=CustomResourceTab1?i.trustAsResourceUrl(CustomResourceTab1+"?id="+o).toString():null,z.urls.custom2=CustomResourceTab2?i.trustAsResourceUrl(CustomResourceTab2+"?id="+o).toString():null,z.changeTab=m,z.closeLightbox=g,z.chatterAvailable=fieldTrackingEnabled.resource,z.formatTravel=_,z.openConsoleTab=n.openConsoleTab,z.formatKpitText=T,z.formatDateToTime=w,z.formatCapacityKpitText=L,z.getContractorCapacityStatus=B,z.isMapEnabled=r.isMapEnabled(),z.contractorSupport=r.areContractorsSupported(),z.isDaily="ZoomLevel3"==scheduler._mode?!0:!1,z.actualRoute=null,z.showActual=!0,z.toggleShowRoute=E,z.toggleActualVisibilityWhenMapTabClicked=U,z.boundOnCaruselItem=S,z.zoomOutToFitAll=b,z.slideToggle=y,z.currentlyShowingOnMap=null,z.changeDate=O,z.getColorByStatus=h,Chart.defaults.global.colours=["#16325c","#DCDCDC","#F7464A","#46BFBD","#FDB45C","#949FB1","#4D5360"],z.donutCharts=null,z.isMapEnabled&&k(),f(o),B(o);var l=j();l.find("#ResourceLightbox").draggable({handle:"#ResourceLightboxHeader"}),angular.element("body").append(l),r.setLightBoxStatus(),z.$on("$destroy",function(){return l.remove()}),z.$on("keypress",function(e,t){27==t.which&&z.$evalAsync(z.closeLightbox)}),s(l)(z),n.safeApply(z),v.getResourceActualRoute(z.lightboxResource.id,scheduler.getState().min_date).then(P)}}function g(){z.killWatch&&z.killWatch(),r.setLightBoxStatus(!1),z.$destroy(),z=null}function h(e){switch(e){case l.NONE:return"#a5e2d6";case l.SCHEDULED:return"#F9D058";case l.DISPATCHED:return"#8DD8FA";case l.IN_PROGRESS:return"#D68EF9";case l.COMPLETED:return"#95D055";case l.COULD_NOT_COMPLETE:return"#f58556";case l.CANCELED:return"#BEBCBA";default:return"#B7C9EA"}}function m(e){e!==z.selectedTab&&(z.selectedTab=e)}function f(e){var t=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date);z.resourceKpi={total:0,completed:0,violations:0,jeopardy:0,avgTravelTime:0,totalScheduledDuration:0};for(var i=0;i<t.length;i++)t[i].resource==e&&("na"===t[i].type&&(z.resourceKpi.avgTravelTime+=t[i].travelTo+t[i].travelFrom),"service"===t[i].type&&(z.resourceKpi.total++,t[i].statusCategory==l.COMPLETED&&z.resourceKpi.completed++,t[i].violations&&z.resourceKpi.violations++,t[i].jeopardy&&z.resourceKpi.jeopardy++,z.resourceKpi.avgTravelTime+=t[i].travelTo+t[i].travelFrom,t[i].start_date&&t[i].end_date&&(z.resourceKpi.totalScheduledDuration+=(t[i].finish-t[i].start)/1e3)));t.length>0&&z.resourceKpi.total>0?z.resourceKpi.avgTravelTime=Math.floor(z.resourceKpi.avgTravelTime/60/z.resourceKpi.total):z.resourceKpi.avgTravelTime=0}function S(e){z.currentlyShowingOnMap=e.id;var t=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);z.map.setCenter(t),z.map.setZoom(13)}function b(){z.bounds.isEmpty()||z.map.fitBounds(z.bounds),z.currentlyShowingOnMap=null}function y(){$("#toggleResourceMapServiceCarousel .fa").toggleClass("rotatedown"),$("#mapCarouselWrapper").slideToggle("slow",function(){})}function _(e){var t=Math.floor(e/60/60),i=Math.floor(e/60%60);return t+customLabels.kpi_h+" "+i+customLabels.kpi_m}function T(){return z.isDaily?customLabels.KPIsAreCalculatedFrom.replaceAll(moment(scheduler._min_date).format("ll"),moment(scheduler._max_date).format("ll")):customLabels.KPIsAreCalculatedFromTo.replaceAll(moment(scheduler._min_date).format("ll"),moment(scheduler._max_date).format("ll"))}function w(e){return e?moment(e).format("LT"):null}function L(e,t){return""===e||""===t?"":customLabels.Between_x_and_y.replaceAll(moment(e).format("ll"),moment(t).format("ll"))}function k(){z.getServiceInfoRowClass=n.getServiceInfoRowClass,z.firstMapShow=!0,z.showRoute=!0,z.showTrafficLayer=!1,z.showServices=!0,z.mapControl={},z.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM},fullscreenControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}},z.serviceInfoWindow={show:!1},z.livePosInfoWindow={show:!1},z.resourceInfoWindow={show:!1},z.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)},resource:{pixelOffset:new google.maps.Size(0,-38)}},z.resourceServicesDate=scheduler.getState().min_date,z.markersArray=[],d.fieldsSetFields().then(function(e){z.serviceFields=e.MapInfo}),z.killWatch=z.$watch("selectedTab",function(e){"map"==e&&o(function(){if(z.map=z.mapControl.getGMap(),google.maps.event.trigger(z.map,"resize"),z.firstMapShow){z.firstMapShow=!1;var e=z.map.getStreetView(),t={fullscreenControl:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER}};e.setOptions(t),z.firstMapShow=!1,z.generateMarkersAndRoute()}},0)}),z.generateMarkersAndRoute=R,z.openDatePicker=M,z.routeToggled=function(){var e=z.showRoute?z.map:null;z.polyLineGoogleObj&&z.polyLineGoogleObj.setMap(e),z.directionsDisplay&&z.directionsDisplay.setMap(e)},z.markerClicked=function(e,t,i){C(i)},z.markerCloseClicked=function(){z.serviceInfoWindow.show=!1,z.livePosInfoWindow.show=!1,z.resourceInfoWindow.show=!1,z.$apply()},z.openFieldSetLink=function(e,t){n.openLink(e,t)},z.openLink=function(e){n.openSObjectLink(e)}}function C(e){var t=e.type;switch(z.serviceInfoWindow.show=!1,z.livePosInfoWindow.show=!1,z.resourceInfoWindow.show=!1,z.currentMarker=e,t){case"service":z.serviceInfoWindow.show=!0;break;case"lastKnownPosition":z.livePosInfoWindow.show=!0;break;case"resource":z.resourceInfoWindow.show=!0}o(function(){z.$apply(),n.setMapCloseButtonPosition()},0)}function R(e){z.resourceSLRPath={stroke:{weight:2,color:"#16325C"},path:[],geodesic:!0,toggle:!0},z.polyLinePath={path:[],geodesic:z.resourceSLRPath.geodesic,strokeColor:z.resourceSLRPath.stroke.color,strokeWeight:z.resourceSLRPath.stroke.weight,strokeOpacity:1},z.markersArray=[],z.bounds=new google.maps.LatLngBounds;var i=F();z.resourceServices=x();var s={};if(i)if(i.latitude)s={latitude:i.latitude,longitude:i.longitude};else{var n=t.territories[i.serviceTerritory];n.latitude&&(s={latitude:n.latitude,longitude:n.longitude})}var r=null;s.latitude&&(z.markersArray.push({id:i.serviceResource,type:"resource",coords:s,markerOptions:{icon:staticResources.homebase_png},resourceName:z.lightboxResource.name}),r=new google.maps.LatLng(s.latitude,s.longitude),z.polyLinePath.path.push(r),z.bounds.extend(r));for(var a=0;a<z.resourceServices.length;a++){var o=z.resourceServices[a];if(o.latitude){if(z.showServices){var c=staticResources.service_png,l={id:o.id,type:"service",coords:{latitude:o.latitude,longitude:o.longitude},markerOptions:{icon:c,labelContent:"<span>"+(a+1)+"</span>"+moment(o.start).format("LT"),labelClass:"ResourceMapServiceMarkerLabel",zIndex:200},item:o};z.markersArray.push(l);
}var u=new google.maps.LatLng(o.latitude,o.longitude);z.bounds.extend(u),z.resourceSLRPath.path.push({location:u,stopover:!0}),z.polyLinePath.path.push(u)}}if(s.latitude&&z.polyLinePath.path.push(r),!e){if(z.showRoute)if(allowStreetLevelRouting&&z.resourceSLRPath.path.length>0){var d=new google.maps.DirectionsService;d.route({origin:r?r:z.resourceSLRPath.path[0].location,destination:r?r:z.resourceSLRPath.path[z.resourceSLRPath.path.length-1].location,waypoints:z.resourceSLRPath.path,travelMode:google.maps.TravelMode.DRIVING},function(e,t){t===google.maps.DirectionsStatus.OK?(z.polyLineGoogleObj&&(z.polyLineGoogleObj.setMap(null),z.polyLineGoogleObj=null),z.directionsDisplay||(z.directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:!0})),z.directionsDisplay.setMap(z.map),z.directionsDisplay.setDirections(e)):(window.alert("Directions request failed due to "+t),D())})}else D();else z.polyLineGoogleObj?z.polyLineGoogleObj.setMap(null):z.directionsDisplay&&z.directionsDisplay.setMap(null);var v=new google.maps.LatLng(37.794024,-122.394837);z.bounds.isEmpty()?z.map.setCenter(v):z.map.fitBounds(z.bounds)}A()}function D(){z.directionsDisplay&&(z.directionsDisplay.setMap(null),z.directionsDisplay=null),z.polyLineGoogleObj&&z.polyLineGoogleObj.setMap(null),z.polyLineGoogleObj=new google.maps.Polyline(z.polyLinePath),z.polyLineGoogleObj.setMap(z.map)}function A(){var e=u.lastKnownPositions();for(var t in e)I(e[t])}function I(e){var i=t.getResources()[e.id],s={id:e.id+"_position",markerOptions:{icon:staticResources.livepos_png},type:"lastKnownPosition",resourceId:e.id,coords:{latitude:e.latitude,longitude:e.longitude},item:angular.extend(angular.copy(e),{resourceName:i.name})};s.item.lastModifiedDate=n.convertDateBetweenTimeZones(s.item.lastModifiedDate,"UTC",userTimeZone),z.markersArray.push(s)}function F(){var e=z.resourceServicesDate,t=new Date(e);t.setHours(24,0,0,0);var i=a.resourcesAndTerritories();for(var s in i){var r=i[s];for(var o in r){var c=r[o];if(n.generateResourceId(c.serviceResource,c.serviceTerritory)==z.terMemberKey&&isIntersect(e,t,c.effectiveStartDate,c.effectiveEndDate))return c}}return null}function x(){var e=z.resourceServicesDate,t=new Date(e);t.setHours(24,0,0,0);var i=scheduler.getEvents(e,t),s=i.filter(function(e){return e.resourceId.indexOf(z.terMemberKey)>-1&&e.latitude}).sort(function(e,t){return e.start.getTime()-t.start.getTime()});return s}function M(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"resourceServicesDateStart",date:new Date(z.resourceServicesDate),navigation:!0,handler:function(e,t){z.$apply(function(){z.resourceServicesDate=e,z.generateMarkersAndRoute(),v.getResourceActualRoute(z.lightboxResource.id,e).then(P)}),scheduler.destroyCalendar()}})}function O(e){z.resourceServicesDate.setDate(z.resourceServicesDate.getDate()+e),z.generateMarkersAndRoute(),v.getResourceActualRoute(z.lightboxResource.id,z.resourceServicesDate).then(P)}function P(e){z.actualRoute&&(z.actualRoute.visible=!1,z.actualRoute.setMap(z.map));var t={},i=[];e.forEach(function(e){("LastKnownLatitude"===e.Field||"LastKnownLongitude"===e.Field)&&(t[e.CreatedDate]=t[e.CreatedDate]||{},t[e.CreatedDate][e.Field.indexOf("Long")>-1?"lng":"lat"]=e.NewValue,t[e.CreatedDate].date=e.CreatedDate)});for(var s in t)i.push(t[s]);z.actualRoute=new google.maps.Polyline({path:i,geodesic:!0,strokeColor:"#ff73bf",strokeOpacity:1,strokeWeight:3}),N()&&z.actualRoute.setMap(z.map)}function E(){z.actualRoute&&(z.actualRoute.visible=z.showActual,z.actualRoute.setMap(z.map))}function N(){return z.showActual}function B(e){for(var t=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),i=[],s=[],n=0;n<t.length;n++)t[n].resource==e&&"contractorcapacity"==t[n].type&&("Week"==t[n].timePeriod&&i.push(t[n]),"Month"==t[n].timePeriod&&s.push(t[n]));z.donutCharts=H(),setTimeout(function(){G(i[0],s[0])},1e3)}function H(){var e={segmentShowStroke:!1,segmentStrokeColor:"#fff",segmentStrokeWidth:2,percentageInnerCutout:75,animation:!0,animationSteps:100,animationEasing:"easeOutSine",animateRotate:!0,animateScale:!1,showTooltips:!0};return{labels:[customLabels.Hours_Used,customLabels.Hours_Available],weekly:{data:[],percentage:"",start:"",end:"",show:!1,options:e},monthly:{data:[],percentage:"",start:"",end:"",show:!1,options:e}}}function G(e,t){var i;e?(i=e.hoursPerTimePeriod-e.hoursInUse,0>i&&(i=0),z.donutCharts.weekly.data=[e.hoursInUse,i],z.donutCharts.weekly.percentage=V(e.hoursInUse,e.hoursPerTimePeriod)+"%",z.donutCharts.weekly.start=e.start_date,z.donutCharts.weekly.end=e.end_date,z.donutCharts.weekly.show=!0):(z.donutCharts.weekly.data=[0,10],z.donutCharts.weekly.show=!1,z.donutCharts.weekly.options.showTooltips=!1,z.donutCharts.weekly.start=z.kpiStart,z.donutCharts.weekly.end=z.kpiEnd),t?(i=t.hoursPerTimePeriod-t.hoursInUse,0>i&&(i=0),z.donutCharts.monthly.data=[t.hoursInUse,i],z.donutCharts.monthly.percentage=V(t.hoursInUse,t.hoursPerTimePeriod)+"%",z.donutCharts.monthly.start=t.start_date,z.donutCharts.monthly.end=t.end_date,z.donutCharts.monthly.show=!0):(z.donutCharts.monthly.data=[0,10],z.donutCharts.monthly.show=!1,z.donutCharts.monthly.options.showTooltips=!1,z.donutCharts.monthly.start=scheduler.getState().min_date,z.donutCharts.monthly.end=scheduler.getState().max_date)}function V(e,t){return parseFloat((e/t*100).toFixed(2))}function U(){o(function(){z.actualRoute&&z.actualRoute.setMap(z.map)},500)}function j(){return angular.element('<div class="LightboxBlackContainer ng-cloack">\n                    <div class="LightboxContainer ng-cloak" id="ResourceLightbox">\n\n                        <div class="lightboxHeaderContainer" id="ResourceLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <img ng-show="lightboxResource.pictureLink" class="resourcePhotoLightbox" ng-src="{{ lightboxResource.pictureLink }}" alt="{{ lightboxResource.name }}" />\n                            <div ng-show="!lightboxResource.pictureLink" alt="{{ lightboxResource.name }}" class="ResourcePhotoIcon resourcePhotoLightbox"></div>\n\n                            <h1 class="lightboxHeader" id="resourceName" ng-bind="lightboxResource.name"></h1>\n                            <span ng-click="changeTab(\'details\')" ng-class="{lightboxSelectedTab: selectedTab == \'details\'}">\n                                '+customLabels.Details+"\n                            </span>\n\n                            <span ng-click=\"changeTab('relatedLists')\" ng-class=\"{lightboxSelectedTab: selectedTab == 'relatedLists'}\">\n                                "+customLabels.Related+'\n                            </span>\n\n                            <span ng-show="chatterAvailable" ng-click="changeTab(\'chatter\')" ng-class="{lightboxSelectedTab: selectedTab == \'chatter\'}">\n                                '+customLabels.Chatter+'\n                            </span>\n\n                            <span ng-if="isMapEnabled" ng-click="changeTab(\'map\'); " ng-class="{lightboxSelectedTab: selectedTab == \'map\'}">\n                                '+customLabels.Map+"\n                            </span>\n\n                            <span ng-click=\"changeTab('calendar')\" ng-class=\"{lightboxSelectedTab: selectedTab == 'calendar'}\">\n                                "+customLabels.Calendar+'\n                            </span>\n                            \n                            <span ng-show="urls.custom1" ng-click="changeTab(\'customTab1\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab1\'}">\n                                '+customLabels.CustomResourceTab1+'\n                            </span>\n                            \n                            <span ng-show="urls.custom2" ng-click="changeTab(\'customTab2\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab2\'}">\n                                '+customLabels.CustomResourceTab2+'\n                            </span>\n\n                            <div class="ExtendedForm">\n                                <a ng-click="openConsoleTab($event,lightboxResource.id)" target="_blank" href="../{{ lightboxResource.id }}" title="'+customLabels.ExtandedForm+'">\n                                    <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                        \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                    \u2028</svg>\n                                </a>\n                            </div>\n                        </div>\n\n                        <section ng-if="isMapEnabled" id="resourceLightboxMap" ng-show ="selectedTab == \'map\'">\n                            <ui-gmap-google-map pan="false" control="mapControl" center="{latitude: 0 ,longitude: 0}" options="mapOptions" zoom="16" class="map-canvas">\n                                <ui-gmap-markers click="markerClicked" models="markersArray" idKey="id" coords="\'coords\'" options="\'markerOptions\'"">\n                                </ui-gmap-markers>\n\n                                <ui-gmap-window show="serviceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.service" >\n                                    <div class="googleMapInfoWindowService">\n                                        <img class="mapTooltipIcon" src="'+staticResources.wo_icon_png+'"/>\n                                        <h1 class="truncate mapTooltipTitle">{{currentMarker.item | displayFieldSetField : serviceFields[0] }}</h1>\n\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[1] || serviceFields[1]">{{serviceFields[1].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[1])" ng-class="getServiceInfoRowClass(serviceFields[1])">{{currentMarker.item | displayFieldSetField : serviceFields[1]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[2] || serviceFields[2]">{{serviceFields[2].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[2])" ng-class="getServiceInfoRowClass(serviceFields[2])">{{currentMarker.item | displayFieldSetField : serviceFields[2]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[3] || serviceFields[3]">{{serviceFields[3].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[3])" ng-class="getServiceInfoRowClass(serviceFields[3])">{{currentMarker.item | displayFieldSetField : serviceFields[3]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[4] || serviceFields[4]">{{serviceFields[4].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[4])" ng-class="getServiceInfoRowClass(serviceFields[4])">{{currentMarker.item | displayFieldSetField : serviceFields[4]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[5] || serviceFields[5]">{{serviceFields[5].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[5])" ng-class="getServiceInfoRowClass(serviceFields[5])">{{currentMarker.item | displayFieldSetField : serviceFields[5]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[6] || serviceFields[6]">{{serviceFields[6].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[6])" ng-class="getServiceInfoRowClass(serviceFields[6])">{{currentMarker.item | displayFieldSetField : serviceFields[6]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[7] || serviceFields[7]">{{serviceFields[7].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[7])" ng-class="getServiceInfoRowClass(serviceFields[7])">{{currentMarker.item | displayFieldSetField : serviceFields[7]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[8] || serviceFields[8]">{{serviceFields[8].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[8])" ng-class="getServiceInfoRowClass(serviceFields[8])">{{currentMarker.item | displayFieldSetField : serviceFields[8]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[9] || serviceFields[9]">{{serviceFields[9].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[9])" ng-class="getServiceInfoRowClass(serviceFields[9])">{{currentMarker.item | displayFieldSetField : serviceFields[9]}}</span></div>\n\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-window show="resourceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.resource">\n                                    <div class="googleMapInfoWindowHomebase">\n                                        <svg aria-hidden="true" class="slds-icon homebaseTooltipIcon">\n                                            \u2028<use xlink:href="'+lsdIcons.home+'"></use>\n                                        \u2028</svg>\n                                        <h1 class="truncate mapTooltipTitle"><span class="homebaseLabel">{{ "'+customLabels.homebase_of+'" | replaceLabels : currentMarker.resourceName }}</span></h1>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.id)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-window show="livePosInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.livePos">\n                                    <div class="googleMapInfoWindowLivePos">\n                                        <svg aria-hidden="true" class="slds-icon livePosTooltipIcon">\n                                        \u2028	<use xlink:href="'+lsdIcons.user+'"></use>\n                                    \u2028	</svg>\n                                        <h1 class="truncate mapTooltipTitle" ng-bind="$parent.$parent.$parent.currentMarker.item.resourceName"></h1>\n                                        <div>'+customLabels.Last_seen+' {{ currentMarker.item.lastModifiedDate | amDateFormat:\'lll\' }}</div>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.resourceId)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-layer type="TrafficLayer"\n                                show=\'showTrafficLayer\'\n                                >\n                            </ui-gmap-layer>\n                            </ui-gmap-google-map>\n                            <div id="ResourceMapOptions">\n                                <div id="ResourceMapOptionsWrapper">\n                                    <input ng-model="$parent.showServices" ng-change="generateMarkersAndRoute(true)" type="checkbox" id="ResourceServicesFilter"></input>\n                                    <label for="ResourceServicesFilter">'+customLabels.Show_services_for+'</label>\n                                    <div class="resourceMapDateArrow" ng-click="changeDate(-1)">\n                                        <svg aria-hidden="true" class="slds-icon resourceMapChevronIcon">\n                                        \u2028   <use xlink:href="'+lsdIcons.chevronleft+'"></use>\n                                    \u2028   </svg>\n                                    </div>\n                                    <u id="resourceServicesDateStart" class="bulkDatePicker" ng-click ="openDatePicker()" >{{resourceServicesDate | amDateFormat:\'L\'}}</u>\n                                    <div class="resourceMapDateArrow" ng-click="changeDate(1)">\n                                        <svg aria-hidden="true" class="slds-icon resourceMapChevronIcon">\n                                        \u2028   <use xlink:href="'+lsdIcons.chevronright+'"></use>\n                                    \u2028   </svg>\n                                    </div>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="$parent.showRoute" ng-change="routeToggled()" type="checkbox" id="RouteFilter"></input>\n                                    <label ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="RouteFilter">'+customLabels.Route+'</label>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="$parent.showActual" ng-change="toggleShowRoute()" type="checkbox" id="actualToggle"></input>\n                                    <label ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="actualToggle">'+customLabels.ActualRoute+'</label>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="showTrafficLayer" type="checkbox" id="trafficToggle"></input>\n                                    <label ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="trafficToggle">'+customLabels.Traffic+'</label>\n                                </div>\n                            </div>\n                            <div id="ResourceMapCarousel" ng-show="resourceServices.length > 0">\n                                <div id="toggleResourceMapServiceCarousel" ng-click="slideToggle()">\n                                    <i class="fa fa-caret-up"></i>\n                                </div>\n                                <div id="mapCarouselWrapper">\n                                    <div class="carouselArrow crouselLeft">\n                                        <svg aria-hidden="true" class="slds-icon arrowIcon">\u2028<use xlink:href="'+lsdIcons.chevronleft+'"></use>\u2028</svg>\n                                    </div>\n                                    <div class="carouselArrow crouselRight">\n                                        <svg aria-hidden="true" class="slds-icon arrowIcon">\u2028<use xlink:href="'+lsdIcons.chevronright+'"></use>\u2028</svg>                                \n                                    </div>\n                                    <div ng-repeat="marker in markersArray" class="carouselItem" ng-if="marker.type == \'service\'">\n                                        <span class="appointment-times">{{formatDateToTime(marker.item.start)}} - {{formatDateToTime(marker.item.finish)}}</span>\n                                        <span class="appointment-number">{{marker.item.AppointmentNumber}}</span>\n                                        <div class="boundOnMarker globalBlueButton" ng-click="boundOnCaruselItem(marker)" ng-hide="currentlyShowingOnMap == marker.id">\n                                            <svg aria-hidden="true" class="slds-icon boundIcon">\u2028<use xlink:href="'+lsdIcons.checkin+'"></use>\u2028</svg>                                            \n                                        </div>\n                                        <div class="boundOnMarker globalBlueButton" ng-click="zoomOutToFitAll()" ng-show="currentlyShowingOnMap == marker.id">\n                                            <svg aria-hidden="true" class="slds-icon boundIcon">\u2028<use xlink:href="'+lsdIcons.location+'"></use>\u2028</svg>                                            \n                                        </div>\n                                        <span class="appointment-seperator" ng-style="{\'background-color\': getColorByStatus(marker.item.statusCategory)}"></span>\n                                        <div class="appointment-rows">\n                                            <span ng-repeat="field in serviceFields" class="">\n                                                <div ng-show="marker.item[field.JsAPIName]">{{field.Label}}: <span ng-click="openFieldSetLink(marker.item, field)" ng-class="getServiceInfoRowClass(field)">{{marker.item | displayFieldSetField : field}}</span></div>                                            \n                                            </span>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </section>\n\n                        <div class="capacitiesDonuts" ng-show="selectedTab == \'details\' && lightboxResource.isCapacityBased && contractorSupport">\n                            <div id="weeklyCapacity">\n                                <div id="weeklyDonutPercentage" class="donutPercentage">\n                                    <div ng-show="donutCharts.weekly.show" ng-bind="donutCharts.weekly.percentage"></div>\n                                    <div class="noCapacity" ng-show="!donutCharts.weekly.show">'+customLabels.No_Weekly_Capacity+'</div>\n                                    <div class="capacityTimeFrameLabel truncate" ng-show="donutCharts.weekly.show" title="'+customLabels.Weekly_Capacity+'">'+customLabels.Weekly_Capacity+'</div>\n                                </div>\n                                <canvas id="weeklyDoughnutChart"\n                                        class="chart chart-doughnut"\n                                        chart-options="donutCharts.weekly.options"\n                                        chart-data="donutCharts.weekly.data"\n                                        chart-labels="donutCharts.labels">\n                                </canvas>\n                                <div class="capacityRange">{{formatCapacityKpitText(donutCharts.weekly.start, donutCharts.weekly.end)}}</div>\n                            </div>\n\n                            <div id="monthlyCapacity">\n                                <div id="monthlyDonutPercentage" class="donutPercentage">\n                                    <div ng-show="donutCharts.monthly.show" ng-bind="donutCharts.monthly.percentage"></div>\n                                    <div class="noCapacity" ng-show="!donutCharts.monthly.show">'+customLabels.No_Monthly_Capacity+'</div>\n                                    <div class="capacityTimeFrameLabel truncate" ng-show="donutCharts.monthly.show" title="'+customLabels.Monthly_Capacity+'">'+customLabels.Monthly_Capacity+'</div> \n                                </div>\n                                <canvas id="monthlyDoughnutChart"\n                                        class="chart chart-doughnut"\n                                        chart-options="donutCharts.monthly.options"\n                                        chart-data="donutCharts.monthly.data"\n                                        chart-labels="donutCharts.labels">\n                                </canvas>\n                                <div class="capacityRange">{{formatCapacityKpitText(donutCharts.monthly.start, donutCharts.monthly.end)}}</div>\n                            </div>\n                        </div>\n\n                        <div id="KPIforResource" ng-show="selectedTab == \'details\'" ng-class="{KPIforResourceWithCapacity: (lightboxResource.isCapacityBased && contractorSupport)}">\n                            <div class="kpiIndicator" ng-show="!lightboxResource.isCapacityBased || (lightboxResource.isCapacityBased && !contractorSupport)">\n                                <div class="kpiResourceValue" >\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.clock+'"></use>\u2028</svg>\n                                    {{ formatTravel(resourceKpi.totalScheduledDuration) }}\n                                </div>\n\n                                '+customLabels.Total_Scheduled+'\n                            </div>\n\n                            <div class="kpiIndicator" ng-show="isMapEnabled && (!lightboxResource.isCapacityBased || (lightboxResource.isCapacityBased && !contractorSupport))">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIconTravel"><use xlink:href="'+lsdIcons.car+'"></use>\u2028</svg>\n                                    {{ formatTravel(resourceKpi.avgTravelTime * 60) }}\n                                </div>\n\n                                '+customLabels.Average_Travel+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.violation+'"></use>\u2028</svg>\n                                    {{ resourceKpi.violations }}\n                                </div>\n\n                                '+customLabels.Violations+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon"><use xlink:href="'+lsdIcons.jeopardy+'"></use>\u2028</svg>\n                                    {{ resourceKpi.jeopardy }}\n                                </div>\n                                 '+customLabels.In_Jeopardy+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.completed+'"></use>\u2028</svg>\n                                    {{ resourceKpi.completed }}/{{ resourceKpi.total }}\n                                </div>\n\n                                '+customLabels.Completed+'\n                            </div>\n\n                            <div class="KpiRange">{{formatKpitText()}}</div>\n                        </div>\n\n                        <iframe ng-src="{{ urls.details }}" id="detailsIframeResource" ng-class="{detailsIframeResourceContractor: lightboxResource.isCapacityBased && contractorSupport}" ng-show="selectedTab == \'details\'"></iframe>\n                        <iframe ng-src="{{ urls.related }}" id="relatedListIframeResource" ng-show="selectedTab == \'relatedLists\'" ></iframe>\n                        <iframe ng-src="{{ urls.chatter }}" ng-if="chatterAvailable" id="chatterIframeResource" ng-show="selectedTab == \'chatter\'" ></iframe>\n                        <iframe ng-src="{{ urls.calendar }}" id="calendarIframeResource" ng-show="selectedTab == \'calendar\'" ></iframe>\n                        <iframe ng-if="urls.custom1" ng-show="selectedTab == \'customTab1\'" ng-src="{{ urls.custom1 }}" class="resourceLightboxIframe"></iframe>\n                        <iframe ng-if="urls.custom2" ng-show="selectedTab == \'customTab2\'" ng-src="{{ urls.custom2 }}" class="resourceLightboxIframe"></iframe>\n\n                    </div>\n                </div>')}var z=null;return{open:p}}e.$inject=["$rootScope","ResourcesAndTerritoriesService","$sce","$compile","utils","StateService","TimePhasedDataService","$timeout","SERVICE_STATUS","SERVICE_CATEGORY","LastKnownPositionService","FieldSetFieldsService","sfdcService"],angular.module("serviceExpert").factory("ResourceLightboxService",e)}(),function(){function e(e,t,i,s,n,r,a,o,c,l){function u(n,r,a){f=e.$new(!0),f.menuResource=t.getResources()[n],f.resourceId=n,f.section=r,f.openResourceLightbox=v,f.runDynamicGanttFunction=p,f.hasCustomPermission=s.hasCustomPermission,f.showCrew=g,f.openResourceDayOptimizationLightbox=h,f.isCrew=!1,void 0!==t.getCrewResources()[n]&&(f.isCrew=!0);var o=m(),c=$($(a).closest(".resourceMenuBtn")),l=c.offset();angular.element("body").append(o),$(".resourceMenuContainer").css({top:l.top,left:l.left}),f.$on("$destroy",function(){return o.remove()}),angular.element("body").on("mousedown",function(e){for(var t=["resMenuSingleAction"],i=0;i<t.length;i++)if(e.target.classList.contains(t[i])||e.target.parentNode&&e.target.parentNode.classList.contains(t[i]))return;d(),e.stopPropagation(),angular.element("body").off("mousedown")}),i(o)(f),s.safeApply(f)}function d(){f.$destroy()}function v(){n.open(f.resourceId,f.section)}function p(e){var t=void 0,i=void 0;t=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),i=a.selectedPolicyId;var n={FillInSchedule:{FunctionName:r.runFillInSchedule,NotificationHeaderText:customLabels.x_request_sent.replaceAll(customLabels.Fill_in_Schedule),NotificationText:customLabels.RequestNotificationSent.replaceAll(customLabels.Fill_in_Schedule,f.menuResource.name,moment(t).format("L"))},FixOverlaps:{FunctionName:r.runFixOverlaps,NotificationHeaderText:customLabels.x_request_sent.replaceAll(customLabels.FixOverlaps),NotificationText:customLabels.RequestNotificationSent.replaceAll(customLabels.FixOverlaps,f.menuResource.name,moment(t).format("L"))}};if(useLocationTimezone){var l=t,u=addDaysToDate(t,1),v={start_date:l,end_date:u},p=c.getIntersectingSrstOffset(v,f.resourceId),g=s.getUserOffset(l);s.getUserOffset(u);t.setMinutes(l.getMinutes()+g-p)}var h=n[e].FunctionName;h(t,f.resourceId,i).then(function(t){t?(t[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?s.addNotification(n[e].NotificationHeaderText,n[e].NotificationText,function(e){s.openSObjectLink("../"+e)},t.Id):s.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){s.openSObjectLink("../"+e)},t.Id),o.updateOptimizationRequest(t)):s.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).then(function(){})["catch"](function(t){console.warn(e+" failed :("),console.log(t),s.addNotification(customLabels.Action_Could_Not_Be_Performed,t.message)})["finally"](function(){}),d()}function g(){var i=t.getResources(),s=c.currentCrewToShow;s={};var n=c.crewToServiceCrewMembers()[f.menuResource.serviceCrew];s[f.resourceId]=f.menuResource;for(var r in n)s[n[r].serviceResource]=i[n[r].serviceResource],void 0===s[n[r].serviceResource].members&&(s[n[r].serviceResource].members={}),s[n[r].serviceResource].members[r]=n[r];c.currentCrewToShow=s,d(),e.$broadcast("moveToCrewView")}function h(){l.open(f.resourceId)}function m(){return angular.element('\n                    <div id="resourceMenu" class="resourceMenuContainer">\n                        <div class="truncate resMenuSingleAction" ng-click="openResourceLightbox()" title="'+customLabels.Details+'">\n                            <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                <use xlink:href="'+lsdIcons.info+'"></use>\n                            \u2028</svg>\n                            '+customLabels.Details+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="openResourceDayOptimizationLightbox()" ng-hide="menuResource.isCapacityBased || !hasCustomPermission(\'Resource_Schedule_Optimization\')" title="'+customLabels.RDOptimize+'">\n                            <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                <use xlink:href="'+lsdIcons.magicwand+'"></use>\n                            \u2028</svg>\n                            '+customLabels.RDOptimize+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="runDynamicGanttFunction(\'FixOverlaps\')" ng-hide="menuResource.isCapacityBased || !hasCustomPermission(\'Fix_Overlaps\')" title="'+customLabels.FixOverlaps+'">\n                            <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                <use xlink:href="'+lsdIcons.crossfilter+'"></use>\n                            \u2028</svg>\n                            '+customLabels.FixOverlaps+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="runDynamicGanttFunction(\'FillInSchedule\')" ng-hide="!hasCustomPermission(\'Fill_in\')" title="'+customLabels.Fill_in_Schedule+'">\n                            <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                <use xlink:href="'+lsdIcons.summarydetail+'"></use>\n                            \u2028</svg>\n                            '+customLabels.Fill_in_Schedule+'\n                        </div>\n                        <div class="truncate resMenuSingleAction" ng-click="showCrew()" ng-show="isCrew" title="'+customLabels.showCrewAndHisMemebers+'">\n                            <svg aria-hidden="true" class="slds-icon crew-icon-menu">\n                                <use xlink:href="'+lsdIcons.crew+'"></use>\n                            \u2028</svg>\n                            '+customLabels.showCrew+"\n                        </div>\n                    </div>\n                ");
}var f=null;return{open:u}}e.$inject=["$rootScope","ResourcesAndTerritoriesService","$compile","utils","ResourceLightboxService","sfdcService","StateService","DeltaService","TimePhasedDataService","rdOptimizeLightboxService"],angular.module("serviceExpert").factory("ResourceSmallMenu",e)}(),function(){function e(e,t){function i(){return v}function s(){return g}function n(){return p}function r(){return h}function a(){return m}function o(){var i=e.defer();return t.GetResourcesAndTerritories().then(function(e){i.resolve(),e.territories.forEach(function(e){e.IsActive&&(u[e.Id]=new ServiceTerritory(e)),d[e.Id]=new ServiceTerritory(e)}),e.resources.forEach(function(e){v[e.Id]=new ServiceResource(e),v[e.Id].isCapacityBased&&p.push(e.Id),v[e.Id].serviceCrew&&(h[e.Id]=e,m[v[e.Id].serviceCrew]=e)}),e.operatingHours.forEach(function(e){g[e.Id]=new OperatingHours(e)}),l.territories.resolve(u),l.resources.resolve(v),l.operatingHours.resolve(g)})["catch"](function(e){i.reject(e),l.resources.reject(),l.territories.reject(),l.operatingHours.reject(),console.warn("GetResourcesAndTeritorries: unable to load resources, territories, or operating hours"),bootstrap.handleError(e)}),i.promise}function c(){u={},v={},g={},p=[],h={},m={}}var l={territories:e.defer(),resources:e.defer(),operatingHours:e.defer()},u={},d={},v={},p=[],g={},h={},m={};return o(),{promises:{territories:function(){return l.territories.promise},resources:function(){return l.resources.promise},operatingHours:function(){return l.operatingHours.promise}},territories:u,allTerritories:d,getResources:i,operatingHours:g,getOperatingHours:s,getCapacityBasedResources:n,getCrewResources:r,getCrewToResources:a,contractorResources:p,crewResources:h,crewToResources:m,getResourceAndTerritories:o,reset:c}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("ResourcesAndTerritoriesService",e)}(),function(){function e(e,t,i,s,n,r,a,o,c,l,u,d,v,p){function g(o){T=e.$new(!0),T.lightboxService=t.serviceAppointments()[o],T.selectedTab="service",T.urls={service:i.trustAsResourceUrl(customLightboxPage+"?id="+o).toString()},T.lightboxService.accountId&&(T.urls.account=i.trustAsResourceUrl(customAccountLightbox+"?id="+T.lightboxService.accountId).toString()),T.urls.service_chatter=i.trustAsResourceUrl(customServiceChatterLightbox+"?id="+T.lightboxService.id).toString(),T.lightboxService.parentRecordType===r.WORKORDER?(T.urls.wo=i.trustAsResourceUrl(customWoLightbox+"?id="+T.lightboxService.parentRecord).toString(),T.urls.wo_chatter=i.trustAsResourceUrl(customWoChatterLightbox+"?id="+T.lightboxService.parentRecord).toString(),T.urls.related=i.trustAsResourceUrl(customWoRelatedLightbox+"?id="+T.lightboxService.parentRecord).toString()):T.lightboxService.parentRecordType===r.LINEITEM?(T.urls.wo=i.trustAsResourceUrl(customWoliLightbox+"?id="+T.lightboxService.parentRecord).toString(),T.urls.wo_chatter=i.trustAsResourceUrl(customWoliChatterLightbox+"?id="+T.lightboxService.parentRecord).toString(),T.urls.related=i.trustAsResourceUrl(customWoliRelatedLightbox+"?id="+T.lightboxService.parentRecord).toString()):T.lightboxService.parentRecordType===r.ACCOUNT?(T.urls.related=null,T.urls.account=i.trustAsResourceUrl(customAccountLightbox+"?id="+T.lightboxService.parentRecord).toString()):T.urls.related=null,T.urls.custom1=CustomServiceTab1?i.trustAsResourceUrl(CustomServiceTab1+"?id="+T.lightboxService.id).toString():null,T.urls.custom2=CustomServiceTab2?i.trustAsResourceUrl(CustomServiceTab2+"?id="+T.lightboxService.id).toString():null,T.changeTab=y,T.isChatterAvailable=m,T.closeLightbox=b,T.chatterAvailable=fieldTrackingEnabled.service,T.openConsoleTab=n.openConsoleTab,T.isMapEnabled=a.isMapEnabled(),T.selectedSubTabWo="details",T.selectedSubTabService="details",T.showWOTab=f,T.getIdOfObjectInActiveTab=h,T.isMapEnabled&&S(),T.$on("$destroy",function(){return c.remove()}),T.$on("keypress",function(e,t){27==t.which&&T.$evalAsync(T.closeLightbox)});var c=_();c.find("#ServiceLightbox").draggable({handle:"#ServiceLightboxHeader"}),a.setLightBoxStatus(),s(c)(T),n.safeApply(T,function(){angular.element("body").append(c)})}function h(){switch(T.selectedTab){case"account":return T.lightboxService.accountId?T.lightboxService.accountId:T.lightboxService.id;case"wo":return T.lightboxService.parentRecord?T.lightboxService.parentRecord:T.lightboxService.id;default:return T.lightboxService.id}}function m(e){return"wo"===e&&"WorkOrder"===T.lightboxService.parentRecordType&&fieldTrackingEnabled.workorder?!0:"wo"===e&&"WorkOrderLineItem"===T.lightboxService.parentRecordType&&fieldTrackingEnabled.woli?!0:"service"===e&&fieldTrackingEnabled.service?!0:!1}function f(e){return e===r.LINEITEM||e===r.WORKORDER}function S(){function e(e){var t=e.type;switch(T.serviceInfoWindow.show=!1,T.livePosInfoWindow.show=!1,T.currentMarker=e,t){case"service":T.serviceInfoWindow.show=!0;break;case"lastKnownPosition":T.livePosInfoWindow.show=!0}o(function(){T.$apply(),n.setMapCloseButtonPosition()},0)}function t(){var e=u.lastKnownPositions();for(var t in e)i(e[t])}function i(e){var t=d.getResources()[e.id],i={id:e.id+"_position",icon:staticResources.livepos_png,type:"lastKnownPosition",resourceId:e.id,coords:{latitude:e.latitude,longitude:e.longitude},item:angular.extend(angular.copy(e),{resourceName:t.name})};T.allMarkersArray.push(i)}if(T.serviceIcon=staticResources.wo_icon_png,T.resourceIcon=lsdIcons.user,T.lastSeenLabel=customLabels.Last_seen,T.getServiceInfoRowClass=n.getServiceInfoRowClass,T.currentMarker={},T.map=null,T.mapControl={},T.allMarkersArray=[],T.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}},T.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)}},T.serviceInfoWindow={show:!1},T.livePosInfoWindow={show:!1},l.fieldsSetFields().then(function(e){T.serviceFields=e.MapInfo}),null!=T.lightboxService.latitude&&null!=T.lightboxService.longitude)var s=c(function(){if(!T.mapControl||T.mapControl.getGMap){c.cancel(s),T.map=T.mapControl.getGMap();var e=staticResources.service_png;T.lightboxService.statusCategory==p.COMPLETED&&(e=staticResources.service_completed_png),T.allMarkersArray.push({id:T.lightboxService.id,icon:e,type:"service",coords:{latitude:T.lightboxService.latitude,longitude:T.lightboxService.longitude},item:T.lightboxService}),t();var i=new google.maps.LatLng(T.lightboxService.latitude,T.lightboxService.longitude);T.map.setCenter(i)}},500);T.openLink=function(e,t){n.openLink(e,t)},T.markerCloseClicked=function(){T.serviceInfoWindow.show=!1,T.livePosInfoWindow.show=!1,T.$apply()},T.markerClicked=function(t,i,s){e(s)},T.killWatch=T.$watch("selectedTab",function(e){"map"==e&&o(function(){google.maps.event.trigger(T.map,"resize")},0)})}function b(){a.setLightBoxStatus(!1),T.killWatch&&T.killWatch(),T.$destroy()}function y(e){e!==T.selectedTab&&(T.selectedTab=e)}function _(){return angular.element('<div class="LightboxBlackContainer">\n                <div class="LightboxContainer" id="ServiceLightbox">\n\n                    <div class="lightboxHeaderContainer" id="ServiceLightboxHeader">\n\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n\n                        <h1 class="lightboxHeader">{{lightboxService.name}}</h1>\n\n                        <span ng-click="changeTab(\'service\')" ng-class="{lightboxSelectedTab: selectedTab == \'service\'}">\n                            '+customLabels.Service+'\n                        </span>\n\n                        <span ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-click="changeTab(\'wo\')" ng-class="{lightboxSelectedTab: selectedTab == \'wo\'}">\n                            <div ng-show="lightboxService.parentRecordType === \'WorkOrder\'">'+customLabels.WorkOrder+"</div>\n                            <div ng-show=\"lightboxService.parentRecordType === 'WorkOrderLineItem'\">"+customLabels.Woli+'</div>\n                        </span>\n\n                        <span ng-show="urls.related" ng-click="changeTab(\'relatedList\')" ng-class="{lightboxSelectedTab: selectedTab == \'relatedList\'}">\n                            '+customLabels.Related+'\n                        </span>\n\n                        <span ng-if="isMapEnabled" ng-show="lightboxService.latitude && lightboxService.longitude" ng-click="changeTab(\'map\')" ng-class="{lightboxSelectedTab: selectedTab == \'map\'}">\n                            '+customLabels.Map+'\n                        </span>\n\n                        <span ng-show="urls.account" ng-click="changeTab(\'account\')" ng-class="{lightboxSelectedTab: selectedTab == \'account\'}">\n                            '+customLabels.Account+'\n                        </span>\n                        \n                        <span ng-show="urls.custom1" ng-click="changeTab(\'customTab1\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab1\'}">\n                            '+customLabels.CustomServiceTab1+'\n                        </span>\n                        \n                        <span ng-show="urls.custom2" ng-click="changeTab(\'customTab2\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab2\'}">\n                            '+customLabels.CustomServiceTab2+'\n                        </span>\n\n                        <div class="ExtendedForm">\n                            <a ng-click="openConsoleTab($event,getIdOfObjectInActiveTab())" target="_blank" href="../{{ getIdOfObjectInActiveTab() }}" title="'+customLabels.ExtandedForm+'">\n                                <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                    \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                \u2028</svg>\n                            </a>\n                        </div>\n\n                    </div>\n                   \n                    <div class="InnerWoTabs" ng-show="isChatterAvailable(\'service\') && selectedTab == \'service\'">\n                        <div class="InnerLightboxTab" ng-class="{\'selected\': selectedSubTabService == \'details\'}" ng-click="selectedSubTabService=\'details\'"}">'+customLabels.Details+"</div>\n                        <div class=\"InnerLightboxTab\" ng-class=\"{'selected': selectedSubTabService == 'feed'}\" ng-click=\"selectedSubTabService='feed'\">"+customLabels.Feed+'</div>\n                        <div class="InnerLightboxHr"></div>\n                    </div>\n                    \n                    <div class="InnerWoTabs" ng-show="isChatterAvailable(\'wo\') && selectedTab == \'wo\'">\n                        <div class="InnerLightboxTab" ng-class="{\'selected\': selectedSubTabWo == \'details\'}" ng-click="selectedSubTabWo=\'details\'"}">'+customLabels.Details+"</div>\n                        <div class=\"InnerLightboxTab\" ng-class=\"{'selected': selectedSubTabWo == 'feed'}\" ng-click=\"selectedSubTabWo='feed'\">"+customLabels.Feed+'</div>\n                        <div class="InnerLightboxHr"></div>\n                    </div>\n                    \n                    <iframe ng-show="selectedTab == \'wo\' && selectedSubTabWo == \'details\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'wo\')}" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-src="{{ urls.wo }}"></iframe>\n                    <iframe ng-show="selectedTab == \'wo\' && selectedSubTabWo == \'feed\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'wo\')}" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-src="{{ urls.wo_chatter }}"></iframe>\n                    \n                    <iframe ng-show="selectedTab == \'service\' && selectedSubTabService == \'details\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'service\')}"  ng-src="{{ urls.service }}"></iframe>\n                    <iframe ng-show="selectedTab == \'service\' && selectedSubTabService == \'feed\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'service\')}"  ng-src="{{ urls.service_chatter }}"></iframe>\n                    \n                    <iframe ng-show="selectedTab == \'relatedList\' && urls.related" ng-src="{{ urls.related }}"></iframe>  \n                    <iframe ng-show="selectedTab == \'account\' && urls.account" ng-src="{{ urls.account }}"></iframe>\n                    \n                    <iframe ng-if="urls.custom1" ng-show="selectedTab == \'customTab1\'" ng-src="{{ urls.custom1 }}"></iframe>\n                    <iframe ng-if="urls.custom2" ng-show="selectedTab == \'customTab2\'" ng-src="{{ urls.custom2 }}"></iframe>\n\n                    <section ng-if="isMapEnabled" id="serviceLightboxMap" ng-show ="selectedTab == \'map\'">\n                        <ui-gmap-google-map pan="false" control="mapControl" center="{latitude: 0 ,longitude: 0}" options="mapOptions" zoom="16" class="map-canvas">\n                            <ui-gmap-markers click="markerClicked" models="allMarkersArray" idKey="id" coords="\'coords\'" icon="\'icon\'">\n                            </ui-gmap-markers>\n\n                            <ui-gmap-window show="serviceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.service" >\n                                    <div class="googleMapInfoWindowService">\n                                        <img class="mapTooltipIcon" ng-src="{{serviceIcon}}"/>\n                                        <h1 class="truncate mapTooltipTitle">{{currentMarker.item | displayFieldSetField : serviceFields[0] }}</h1>\n\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[1] || serviceFields[1]">{{serviceFields[1].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[1])" ng-class="getServiceInfoRowClass(serviceFields[1])">{{currentMarker.item | displayFieldSetField : serviceFields[1]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[2] || serviceFields[2]">{{serviceFields[2].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[2])" ng-class="getServiceInfoRowClass(serviceFields[2])">{{currentMarker.item | displayFieldSetField : serviceFields[2]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[3] || serviceFields[3]">{{serviceFields[3].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[3])" ng-class="getServiceInfoRowClass(serviceFields[3])">{{currentMarker.item | displayFieldSetField : serviceFields[3]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[4] || serviceFields[4]">{{serviceFields[4].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[4])" ng-class="getServiceInfoRowClass(serviceFields[4])">{{currentMarker.item | displayFieldSetField : serviceFields[4]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[5] || serviceFields[5]">{{serviceFields[5].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[5])" ng-class="getServiceInfoRowClass(serviceFields[5])">{{currentMarker.item | displayFieldSetField : serviceFields[5]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[6] || serviceFields[6]">{{serviceFields[6].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[6])" ng-class="getServiceInfoRowClass(serviceFields[6])">{{currentMarker.item | displayFieldSetField : serviceFields[6]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[7] || serviceFields[7]">{{serviceFields[7].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[7])" ng-class="getServiceInfoRowClass(serviceFields[7])">{{currentMarker.item | displayFieldSetField : serviceFields[7]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[8] || serviceFields[8]">{{serviceFields[8].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[8])" ng-class="getServiceInfoRowClass(serviceFields[8])">{{currentMarker.item | displayFieldSetField : serviceFields[8]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[9] || serviceFields[9]">{{serviceFields[9].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[9])" ng-class="getServiceInfoRowClass(serviceFields[9])">{{currentMarker.item | displayFieldSetField : serviceFields[9]}}</span></div>\n\n                                    </div>\n                            </ui-gmap-window>\n\n                            <ui-gmap-window show="livePosInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.livePos">\n                                <div class="googleMapInfoWindowLivePos">\n                                    <svg aria-hidden="true" class="slds-icon livePosTooltipIcon">\n                                    \u2028	<use xlink:href="{{resourceIcon}}"></use>\n                                \u2028	</svg>\n                                    <h1 class="truncate mapTooltipTitle" ng-bind="$parent.$parent.$parent.currentMarker.item.resourceName"></h1>\n                                    <div>{{lastSeenLabel}} {{ currentMarker.item.lastModifiedDate | amDateFormat:\'lll\' }}</div>\n                                </div>\n                            </ui-gmap-window>\n                        </ui-gmap-google-map>\n                    </section>\n\n                </div>\n            </div>')}var T=null;return{open:g}}e.$inject=["$rootScope","TimePhasedDataService","$sce","$compile","utils","PARENT_RECORD_TYPE","StateService","$timeout","$interval","FieldSetFieldsService","LastKnownPositionService","ResourcesAndTerritoriesService","SERVICE_STATUS","SERVICE_CATEGORY"],angular.module("serviceExpert").factory("ServiceAppointmentLightboxService",e)}(),function(){function e(e,t,i,s,n,r,a){function o(t,i,s,n){var r=n&&n[i.selectedFilter]&&n[i.selectedFilter].old;return useNewFilters&&!r?e("servicesListFilterNew")(t,i,s):e("servicesListFilter")(t,i,s,n)}function c(){for(var e in h)h[e]=!1}function l(){S=o(i.serviceAppointments(),m,f,a.getFilterMap());for(var e=0;e<S.length;e++)h[S[e].id]=!0}function u(){c();var e=angular.copy(m);e.selectedFilter="Violating","Custom filter"==m.selectedFilter&&(e.endDate=m.advancedFilter.maxDate),S=o(i.serviceAppointments(),m,f,a.getFilterMap()),S=o(S,e,f,a.getFilterMap());for(var t=0;t<S.length;t++)h[S[t].id]=!0}function d(){c();var e=angular.copy(m);e.selectedFilter="inJeopardy","Custom filter"==m.selectedFilter&&(e.endDate=m.advancedFilter.maxDate),S=o(i.serviceAppointments(),m,f,a.getFilterMap()),S=o(S,e,f,a.getFilterMap());for(var t=0;t<S.length;t++)h[S[t].id]=!0}function v(){c();var e=angular.copy(m);e.selectedFilter="Unscheduled","Custom filter"==m.selectedFilter&&(e.endDate=m.advancedFilter.maxDate),S=o(i.serviceAppointments(),m,f,a.getFilterMap()),S=o(S,e,f,a.getFilterMap());for(var t=0;t<S.length;t++)h[S[t].id]=!0}function p(){var e=0;for(var t in h)h[t]&&e++;return e}function g(){var e=[];for(var t in h)h[t]&&e.push(t);return e}var h={},m=t.filter,f=[],S={};return r.register("services",function(e){e.deleted&&e.deleted.forEach(function(e){return delete h[e]})}),s.getServiceListFields().then(function(e){f=e}),{SelectedServices:h,unselectAll:c,selectAll:l,selectViolations:u,selectInJeopardy:d,selectUnscheduled:v,countSelectedServices:p,getSelected:g}}e.$inject=["$filter","servicesService","TimePhasedDataService","sfdcService","DeltaService","RegisterService","GanttFilterService"],angular.module("serviceExpert").factory("ServiceSelectorService",e)}(),function(){function e(e,t,i){function s(e,t){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=i.getResources()[e];Array.isArray(t)||(t=[t]);for(var a=0,o=t.length;o>a;a++){if(!r.skills[t[a]])return!1;if(s&&n&&!isIntersect(s,n,r.skills[t[a]].effectiveStartDate,r.skills[t[a]].effectiveEndDate))return!1}return!0}var n=[],r={skills:e.defer()};return t.getSkills().then(function(e){for(var t=0;t<e.length;t++)n.push(e[t]);r.skills.resolve(n)})["catch"](function(e){r.skills.reject(e),console.log(e),console.warn("unable to get skill list")}),{skills:n,doesHaveSkills:s,promises:{skills:function(){return r.skills.promise}}}}e.$inject=["$q","sfdcService","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("SkillsService",e)}(),function(){function e(e,t){function i(){return!0}function s(){return contractorSupport}function n(){return mapMode}function r(){return-1!=window.navigator.userAgent.indexOf("Mac OS X")}function a(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!0;S=e}function o(){return S}function c(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!0;b=e}function l(){return b}function u(e){T=e}function d(){return T}var v={},p={policies:e.defer()},g=userLocale?userLocale.split("_")[0]:"en",h=function(){return"undefined"!=typeof sforce?sforce.console.isInConsole():null},m=[],f=null,S=!1;t.getPolicies().then(function(e){m.push.apply(m,_toConsumableArray(e)),m.length>0?p.policies.resolve(m):p.policies.reject("no policies found")})["catch"](function(e){p.policies.reject(e)});var b=!1,y={},_=!1,T=!1;return{isOptimizationEnabled:isOptimizationEnabled,lang:g,isOSX:r,isInConsole:h,policies:m,selectedPolicyId:f,areContractorsSupported:s,isMapEnabled:n,setLightBoxStatus:c,isLightboxOpened:l,setBulkActionRunning:a,isBulkActionRunning:o,schedulingRunningFor:y,isScheduleRunning:_,ganttOpenedTerritories:v,areCrewsSupported:i,getStreamingActiveState:d,setStreamingActiveState:u,promises:{policies:function(){return p.policies.promise}}}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("StateService",e)}(),function(){function e(e,t,i,s,n,r,a){function o(e){if(L||(L=!0,setTimeout(function(){var e=c();u(),l(e)},0)),e.channel.indexOf("AbsencesTopic")>-1)try{return void("deleted"==e.data.event.type?k.add(e.data.sobject.Id):C.add(e.data.sobject.Id))}catch(t){console.log("Streaming API failure : "+t)}if(e.channel.indexOf("ServicesTopic")>-1)try{return void("deleted"==e.data.event.type?R.add(e.data.sobject):D.add(e.data.sobject.Id))}catch(t){console.log("Streaming API failure : "+t)}if(e.channel.indexOf("CapacitiesTopic")>-1)try{return void("deleted"==e.data.event.type?A.add(e.data.sobject):I.add(e.data.sobject.Id))}catch(t){console.log("Streaming API failure : "+t)}if(e.channel.indexOf("LivePositionsTopic")>-1)try{return void F.add(e.data.sobject.Id)}catch(t){console.log("Streaming API failure : "+t)}if(e.channel.indexOf("AssignedResourcesTopic")>-1)try{return void x.add(e.data.sobject.Id)}catch(t){console.log("Streaming API failure : "+t)}if(e.channel.indexOf("OptReqTopic")>-1)try{return void M.add(e.data.sobject.Id)}catch(t){console.log("Streaming API failure : "+t)}if(e.channel.indexOf("TimeDependencyTopic")>-1)try{return void("deleted"==e.data.event.type?O.add(e.data.sobject.Id):(D.add(e.data.sobject[fieldNames.TimeDependency.ServiceAppointment1]),D.add(e.data.sobject[fieldNames.TimeDependency.ServiceAppointment2])))}catch(t){console.log("Streaming API failure : "+t)}}function c(){var e={};return e.deletedAbsencesArray=Array.from(k),e.updatedAbsencesArray=Array.from(C),e.deletedGanttServicesArray=Array.from(R),e.updatedGanttServicesArray=Array.from(D),e.deletedCapacitiesArray=Array.from(A),e.updatedCapacitiesArray=Array.from(I),e.resourcesIdsArray=Array.from(F),e.updatedAssignResourceArray=Array.from(x),e.updatedOptimizationRequestArray=Array.from(M),e.deletedTimeDependencyArray=Array.from(O),e}function l(t){var i=[];0!=t.updatedOptimizationRequestArray.length&&i.push(v(t.updatedOptimizationRequestArray)),0!=t.updatedAssignResourceArray.length&&i.push(p(t.updatedAssignResourceArray)),0!=t.resourcesIdsArray.length&&i.push(m(t.resourcesIdsArray)),0!=t.updatedCapacitiesArray.length&&i.push(h(t.updatedCapacitiesArray)),(0!=t.updatedGanttServicesArray.length||0!=t.deletedTimeDependencyArray.length)&&i.push(S(t.updatedGanttServicesArray,t.deletedTimeDependencyArray)),0!=t.updatedAbsencesArray.length&&i.push(b(t.updatedAbsencesArray)),0!=t.deletedAbsencesArray.length&&i.push(y(t.deletedAbsencesArray)),0!=t.deletedGanttServicesArray.length&&f(t.deletedGanttServicesArray),0!=t.deletedCapacitiesArray.length&&g(t.deletedCapacitiesArray),0!=i.length&&e.all(i).then(function(e){e.forEach(function(e){d(e)})})}function u(){L=!1,k.clear(),C.clear(),R.clear(),D.clear(),A.clear(),I.clear(),F.clear(),x.clear(),M.clear(),O.clear()}function d(e){e&&e.length>0&&w.rules.forEach(function(t){return t(e)})}function v(i){var s=e.defer();return t.getOptimiztionRequestsUpdate(i).then(function(e){r.isOptimizationEnabled&&e&&e.length>0&&w.optimizationRequests.forEach(function(t){return t(e)}),s.resolve()}),s.promise}function p(i){var n=e.defer();return t.getGanttServiceOnAssignedResourceUpdate(i).then(function(e){var t=[];if(e&&e.length>0){var i={};e.length>0&&(i.updated=s.updateTimePhaseData(e,"service").services,t.push.apply(t,_toConsumableArray(a.getRelatedServices(a.getIdsOfSObjects(i.updated))))),i.updated&&w.services.forEach(function(e){return e(i)})}n.resolve(t)}),n.promise}function g(e){if(e&&e.length>0){var t={};t.deleted=s.deleteTimePhaseData(e,"capacity").capacities,t.deleted&&w.capacities.forEach(function(e){return e(t)})}}function h(i){var n=e.defer();return t.getUpdatedResourceCapacities(i).then(function(e){if(e&&e.length>0){var t={};t.updated=s.updateTimePhaseData(e,"capacity").capacities,t.updated&&w.capacities.forEach(function(e){return e(t)})}n.resolve()}),n.promise}function m(i){var s=e.defer();return t.getLivePositionsStreaming(i).then(function(e){var t=n.updatePositions(e);t.isUpdated&&w.positions.forEach(function(e){return e(t.dic)}),s.resolve()}),s.promise}function f(e){var t=[];if(e&&e.length>0){var i={};i.deleted=s.deleteTimePhaseData(e,"service").services,t.push.apply(t,_toConsumableArray(a.getRelatedServices(i.deleted))),i.deleted&&w.services.forEach(function(e){return e(i)}),t.length>0&&w.rules.forEach(function(e){return e(t)})}}function S(i,n){var r=e.defer();return t.getUpdatedServices(i,n).then(function(e){var t=[];if(e&&e.length>0){var i={};e.length>0&&(i.updated=s.updateTimePhaseData(e,"service").services,t.push.apply(t,_toConsumableArray(a.getRelatedServices(a.getIdsOfSObjects(i.updated))))),i.updated&&w.services.forEach(function(e){return e(i)})}r.resolve(t)}),r.promise}function b(i){var n=e.defer();return t.getUpdatedAbsences(i).then(function(e){var t=[],i={};if(e.length>0){i.updated=s.updateTimePhaseData(e,"na").absences;var r=i.updated.map(function(e){return e.resource}).join(",");t.push.apply(t,_toConsumableArray(a.getRelatedServices(a.getIdsOfSObjects(i.updated),r))),(i.updated||i.deleted)&&w.absences.forEach(function(e){return e(i)})}n.resolve(t)}),n.promise}function y(i){var n=e.defer();return t.getDeletedAbsences(i).then(function(e){var t=[],i={};e.length>0&&(i.deleted=s.deleteTimePhaseData(e,"na").absences,t.push.apply(t,_toConsumableArray(a.getRelatedServices(i.deleted))),(i.updated||i.deleted)&&w.absences.forEach(function(e){return e(i)})),n.resolve(t)}),n.promise}function _(e,t){return w[e]&&w[e].push(t)}function T(e,t){w[e].splice(w[e].indexOf(t),1)}var w={services:[],absences:[],capacities:[],positions:[],optimizationRequests:[],rules:[]},L=!1,k=new Set,C=new Set,R=new Set,D=new Set,A=new Set,I=new Set,F=new Set,x=new Set,M=new Set,O=new Set;return{HandleNotification:o,register:_,unRegister:T}}e.$inject=["$q","sfdcService","$interval","TimePhasedDataService","LastKnownPositionService","StateService","utils"],angular.module("serviceExpert").factory("StreamingAPIService",e)}(),function(){function e(e,t,i,s,n){function r(e){var t="/topic/"+e,i=new cometdReplayExtension;i.setChannel(t),i.setReplay(c),$.cometd.registerExtension(e,i),u.push(i)}function a(){$.cometd.addListener("/meta/handshake",function(e){if(e.successful){console.log("Handshake successful!");for(var i=0;i<l.length;i++)$.cometd.subscribe("/topic/"+l[i],t.HandleNotification,function(e){console.log(e),e.successful});s.setStreamingActiveState(!0)}else s.setStreamingActiveState(!1),n.getDelta(),console.warn("Handshake! error: "+e.error)}),$.cometd.addListener("/meta/connect",function(e){e.successful?s.setStreamingActiveState(!0):(console.warn("disconnected! error: "+e.error),console.log(e),s.setStreamingActiveState(!1),n.getDelta())});i.connectToPush()}function o(){try{if(1==s.getStreamingActiveState()){for(var e=0;e<l.length;e++)r(l[e]);a()}else i.connectToPush()}catch(t){console.log(t)}}var c=-1,l=["ServicesTopic","AbsencesTopic","AssignedResourcesTopic","LivePositionsTopic","CapacitiesTopic","OptReqTopic","TimeDependencyTopic"],u=[];return{initStreaming:o}}e.$inject=["$q","StreamingAPIService","MstResolver","StateService","DeltaService"],angular.module("serviceExpert").factory("StreamingClientResolverService",e)}(),function(){function e(e,t,i,s,n){function r(e){return A[s.formatDayToString(e)]}function a(e,t){var i=!1;for(var s in b[e]){var n=b[e][s];isIntersect(t,t,n.effectiveStartDate,n.effectiveEndDate)&&(i=!0)}return i}function o(r,a){var o=e.defer();r.setDate(r.getDate()-window.daysToLoadOnGanttInit),a.setDate(a.getDate()+window.daysToLoadOnGanttInit),(0!==r.getMinutes()||0!==r.getHours())&&(r.setHours(0),r.setMinutes(0)),(0!==a.getMinutes()||0!==a.getHours())&&(a.setHours(0),a.setMinutes(0),a.setDate(a.getDate()+1));for(var l=!1,u=new Date(r);a>u;u.setDate(u.getDate()+1))if("undefined"==typeof A[s.formatDayToString(u)]){l=!0;break}return l?(i.GetTimePhasedObjects(r,a).then(function(e){for(var i=n.get("monthlyViewHelperService"),l={resourcesAndTerritories:{},resourcesByPrimariesAndRelocations:{},resourceOperatingHours:{},serviceAppointments:{},resourceAbsences:{},resourceCapacities:{},serviceCrewMembers:{},start:r,finish:a},u=new Date(r);a>u;u.setDate(u.getDate()+1))A[s.formatDayToString(u)]=!0;0===S.initialPhasedData.promise.$$state.status&&S.initialPhasedData.resolve(),e.resourcesAndTerritories.forEach(function(e){var t=new ResourcesAndTerritories(e);b[t.serviceResource]=b[t.serviceResource]||{},b[t.serviceResource][t.id]=t,l.resourcesAndTerritories[t.serviceResource]=l.resourcesAndTerritories[t.serviceResource]||{},l.resourcesAndTerritories[t.serviceResource][t.id]=t,"S"!==t.serviceTerritoryType&&(y[t.serviceResource]=y[t.serviceResource]||{},y[t.serviceResource][t.id]=t,l.resourcesByPrimariesAndRelocations[t.serviceResource]=l.resourcesByPrimariesAndRelocations[t.serviceResource]||{},l.resourcesByPrimariesAndRelocations[t.serviceResource][t.id]=t)}),e.services.forEach(function(e){var t=new GanttService(e);(!_[t.id]||_[t.id].isChanged(t)||_[t.id].isChainChanged(t))&&(_[e.Id]=t,l.serviceAppointments[e.Id]=t,(monthlyViewSettings.isMonthlyAvailable&&!scheduler._events[t.id]||scheduler._events[e.Id])&&i.updateMonthlyCapacity(t));
}),e.resourceAbsences.forEach(function(e){T[e.Id]&&e.LastModifiedDate===T[e.Id].lastModifiedDate||(T[e.Id]=new ResourceAbsence(e),l.resourceAbsences[e.Id]=T[e.Id],i.updateMonthlyCapacity(T[e.Id]))}),e.resourceCapacities.forEach(function(e){w[e.Id]&&e.LastModifiedDate===w[e.Id].lastModifiedDate||(w[e.Id]=new ResourceCapacity(e),useLocationTimezone||c(w[e.Id]),l.resourceCapacities[e.Id]=w[e.Id])}),e.serviceCrewMembers.forEach(function(e){L[e.Id]=new ServiceCrewMember(e),k[L[e.Id].serviceResource]||(k[L[e.Id].serviceResource]={}),C[L[e.Id].serviceCrew]||(C[L[e.Id].serviceCrew]={}),C[L[e.Id].serviceCrew][e.Id]=L[e.Id],k[L[e.Id].serviceResource][e.Id]=L[e.Id],l.serviceCrewMembers[e.Id]=L[e.Id]}),t.$broadcast("gotNewTimePhasedObjects",l),o.resolve()})["catch"](function(e){0===S.initialPhasedData.promise.$$state.status&&S.initialPhasedData.reject(e),o.reject(e),console.warn("GetTimePhasedObjects: something went wrong "+e.message),s.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}),o.promise):(o.resolve(),o.promise)}function c(e){var t=s.getUserOffset(e.start_date),i=s.getUserOffset(e.end_date),n=g(e,e.resource);e.start_date=e.start_date.setMinutes(e.start_date.getMinutes()+t-n),e.end_date=e.end_date.setMinutes(e.end_date.getMinutes()+i-n)}function l(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1,s=n.get("monthlyViewHelperService"),r={absences:[],services:[],capacities:[]};return Array.isArray(e)||(e=[e]),e.forEach(function(e){if("na"===t){if(i||T[e.Id]&&e.LastModifiedDate===T[e.Id].lastModifiedDate)return;T[e.Id]=new ResourceAbsence(e),r.absences.push(T[e.Id]),s.updateMonthlyCapacity(T[e.Id])}if("service"===t){var n=new GanttService(e);(i||!_[n.id]||_[n.id].isChanged(n)||_[n.id].isChainChanged(n))&&(_[e.Id]=n,r.services.push(n),scheduler._events[n.id]&&scheduler._events[n.id].violations&&n.isScheduled()&&(n.violations=scheduler._events[n.id].violations),(monthlyViewSettings.isMonthlyAvailable&&!scheduler._events[n.id]||scheduler._events[e.Id])&&s.updateMonthlyCapacity(n))}if("capacity"===t){if(w[e.Id]&&e.LastModifiedDate===w[e.Id].lastModifiedDate)return;w[e.Id]=new ResourceCapacity(e),useLocationTimezone||c(w[e.Id]),r.capacities.push(w[e.Id])}if("stm"===t){var a=new ResourcesAndTerritories(e);b[a.serviceResource]=b[a.serviceResource]||{},b[a.serviceResource][a.id]=a,"S"!==a.serviceTerritoryType&&(y[a.serviceResource]=y[a.serviceResource]||{},y[a.serviceResource][a.id]=a)}}),r}function u(e,t){var i=n.get("monthlyViewHelperService"),s={absences:[],services:[],capacities:[]};return Array.isArray(e)||(e=[e]),e.forEach(function(e){"na"===t?(T[e.Id]&&(T[e.Id].isDeleted=!0),T[e.Id]&&i.updateMonthlyCapacity(T[e.Id]),delete T[e.Id],s.absences.push(e.Id)):"service"===t?(_[e.Id]&&(_[e.Id].isDeleted=!0),i.updateMonthlyCapacity(_[e.Id]),delete _[e.Id],s.services.push(e.Id)):"capacity"===t&&(delete w[e.Id],s.capacities.push(e.Id))}),s}function d(){b={},y={},_={},T={},w={},L={},R={},k={},C={},A={}}function v(e,t){for(var i in b[e]){var n=b[e][i];if(n.effectiveStartDate<=t&&t<=n.effectiveEndDate&&"R"===n.serviceTerritoryType)return s.generateResourceId(e,n.serviceTerritory)}var r=[];for(var a in b[e]){var o=b[e][a];if(!showSecondarySTMs&&o.effectiveStartDate<=t&&t<=o.effectiveEndDate&&"P"===o.serviceTerritoryType)return s.generateResourceId(e,o.serviceTerritory);o.effectiveStartDate<=t&&t<=o.effectiveEndDate&&r.push(o.serviceTerritory)}return r.length>0?s.generateResourceId(e,r):null}function p(e,t,i){for(var n in b[e]){var r=b[e][n];if(r.effectiveStartDate<=t&&t<=r.effectiveEndDate&&"R"===r.serviceTerritoryType)return s.generateResourceId(e,r.serviceTerritory)}var a=null,o=null;for(var c in b[e]){var l=b[e][c];l.effectiveStartDate<=t&&t<=l.effectiveEndDate&&"P"===l.serviceTerritoryType&&(o=l.serviceTerritory),l.effectiveStartDate<=t&&t<=l.effectiveEndDate&&l.serviceTerritory===i&&(a=l.serviceTerritory)}return a?s.generateResourceId(e,a):s.generateResourceId(e,o)}function g(e,t){var i=b[t],n=null;for(var r in i){var a=i[r];if(isIntersect(a.effectiveStartDate,a.effectiveEndDate,e.start_date,e.end_date)&&(n=a,"R"===a.serviceTerritoryType))break}var o=n&&n.timezone?n.timezone:"GMT";return-moment.tz.zone(o).offset(s.convertDtToMomentDt(e.start_date,o).valueOf())}function h(e,t){var i=e.split("_")[0],s=e.split("_")[1],n=b[i]||{};for(var r in n){var a=n[r];if(a.serviceTerritory!==s&&"R"===a.serviceTerritoryType&&isIntersect(a.effectiveStartDate,a.effectiveEndDate,t,t))return!0}return!1}function m(e,t){var i=e.split("_")[0],s=e.split("_")[1],n=b[i]||{};for(var r in n){var a=n[r];if(a.serviceTerritory===s&&"S"===a.serviceTerritoryType&&isIntersect(a.effectiveStartDate,a.effectiveEndDate,t,t))return!0}return!1}function f(e,t){var i=e.split("_")[0],s=(e.split("_")[1],k[i]||{});for(var n in s){var r=s[n];if(isIntersect(r.startDate,r.endDate,t,t))return!0}return!1}var S={initialPhasedData:e.defer()},b={},y={},_={},T={},w={},L={},k={},C={},R={},D=!1,A={};return{resourcesAndTerritories:function(){return b},resourcesByPrimariesAndRelocations:function(){return y},serviceAppointments:function(){return _},resourceAbsences:function(){return T},resourceCapacities:function(){return w},resourceToServiceCrewMembers:function(){return k},crewToServiceCrewMembers:function(){return C},serviceCrewMembers:function(){return L},visitedDates:function(){return A},getTimePhasedObjects:o,updateTimePhaseData:l,deleteTimePhaseData:u,reset:d,getResoruceGanttIdByDate:v,getResoruceGanttIdByDateAndTerritory:p,getIntersectingSrstOffset:g,didVisitDay:r,isTimephaseAvailable:a,isResourceRelocated:h,isResourceSecondary:m,isResourceCrewMembers:f,isCrewViewActive:D,currentCrewToShow:R,promises:{initialPhasedData:S.initialPhasedData.promise}}}e.$inject=["$q","$rootScope","sfdcService","utils","$injector"],angular.module("serviceExpert").factory("TimePhasedDataService",e)}(),function(){function e(e,t,i){function s(){for(var e in r)r[e]=0}function n(){var n=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),a=0;s();for(var o=i.GetUserSettingsProperty("locations"),c=0;c<n.length;c++){var l=n[c],u=!0;if(showSecondarySTMs&&n[c].resourceId.indexOf(",")>-1){for(var d=n[c].resourceId.split(","),v=null,p=0;p<d.length;p++){var g=d[p].split("_")[1];if(o.indexOf(g)>-1){v=g;break}}if(!v)continue}else if(-1===o.indexOf(n[c].resourceId.split("_")[1]))continue;if("na"===l.type&&(r.avgTravelTime+=l.travelTo+l.travelFrom),"service"===l.type){if(e.areContractorsSupported()&&l.resourceContractor?u=!1:a++,r.total++,l.statusCategory===t.COMPLETED&&r.completed++,l.violations&&r.violations++,l.jeopardy&&r.jeopardy++,u)if(l.isMDT){var h=0;l.mdtTimes.travel.forEach(function(e){scheduler._min_date<=e.Start&&e.Finish<=scheduler._max_date&&(h+=e.Finish-e.Start)}),r.avgTravelTime+=h/1e3}else r.avgTravelTime+=l.travelTo+l.travelFrom;if(l.isMDT){var m=0;l.mdtTimes.working.forEach(function(e){scheduler._min_date<=e.Start&&e.Finish<=scheduler._max_date&&(m+=e.Finish-e.Start)}),r.totalScheduledDuration+=m/1e3}else r.totalScheduledDuration+=(l.finish-l.start)/1e3}}n.length>0&&r.total>0&&a>0?e.areContractorsSupported()?r.avgTravelTime=Math.floor(r.avgTravelTime/60/a):r.avgTravelTime=Math.floor(r.avgTravelTime/60/r.total):r.avgTravelTime=0}var r={total:0,completed:0,violations:0,jeopardy:0,avgTravelTime:0,totalScheduledDuration:0};return{calculateKpis:n,kpis:r}}e.$inject=["StateService","SERVICE_CATEGORY","userSettingsManager"],angular.module("serviceExpert").factory("kpiCalculationsService",e)}(),function(){function e(e,t,i,s,n,r,a){function o(e){e.setGanttResource(n.resourcesAndTerritories(),r.generateResourceId);var t=scheduler._events[e.id],i=null;if((e.resourceId||t)&&(!e.isMDT||e.mdtTimes)){if(t){var s=c(t.eventBeforeDrag||t);t.eventBeforeDrag&&(t.eventBeforeDrag=null),"service"===e.type||"na"===e.type?(i=t.resourceName===e.resourceName?e.resourceId:t.resourceBeforeDrag||t.resourceId,t.resourceBeforeDrag=null):"break"===e.type&&(i=t.resourceId),v(t.id,i,s.travelBeforeSum,"travel",!1),v(t.id,i,s.scheduledObjectSum,t.type,!1),v(t.id,i,s.travelAfterSum,"travel",!1)}if(!e.resourceId||e.isDeleted||e.locationRemovedMe)return void(e.locationRemovedMe&&(e.locationRemovedMe=!1));var a=c(e);v(e.id,e.resourceId,a.travelBeforeSum,"travel"),v(e.id,e.resourceId,a.scheduledObjectSum,e.type),v(e.id,e.resourceId,a.travelAfterSum,"travel")}}function c(e){if(e.resourceId.indexOf(",")>-1)for(var t=e.resourceId.split(","),i=0;i<t.length;i++)L[t[i]]=L[t[i]]||{};else L[e.resourceId]=L[e.resourceId]||{};var s={start:new Date(e.start_date),finish:new Date(e.start)},n={start:new Date(e.start),finish:new Date(e.finish)},r={start:new Date(e.finish),finish:new Date(e.end_date)};return{travelBeforeSum:e.isMDT?l(e.mdtTimes.travel):l(s.start,s.finish),scheduledObjectSum:e.isMDT?l(e.mdtTimes.working):l(n.start,n.finish),travelAfterSum:l(r.start,r.finish)}}function l(e,t){var i={};if(!t)return e.forEach(function(e){t=new Date(e.Finish);for(var s=new Date(e.Start);t>s;s=d(s)){var n=d(s);n=n>t?t:n,i[u(s)]?i[u(s)]+=Math.round((n.getTime()-s.getTime())/1e3/60):i[u(s)]=Math.round((n.getTime()-s.getTime())/1e3/60)}}),i;for(var s=new Date(e);t>s;s=d(s)){var n=d(s);n=n>t?t:n,i[u(s)]=Math.round((n.getTime()-s.getTime())/1e3/60)}return i}function u(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function d(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate()+1,0,0,0,0)}function v(e,t,i,s){for(var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:!0,r=t.split(","),a=0;a<r.length;a++){t=r[a];for(var o in i)if(L[t]=L[t]||{},void 0===L[t][o]&&(L[t][o]=new p),n)L[t][o][s]+=i[o],-1===L[t][o].events.indexOf(e)&&L[t][o].events.push(e);else{L[t][o][s]-=i[o];var c=L[t][o].events.indexOf(e);c>-1&&L[t][o].events.splice(c,1)}}}function p(){this["break"]=0,this.na=0,this.service=0,this.travel=0,this.capacity=-1,this.overtime=0,this.events=[]}function g(t,i){var s=new p,r=u(i);s.capacity=0;for(var a=0;a<t.length;a++){var o=null,c=t[a].key;if(!(contractorSupport&&t[a].contractor||n.isResourceRelocated(c,i)||n.isResourceCrewMembers(c,i)||n.isResourceSecondary(c,i))){L[c]||(L[c]={}),L[c][r]&&(o=L[c][r]),o||(L[c][r]=new p,o=L[c][r]),-1===o.capacity;var l=w;e.resourceToWorkingDates[c]&&e.resourceToWorkingDates[c][r]&&(l=e.resourceToWorkingDates[c][r]),o&&(s["break"]+=o["break"],s.na+=o.na>l.regular?l.regular:o.na,s.service+=o.service,s.travel+=o.travel,s.capacity+=l.regular>-1?l.regular:0,s.overtime+=l.overtime)}}return s}function h(e){var t=0;C.services&&(t+=e.service),C.breaks&&(t+=e["break"]),C.na&&(t+=e.na),C.travel&&(t+=e.travel);var i=C.overtime?e.capacity+e.overtime:e.capacity;if(i>0){var s=t/i;return s=Math.round(100*s)}return null}function m(e,t,i,s){var n=0;C.services&&(n+=e.service),C.breaks&&(n+=e["break"]),C.na&&(n+=e.na),C.travel&&(n+=e.travel);var r=C.overtime?e.capacity+e.overtime:e.capacity;if(r>0){var a=n/r;a=Math.round(100*a);var o="";o=a<=monthlyViewSettings.high?"style='box-shadow: inset 0 -2px 0 rgb(24, 165, 146)'":a>monthlyViewSettings.high&&a<=monthlyViewSettings.critical?"style='box-shadow: inset 0 -2px 0 #FFEB3B'":"style='box-shadow: inset 0 -2px 0 rgb(236, 95, 84)'";var c="";return e.travel/r>monthlyViewSettings.highTravel/100&&(c='<svg aria-hidden="true" class="tooMuchTravel slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>'),"<div "+o+' onmouseout="removeMonthlyLocationTooltip()" onmouseover="createLocationMonthlyTooltip(event,\''+t+"', '"+i+"', '"+s+"')\">"+c+'<div class="monthlyViewHoursContainer">'+a+"%</div></div>"}return""}function f(e){var t=Math.floor(e/60),i=e%60;return 10>i&&(i="0"+i),{hours:t,minutes:i}}function S(e){return e.hours+"h "+e.minutes+"m"}function b(e){return customLabels.Start+": "+moment(e.start).format("llll")+"\n"+(customLabels.Finish+": "+moment(e.finish).format("llll"))}function y(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:w;if(e.service){var s=f(e.service);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.clock+'"></use></svg>\n                        '+S(s)+"\n                        <div>"+customLabels.TotalScheduled+"</div>\n                    </div>"}if(e.travel){var n=f(e.travel);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_travel_icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>\n                        '+S(n)+"\n                        <div>"+customLabels.TotalTravel+"</div>\n                    </div>"}if(e.na){var r=f(e.na);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.na+'"></use></svg>\n                        '+S(r)+"\n                        <div>"+customLabels.TotalNAs+"</div>\n                    </div>"}if(e["break"]){var a=f(e["break"]);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_travel_icon"><use xlink:href="'+lsdIcons.coffee+'"></use></svg>\n                        '+S(a)+"\n                        <div>"+customLabels.TotalBreaks+"</div>\n                    </div>"}e.capacity,e.overtime;if(i.regular){var o=f(i.regular);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.bucket+'"></use></svg>\n                        '+S(o)+"\n                        <div>"+customLabels.TotalCapacity+"</div>\n                    </div>"}if(i.overtime){var c=f(i.overtime);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_overtime_icon"><use xlink:href="'+lsdIcons.overtime+'"></use></svg>\n                        '+S(c)+"\n                        <div>"+customLabels.TotalOvertime+"</div>\n                    </div>"}return t}function T(){L={},k={}}var w={regular:0,overtime:0},L={},k={},C={services:!0,na:!0,travel:!0,breaks:!0,overtime:!0};return scheduler.attachEvent("onSchedulerReady",function(){scheduler.attachEvent("onXScaleClick",function(e,t,i){"MonthlyView"===scheduler._mode&&scheduler.setCurrentView(t,"ZoomLevel3")}),scheduler.templates.MonthlyView_scalex_class=function(e){return"monthlyXScale"},scheduler.templates.MonthlyView_cell_value=function(t,i){var s=i.key;i.name;if(!contractorSupport||!i.contractor){if(i.children){var n=g(i.children,t);return k[i.key]||(k[i.key]={}),k[i.key][u(t)]=n,m(n,i.key,i.name,u(t))}if(L[s]&&L[i.key][u(t)]){var r=0,a=L[s][u(t)],o=w;if(e.resourceToWorkingDates[s]&&(o=e.resourceToWorkingDates[s][u(t)]||w),C.services&&(r+=a.service),C.breaks&&(r+=a["break"]),C.na){var c=a.na;a.na>o.regular&&(c=o.regular),r+=c}if(C.travel&&(r+=a.travel),0===r)return;var l=void 0,d=void 0,v=C.overtime?o.regular+o.overtime:o.regular;if(v>0){d=r/v,d=Math.round(100*d);var p="";return a.travel/v>monthlyViewSettings.highTravel/100&&(p='<svg aria-hidden="true" class="tooMuchTravel slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>'),l="",l=d<=monthlyViewSettings.high?"rgba(125, 195, 125, "+d/100+")":d>monthlyViewSettings.high&&d<=monthlyViewSettings.critical?"rgba(242, 207, 91, "+(.11+d/100*.65)+")":"rgba(239, 110, 100, "+(.11+d/100*.65)+")","<div onclick=\"createMonthlyTooltip(event, '"+s+"', '"+u(t)+'\')" style="background: '+l+'">'+p+'<div class="monthlyViewHoursContainer">'+d+"%</div></div>"}return l="rgba(239, 110, 100, 1)","<div onclick=\"createMonthlyTooltip(event, '"+s+"', '"+u(t)+'\')" style="background: '+l+'"><div class="monthlyViewHoursContainer"><i class="fa fa-ban" /></div></div>'}}}}),window.createLocationMonthlyTooltip=function(e,t,i,s){$("#MonthlyLocationViewTooltip").remove(),$("#MonthlyViewTooltip").remove();var n=k[t][s],r="";r=y(n,r,{regular:n.capacity,overtime:n.overtime});var a=s.split("_");a=new Date(a[2],a[1],a[0],0,0,0,0),a=moment(a).format("ll");var o=window.innerHeight,c=window.innerWidth,l=e.clientX+340<=c?e.clientX:e.clientX-340;$('<div id="MonthlyLocationViewTooltip">\n                    <h1>'+_.escape(i)+" - "+_.escape(a)+'</h1>\n                    <div id="CapacityIconsContainer">'+r+"</div>\n               </div>").css("left",l+"px").css("top",e.clientY+5+"px").appendTo("body");var u=$("#MonthlyViewTooltip"),d=u.height();d+e.clientY>o&&u.css("top",e.clientY-d-20+"px")},window.removeMonthlyLocationTooltip=function(){$("#MonthlyLocationViewTooltip").remove()},window.createMonthlyTooltip=function(t,i,s){t.stopPropagation(),$("#MonthlyViewTooltip").remove(),$("#MonthlyLocationViewTooltip").remove();var n=a.getResources()[i.split("_")[0]].name,r=L[i][s],o="",c=w;e.resourceToWorkingDates[i]&&e.resourceToWorkingDates[i][s]&&(c=e.resourceToWorkingDates[i][s]),o=y(r,o,c);var l=r.events.sort(function(e,t){return scheduler._events[e].start_date.getTime()>scheduler._events[t].start_date.getTime()?-1:scheduler._events[e].start_date.getTime()<scheduler._events[t].start_date.getTime()?1:0}).map(function(e){var t="",i="";if(scheduler._events[e]&&"service"===scheduler._events[e].type){var s=flaggedServices[e]?customLabels.Unflag:customLabels.Flag;t="__monthlyViewFunctions.service('"+e+"')",i="<div onclick=\"__monthlyViewFunctions.flag(event, '"+e+'\')" class="monthlyViewFlag">'+s+"</div>"}else t="__monthlyViewFunctions.absence('"+e+"')";var n=" ";n+=scheduler._events[e]&&scheduler._events[e].jeopardy?"monthlyView_JeopardyTooltip":"",n+=scheduler._events[e]&&scheduler._events[e].violations&&!scheduler._events[e].jeopardy?"monthlyView_ViolationsTooltip":"";var r="";scheduler._events[e]&&"break"!==scheduler._events[e].type&&(r=Math.floor((scheduler._events[e].travelTo+scheduler._events[e].travelFrom)/60),r=""+S(f(r)),r='<svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg> '+r);var a=Math.floor((scheduler._events[e].finish-scheduler._events[e].start)/1e3/60);a=""+S(f(a)),a='<svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.clock+'"></use></svg> '+a;var o=""===r?"mytooltip_breakfix":"";return'\n                        <div class="'+n+' monthlyView_TooltipEventRow" title="'+b(scheduler._events[e])+'">\n                            <div class="monthlyView_EventName" onclick="'+t+'">'+scheduler._events[e].name+'</div>\n                            <div class="monthlyView_EventDate"><span class="mytooltip_duration '+o+'">'+a+'</span><span class="mytooltip_travel">'+r+"</span>"+i+"</div>\n                        </div>"}),u=s.split("_");u=new Date(u[2],u[1],u[0],0,0,0,0),u=moment(u).format("ll");var d=window.innerHeight,v=window.innerWidth,p=t.clientX+340<=v?t.clientX:t.clientX-340;$('<div id="MonthlyViewTooltip">\n                    <h1>\n                        '+_.escape(n)+" - "+u+'\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.close+'"></use></svg>\n                    </h1>\n                    <div id="CapacityIconsContainer">'+o+'</div>\n                    <div id="MonthlyTooltipListContainer">'+l.join("")+"</div>\n               </div>").css("left",p+"px").css("top",t.clientY+5+"px").appendTo("body");var g=$("#MonthlyViewTooltip"),h=g.height();h+t.clientY>d&&g.css("top",t.clientY-h-20+"px")},$("body").on("click",function(){$("#MonthlyViewTooltip").remove()}),window.__monthlyViewFunctions={service:function(e){s.open(e)},absence:function(e){i.open(e)},flag:function(e,i){e.currentTarget.innerHTML=e.currentTarget.innerHTML===customLabels.Flag?customLabels.Unflag:customLabels.Flag,e.stopPropagation(),t.$broadcast("flagService",i),t.$apply()}},{updateMonthlyCapacity:o,capacityCalculationFields:C,workingTimesByLocation:k,calculateLocation:g,calculateLocationUtilization:h,reset:T}}e.$inject=["calendarsService","$rootScope","AbsenceLightboxService","ServiceAppointmentLightboxService","TimePhasedDataService","utils","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("monthlyViewHelperService",e)}(),function(){function e(){var e={fslOperationRemoteAction:null,apiVersion:"41.0",fieldNames:{Initiator:"Initiator__c",Request_Type:"Request_Type__c",ResultText:"ResultText__c"},autoConnect:!0};this.setConfig=function(t){return e=t},this.$get=function(i){return t(i,e)},this.$get.$inject=["$q"]}function t(e,t){function i(){$.cometd.addListener("/meta/handshake",function(e){e.successful?(console.log("Handshake successful!"),$.cometd.subscribe("/topic/MstCompletedChannel",s)):console.warn("Handshake! error: "+e.error)}),$.cometd.addListener("/meta/connect",function(e){e.successful||console.warn("disconnected! error: "+e.error)});$.cometd.init({url:window.location.protocol+"//"+window.location.hostname+(null!=window.location.port?":"+window.location.port:"")+"/cometd/"+t.apiVersion+"/",requestHeaders:{Authorization:"OAuth "+sessionId},maxBackoff:5e3,logLevel:"debug"})}function s(e){if("deleted"!==e.data.event.type){console.info("message from stream, type: "+e.data.event.type+", replayId: "+e.data.event.replayId+", fslOp: "+e.data.sobject.Id),l=e.data.event.replayId,c[e.data.sobject.Id]=e;var t=o[e.data.sobject.Id];t&&t.deferred.resolve(e)}}function n(e){var t=e.ResourceIDToScheduleData;for(var i in t)t[i].SchedulingOptions.forEach(function(e){e.Interval.Start=moment(e.Interval.Start).valueOf(),e.Interval.Finish=moment(e.Interval.Finish).valueOf();for(var t in e.MSTOptions)e.MSTOptions[t].Interval.Start=moment(e.MSTOptions[t].Interval.Start).valueOf(),e.MSTOptions[t].Interval.Finish=moment(e.MSTOptions[t].Interval.Finish).valueOf()})}function r(e){e.forEach(function(e){e.Interval.Start=moment(e.Interval.Start).valueOf(),e.Interval.Finish=moment(e.Interval.Finish).valueOf()})}function a(i){o[i]={time:(new Date).getTime(),deferred:e.defer(),mstPromise:e.defer()};var s=o[i];return o[i].deferred.promise.then(function(e){t.fslOperationRemoteAction&&Visualforce.remoting.Manager.invokeAction(t.fslOperationRemoteAction,s.time,e.data.sobject.Id,function(e,i){i.status&&!e.fslOperation.fslOperation[t.fieldNames.ResultText]?(e.fslOperation.result=JSON.parse(e.fslOperation.result),"Get Candidates"===e.fslOperation.fslOperation[t.fieldNames.Request_Type]&&n(e.fslOperation.result),"Appointment Booking"===e.fslOperation.fslOperation[t.fieldNames.Request_Type]&&r(e.fslOperation.result.Slots),s.mstPromise.resolve(e)):s.mstPromise.reject(e.fslOperation.fslOperation[t.fieldNames.ResultText])},{buffer:!1,escape:!1,timeout:12e4})}),c[i]&&(s.deferred.resolve(c[i]),delete c[i]),o[i].mstPromise.promise}var o={},c={},l=-1,u=new cometdReplayExtension;return u.setChannel("/topic/MstCompletedChannel"),u.setReplay(l),$.cometd.registerExtension("myReplayExtensionName",u),function(){try{t.autoConnect&&i()}catch(e){console.log(e)}}(),{getUpdates:a,connectToPush:i,handleCometdConnection:s}}angular.module("MstResolver",[]).provider("MstResolver",e)}(),GanttService.prototype.setSchedulerProperties=function(){var e=void 0,t=void 0,i=void 0,s=void 0,n=void 0,r=void 0,a=void 0,o=void 0;this.schedStartTime&&(e=60*new Date(this.schedStartTime).getTimezoneOffset()*1e3),this.schedEndTime&&(t=60*new Date(this.schedEndTime).getTimezoneOffset()*1e3),this.dueDate&&(r=60*new Date(this.dueDate).getTimezoneOffset()*1e3),this.earliestStartTime&&(n=60*new Date(this.earliestStartTime).getTimezoneOffset()*1e3),this.arrivalWindowStartTime&&(a=60*new Date(this.arrivalWindowStartTime).getTimezoneOffset()*1e3),this.arrivalWindowEndTime&&(o=60*new Date(this.arrivalWindowEndTime).getTimezoneOffset()*1e3),this.actualStartTime&&(i=60*new Date(this.actualStartTime).getTimezoneOffset()*1e3),this.actualEndTime&&(s=60*new Date(this.actualEndTime).getTimezoneOffset()*1e3),this.text=this.ganttLabel?this.ganttLabel:this.name,this.start=this.schedStartTime?new Date(this.schedStartTime+e):null,this.finish=this.schedEndTime?new Date(this.schedEndTime+t):null,this.dueDate=this.dueDate?new Date(this.dueDate+r):null,this.earlyStart=this.earliestStartTime?new Date(this.earliestStartTime+n):null,this.appStart=this.arrivalWindowStartTime?new Date(this.arrivalWindowStartTime+a):null,this.appEnd=this.arrivalWindowEndTime?new Date(this.arrivalWindowEndTime+o):null,this.actualStartTime=this.actualStartTime?new Date(this.actualStartTime+i):null,this.actualEndTime=this.actualEndTime?new Date(this.actualEndTime+s):null,this.type="service",this.travelTo=this.travelTimeTo?60*parseInt(this.travelTimeTo):0,this.travelFrom=this.travelTimeFrom?60*parseInt(this.travelTimeFrom):0,this.estDuration=this.estDuration?parseFloat(this.estDuration):null},GanttService.prototype.setGanttResource=function(e,t){if(this.isScheduled()){var i=e[this.resource],s=[],n=void 0,r=void 0;this.resourceId=null,this.schedStartTime&&(n=60*new Date(this.schedStartTime).getTimezoneOffset()*1e3),this.schedEndTime&&(r=60*new Date(this.schedEndTime).getTimezoneOffset()*1e3),this.start_date=this.schedStartTime?new Date(this.schedStartTime+n):null,this.end_date=this.schedEndTime?new Date(this.schedEndTime+r):null;for(var a in i){var o=i[a];"R"===o.serviceTerritoryType&&(isIntersect(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.end_date)||!o.effectiveEndDate&&o.effectiveStartDate<this.end_date)&&s.push(o.serviceTerritory)}if(0===s.length)for(var c in i){var l=i[c];isIntersect(l.effectiveStartDate,l.effectiveEndDate,this.start_date,this.start_date)&&s.push(l.serviceTerritory)}else if(showSecondarySTMs)for(var u in i){var d=i[u];"S"===d.serviceTerritoryType&&isIntersect(d.effectiveStartDate,d.effectiveEndDate,this.start_date,this.end_date)&&s.push(d.serviceTerritory)}this.resourceId=t(this.resource,s),this.isScheduled()&&this.updateDatesBasedOnTravel()}},GanttService.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds?this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60)):(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds,this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60)))),this.travelTo&&(this.travelTo<=maxTravelTimeInSeconds?this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)):(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds,this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)))))},GanttService.prototype.isScheduled=function(){return this.resource&&this.schedEndTime&&this.schedStartTime},GanttService.prototype.getGanttResource=function(e){return e&&getGanttResourceWithSecondaryStms(this),this.resourceId?this.resourceId.substr(0,18):this.resourceId},GanttService.prototype.getGanttTerritory=function(){return this.resourceId?this.resourceId.substr(19,37):this.resourceId},GanttService.prototype.isChanged=function(e){return this.AssignedResourceLastModifiedDate!=e.AssignedResourceLastModifiedDate||this.ServiceAppointmentLastModifiedDate!=e.ServiceAppointmentLastModifiedDate},GanttService.prototype.isChainChanged=function(e){return this.isServiceInChain!=e.isServiceInChain||this.relatedService1!=e.relatedService1||this.relatedService2!=e.relatedService2},GanttService.prototype.minPriority=1e6,GanttService.copy=function(e){var t=new GanttService(null,!0);return angular.merge(t,e),t},GanttService.prototype.calculateMdtTimes=function(e){try{this.mdtTimes=JSON.parse(e);var t=1e3*(new Date).getTimezoneOffset()*60,i={travel:[],working:[]};this.mdtTimes.forEach(function(e){var s=moment.tz(e.Start,userTimeZone),n=moment.tz(e.Finish,userTimeZone);s=new Date(s.valueOf()-60*s._offset*1e3+t),n=new Date(n.valueOf()-60*n._offset*1e3+t),e.Start=s,e.Finish=n,"OperationalSlot"===e.Type?i.working.push(e):"Travel"===e.Type&&i.travel.push(e)}),this.mdtTimes=i}catch(s){this.mdtTimes={travel:[],working:[]}}},function(e){var t={Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6};e.TimeSlot=function(e){this.startHour=Math.floor(e[fieldNames.TimeSlot.StartTime]/1e3/60/60),this.startMinute=Math.ceil(e[fieldNames.TimeSlot.StartTime]/1e3/60/60%1*60),this.endHour=Math.floor(e[fieldNames.TimeSlot.EndTime]/1e3/60/60),this.endMinute=Math.ceil(e[fieldNames.TimeSlot.EndTime]/1e3/60/60%1*60),this.type=e[fieldNames.TimeSlot.Type],0==this.endHour&&(this.endHour=24)},e.OperatingHours=function(e){this.id=e.Id,this.name=e.Name,this.timezone=e[fieldNames.OperatingHours.Timezone],this.slots={};var i=e[fieldNames.OperatingHours.Time_Slots__r];i||(i=[]);for(var s=0;s<i.length;s++){var n=i[s],r=n[fieldNames.TimeSlot.DayOfWeek];r=t[r];var a=this.slots[r];a||(a=[],this.slots[r]=a),a.push(new TimeSlot(n))}}}(window),ResourceAbsence.prototype.setSchedulerProperties=function(){var e=void 0,t=void 0;this.start&&(e=60*new Date(this.start).getTimezoneOffset()*1e3),this.end&&(t=60*new Date(this.end).getTimezoneOffset()*1e3),this.start=new Date(this.start+e),this.finish=new Date(this.end+t),this.end=new Date(this.end+t)},ResourceAbsence.prototype.setGanttResource=function(e,t){var i=e[this.resource],s=[];if(this.resourceId=null,this.isScheduled()){this.start_date=this.start?new Date(this.start.getTime()):null,this.end_date=this.finish?new Date(this.finish.getTime()):null;for(var n in i){var r=i[n];"R"===r.serviceTerritoryType&&(isIntersect(r.effectiveStartDate,r.effectiveEndDate,this.start_date,this.end_date)||!r.effectiveEndDate&&r.effectiveStartDate<this.end_date)&&s.push(r.serviceTerritory)}if(0===s.length)for(var a in i){var o=i[a];(isIntersect(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.end_date)||!o.effectiveEndDate&&o.effectiveStartDate<this.end_date)&&s.push(o.serviceTerritory)}else if(showSecondarySTMs)for(var c in i){var l=i[c];"S"===l.serviceTerritoryType&&(isIntersect(l.effectiveStartDate,l.effectiveEndDate,this.start_date,this.end_date)||!l.effectiveEndDate&&l.effectiveStartDate<this.end_date)&&s.push(l.serviceTerritory)}this.resourceId=t(this.resource,s),this.isScheduled()&&this.updateDatesBasedOnTravel()}},ResourceAbsence.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds?this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60)):(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds,this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60)))),this.travelTo&&(this.travelTo<=maxTravelTimeInSeconds?this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)):(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds,this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)))))},ResourceAbsence.prototype.isScheduled=function(){return!!this.resource},ResourceAbsence.prototype.getGanttResource=function(){return this.resourceId?this.resourceId.substr(0,18):this.resourceId},ResourceCapacity.prototype.setSchedulerProperties=function(){var e=void 0,t=void 0;switch(this.start&&(e=60*new Date(this.start).getTimezoneOffset()*1e3),this.end&&(t=60*new Date(this.end).getTimezoneOffset()*1e3),this.start_date=this.start?new Date(this.start+e):null,this.end_date=this.end?new Date(this.end+t):null,this.timePeriod){case"Day":this.end_date=addDaysToDate(this.start_date,1);break;case"Week":this.end_date=addDaysToDate(this.start_date,7);break;case"Month":this.end_date=addDaysToDate(this.end_date,1)}this.hoursPerTimePeriod>0?this.text="<b>"+customLabels.booked.replaceAll(calcCapacityPercentage(this.hoursInUse,this.hoursPerTimePeriod)+"%")+"</b> (<b>"+customLabels.x_Hours_scheduled_out_of_y.replaceAll(this.hoursInUse,this.hoursPerTimePeriod)+"</b>)":this.workItemsPerTimePeriod>0&&(this.text="<b>"+customLabels.booked.replaceAll(calcCapacityPercentage(this.workItemsAllocated,this.workItemsPerTimePeriod)+"%")+"</b> (<b>"+customLabels.NumServicesScheduled.replaceAll(this.workItemsAllocated,this.workItemsPerTimePeriod)+"</b>)"),
this.type="contractorcapacity"},ResourceCapacity.prototype.setGanttResource=function(e,t){var i=e[this.resource],s=[];for(var n in i){var r=i[n];(isIntersect(r.effectiveStartDate,r.effectiveEndDate,this.start_date,this.end_date)||!r.effectiveEndDate&&r.effectiveStartDate<this.end_date)&&s.push(r.serviceTerritory)}this.resourceId=t(this.resource,s)},ResourceCapacity.prototype.isScheduled=function(){return!!this.resource},ResourceCapacity.prototype.getGanttResource=function(){return this.resourceId?this.resourceId.substr(0,18):this.resourceId};var bootstrap={};bootstrap.loadUserSettings=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.IsUserSettingExist,function(e,t){t.status?0==t.result?Visualforce.remoting.Manager.invokeAction(RemoteActions.CreateNewUserSettingsLocStorage,localStorage.getItem(sfdcUser+"_serviceExpertLocations"),localStorage.getItem(sfdcUser+"_serviceExpertOrphan"),localStorage.getItem(sfdcUser+"_serviceExpertSettings"),localStorage.getItem(sfdcUser+"_serviceExpertFilters"),function(e,t){t.status&&(bootstrap.loadedUserSettings=JSON.parse(t.result),angular.bootstrap(document.getElementById("serviceExpertApp"),["serviceExpert"]))},{buffer:!1,escape:!1,timeout:12e4}):Visualforce.remoting.Manager.invokeAction(RemoteActions.GetCreateUserSettings,function(e,t){t.status?(bootstrap.loadedUserSettings=JSON.parse(t.result),angular.bootstrap(document.getElementById("serviceExpertApp"),["serviceExpert"])):bootstrap.handleError(t)},{buffer:!1,escape:!1,timeout:12e4}):bootstrap.handleError(t)},{buffer:!1,escape:!1,timeout:12e4})},bootstrap.Start=function(){bootstrap.UpdatePermissionSets()},bootstrap.UpdatePermissionSets=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.updatePermissionSets,function(e,t){if(null==e||void 0==e)bootstrap.loadUserSettings();else try{handleTabSettingAndRecordTypesPermissions(e).then(function(){bootstrap.loadUserSettings()})}catch(i){console.log(i),bootstrap.loadUserSettings()}})},bootstrap.UpdatePermissionSetsBootstrap=function(e,t){Visualforce.remoting.Manager.invokeAction(sharedRemoteActions.updatePermissionSets,function(i,s){if(null==i||void 0==i)angular.bootstrap(document.getElementById(e),[t]);else try{handleTabSettingAndRecordTypesPermissions(i).then(function(){angular.bootstrap(document.getElementById(e),[t])})}catch(n){console.log(n),angular.bootstrap(document.getElementById(e),[t])}})},bootstrap.handleError=function(e){var t={no_dispatcher_license_found:!0,Apex_CPU_time_limit_exceeded:!0},i=!1;for(var s in t)customLabels[s]==e.message&&(i=!0);cantLoadGantt(-1!=e.message.toLowerCase().indexOf("dml")?customLabels.no_dispatcher_permissions_found.replace("{0}",'<a href="vf066_settings#page=0&tab=1" target="_blank">').replace("{1}","</a>"):i?e.message:customLabels.dispatcher_console_error_loading+'<div class="otherMessage">'+e.message+"</div>")},function(){moment.defineLocale("en_NZ",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(e){var t=e%10,i=1===~~(e%100/10)?"th":1===t?"st":2===t?"nd":3===t?"rd":"th";return e+i},week:{dow:1,doy:4}})}();var globalStatuses={},globalCategories={},flaggedServices={},contextShown=!1,snapTo=!1,globalSelectedGanttServices={},capacityDurationFilter="Day",cachedDomElements={},violationDelimiter="&lt;br/&gt;",minHourToDisplay=0,maxHourToDisplay=24,includeWeekends=!1,gameOn=!1,ctrlPressed=!1,showCandidates={on:!1,id:null};$(function(){$("body").keydown(function(e){ctrlPressed=e.ctrlKey,updateTimesToSnapIn()}).keyup(function(e){ctrlPressed=!1,updateTimesToSnapIn()})}),$(function(){moment.locale(userLocale)}),$(function(){svg4everybody(),"function"==typeof srcUp&&$("body").css("margin","0")});var formatDateByLocaleWithDayOfTheWeek=function(e){var t=utils.formatDateWithDayOfWeek(e);if(t)return t;var i=["en_US"];return-1!=i.indexOf(userLocale)?moment(e).format("ddd, MMM D YYYY"):moment(e).format("LL")};scheduler.attachEvent("onSchedulerReady",function(){scheduler.templates.ZoomLevel1_second_scale_date=function(e){return formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.MonthlyView_second_scale_date=function(e){return moment(e).format("MMM")},scheduler.templates.MDTView_second_scale_date=scheduler.templates.MonthlyView_second_scale_date,scheduler.templates.ZoomLevel2_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel3_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel4_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel5_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel6_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel2_date=function(e,t){return e.getDate()!==t.getDate()?formatDateByLocaleWithDayOfTheWeek(e)+" - "+formatDateByLocaleWithDayOfTheWeek(t):formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.ZoomLevel3_date=function(e,t){return formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.ZoomLevel4_date=function(e,t){var i=new Date(t);return i.setDate(i.getDate()-1),formatDateByLocaleWithDayOfTheWeek(e)+" - "+formatDateByLocaleWithDayOfTheWeek(i)},scheduler.templates.ZoomLevel5_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.ZoomLevel6_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MonthlyView_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MDTView=scheduler.templates.ZoomLevel4_date});var BrickBreaker=function(){function e(){function e(e){var t=e.clientX-p.offsetLeft;t>0&&t<p.width&&(T=t-_/2)}function t(){g.beginPath(),g.arc(m,f,h,0,2*Math.PI),g.fillStyle="#0095DD",g.fill(),g.closePath()}function i(){g.beginPath(),g.rect(T,p.height-y,_,y),g.fillStyle="#0095DD",g.fill(),g.closePath()}function s(){for(var e=0;e<l.length;e++)if(0!=l[e].status){var t=l[e].left,i=l[e].top,s=l[e].width,n=l[e].height;g.beginPath(),g.rect(t,i,s,n),g.fillStyle=l[e].color,g.fill(),s>=40&&(g.font="10px Salesforce Sans",g.fillStyle="#000",g.fillText(l[e].name,t+5,i+10)),g.closePath()}}function n(){if(g.clearRect(0,0,p.width,p.height),s(),t(),i(),r(),o(),(m+S>p.width-h||h>m+S)&&(S=-S),h>f+b)b=-b;else if(f+b>p.height-h)if(m>T&&T+_>m)b=-b;else{if(C--,!C)return alert("GAME OVER - back to work"),void a();m=p.width/2,f=p.height-30,S=5,b=-5,T=(p.width-_)/2}w&&T<p.width-_?T+=7:L&&T>0&&(T-=7),m+=S,f+=b,requestAnimationFrame(n)}function r(){for(var e=0;e<l.length;e++){var t=l[e];if(1==t.status&&m>=t.left&&m<=t.left+t.width&&f>=t.top&&f<=t.top+t.height&&(b=-b,t.status=0,k+=10,k/10==l.length))return alert("You win, great... \\_()_/. back to work"),void a()}}function a(){gameOn=!1,document.removeEventListener("mousemove",e),scheduler.updateView(),$("#bricks-overlay").remove()}function o(){g.font="16px Salesforce Sans",g.fillStyle="#0095DD",g.fillText("Score: "+k+", Lives: "+C,d/2,25)}function c(){for(var e={scheduled:"#F9D058","new":"#A5E2D6",dispatched:"#8DD8FA",inprogress:"#D68EF9",completed:"#95D055",incomplete:"#EA8288","default":"#B7C9EA"},t=[],i=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),s=0;s<i.length;s++){var n=i[s],r=void 0,a=void 0,o=$(scheduler.getRenderedEvent(n.id));o.visible()&&(a=$(o.children()[0]).width(),"service"==n.type?r=e[n.Status.toLowerCase().replace(" ","")]:"break"==n.type?(r="#5e698f",a=o.width()):"na"==n.type&&(r="#d7dfe7"),t.push({color:r,top:o.offset().top-264,left:o.offset().left-$("#LeftSideContainer").width()+8,width:a,height:scheduler.matrix.ZoomLevel3.event_dy-2,name:n.name,status:1}))}return t}var l=c();gameOn=!0,scheduler.updateView(),$("#GanttContainer").append('<div id="bricks-overlay" style="position:absolute; top:100px; z-index:100">\n                                            <canvas id="brick-canvas"></canvas>\n                                        </div>');var u=$(".dhx_cal_data"),d=u.width(),v=u.height(),p=document.getElementById("brick-canvas");p.width=d,p.height=v;var g=p.getContext("2d"),h=15,m=p.width/2,f=p.height-30,S=5,b=-5,y=15,_=95,T=($("body").width()-_)/2,w=!1,L=!1,k=0,C=3;$(".item").length>15?15:$(".item").length;return document.addEventListener("mousemove",e,!1),n(),"GAME ON!"}return $.fn.visible=function(e){var t=$(this),i=$(window),s=i.scrollTop(),n=s+i.height(),r=t.offset().top,a=r+t.height(),o=e===!0?a:r,c=e===!0?r:a;return n>=c&&o>=s},{play:e}}(),schedulerConfig=function(e){function t(){scheduler.createTimelineView({name:"ZoomLevel2",x_unit:"minute",x_date:p.dateFormat,x_step:30,x_size:16,x_start:0,x_length:6,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:p.resourceCellSize,second_scale:{x_unit:"day",x_date:p.dateTitleFormat},event_dy:p.eventHeight,dy:p.rowHeight,section_autoheight:!1,folder_dy:p.locationCellHeight,folder_events_available:!1,sort:p.sort})}function i(){scheduler.createTimelineView({name:"ZoomLevel3",x_unit:"minute",x_date:p.dateFormat,x_step:60,x_size:24,x_start:0,x_length:24,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:p.resourceCellSize,second_scale:{x_unit:"day",x_date:p.dateTitleFormat},event_dy:p.eventHeight,dy:p.rowHeight,section_autoheight:!1,folder_dy:p.locationCellHeight,folder_events_available:!1,sort:p.sort})}function s(){scheduler.createTimelineView({name:"ZoomLevel4",x_unit:"minute",x_date:p.dateFormat,x_step:120,x_size:24,x_start:0,x_length:12,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:p.resourceCellSize,second_scale:{x_unit:"day",x_date:p.dateTitleFormat},event_dy:p.eventHeight,dy:p.rowHeight,section_autoheight:!1,folder_dy:p.locationCellHeight,folder_events_available:!1,sort:p.sort})}function n(){scheduler.createTimelineView({name:"ZoomLevel5",x_unit:"minute",x_date:p.dateFormat,x_step:240,x_size:18,x_start:0,x_length:6,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:p.resourceCellSize,second_scale:{x_unit:"day",x_date:p.dateTitleFormat},event_dy:p.eventHeight,dy:p.rowHeight,section_autoheight:!1,folder_dy:p.locationCellHeight,folder_events_available:!1,sort:p.sort})}function r(){scheduler.createTimelineView({name:"ZoomLevel6",x_unit:"minute",x_date:p.dateFormat,x_step:360,x_size:28,x_start:0,x_length:4,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:p.resourceCellSize,second_scale:{x_unit:"day",x_date:p.dateTitleFormat},event_dy:p.eventHeight,dy:p.rowHeight,section_autoheight:!1,folder_dy:p.locationCellHeight,folder_events_available:!1,sort:p.sort})}function a(){scheduler.createTimelineView({name:"MonthlyView",x_unit:"day",x_date:"%d",x_step:1,x_size:31,x_start:0,x_length:1,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:p.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:p.eventHeight,dy:p.rowHeight,section_autoheight:!1,folder_dy:p.locationCellHeight,folder_events_available:!1,sort:p.sort})}function o(){scheduler.createTimelineView({name:"MTDView",x_unit:"day",x_date:"%d",x_step:1,x_size:35,x_start:0,x_length:1,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:p.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:p.eventHeight,dy:p.rowHeight,section_autoheight:!1,folder_dy:p.locationCellHeight,folder_events_available:!1,sort:p.sort})}function c(){t(),i(),s(),n(),r(),a(),o()}function l(){scheduler.config.drag_resize=!1,scheduler.config.multisection=!0,scheduler.config.multisection_shift_all=!1,scheduler.config.limit_drag_out=!1,scheduler.config.dblclick_create=!1,scheduler.config.mark_now=!1,scheduler.config.time_step=1,scheduler.dhtmlXTooltip.config.className="dhtmlXTooltip tooltip expertTooltip",scheduler.dhtmlXTooltip.config.timeout_to_display=375,scheduler.dhtmlXTooltip.config.delta_x=-15,scheduler.dhtmlXTooltip.config.delta_y=-15,scheduler.config.minicalendar.mark_events=!1,scheduler.config.preserve_length=!1}function u(e,t){var i=32;switch(e){case"xsmall":i=27;break;case"small":i=32;break;case"normal":i=39;break;case"large":i=46;break;default:i=39}if(scheduler.matrix.ZoomLevel3.dy!=i){for(var s in scheduler.matrix)scheduler.matrix[s].dy=i,scheduler.matrix[s].event_dy=i-4,scheduler.matrix[s].folder_dy=i+2;t&&scheduler._is_initialized()&&scheduler.setCurrentView()}}function d(e){scheduler.config.readonly=e}function v(e,t){var i=new Date(e.start_date),s=new Date(e.end_date),n=new Date(t.start_date),r=new Date(t.end_date);return"na"==e.type&&"na"!=t.type?(i>r||n>s)&&+i>+n?1:-1:"na"==t.type&&"na"!=e.type?n>s||i>r?+i>+n?1:-1:1:+i>+n?1:-1}var p={dateTitleFormat:"%D, %F %d",dateFormat:"%g:%i%A",resourceCellSize:170,locationCellHeight:44,rowHeight:46,eventHeight:42,sort:v};return{timelineConfigs:p,configTimelines:c,setRowHeights:u,setReadOnly:d,setConfigurations:l,sortEvents:v}}(schedulerConfig||{});scheduler.attachEvent("onSchedulerReady",function(){scheduler.templates.calendar_month=function(e){var t=["en_US","en_GB"];return-1!=t.indexOf(userLocale)?moment(e).format("MMMM YYYY"):moment(e).format("LL")},scheduler.templates.calendar_date=function(e){return moment(e).format("DD")},scheduler.templates.calendar_scale_date=function(e){return moment(e).format("ddd")},scheduler.templates.calendar_time=function(e){return moment(e).format("l")}});